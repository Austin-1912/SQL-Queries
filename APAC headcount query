CREATE OR REPLACE TABLE CAR_688_CAMPAIGN_SUMMARY AS
SELECT
    Communication_Channel,
    Channel_Type,
    test_control_flag,
    CAMPAIGN_NAME,
    
    -- Basic Counts
    COUNT(DISTINCT CUSTOMER_KEY) as unique_customers,
    SUM(communications_sent) as total_communications_sent,
    SUM(communication_undelivered) as total_undelivered,
    SUM(communication_opened_7days) as total_opened_7days,
    SUM(communication_clicked_7days) as total_clicked_7days,
    
    -- Click Rate (for Content Card, Email, In-App, SMS)
    CASE
        WHEN Channel_Type IN ('Content Card', 'EMAIL', 'IN-APP', 'SMS')
            AND SUM(communications_sent) > 0
        THEN ROUND((SUM(communication_clicked_7days) * 100.0) / SUM(communications_sent), 2)
        ELSE NULL
    END as click_rate_pct,
    
    -- Open Rate (for Email, Push)
    CASE
        WHEN Channel_Type IN ('EMAIL', 'Push')
            AND SUM(communications_sent) > 0
        THEN ROUND((SUM(communication_opened_7days) * 100.0) / SUM(communications_sent), 2)
        ELSE NULL
    END as open_rate_pct
    
FROM CAR_688_CAMPAIGN_BASE
GROUP BY Communication_Channel, Channel_Type, test_control_flag, CAMPAIGN_NAME
ORDER BY Communication_Channel, test_control_flag;
