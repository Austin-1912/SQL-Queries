-- Step 1: Create base transaction table with filters
CREATE OR REPLACE TABLE CAR_825_TXN_BASE AS
SELECT
    SNDCUSTOMER_KEY,
    RCVCUSTOMER_KEY,
    MTCN,
    SNDCOUNTRY_CODE AS snd_country,
    RCVCOUNTRY_CODE AS rcv_country,
    PAYOUT_TYPE,
    SNDPRINCIPAL_USD,
    RCVPAYING_DATETIME AS txn_dt,
    PRIMARY_CHANNEL,
    REVENUE,
FROM WUDNA.SUMMARY_GEN.WUDNA_TXN_MASTER_VW
WHERE
    DATE(RCVPAYING_DATETIME) >= '2021-01-01' AND
    SUB_CHANNEL IN ('DIGITAL PARTNERS DWL')
    AND VALID_TXN_TYPE_CODE = 'Y'
    AND SNDPRINCIPAL_USD > 0
    AND REFUND_TRXN = 'N'
    AND PRODUCT_GROUP NOT IN ('QCOL', 'QCSH');
 
-- Step 2: Create dominant corridor table per sender customer
CREATE OR REPLACE TABLE CAR_825_DOMINANT_CORRIDOR AS
SELECT *
FROM (
    SELECT
        SNDCUSTOMER_KEY,
        CONCAT(snd_country, '-', rcv_country) AS corridor,
        snd_country,
        rcv_country,
        COUNT(DISTINCT MTCN) AS txn_count,
        SUM(SNDPRINCIPAL_USD) AS total_principal_usd,
        ROW_NUMBER() OVER (
            PARTITION BY SNDCUSTOMER_KEY
            ORDER BY COUNT(DISTINCT MTCN) DESC, MAX(txn_dt) DESC
        ) AS rnk
    FROM CAR_825_TXN_BASE
    GROUP BY SNDCUSTOMER_KEY, snd_country, rcv_country
)
WHERE rnk = 1;
 
-- Step 3: Create dominant payout type table per sender customer
CREATE OR REPLACE TABLE CAR_825_DOMINANT_PAYOUT AS
SELECT *
FROM (
    SELECT
        SNDCUSTOMER_KEY,
        PAYOUT_TYPE,
        COUNT(DISTINCT MTCN) AS txn_count,
        SUM(SNDPRINCIPAL_USD) AS total_principal_usd,
        ROW_NUMBER() OVER (
            PARTITION BY SNDCUSTOMER_KEY
            ORDER BY COUNT(DISTINCT MTCN) DESC, MAX(txn_dt) DESC
        ) AS rnk
    FROM CAR_825_TXN_BASE
    GROUP BY SNDCUSTOMER_KEY, PAYOUT_TYPE
)
WHERE rnk = 1;
 
-- Step 4: Create comprehensive customer summary with dominant attributes
CREATE OR REPLACE TABLE CAR_825_CUSTOMER_SUMMARY AS
SELECT
    b.SNDCUSTOMER_KEY,
    COUNT(DISTINCT b.MTCN) AS total_transactions,
    SUM(b.SNDPRINCIPAL_USD) AS total_principal_usd,
    AVG(b.SNDPRINCIPAL_USD) AS avg_principal_usd,
    SUM(b.REVENUE) AS total_revenue,
    MIN(b.txn_dt) AS first_txn_date,
    MAX(b.txn_dt) AS last_txn_date,
    -- Dominant corridor info
    c.corridor AS dominant_corridor,
    c.snd_country AS dominant_snd_country,
    c.rcv_country AS dominant_rcv_country,
    c.txn_count AS corridor_txn_count,
    -- Dominant payout info
    p.PAYOUT_TYPE AS dominant_payout_type,
    p.txn_count AS payout_txn_count
FROM CAR_825_TXN_BASE b
LEFT JOIN CAR_825_DOMINANT_CORRIDOR c
    ON b.SNDCUSTOMER_KEY = c.SNDCUSTOMER_KEY
LEFT JOIN CAR_825_DOMINANT_PAYOUT p
    ON b.SNDCUSTOMER_KEY = p.SNDCUSTOMER_KEY
GROUP BY
    b.SNDCUSTOMER_KEY,
    c.corridor,
    c.snd_country,
    c.rcv_country,
    c.txn_count,
    p.PAYOUT_TYPE,
    p.txn_count;
This is a query i have written however in here i dont have the New Customer , Existing Customer and Winback Customer Flag. 
Definitions include:
New - Transaction Present in 2025 , Was not present before,
Existing - Transaction Present in 2024 as well as 2025,
Winback - Transaction Present in 2025 , not in 2024, and present before that. Need a column where the above will be given.
Also will need to create TPC & TPC Bucket for customers like 1x , 2x, 3x, 4x+ on the number of transactions.
As well as PPT & PPT bucket - Principal Per Transactions make  buckets like <100$ , 100-500, 500 - 1000 and soo on . i might alter the PPT bucket on the basis of PPT we are getting. 
