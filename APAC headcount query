CREATE OR REPLACE TABLE CAR_843_CUSTOMER_BASE1
AS
SELECT
    t.txn_id,
    t.rcvpaying_datetime as transaction_date,
    t.sndcustomer_key as GID,
    t.sndcountry_code as snd_country,
    t.rcvcountry_code as rcv_country,
    cm.country_code as Registered_Country_Code,
    cm.state as Registered_State,
    cm.city as Registered_City,
    cm.first_registration_date,
ROW_NUMBER() OVER (PARTITION BY t.sndcustomer_key ORDER BY t.rcvpaying_datetime ASC) AS rn_first
FROM wudna.summary_gen.wudna_txn_master_analytics_vw t
LEFT JOIN WUDNA.SUMMARY_GEN.WUDNA_CUSTOMER_MASTER_VW cm
    ON t.sndcustomer_key = cm.customer_key
WHERE 
DATE(rcvpaying_datetime) <= '2026-01-26' AND 
t.sndcountry_code = 'IN' 
AND cm.country_code = 'IN';


CREATE OR REPLACE TABLE CAR_843_Customer_Flags AS
SELECT
    MIN(transaction_date) AS first_transaction_date,
    GID AS Customer_key,
    COUNT(CASE 
        WHEN DATE(transaction_date) >= '2025-07-01' AND DATE(transaction_date) <= '2026-01-26' THEN txn_id 
    END) AS R6_txns,
    COUNT(CASE
        WHEN DATE(transaction_date) < '2025-07-01' THEN txn_id 
    END) AS R6Plus_txns,
    MODE(CASE 
        WHEN rn_first = 1 THEN snd_country || '-' || rcv_country 
    END) AS first_corridor 
FROM CAR_843_CUSTOMER_BASE1 
GROUP BY ALL;

CREATE OR REPLACE TABLE CAR_843_first_corridor_txns AS
SELECT 
    a.*,
    b.*
FROM 
    CAR_843_Customer_Flags a 
    LEFT JOIN CAR_843_CUSTOMER_BASE1 b
        ON a.customer_key = b.GID
WHERE 
    a.R6_txns > 0 
    AND a.R6Plus_txns = 0;

CREATE OR REPLACE TABLE dominant_corridor1 AS
    -- Get dominant (most frequent) corridor
    SELECT *
FROM (
    SELECT
        GID,
        CONCAT(snd_country, '-', rcv_country) AS corridor,
        COUNT(DISTINCT txn_id)                  AS txn_count,
        ROW_NUMBER() OVER (
            PARTITION BY GID
            ORDER BY COUNT(DISTINCT txn_id) DESC, MAX(transaction_date) DESC
        ) AS rnk
    FROM CAR_843_CUSTOMER_BASE1
    WHERE 
    a.R6_txns > 0 
    AND a.R6Plus_txns = 0;
    GROUP BY ALL
)
WHERE rnk = 1;

-- Final output
SELECT 
    '@' || cb.GID AS GID,
    cb.Registered_Country_Code,
    cb.Registered_State,
    cb.Registered_City,
    cb.first_registration_date,
    fc.first_corridor,
    fc.first_transaction_date,
    dc.corridor as dominant_corridor,
FROM CAR_843_Customer_base cb
LEFT JOIN dominant_corridor dc ON cb.GID = dc.GID
where fc.first_transaction_date IS NOT NULL
-- and fc.first_transaction_date >= cb.first_registration_date
ORDER BY cb.GID;
