Here's the corrected query with all the `NOT IN` issues fixed and proper logic:

```sql
-- ============================================================================
-- CAR_841: Canada CEM Audience Sizing Analysis - CORRECTED
-- ============================================================================

-- Step 1: Create historical transactions table
CREATE OR REPLACE TABLE CAR_841_HISTORICAL_TXNS AS
SELECT DISTINCT
    SNDCUSTOMER_KEY,
    RCVPAYING_DATETIME,
    PRICING_CHANNEL,
    -- Channel classification
    CASE
        WHEN PRICING_CHANNEL IN ('WEB', 'APP') THEN 'DIGITAL'
        WHEN PRICING_CHANNEL IN ('POS', 'TMT', 'AIR') THEN 'RETAIL'
        ELSE 'OTHER'
    END AS channel_group,
    -- Time period classification
    CASE
        WHEN DATE(RCVPAYING_DATETIME) >= DATEADD(MONTH, -12, DATE('2026-01-27'))
             AND DATE(RCVPAYING_DATETIME) < DATE('2026-01-27')
        THEN 'R12'
        
        WHEN DATE(RCVPAYING_DATETIME) >= DATEADD(MONTH, -48, DATE('2026-01-27'))
             AND DATE(RCVPAYING_DATETIME) < DATEADD(MONTH, -12, DATE('2026-01-27'))             
        THEN 'R13_PLUS'
    END AS history_period
FROM SUMMARY_GEN.WUDNA_TXN_MASTER_ANALYTICS_VW
WHERE DATE(RCVPAYING_DATETIME) >= DATEADD(MONTH, -48, DATE('2026-01-27'))
  AND DATE(RCVPAYING_DATETIME) < DATE('2026-01-27')
  AND SNDCOUNTRY_CODE = 'CA'
  AND RCVPAYING_DATETIME IS NOT NULL 
  AND SNDCUSTOMER_KEY IS NOT NULL;

-- Validation
SELECT 'Step 1: Historical Transactions' AS step,
       COUNT(*) AS total_records,
       COUNT(DISTINCT SNDCUSTOMER_KEY) AS unique_customers,
       SUM(CASE WHEN history_period = 'R12' THEN 1 ELSE 0 END) AS r12_txns,
       SUM(CASE WHEN history_period = 'R13_PLUS' THEN 1 ELSE 0 END) AS r13plus_txns
FROM CAR_841_HISTORICAL_TXNS;

-- Step 2: Identify active customers (transacted in R12)
CREATE OR REPLACE TABLE CAR_841_ACTIVE_CUSTOMERS AS
SELECT DISTINCT SNDCUSTOMER_KEY AS customer_key
FROM CAR_841_HISTORICAL_TXNS
WHERE history_period = 'R12';

SELECT 'Step 2: Active Customers' AS step,
       COUNT(DISTINCT customer_key) AS unique_customers, 
       COUNT(customer_key) AS total_records
FROM CAR_841_ACTIVE_CUSTOMERS;

-- Step 3: Identify lapsed customers (transacted in R13+ but NOT in R12)
-- FIXED: Using LEFT JOIN instead of NOT IN
CREATE OR REPLACE TABLE CAR_841_LAPSED_CUSTOMERS AS
SELECT DISTINCT h.SNDCUSTOMER_KEY AS customer_key
FROM CAR_841_HISTORICAL_TXNS h
LEFT JOIN CAR_841_ACTIVE_CUSTOMERS ac 
    ON h.SNDCUSTOMER_KEY = ac.customer_key
WHERE h.history_period = 'R13_PLUS'
  AND ac.customer_key IS NULL;

SELECT 'Step 3: Lapsed Customers' AS step,
       COUNT(DISTINCT customer_key) AS unique_customers, 
       COUNT(customer_key) AS total_records
FROM CAR_841_LAPSED_CUSTOMERS;

-- Step 4a: App users in R12
CREATE OR REPLACE TABLE CAR_841_CA_APP_USERS_R12 AS
SELECT DISTINCT SNDCUSTOMER_KEY AS customer_key
FROM CAR_841_HISTORICAL_TXNS
WHERE PRICING_CHANNEL = 'APP'
  AND DATE(RCVPAYING_DATETIME) >= '2025-01-27' 
  AND DATE(RCVPAYING_DATETIME) < '2026-01-27';

SELECT 'Step 4a: App Users R12' AS step,
       COUNT(DISTINCT customer_key) AS unique_customers, 
       COUNT(customer_key) AS total_records
FROM CAR_841_CA_APP_USERS_R12;

-- Step 4b: App users in R13_Plus
CREATE OR REPLACE TABLE CAR_841_CA_APP_USERS_R13_PLUS AS
SELECT DISTINCT SNDCUSTOMER_KEY AS customer_key
FROM CAR_841_HISTORICAL_TXNS
WHERE PRICING_CHANNEL = 'APP'
  AND DATE(RCVPAYING_DATETIME) >= '2022-01-27' 
  AND DATE(RCVPAYING_DATETIME) < '2025-01-27';

SELECT 'Step 4b: App Users R13_Plus' AS step,
       COUNT(DISTINCT customer_key) AS unique_customers, 
       COUNT(customer_key) AS total_records
FROM CAR_841_CA_APP_USERS_R13_PLUS;

-- Validation: Lapsed customers who used app in R13_Plus
SELECT 'Validation: Lapsed App Users from R13_Plus' AS check_name,
       COUNT(DISTINCT a.customer_key) AS lapsed_app_users
FROM CAR_841_CA_APP_USERS_R13_PLUS a
INNER JOIN CAR_841_LAPSED_CUSTOMERS b
    ON a.customer_key = b.customer_key;

-- Step 5: Identify RNT (Registered Non-Transactors) in R12
-- FIXED: Using LEFT JOIN instead of NOT IN
CREATE OR REPLACE TABLE CAR_841_RNT_R12 AS
SELECT DISTINCT cm.customer_key
FROM SUMMARY_GEN.WUDNA_CUSTOMER_MASTER_VW cm
LEFT JOIN CAR_841_ACTIVE_CUSTOMERS ac 
    ON cm.customer_key = ac.customer_key
WHERE cm.country_code = 'CA'
  AND DATE(cm.first_registration_date) >= DATEADD(MONTH, -12, DATE('2026-01-27'))
  AND DATE(cm.first_registration_date) < DATE('2026-01-27')
  AND ac.customer_key IS NULL;  -- No transaction in R12

SELECT 'Step 5: RNT Customers' AS step,
       COUNT(DISTINCT customer_key) AS unique_customers, 
       COUNT(customer_key) AS total_records
FROM CAR_841_RNT_R12;

-- Step 6: Master marketability table
-- FIXED: Corrected JOIN logic for app users
CREATE OR REPLACE TABLE CAR_841_CA_MARKETABILITY AS
SELECT
    cm.customer_key,
    cm.country_code,
    cm.global_holdout,

    -- Customer segment
    CASE
        WHEN ac.customer_key IS NOT NULL THEN 'ACTIVE'
        WHEN lc.customer_key IS NOT NULL THEN 'LAPSED'
        WHEN rnt.customer_key IS NOT NULL THEN 'RNT'
        ELSE 'OTHER'
    END AS customer_segment,

    -- Email marketable (marketing + email on file + opt-in)
    CASE
        WHEN cm.marketing_flag = 'Y'
         AND cm.email_address_on_file_flag = 'Y'
         AND cm.opt_email = 'I'
        THEN 'Y' ELSE 'N'
    END AS email_marketability_flag,

    -- SMS marketable
    CASE 
        WHEN cm.country_code IN ('US','CA') 
         AND cm.MOBILE_NUMBER_ON_FILE_FLAG = 'Y' 
         AND cm.opt_sms = 'I' 
         AND cm.DOUBLE_OPT_SMS = 'I' 
         AND cm.marketing_flag = 'Y' 
        THEN 'Y' 
        ELSE 'N' 
    END AS SMS_Marketable,

    -- App reachable in R12 (had APP txn in R12)
    CASE 
        WHEN au.customer_key IS NOT NULL THEN 'Y' 
        ELSE 'N' 
    END AS app_marketability_flag,
    
    -- App reachable in R13_Plus (had APP txn in R13_Plus)
    CASE 
        WHEN aus.customer_key IS NOT NULL THEN 'Y' 
        ELSE 'N' 
    END AS R13plus_app_marketability_flag,

    -- Service email (email on file, regardless of marketing opt-in)
    CASE
        WHEN cm.email_address_on_file_flag = 'Y' THEN 'Y'
        ELSE 'N'
    END AS service_email_flag,

    -- R12 CEM addressable (email/SMS/app in R12 with marketing consent)
    CASE
        WHEN (
            (cm.marketing_flag = 'Y'
             AND cm.email_address_on_file_flag = 'Y'
             AND cm.opt_email = 'I')
            OR
            (cm.country_code IN ('US','CA')
             AND cm.MOBILE_NUMBER_ON_FILE_FLAG = 'Y'
             AND cm.opt_sms = 'I'
             AND cm.DOUBLE_OPT_SMS = 'I'
             AND cm.marketing_flag = 'Y')
            OR 
            au.customer_key IS NOT NULL
        )
        THEN 'Y'
        ELSE 'N'
    END AS R12_marketability_flag,

    -- R12+ CEM addressable (email/SMS/app in R12 OR R13_Plus with marketing consent)
    CASE
        WHEN (
            (cm.marketing_flag = 'Y'
             AND cm.email_address_on_file_flag = 'Y'
             AND cm.opt_email = 'I')
            OR
            (cm.country_code IN ('US','CA')
             AND cm.MOBILE_NUMBER_ON_FILE_FLAG = 'Y'
             AND cm.opt_sms = 'I'
             AND cm.DOUBLE_OPT_SMS = 'I'
             AND cm.marketing_flag = 'Y')
            OR 
            au.customer_key IS NOT NULL
            OR 
            aus.customer_key IS NOT NULL
        )
        THEN 'Y'
        ELSE 'N'
    END AS R12Plus_marketability_flag

FROM SUMMARY_GEN.WUDNA_CUSTOMER_MASTER_VW cm
LEFT JOIN CAR_841_ACTIVE_CUSTOMERS ac ON cm.customer_key = ac.customer_key
LEFT JOIN CAR_841_LAPSED_CUSTOMERS lc ON cm.customer_key = lc.customer_key
LEFT JOIN CAR_841_RNT_R12 rnt ON cm.customer_key = rnt.customer_key
-- FIXED: Join app users to ALL customers, not just lapsed
LEFT JOIN CAR_841_CA_APP_USERS_R12 au ON cm.customer_key = au.customer_key
LEFT JOIN CAR_841_CA_APP_USERS_R13_PLUS aus ON cm.customer_key = aus.customer_key
WHERE cm.country_code = 'CA';

SELECT 'Step 6: Marketability Master Table' AS step,
       COUNT(DISTINCT customer_key) AS unique_customers, 
       COUNT(customer_key) AS total_records
FROM CAR_841_CA_MARKETABILITY;

-- ============================================================================
-- FINAL REPORT
-- ============================================================================

SELECT 
    customer_segment,
    COUNT(DISTINCT customer_key) AS total_customers,
    
    -- Overall marketability flags
    SUM(CASE WHEN R12_marketability_flag = 'Y' THEN 1 ELSE 0 END) AS R12_Marketable,
    SUM(CASE WHEN R12Plus_marketability_flag = 'Y' THEN 1 ELSE 0 END) AS R13Plus_Marketable,
    
    -- Channel exclusivity (Email only, no SMS, no App)
    SUM(CASE WHEN email_marketability_flag = 'Y' 
              AND SMS_Marketable = 'N' 
              AND app_marketability_flag = 'N' 
              AND R13plus_app_marketability_flag = 'N'
         THEN 1 ELSE 0 END) AS EMAIL_ONLY,
    
    -- R12 App only (no email, no SMS)
    SUM(CASE WHEN email_marketability_flag = 'N' 
              AND SMS_Marketable = 'N' 
              AND app_marketability_flag = 'Y' 
         THEN 1 ELSE 0 END) AS R12_APP_ONLY,
    
    -- R13_Plus App only (no email, no SMS, no R12 app)
    SUM(CASE WHEN email_marketability_flag = 'N' 
              AND SMS_Marketable = 'N' 
              AND app_marketability_flag = 'N'
              AND R13plus_app_marketability_flag = 'Y' 
         THEN 1 ELSE 0 END) AS R13Plus_APP_ONLY,
    
    -- Email + R12 App (no SMS)
    SUM(CASE WHEN email_marketability_flag = 'Y' 
              AND SMS_Marketable = 'N' 
              AND app_marketability_flag = 'Y' 
         THEN 1 ELSE 0 END) AS EMAIL_R12APP,
    
    -- Email + R13_Plus App (no SMS, no R12 app)
    SUM(CASE WHEN email_marketability_flag = 'Y' 
              AND SMS_Marketable = 'N' 
              AND app_marketability_flag = 'N'
              AND R13plus_app_marketability_flag = 'Y' 
         THEN 1 ELSE 0 END) AS EMAIL_R13PlusAPP,
    
    -- SMS marketable
    SUM(CASE WHEN SMS_Marketable = 'Y' THEN 1 ELSE 0 END) AS SMS_Marketable,
    
    -- Service email addressable
    SUM(CASE WHEN service_email_flag = 'Y' THEN 1 ELSE 0 END) AS service_email_addressable

FROM CAR_841_CA_MARKETABILITY
GROUP BY customer_segment
ORDER BY 
    CASE customer_segment
        WHEN 'ACTIVE' THEN 1
        WHEN 'LAPSED' THEN 2
        WHEN 'RNT' THEN 3
        ELSE 4
    END;

-- ============================================================================
-- ADDITIONAL VALIDATIONS
-- ============================================================================

-- Validation 1: Check segment overlap (should be 0)
SELECT 
    'Segment Overlap Check' AS validation,
    COUNT(*) AS overlapping_customers
FROM (
    SELECT customer_key, COUNT(DISTINCT customer_segment) AS segment_count
    FROM CAR_841_CA_MARKETABILITY
    WHERE customer_segment IN ('ACTIVE', 'LAPSED', 'RNT')
    GROUP BY customer_key
    HAVING COUNT(DISTINCT customer_segment) > 1
);

-- Validation 2: Segment distribution
SELECT 
    'Segment Distribution' AS validation,
    customer_segment,
    COUNT(DISTINCT customer_key) AS customer_count,
    ROUND(COUNT(DISTINCT customer_key) * 100.0 / SUM(COUNT(DISTINCT customer_key)) OVER(), 2) AS pct_of_total
FROM CAR_841_CA_MARKETABILITY
GROUP BY customer_segment
ORDER BY customer_count DESC;

-- Validation 3: App user reconciliation
SELECT 
    'App Users Reconciliation' AS validation,
    'R12 App Users from Txn Table' AS source,
    COUNT(DISTINCT customer_key) AS count
FROM CAR_841_CA_APP_USERS_R12
UNION ALL
SELECT 
    'App Users Reconciliation' AS validation,
    'R12 App Users in Marketability (Flag=Y)' AS source,
    COUNT(DISTINCT customer_key) AS count
FROM CAR_841_CA_MARKETABILITY
WHERE app_marketability_flag = 'Y'
UNION ALL
SELECT 
    'App Users Reconciliation' AS validation,
    'R13_Plus App Users from Txn Table' AS source,
    COUNT(DISTINCT customer_key) AS count
FROM CAR_841_CA_APP_USERS_R13_PLUS
UNION ALL
SELECT 
    'App Users Reconciliation' AS validation,
    'R13_Plus App Users in Marketability (Flag=Y)' AS source,
    COUNT(DISTINCT customer_key) AS count
FROM CAR_841_CA_MARKETABILITY
WHERE R13plus_app_marketability_flag = 'Y';
```

## Key Corrections Made:

1. **Fixed `NOT IN` issues** - Replaced with `LEFT JOIN ... WHERE IS NULL` in:
   - Lapsed customers identification
   - RNT customers identification

2. **Fixed App User JOIN logic**:
   - Changed `LEFT JOIN CAR_841_CA_APP_USERS_R12 au ON lc.customer_key = au.customer_key` 
   - To: `LEFT JOIN CAR_841_CA_APP_USERS_R12 au ON cm.customer_key = au.customer_key`
   - This ensures app users are identified for ALL customers, not just lapsed ones

3. **Improved EMAIL_ONLY logic** - Now excludes both R12 and R13_Plus app users

4. **Fixed R13Plus_APP_ONLY logic** - Now excludes R12 app users

5. **Added comprehensive validations** - To verify data integrity

6. **Added step-by-step validation queries** - To track counts at each step

This should now produce accurate results!
