--New --270k
CREATE OR REPLACE TABLE CAR_695_INDIA_WUBD_TXN_COUNT AS
SELECT 
    DATE(RCVPAYING_DATETIME) AS TXN_DATE,
    SNDCUSTOMER_KEY,
    COUNT(TXN_ID) AS CUSTOMER_TXNS,
    COUNT(CASE WHEN UPPER(PRICING_CHANNEL) = 'WEB' THEN TXN_ID END) AS CUSTOMER_WEB_TXNS,
    COUNT(CASE WHEN UPPER(PRICING_CHANNEL) = 'APP' THEN TXN_ID END) AS CUSTOMER_APP_TXNS
FROM 
    WUDNA.SUMMARY_GEN.WUDNA_TXN_MASTER_ANALYTICS_VW 
WHERE
    SNDCOUNTRY_CODE = 'IN' 
    AND DATE(RCVPAYING_DATETIME) BETWEEN '2022-01-01' AND '2025-09-30'
    AND UPPER(PRICING_CHANNEL) NOT IN ('POS', 'AIR', 'TMT')
GROUP BY 
    TXN_DATE, SNDCUSTOMER_KEY;


SELECT
    TXN_DATE,
    '@' || SNDCUSTOMER_KEY AS GID,
    CUSTOMER_TXNS,
    CUSTOMER_WEB_TXNS,
    CUSTOMER_APP_TXNS,
    --channel,
    CASE
        WHEN CUSTOMER_TXNS >= 1 AND CUSTOMER_TXNS <= 5 THEN '1X-5X'
        WHEN CUSTOMER_TXNS >= 6 AND CUSTOMER_TXNS <= 10 THEN '6X-10X'
        WHEN CUSTOMER_TXNS >= 11 AND CUSTOMER_TXNS <= 15 THEN '11X-15X'
        ELSE '15X+'
    END AS TPC_BUCKET
FROM CAR_695_INDIA_WUBD_TXN_COUNT
WHERE
    SNDCUSTOMER_KEY IS NOT NULL;
--AND CUSTOMER_WEB_TXNS>0 AND  CUSTOMER_APP_TXNS>0;

SELECT
    TXN_DATE,
    SNDCUSTOMER_KEY,
    COUNT(*) AS ROW_COUNT
FROM CAR_695_INDIA_WUBD_TXN_COUNT
GROUP BY TXN_DATE, SNDCUSTOMER_KEY
HAVING COUNT(*) > 1;

--old - 77k

CREATE OR REPLACE TABLE CAR_695_INDIA_WUBD_TXN_COUNT AS
SELECT 
    DATE(DATE_TRUNC('YEAR', RCVPAYING_DATETIME)) AS YEAR,
    SNDCUSTOMER_KEY,
    COUNT(TXN_ID) AS CUSTOMER_TXNS,
    COUNT(CASE WHEN UPPER(PRICING_CHANNEL) = 'WEB' THEN TXN_ID END) AS CUSTOMER_WEB_TXNS,
    COUNT(CASE WHEN UPPER(PRICING_CHANNEL) = 'APP' THEN TXN_ID END) AS CUSTOMER_APP_TXNS
FROM 
    WUDNA.SUMMARY_GEN.WUDNA_TXN_MASTER_ANALYTICS_VW 
WHERE
    SNDCOUNTRY_CODE = 'IN' 
    AND RCVPAYING_DATETIME >= '2022-01-01' and DATe(RCVPAYING_DATETIME) <= '2025-09-30'
    AND UPPER(PRICING_CHANNEL) NOT IN ('POS', 'AIR', 'TMT')
GROUP BY 
    ALL;


SELECT 
    YEAR,
    '@' || SNDCUSTOMER_KEY AS GID,
    CUSTOMER_TXNS,
    CUSTOMER_WEB_TXNS,
    CUSTOMER_APP_TXNS,
    CASE
        WHEN CUSTOMER_TXNS >= 1 AND CUSTOMER_TXNS <= 5 THEN '1X-5X'
        WHEN CUSTOMER_TXNS >= 6 AND CUSTOMER_TXNS <= 10 THEN '6X-10X'
        WHEN CUSTOMER_TXNS >= 11 AND CUSTOMER_TXNS <= 15 THEN '11X-15X'
        ELSE '15X+'
    END AS TPC_BUCKET
FROM CAR_695_INDIA_WUBD_TXN_COUNT
WHERE
    SNDCUSTOMER_KEY IS NOT NULL;
