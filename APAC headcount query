CREATE OR REPLACE TABLE CAR_855_AUNZSG_BASE_TXNS AS
SELECT
    t.SNDCUSTOMER_KEY,
    t.txn_id,
    t.PRICING_CHANNEL,
    TO_DECIMAL(t.SNDPRINCIPAL_AMOUNT,18,2) as SNDPRINCIPAL_AMOUNT,
    t.sndcurrency_code,
    UPPER(t.SNDCOUNTRY_CODE) AS sndcountry_code,
    UPPER(t.RCVCOUNTRY_CODE) AS rcvcountry_code,
    t.RCVPAYING_DATETIME,
    -- Flag transactions by tier eligibility
    CASE
        WHEN TO_DECIMAL(t.SNDPRINCIPAL_AMOUNT,18,2) >= 500 THEN '500'
        WHEN TO_DECIMAL(t.SNDPRINCIPAL_AMOUNT,18,2) >= 300 THEN '300'
        ELSE 'BELOW_THRESHOLD'
    END AS tier_flag
FROM SUMMARY_GEN.WUDNA_TXN_MASTER_ANALYTICS_VW t
WHERE
    -- Geographic filters
    UPPER(t.SNDCOUNTRY_CODE) IN ('AU', 'NZ', 'SG')
    AND UPPER(t.RCVCOUNTRY_CODE) = 'PH'
    -- Date window
    AND DATE(t.RECORD_DATETIME) >= '2025-12-01'
    AND DATE(t.RECORD_DATETIME) <= '2026-01-31'
    -- Channel filters: AU/NZ both channels, SG digital only
    AND (
        (UPPER(t.SNDCOUNTRY_CODE) IN ('AU', 'NZ'))
        OR
        (UPPER(t.SNDCOUNTRY_CODE) = 'SG' AND UPPER(t.PRICING_CHANNEL) IN ('WEB', 'APP') )
    )
    -- Only transactions >= 300 (minimum threshold)
    AND TO_DECIMAL(t.SNDPRINCIPAL_AMOUNT,18,2) >= 300;

-- Step 2: Customer-level aggregation with tier qualification
CREATE OR REPLACE TABLE CAR_855_AUNZSG_CUSTOMER_QUALIFICATION AS
SELECT
    SNDCUSTOMER_KEY,
    sndcountry_code,
    rcvcountry_code,
    
    -- Count transactions by tier
    COUNT(CASE WHEN tier_flag = '500' THEN txn_id END) AS txns_500_tier,
    COUNT(CASE WHEN tier_flag = '300' THEN txn_id END) AS txns_300_tier,
    COUNT(CASE WHEN SNDPRINCIPAL_AMOUNT >= 300 THEN txn_id END) AS txns_300_plus,
    COUNT(txn_id) AS total_qualifying_txns,
    
    -- Determine qualification tier
    CASE
        WHEN COUNT(CASE WHEN tier_flag = '500' THEN txn_id END) >= 2 THEN 'TIER_500'
        WHEN COUNT(CASE WHEN SNDPRINCIPAL_AMOUNT >= 300 THEN txn_id END) >= 2 THEN 'TIER_300'
        ELSE 'NOT_QUALIFIED'
    END AS qualification_tier,
    
    -- Channel breakdown
    COUNT(CASE WHEN UPPER(PRICING_CHANNEL) IN ('APP', 'WEB') THEN txn_id END) AS digital_txns,
    COUNT(CASE WHEN UPPER(PRICING_CHANNEL) IN ('POS', 'TMT') THEN txn_id END) AS retail_txns
 
FROM CAR_855_AUNZSG_BASE_TXNS
GROUP BY
    ALL;

 --Final Pull
 SELECT 
        '@' || sndcustomer_key as GID,
       sndcountry_code,
       rcvcountry_code,
       qualification_tier
FROM CAR_855_AUNZSG_CUSTOMER_QUALIFICATION
WHERE qualification_tier IN ('TIER_500', 'TIER_300');
