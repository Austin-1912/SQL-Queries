WITH car_688_campaigns_only AS (
    SELECT CUSTOMER_KEY, CAMPAIGN_NAME
    FROM AK_CAMPAIGN_WISE_BIRD_COMMUNICATIONS_EMAIL_FINAL
    WHERE UPPER(CAMPAIGN_NAME) IN (
        UPPER('EMAIL_Awareness_APN_CTAOmnichannel_EUtoIndiaDiwaliGeneric_Wave1EUGenericENControl'),
        UPPER('EMAIL_Awareness_APN_CTAOmnichannel_EUtoIndiaDiwaliGeneric_Wave1EUGenericENTest')
    )
    
    UNION ALL
    
    SELECT CUSTOMER_KEY, CAMPAIGN_NAME
    FROM SJ_BI_CAMPAIGN_WISE_EMAIL_COMMUNICATIONS_2_V2_MYWU_UPDATE_CUSTOMER_LEVEL
    WHERE UPPER(CAMPAIGN_NAME) IN (
        UPPER('SMS_Awareness_APN_CTAOmnichannel_EUtoIndiaDiwaliGeneric_Wave1EUGenericControl'),
        UPPER('SMS_Awareness_APN_CTAOmnichannel_EUtoIndiaDiwaliGeneric_Wave1EUGenericTest')
    )
    
    UNION ALL
    
    SELECT CUSTOMER_KEY, CAMPAIGN_NAME
    FROM SJ_BI_CAMPAIGN_WISE_EMAIL_COMMUNICATIONS_2_V2_MYWU_UPDATE_CUSTOMER_LEVEL
    WHERE UPPER(CAMPAIGN_NAME) ILIKE UPPER('APP_Awareness_APN_CTADigital_EUtoIndiaDiwaliGeneric_Wave1EUGeneric-variant1%')
       OR UPPER(CAMPAIGN_NAME) ILIKE UPPER('APP_Awareness_APN_CTADigital_EUtoIndiaDiwaliGeneric_Wave1EUGeneric-control%')
)


-- EMAIL TEST mismatches
SELECT 'EMAIL_TEST' AS segment,
       '@' || SUBSTR(a.SNDCUSTOMER_KEY, 2, 19) AS mismatched_customer_key,
       c.CAMPAIGN_NAME AS received_campaign
FROM WUDNA.CEX_SANDBOX.EMAIL_MARKETABLE_TEST_CAR_688 a
LEFT JOIN car_688_campaigns_only c
    ON SUBSTR(a.SNDCUSTOMER_KEY, 2, 19) = c.CUSTOMER_KEY
WHERE UPPER(c.CAMPAIGN_NAME) IS DISTINCT FROM UPPER('EMAIL_Awareness_APN_CTAOmnichannel_EUtoIndiaDiwaliGeneric_Wave1EUGenericENTest')

UNION ALL

-- EMAIL CONTROL mismatches
SELECT 'EMAIL_CONTROL',
       '@' || SUBSTR(a.SNDCUSTOMER_KEY, 2, 19),
       c.CAMPAIGN_NAME
FROM WUDNA.CEX_SANDBOX.EMAIL_MARKETABLE_CONTROL_CAR_688 a
LEFT JOIN car_688_campaigns_only c
    ON SUBSTR(a.SNDCUSTOMER_KEY, 2, 19) = c.CUSTOMER_KEY
WHERE UPPER(c.CAMPAIGN_NAME) IS DISTINCT FROM UPPER('EMAIL_Awareness_APN_CTAOmnichannel_EUtoIndiaDiwaliGeneric_Wave1EUGenericENControl')

UNION ALL

-- SMS TEST mismatches
SELECT 'SMS_TEST',
       '@' || SUBSTR(a.SNDCUSTOMER_KEY, 2, 19),
       c.CAMPAIGN_NAME
FROM WUDNA.CEX_SANDBOX.SMS_MARKETABLE_TEST_CAR_688 a
LEFT JOIN car_688_campaigns_only c
    ON SUBSTR(a.SNDCUSTOMER_KEY, 2, 19) = c.CUSTOMER_KEY
WHERE UPPER(c.CAMPAIGN_NAME) IS DISTINCT FROM UPPER('SMS_Awareness_APN_CTAOmnichannel_EUtoIndiaDiwaliGeneric_Wave1EUGenericTest')

UNION ALL

-- SMS CONTROL mismatches
SELECT 'SMS_CONTROL',
       '@' || SUBSTR(a.SNDCUSTOMER_KEY, 2, 19),
       c.CAMPAIGN_NAME
FROM WUDNA.CEX_SANDBOX.SMS_MARKETABLE_CONTROL_CAR_688 a
LEFT JOIN car_688_campaigns_only c
    ON SUBSTR(a.SNDCUSTOMER_KEY, 2, 19) = c.CUSTOMER_KEY
WHERE UPPER(c.CAMPAIGN_NAME) IS DISTINCT FROM UPPER('SMS_Awareness_APN_CTAOmnichannel_EUtoIndiaDiwaliGeneric_Wave1EUGenericControl')

UNION ALL

-- APP TEST mismatches
SELECT 'APP_TEST',
       '@' || SUBSTR(a.SNDCUSTOMER_KEY, 2, 19),
       c.CAMPAIGN_NAME
FROM WUDNA.CEX_SANDBOX.APP_MARKETABLE_TEST_CAR_688 a
LEFT JOIN car_688_campaigns_only c
    ON SUBSTR(a.SNDCUSTOMER_KEY, 2, 19) = c.CUSTOMER_KEY
WHERE c.CAMPAIGN_NAME IS NULL
   OR NOT ILIKE(c.CAMPAIGN_NAME, 'APP_Awareness_APN_CTADigital_EUtoIndiaDiwaliGeneric_Wave1EUGeneric-variant1%')

UNION ALL

-- APP CONTROL mismatches
SELECT 'APP_CONTROL',
       '@' || SUBSTR(a.SNDCUSTOMER_KEY, 2, 19),
       c.CAMPAIGN_NAME
FROM WUDNA.CEX_SANDBOX.APP_MARKETABLE_CONTROL_CAR_688 a
LEFT JOIN car_688_campaigns_only c
    ON SUBSTR(a.SNDCUSTOMER_KEY, 2, 19) = c.CUSTOMER_KEY
WHERE c.CAMPAIGN_NAME IS NULL
   OR NOT ILIKE(c.CAMPAIGN_NAME, 'APP_Awareness_APN_CTADigital_EUtoIndiaDiwaliGeneric_Wave1EUGeneric-control%');
