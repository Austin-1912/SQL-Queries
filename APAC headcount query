
SELECT date_trunc('DAY', A.release_2_vendor_date) FROM "WUDNA"."SUMMARY_GEN"."WUDNA_SOLICITATION_HISTORY_VW" A;

//==================================================================================================================
//==================================================================================================================


-- SJ_BI_CAMPAIGN_WISE_EMAIL_COMMUNICATIONS_2_V2_MYWU_UPDATE_CUSTOMER_LEVEL
-- AK_BIRD_CAMPAIGN_COMMUNICATION_OMNITURE_CUSTOMER_LEVEL_BIRD_SFMC_UNION
-- SJ_bi_campaign_wise_email_communications_2_v2_mywu_UPDATE





//==================================================================================================================
//==================================================================================================================


create or replace procedure BIRD_CAMPAIGN_TRACKER_WEEKLY_7_DAYS()
    returns string
    language javascript
    strict
    execute as caller
    as
  $$
	

    
var sql_command_1 = 
    `INSERT INTO BIRD_CAMPAIGN_LOG
    VALUES ('Stored Prac Started',CURRENT_TIMESTAMP,0,0,0,0)`;	




//==========BACKUP TABLES===============================================================================================================


var sql_command_1_1 = 
`CREATE OR REPLACE TABLE SJ_BI_CAMPAIGN_WISE_EMAIL_COMMUNICATIONS_2_V2_MYWU_UPDATE_CUSTOMER_LEVEL_BACKUP_2025 AS
SELECT * FROM SJ_BI_CAMPAIGN_WISE_EMAIL_COMMUNICATIONS_2_V2_MYWU_UPDATE_CUSTOMER_LEVEL`;


var sql_command_1_2 = 
`CREATE OR REPLACE TABLE AK_BIRD_CAMPAIGN_COMMUNICATION_OMNITURE_CUSTOMER_LEVEL_BIRD_SFMC_UNION_BACKUP_2025 AS
SELECT * FROM AK_BIRD_CAMPAIGN_COMMUNICATION_OMNITURE_CUSTOMER_LEVEL_BIRD_SFMC_UNION`;


var sql_command_1_3 = 
`CREATE OR REPLACE TABLE SJ_bi_campaign_wise_email_communications_2_v2_mywu_UPDATE_BACKUP_2025 AS
SELECT * FROM SJ_bi_campaign_wise_email_communications_2_v2_mywu_UPDATE`;



//=======================================================================================================================================
//===============================(BIRD SOLICITATION BASE TABLE)==========================================================================
//=======================================================================================================================================



var sql_command_2 = 
`CREATE OR REPLACE TABLE AK_BIRD_SOLICITATION_HISTORY_VW AS
   with BI_SAMEDAY_CAMPAIGN_1 as
    (
	select
	a.*,
	date_trunc('DAY',release_2_vendor_date) as event_captured_day,
	lag(date_trunc('DAY',release_2_vendor_date)) over ( partition by customer_key,/*pir_nbr,*/campaign_desc order by date_trunc('DAY',release_2_vendor_date)) as prev_event_captured_dt
	from(
		select 
			customer_key,customer_id,card_number,country,/*pir_nbr,*/release_2_vendor_date,activity_code,
			UPPER( case when ((nullif(trim(upper(to_varchar(campaign_desc))),'') is NULL) or 
					   (nullif(trim(upper(to_varchar(campaign_desc))),'<NULL>') is NULL)) then 'UNKNOWN'
						else trim(upper(to_varchar(campaign_desc))) end) campaign_desc,
            row_number()over (partition by customer_key,/*pir_nbr,*/campaign_desc,date_trunc('DAY',release_2_vendor_date) order by release_2_vendor_date ) as top
			,journey_name
          FROM 
          (SELECT 
            customer_key,
            CUSTOMER_ID,
            CARD_NUMBER,
            COUNTRY,
            --PIR_NBR,
            RELEASE_2_VENDOR_DATE,
            ACTIVITY_CODE,
            CAMPAIGN_DESC,
            DROP_START_DATE,
            DROP_END_DATE,
            PROMOTION_CODE,
            PROMOTION_DESC,
            SEQ_NUMBER,
            PRIVACY_NOTICE_CODE,
            DYNAMIC_CONTENT_SIGNATURE_ID,
            JOURNEY_NAME
        FROM "WUDNA"."SUMMARY_GEN"."WUDNA_SOLICITATION_HISTORY_VW" B
        --Left Join "WUDNA"."SUMMARY_GEN".WUDNA_ACCOUNT_MASTER_VW A on B.CUSTOMER_KEY = A.CUSTOMER_UMN
        WHERE  B.customer_key IS NOT NULL AND
        YEAR(RELEASE_2_VENDOR_DATE) >= 2024
        )
    WHERE Len(customer_key) in (9,15,19) AND year(RELEASE_2_VENDOR_dATE) >= 2024
	and substr(activity_code,1,1)='S' and substr(activity_code,3,1) IN ('E','S')
	)a
	where top=1
    )
    select 
    a.*,
    datediff('DAY',prev_event_captured_dt,event_captured_day) as days_between_communication 
    from BI_SAMEDAY_CAMPAIGN_1 a 
    where(days_between_communication is null or days_between_communication > 6)`;




var sql_command_3 =
`INSERT INTO BIRD_CAMPAIGN_LOG
Select 
    'AK_BIRD_SOLICITATION_HISTORY_VW',
    CURRENT_TIMESTAMP,
    count(1), 
    Count(distinct CAMPAIGN_DESC), 
    0,
    0 
from AK_BIRD_SOLICITATION_HISTORY_VW`;



//=======================================================================================================================================
//===============================(CUSTOMER KEY WITH MEMBERSHIP DATE BASE TABLE)===========================================================
//=======================================================================================================================================



var sql_command_4 =
`create or replace table SJ_CS_CUST_MEMBERSHIP_DATE as
WITH ENROLLMENT_DATE_CTE AS
(select A.*,
FROM
   (
   SELECT distinct A.CUSTOMER_KEY,
 
case when (a.APP_REGISTRATION_DATE is not null or A.WEB_REGISTRATION_DATE is not null or A.WUPLUS_REGISTRATION_DATE is not null or a.WALLET_REGISTRATION_DATE is not null or a.CRYPTO_REGISTRATION_DATE is not null or a.ONEAPP_REGISTRATION_DATE is not null  or a.CORRECTION_PAY_REGISTRATION_DATE is not null or a.PREPAID_REGISTRATION_DATE is not null) then 'DIGITAL'
 
WHEN a.POS_REGISTRATION_DATE is not null THEN 'RETAIL'
 
ELSE 'OTHER' END AS ENROLLMENT_CHANNEL,
 
to_date(MYWU_MEMBER_UPDATE_DATE) as ENROLLMENT_DATE,
 
row_number() OVER (Partition by A.CUSTOMER_KEY ORDER BY MYWU_MEMBER_UPDATE_DATE DESC) AS RANK
 
FROM WUDNA.SUMMARY_GEN.WUDNA_LOYALTY_ENROLLMENT_VW A
 
inner join WUDNA.SUMMARY_GEN.WUDNA_CUSTOMER_MASTER_VW C on A.CUSTOMER_KEY = C.CUSTOMER_KEY
 
WHERE A.enrollment_flag ='Y' AND A.LOYALTY_MEMBER_FLAG ='Y'
    )A
    where rank =1)

select customer_key,ENROLLMENT_DATE AS MEMBERSHIP_DATE from ENROLLMENT_DATE_CTE`;


//------------------------------------------------------------


var sql_command_5 = 
	`INSERT INTO BIRD_CAMPAIGN_LOG
Select 
    'SJ_CS_CUST_MEMBERSHIP_DATE',
    CURRENT_TIMESTAMP,count(1) , 
    0, 
    0,
    0 
from SJ_CS_CUST_MEMBERSHIP_DATE`;



//=======================================================================================================================================
//===============================(EMAIL BASE TABLE WITH ALL ENGAGEMENT COUNTS)===========================================================
//=======================================================================================================================================


// SELECT COUNT(*) FROM AK_BIRD_WU_MARKETING_EMAIL_SENT_BASE;
// --341,539,266

// SELECT COUNT(*) FROM WUDNA.SUMMARY_GEN.BIRD_WU_MARKETING_EMAIL_SENT_VW;
// --342,115,587



//------FOR EMAIL---------------------------------------

var sql_command_6 =
`CREATE OR REPLACE TABLE AK_BIRD_WU_MARKETING_EMAIL_SENT_BASE AS 
WITH CTE_1 AS (
SELECT
    *,
    lag(EMAILSENTDATE) over ( partition by customer_key,/*pir_nbr,*/EMAILNAME order by EMAILSENTDATE) as prev_event_captured_dt
FROM 
    WUDNA.SUMMARY_GEN.BIRD_WU_MARKETING_EMAIL_SENT_VW
),

CTE_2 AS (
SELECT 
    *,
    datediff('DAY',prev_event_captured_dt,EMAILSENTDATE) as days_between_communication
FROM 
    CTE_1
)

SELECT * FROM CTE_2
WHERE (days_between_communication is null or days_between_communication > 6)
    `;



var sql_command_7 = 
	`INSERT INTO BIRD_CAMPAIGN_LOG
Select 
    'AK_BIRD_WU_MARKETING_EMAIL_SENT_BASE',
    CURRENT_TIMESTAMP,count(1) , 
    0, 
    0,
    0 
from AK_BIRD_WU_MARKETING_EMAIL_SENT_BASE`;




//SELECT COUNT(*) FROM AK_BIRD_EVENT_LEVEL_DATA;
//1,456,973,009


var sql_command_8 =
`CREATE OR REPLACE TABLE AK_BIRD_EVENT_LEVEL_DATA AS 

WITH AK_BIRD_EMAIL_CAMPAIGN_V00 AS 
(SELECT
    A.*
FROM
    AK_BIRD_SOLICITATION_HISTORY_VW A
WHERE SUBSTR(ACTIVITY_CODE,3,1) = 'E'
),

AK_BIRD_EMAIL_CAMPAIGN_V01 as
(
SELECT 

NVL(A.ACTIVITY_CODE,'SAEAA') AS ACTIVITY_CODE,
B.customer_key,
upper(B.emailname) emailname,
date_trunc('DAY', B.emailsentdate) as emailsentdate,
   A.EVENT_CAPTURED_DAY,
   A.PREV_EVENT_CAPTURED_DT,
   b.DAYS_BETWEEN_COMMUNICATION,

ACCOUNTID,
OYBACCOUNTID,
JOBID, 
LISTID,
BATCHID,
SUBSCRIBERID, 
 
 
DOMAIN, 
FROMNAME, 
FROMEMAIL,
EMAILSUBJECT,
SENDCLASSIFICATIONTYPE, 
SENDCLASSIFICATION, 
B.PRFRD_LANGUAGE_CODE, 
B.COUNTRY_CODE, 
JOURNEY_NAME,


FROM AK_BIRD_WU_MARKETING_EMAIL_SENT_BASE B 


LEFT OUTER JOIN 

(
SELECT b.ACTIVITY_CODE 
	,B.customer_key
	,upper(B.CAMPAIGN_DESC) campaign_desc
	,date_trunc('DAY', B.RELEASE_2_VENDOR_DATE) as RELEASE_2_VENDOR_DATE
	,country AS country_code
    ,b.EVENT_CAPTURED_DAY
    ,b.PREV_EVENT_CAPTURED_DT
    ,DAYS_BETWEEN_COMMUNICATION
    
FROM AK_BIRD_EMAIL_CAMPAIGN_V00 b
)a

ON 
B.customer_key = A.customer_key AND 
date_trunc('DAY', DATE(B.emailsentdate)) = date_trunc('DAY', A.release_2_vendor_date) AND 
trim(upper(B.emailname)) = upper(A.campaign_desc)
WHERE 
    B.CUSTOMER_KEY IS NOT NULL

),


BI_sfmc_EMAIL_CAMPAIGN_v3 as
(select distinct *,date_trunc('DAY',opendate) as event_captured_day
from summary_gen.BIRD_WU_MARKETING_EMAIL_OPEN_VW 
     where len(CUSTOMER_KEY) in (9,15,19) and 
     year(opendate) >= 2024),
     
BI_sfmc_EMAIL_CAMPAIGN_v4 as
(select distinct *,date_trunc('DAY',clickdate) as event_captured_day
from "WUDNA"."SUMMARY_GEN"."BIRD_WU_MARKETING_EMAIL_CLICK_VW" 
     where len(CUSTOMER_KEY) in (9,15,19) and 
     year(clickdate) >= 2024 AND 
     UPPER(URL) NOT LIKE '%UNSUB%'),
BI_sfmc_EMAIL_CAMPAIGN_v5 as
(select distinct *,date_trunc('DAY',COMPLAINTDATE) as event_captured_day
from "WUDNA"."SUMMARY_GEN"."BIRD_WU_MARKETING_EMAIL_COMPLAINT_VW" 
     where len(CUSTOMER_KEY) in (9,15,19) and 
     year(complaintdate) >= 2024),
BI_sfmc_EMAIL_CAMPAIGN_v7 as
(select distinct *,date_trunc('DAY',bouncedate) as event_captured_day from "WUDNA"."SUMMARY_GEN"."BIRD_WU_MARKETING_EMAIL_BOUNCE_VW" 
     where len(CUSTOMER_KEY) in (9,15,19) and 
     year(bouncedate) >= 2024),
BI_sfmc_OPT_OUT as
(select distinct *,date_trunc('DAY',email_timestamp) as event_captured_day 
from  "WUDNA"."SUMMARY_GEN"."BIRD_WU_MARKETING_EMAIL_OPT_OUT_VW"
     where Len(CUSTOMER_KEY) in (9,15,19) and 
     year(EMAIL_TIMESTAMP) >= 2024)
select 
activity_code, 
a.country_code as country,
date_trunc('DAY',a.emailsentdate) as emailsentdate,
a.EVENT_CAPTURED_DAY,
   
a.prev_event_captured_dt,
a.days_between_communication,
a.customer_key as customer_key,
date_trunc('MONTH',a.EVENT_CAPTURED_DAY) as CAMPAIGN_MONTH,
a.emailname as emailname,
'NA' as MARKETING_STRATEGY, 
'NA' as MARKETING_PROGRAM, 

case when c.EVENT_CAPTURED_DAY is not null and c.EVENT_CAPTURED_DAY >= a.EVENT_CAPTURED_DAY then 'Y' else 'N' end open__flag,

case when  c.EVENT_CAPTURED_DAY >= a.EVENT_CAPTURED_DAY then c.EVENT_CAPTURED_DAY end  as opendate,

//case when d.EVENT_CAPTURED_DAY is not null and c.EVENT_CAPTURED_DAY >= a.EVENT_CAPTURED_DAY and d.EVENT_CAPTURED_DAY >= c.EVENT_CAPTURED_DAY then 'Y' else 'N' end click__flag,
case when d.EVENT_CAPTURED_DAY is not null and d.EVENT_CAPTURED_DAY >= a.EVENT_CAPTURED_DAY then 'Y' else 'N' end click__flag,  //7_DAYS_ATTRIBUTION_CHANGE_FROM_30_DAYS

d.EVENT_CAPTURED_DAy as clickdate,

//case when c.EVENT_CAPTURED_DAY >= a.EVENT_CAPTURED_DAY and d.EVENT_CAPTURED_DAY >= c.EVENT_CAPTURED_DAY then d.EVENT_CAPTURED_DAY end as click__date, 
case when d.EVENT_CAPTURED_DAY >= a.EVENT_CAPTURED_DAY then d.EVENT_CAPTURED_DAY end as click__date,    //7_DAYS_ATTRIBUTION_CHANGE_FROM_30_DAYS

//case when c.EVENT_CAPTURED_DAY >= a.EVENT_CAPTURED_DAY and d.EVENT_CAPTURED_DAY >= c.EVENT_CAPTURED_DAY then d.url end offer_url,
case when d.EVENT_CAPTURED_DAY >= a.EVENT_CAPTURED_DAY then d.url end offer_url,    //7_DAYS_ATTRIBUTION_CHANGE_FROM_30_DAYS

e.EVENT_CAPTURED_DAY as spam_date,
f.EVENT_CAPTURED_DAY as bounce_date,
g.EVENT_CAPTURED_DAY as optout_date,
case when upper(nvl(a.emailname,'UNKNOWN'))  like '%RESEND%' or 
		upper(nvl(a.emailname,'UNKNOWN'))  like '%RE SEND%' or 
		upper(nvl(a.emailname,'UNKNOWN'))  like '%RE_SEND%' or 
		upper(nvl(a.emailname,'UNKNOWN'))  like '%RE-SEND%'
		then 'Y' else 'N' end as RESEND_FLAG,
        
case when open__flag = 'Y' and c.EVENT_CAPTURED_DAY >= a.EVENT_CAPTURED_DAY 
and (extract(epoch from c.EVENT_CAPTURED_DAY)-extract(epoch from a.EVENT_CAPTURED_DAY)) <= 2592000 then 'Y' else 'N' end as  Email_Opened_in_30_Day,

//case when open__flag = 'Y' and click__flag='Y' and c.EVENT_CAPTURED_DAY >= a.EVENT_CAPTURED_DAY and d.EVENT_CAPTURED_DAY >= c.EVENT_CAPTURED_DAY
//and (extract(epoch from d.EVENT_CAPTURED_DAY)-extract(epoch from c.EVENT_CAPTURED_DAY)) <= 2592000 then 'Y' else 'N' end as  Email_clicked_in_30_Day,
case when click__flag='Y' and d.EVENT_CAPTURED_DAY >= a.EVENT_CAPTURED_DAY
and (extract(epoch from d.EVENT_CAPTURED_DAY)-extract(epoch from a.EVENT_CAPTURED_DAY)) <= 2592000 then 'Y' else 'N' end as  Email_clicked_in_30_Day,   //7_DAYS_ATTRIBUTION_CHANGE_FROM_30_DAYS

case when open__flag = 'Y' and c.EVENT_CAPTURED_DAY >= a.EVENT_CAPTURED_DAY 
and (extract(epoch from c.EVENT_CAPTURED_DAY)-extract(epoch from a.EVENT_CAPTURED_DAY)) <= 604800 then 'Y' else 'N' end as  Email_Opened_in_7_Day,

//case when open__flag = 'Y' and click__flag='Y' and c.EVENT_CAPTURED_DAY >= a.EVENT_CAPTURED_DAY and d.EVENT_CAPTURED_DAY >= c.EVENT_CAPTURED_DAY
//and (extract(epoch from d.EVENT_CAPTURED_DAY)-extract(epoch from c.EVENT_CAPTURED_DAY)) <= 604800 then 'Y' else 'N' end as  Email_clicked_in_7_Day,
case when click__flag='Y' and d.EVENT_CAPTURED_DAY >= a.EVENT_CAPTURED_DAY
and (extract(epoch from d.EVENT_CAPTURED_DAY)-extract(epoch from a.EVENT_CAPTURED_DAY)) <= 604800 then 'Y' else 'N' end as  Email_clicked_in_7_Day  //7_DAYS_ATTRIBUTION_CHANGE_FROM_30_DAYS

from AK_BIRD_EMAIL_CAMPAIGN_V01 as a
left join BI_sfmc_EMAIL_CAMPAIGN_v3 as c 
	on a.customer_key = c.customer_key and trim(upper(a.emailname)) = trim(upper(c.emailname))
left join BI_sfmc_EMAIL_CAMPAIGN_v4 as d 
	on a.customer_key = d.customer_key and trim(upper(a.emailname)) = trim(upper(d.emailname))
left join BI_sfmc_EMAIL_CAMPAIGN_v5 as e 
	on a.customer_key = e.customer_key and trim(upper(a.emailname)) = trim(upper(e.emailname))
left join BI_sfmc_EMAIL_CAMPAIGN_v7 as f 
	on a.customer_key = f.customer_key and trim(upper(a.emailname)) = trim(upper(f.emailname))
left join BI_sfmc_OPT_OUT as g 
	on a.customer_key = g.CUSTOMER_KEY
	AND trim(upper(a.emailname)) = trim(upper(g.emailname))
//WHERE
    //UPPER(D.URL) NOT LIKE '%UNSUBCRIBE%'
    `;


//-------------------------------------------------------------------


var sql_command_9 = 
	`INSERT INTO BIRD_CAMPAIGN_LOG
Select 
    'AK_BIRD_EVENT_LEVEL_DATA',
    CURRENT_TIMESTAMP,count(1), 
    Count(distinct EMAILNAME), 
    sum(Case When EMAIL_OPENED_IN_30_DAY = 'Y' THEN 1 ELSE 0 END),
    sum(Case When EMAIL_CLICKED_IN_30_DAY = 'Y' THEN 1 ELSE 0 END) 
from AK_BIRD_EVENT_LEVEL_DATA`;
    




//=======================================================================================================================================
//===============================(EMAIL ENGAGEMENT TABLE WITH OPEN, CLICKS FLAG COUNT)===================================================
//=======================================================================================================================================


var sql_command_10 =
`create or replace TABLE AK_BIRD_EMAIL_CAMPAIGN_V02 as
with OMNITURE_CLICK_FIX_2 AS 
(
select 
*,
lead(opendate) over(partition by customer_key,emailname,emailsentdate order by opendate) as next_open_date
from 
(select distinct customer_key,emailname,emailsentdate,opendate from AK_BIRD_EVENT_LEVEL_DATA) a 
order by customer_key,emailname,EMAILSENTDATE ,opendate,next_open_date),

OMNITURE_CLICK_FIX_3 AS ( 
select 
*,
lead(clickdate) over(partition by customer_key,emailname,emailsentdate,opendate order by clickdate) as next_click_date 
from 
(select distinct customer_key,emailname,emailsentdate,opendate,clickdate from AK_BIRD_EVENT_LEVEL_DATA ) a 
order by customer_key,emailname,emailsentdate,opendate,clickdate),

OMNITURE_CLICK_FIX_4 AS (
select a.*,
case when  a.OPENdATE >= a.EMAILSENTDATE
AND (a.CLICKDATE > a.OPENDATE or next_open_date is not null) 
and (next_open_date > a.clickdate or (next_open_date<next_click_date or next_click_date is null )or next_open_date is null ) 
and (next_click_date>a.emailsentdate or next_click_date is null)
and a.clickdate is not null then 'Y' ELSE 'N' end  as CLICKFLAG,
a.OPENDATE AS OPEN_DATE,
a.CLICKDATE AS CLICK_DATE,
case when OPEN_DATE is not null and OPEN_DATE >= a.EVENT_CAPTURED_DAY then 'Y' else 'N' end open_flag,
case when OPEN_DATE >= a.EVENT_CAPTURED_DAY then OPEN_DATE end  as open_date_1,

-- case when a.CLICKDATE is not null and OPEN_DATE >= a.EVENT_CAPTURED_DAY and CLICK_DATE >= OPEN_DATE      //7_DAYS_ATTRIBUTION_CHANGE_FROM_30_DAYS
-- 		then 'Y' else 'N' end click_flag,
case when a.CLICKDATE is not null and CLICK_DATE >= a.EVENT_CAPTURED_DAY
		then 'Y' else 'N' end click_flag,

//case when OPEN_DATE >= a.EVENT_CAPTURED_DAY and CLICK_DATE >= OPEN_DATE then CLICK_DATE end as click_date_1,      //7_DAYS_ATTRIBUTION_CHANGE_FROM_30_DAYS
case when CLICK_DATE >= a.EVENT_CAPTURED_DAY and CLICK_DATE >= OPEN_DATE then CLICK_DATE end as click_date_1

from AK_BIRD_EVENT_LEVEL_DATA a
left join OMNITURE_CLICK_FIX_2 b on a.customer_key=b.customer_key and a.opendate=b.opendate AND A.EMAILNAME = B.EMAILNAME   
left join OMNITURE_CLICK_FIX_3 c on a.customer_key=c.customer_key and a.opendate=c.opendate and a.clickdate=c.clickdate AND A.EMAILNAME = C.EMAILNAME)
SELECT * FROM OMNITURE_CLICK_FIX_4`;


//--------------------------------------------------------------------


var sql_command_11 =
	`INSERT INTO BIRD_CAMPAIGN_LOG
Select 
    'AK_BIRD_EMAIL_CAMPAIGN_V02',
    CURRENT_TIMESTAMP,count(1), 
    Count(distinct EMAILNAME), 
    sum(CASE WHEN EMAIL_OPENED_IN_30_DAY = 'Y' THEN 1 ELSE 0 END),
    sum(CASE WHEN EMAIL_CLICKED_IN_30_DAY = 'Y' THEN 1 ELSE 0 END) 
from AK_BIRD_EMAIL_CAMPAIGN_V02`;





//=======================================================================================================================================
//===============================(EMAIL FINAL ENGAGEMENT TABLE AT CUSTOMER LEVEL)========================================================
//=======================================================================================================================================



// SELECT SUM(Total_Emails_Sent) FROM AK_campaign_wise_BIRD_communications_EMAIL_FINAL;
//352,661,187
//3,226,400


var sql_command_12 =
`create or replace table AK_campaign_wise_BIRD_communications_EMAIL_FINAL as
select 
activity_code, 
f.country,
date(f.emailsentdate) as event_captured_dt,

f.customer_key,
upper(f.emailname) as campaign_name,
f.marketing_strategy,
resend_flag,
count( distinct customer_key) 
    as Total_Emails_Sent,
count( distinct case when bounce_date is not null then customer_key end ) 
    as Emails_Un_Delivered,
count( distinct case when email_opened_in_30_day='Y' then customer_key end ) 
    as Emails_opened_atleast_once_within_30_days_of_communication,
count( distinct case when email_clicked_in_30_day='Y' then customer_key end ) 
    as Emails_with_atleast_one_link_click_within_30_days_of_communication,
 
count( distinct case when email_opened_in_7_day='Y' then customer_key end ) 
    as Emails_opened_atleast_once_within_7_days_of_communication,
count( distinct case when email_clicked_in_7_day='Y' then customer_key end ) 
    as Emails_with_atleast_one_link_click_within_7_days_of_communication,
count(distinct f.customer_key ) as  Customers_Contacted_atleast_once_by_Email,
count(distinct case when bounce_date is not null then f.customer_key end ) as Customers_bounced_atleast_one_Email,
count(distinct case when email_opened_in_30_day='Y' then f.customer_key end ) as Customers_Opening_atleast_one_Mail_within_30_days_of_communication,
count(distinct case when email_clicked_in_30_day='Y' then f.customer_key end ) as Customers_clicking_atleast_one_Mail_within_30_days_of_communication,
count(distinct case when spam_date is not null then f.customer_key end ) as Customers_complaining_about_spam,
count(distinct case when optout_date is not null then f.customer_key end ) as Customers_opting_out_of_email_marketing,

count(distinct case when spam_date is not null or optout_date is not null 
      then customer_key||event_captured_dt||opendate||click__date end ) as bad_clicks,
count(distinct customer_key||event_captured_dt||opendate||click__date  ) as unique_clicks,
MIN(CASE WHEN CLICK_DATE >= emailsentdate THEN CLICK_DATE END) AS CLICK_DATE    //ADDED_CLICK_DATE

from 
 AK_BIRD_EMAIL_CAMPAIGN_V02  f 
group by 1,2,3,4,5,6,7`;


//----------------------------------------------------------------------

var sql_command_13 = 
	`INSERT INTO BIRD_CAMPAIGN_LOG
Select 
    'AK_campaign_wise_BIRD_communications_EMAIL_FINAL',
    CURRENT_TIMESTAMP,
    count(1), 
    Count(distinct CAMPAIGN_NAME), 
    sum(EMAILS_OPENED_ATLEAST_ONCE_WITHIN_30_DAYS_OF_COMMUNICATION),
    sum(EMAILS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_30_DAYS_OF_COMMUNICATION) 
from AK_campaign_wise_BIRD_communications_EMAIL_FINAL`;



//=======================================================================================================================================
//===============================(EMAIL AND OMNITURE WITH ENGAGEMENT TABLE AT CUSTOMER LEVEL)============================================
//=======================================================================================================================================


/*
var sql_command_14 =
`create or replace table AK_BIRD_CAMPAIGN_OMNITURE_EMAIL_CLICK_DATA as
with BI_click_data_set  as 
(select  distinct emailname campaign_name,customer_key,event_captured_day,emailsentdate event_captured_dt,open_date_1 open_date,
open_flag,click_date_1 click_date,click_flag,email_clicked_in_30_day,email_opened_in_30_day
from AK_BIRD_EMAIL_CAMPAIGN_V02 where click_flag='Y'),

BI_click_data_set_1  as 
(
select 
a.*,b.*
from 
BI_click_data_set a inner join (Select * from AK_BIRD_CAMPAIGN_OMNITURE_BASE_HIT_FINAL where POST_EVAR85 <>'') b 
on UPPER(a.campaign_name)=upper(b.Campaign__Name) and a.customer_key=b.Customer__Key 
),

bi_click_data_set_2  as 
(
select 
a.*,
datediff('DAY',event_captured_day,substr(date_time,1,10)) days_between_email_rcvd_date_to_omniture_click,
datediff('DAY',open_date,substr(date_time,1,10)) days_between_open_date_to_omniture_click,
datediff('DAY',click_date,substr(date_time,1,10)) days_between_resp_click_date_to_omniture_click_date
from bi_click_data_set_1 a),
next_open_dates as 
(select 
*,
lead(open_date) over( partition by customer_key,campaign_name,event_captured_dt order by open_date) as next_open_date
from 
(select distinct customer_key,campaign_name,event_captured_dt,open_date from bi_click_data_set_2 ) a 
order by customer_key,campaign_name,event_captured_dt,open_date,next_open_date),
next_click_dates as 
(select 
*,
lead(click_date) over( partition by customer_key,campaign_name,event_captured_dt,open_date    order by click_date) as next_click_date 
from 
(select distinct customer_key,campaign_name,event_captured_dt,open_date,click_date from bi_click_data_set_2 ) a 
order by customer_key,campaign_name,event_captured_dt,open_date,click_date),

bi_click_data_set_2_V as 
(select 
a.*,
b.next_open_date ,
c.next_click_date
from bi_click_data_set_2 a 
left outer join next_open_dates b on a.customer_key=b.customer_key and a.campaign_name=b.campaign_name 
    and a.event_captured_dt=b.event_captured_dt and a.open_date=b.open_date 
left outer join next_click_dates c on a.customer_key=c.customer_key and a.campaign_name=c.campaign_name 
    and a.event_captured_dt=c.event_captured_dt and a.open_date=c.open_date and a.click_date=c.click_date),
    
BI_click_data_set_2_v2_oct as 
(select a.* from (
select a.*,row_number ( ) over ( partition by Customer_Key,Campaign_Name,date_time order by click_date desc) as top from (
select 
* 
from BI_click_data_set_2_v a 
where 
click_date >= open_date  and (next_open_date > click_date   or next_open_date is null) 
and date_time >= click_date and (next_click_date > date_time   or next_click_date is null  ) ) a  ) a where top=1)
select * from BI_click_data_set_2_v2_oct`;


//---------------------------------------------------------------------


var sql_command_15 = 
	`INSERT INTO BIRD_CAMPAIGN_LOG
Select 
    'AK_BIRD_CAMPAIGN_OMNITURE_EMAIL_CLICK_DATA',
    CURRENT_TIMESTAMP,
    count(1), 
    Count(distinct CAMPAIGN_NAME), 
    sum(CASE WHEN EMAIL_OPENED_IN_30_DAY = 'Y' THEN 1 ELSE 0 END),
    sum(CASE WHEN EMAIL_CLICKED_IN_30_DAY = 'Y' THEN 1 ELSE 0 END) 
from AK_BIRD_CAMPAIGN_OMNITURE_EMAIL_CLICK_DATA`;





//=======================================================================================================================================
//===============================(EMAIL AND OMNITURE WITH ENGAGEMENT 2ND TABLE AT CUSTOMER LEVEL)========================================
//=======================================================================================================================================



var sql_command_16 = 
`create or replace table AK_BIRD_CAMPAIGN_EMAIL_OMNITURE_CLICK_DATA_V2 as

with BI_SFMC_and_omniture_data  as 
(
select 
distinct 
a.*,
VISIT_ID	,
VISITOR_ID	,
REGISTRATION_EVENT	, 
SIGN_IN_EVENT	, 
TXN_START_EVENT	, 
REG_ATTEMPT_EVENT	, 
LOGIN_ATTEMPT_EVENT	, 
SUBMIT_TXN_EVENT	,
RECEIPT_EVENT	, 
DAYS_BETWEEN_EMAIL_RCVD_DATE_TO_OMNITURE_CLICK	,
post_evar11, 
concat(a.emailname,a.customer_key,a.emailsentdate) as email, 
  b.Campaign_Name||b.Customer_Key||b.event_captured_dt||b.open_date||b.click_date||b.date_time as hit 
from 
(select a.*,row_number() over(partition by emailsentdate,emailname,customer_key,open_date_1,click_date_1 order by click_date_1 ) as rnk 
 from AK_BIRD_EMAIL_CAMPAIGN_V02 a ) a 
left outer join 
(select a.*,dense_rank() over(partition by event_captured_dt,campaign_name,customer_key,open_date,click_date order by click_date ) as rnk 
 from AK_BIRD_CAMPAIGN_OMNITURE_EMAIL_CLICK_DATA a) b 
on 
a.emailsentdate=b.event_captured_dt and 
a.emailname=b.campaign_name and 
a.customer_key=b.customer_key and 
a.open_date_1=b.open_date and 
a.click_date_1=b.click_date and 
a.rnk=b.rnk)
select * from BI_SFMC_and_omniture_data`;


//---------------------------------------------------------------------

var sql_command_17 = 
	`INSERT INTO BIRD_CAMPAIGN_LOG
Select 
    'AK_BIRD_CAMPAIGN_EMAIL_OMNITURE_CLICK_DATA_V2',
    CURRENT_TIMESTAMP,
    count(1) , 
    Count(distinct EMAILNAME), 
    sum(CASE WHEN EMAIL_OPENED_IN_30_DAY = 'Y' THEN 1 ELSE 0 END),
    sum(CASE WHEN EMAIL_CLICKED_IN_30_DAY = 'Y' THEN 1 ELSE 0 END) 
from AK_BIRD_CAMPAIGN_EMAIL_OMNITURE_CLICK_DATA_V2`;




//=======================================================================================================================================
//===============================(EMAIL AND OMNITURE WITH ENGAGEMENT FINAL TABLE AT CUSTOMER LEVEL)======================================
//=======================================================================================================================================


var sql_command_18 = 
`CREATE OR REPLACE TABLE AK_BIRD_CAMPAIGN_EMAIL_OMNITURE_FINAL AS
select 
f.country,
date_trunc(week,f.emailsentdate) rweek,
f.customer_key,
upper(f.emailname) as campaign_name,
f.marketing_strategy,
resend_flag,
activity_code,
count(distinct VISIT_ID) Session_count,
count(distinct visitor_Id) Visitor_count,
count(distinct case when registration_event > 0 then email end ) Emails_registrations,
count(distinct case when sign_in_event > 0 then email  end ) Emails_sign_ins,
count(distinct case when reg_attempt_event > 0 then email  end ) Emails_reg_attempts,
count(distinct case when login_attempt_event > 0 then email  end ) Emails_login_attempts,
count(distinct case when txn_start_event > 0 then email  end ) Emails_txn_starts,
count(distinct case when submit_txn_event > 0 then email  end ) Emails_txn_submits,
count(distinct case when receipt_event > 0 then email  end ) Emails_receipts,
count(distinct case when registration_event > 0 then hit end ) registrations,
count(distinct case when sign_in_event > 0 then hit  end ) sign_ins,
count(distinct case when reg_attempt_event > 0 then hit  end ) reg_attempts,
count(distinct case when login_attempt_event > 0 then hit  end ) login_attempts,
count(distinct case when txn_start_event > 0 then hit  end ) txn_starts,
count(distinct case when submit_txn_event > 0 then hit  end ) txn_submits,
count(distinct case when receipt_event > 0 then hit  end ) receipts,
sum( case when receipt_event > 0 and post_evar11 <> 'NaN' and post_evar11 <> '' 
        and post_evar11 is not null then post_evar11  end ) receipts_revenue,

count(distinct case when DAYS_BETWEEN_EMAIL_RCVD_DATE_TO_OMNITURE_CLICK < 30 then f.customer_key end ) as customers_visiting_wu_com_in_30_days

from 
 AK_BIRD_CAMPAIGN_EMAIL_OMNITURE_CLICK_DATA_V2 f
group by 1,2,3,4,5,6,7`;


//---------------------------------------------------------------------

var sql_command_19 = 
	`INSERT INTO BIRD_CAMPAIGN_LOG
Select 
    'AK_BIRD_CAMPAIGN_EMAIL_OMNITURE_FINAL',
    CURRENT_TIMESTAMP,
    count(1) , 
    Count(distinct CAMPAIGN_NAME), 
    0,
    0 
from AK_BIRD_CAMPAIGN_EMAIL_OMNITURE_FINAL`;

*/

//=======================================================================================================================================
//===============================(SMS BASE TABLE WITH ALL ENGAGEMENT COUNTS)=============================================================
//=======================================================================================================================================


// SELECT COUNT(*) FROM AK_BIRD_WU_MARKETING_SMS_SENT_BASE;
// --39,746,772

// SELECT COUNT(*) FROM WUDNA.SUMMARY_GEN.BIRD_WU_MARKETING_SMS_SENT_VW;
// --39,776,543

//------FOR SMS--------------------


var sql_command_14 =
`CREATE OR REPLACE TABLE AK_BIRD_WU_MARKETING_SMS_SENT_BASE AS 
WITH CTE_1 AS (
SELECT
    *,
    lag(ACTIONDATETIME) over ( partition by customer_key,/*pir_nbr,*/NAME order by ACTIONDATETIME) as prev_event_captured_dt
FROM 
    WUDNA.SUMMARY_GEN.BIRD_WU_MARKETING_SMS_SENT_VW
),

CTE_2 AS (
SELECT 
    *,
    datediff('DAY',prev_event_captured_dt,ACTIONDATETIME) as days_between_communication
FROM 
    CTE_1
)

SELECT * FROM CTE_2
WHERE (days_between_communication is null or days_between_communication > 6)
    `;





var sql_command_15 = 
	`INSERT INTO BIRD_CAMPAIGN_LOG
Select 
    'AK_BIRD_WU_MARKETING_SMS_SENT_BASE',
    CURRENT_TIMESTAMP,count(1) , 
    0, 
    0,
    0 
from AK_BIRD_WU_MARKETING_SMS_SENT_BASE`;




var sql_command_16 = 
`CREATE OR REPLACE TABLE AK_BIRD_campaign_wise_sms_communications_main AS
WITH AK_BIRD_CAMPAIGN_WISE_SMS_COMMUNICATIONS as (

SELECT 
A.customer_key,
NVL(B.ACTIVITY_CODE,'SASAA') ACTIVITY_CODE,
	upper(A.NAME) campaign_desc,
    upper(a.NAME) as campaign_desc_1,
	//date_trunc('DAY', A.ACTIONDATETIME) as release_2_vendor_date,
    A.ACTIONDATETIME as release_2_vendor_date,
	country AS country,
    b.EVENT_CAPTURED_DAY,
    b.PREV_EVENT_CAPTURED_DT,
    A.DAYS_BETWEEN_COMMUNICATION,
    SENT,
    DELIVERED,
    UNDELIVERED,
    ACTIONDATETIME,
    NAME,
FROM 
    //--WUDNA.SUMMARY_GEN.BIRD_WU_MARKETING_SMS_SENT_VW A
    AK_BIRD_WU_MARKETING_SMS_SENT_BASE A
LEFT JOIN 
    (select 
    a.*,

    from AK_BIRD_SOLICITATION_HISTORY_VW a 

    where substr(activity_code,3,1) = 'S'
    ) b

ON 
a.customer_key = b.customer_key AND 
date_trunc('DAY', date(A.ACTIONDATETIME)) = date_trunc('DAY', b.release_2_vendor_date) AND 
trim(upper(a.NAME)) = upper(b.campaign_desc)

),


SMS_Undelivered_main as (
    SELECT 
        DISTINCT customer_key AS customer_id ,
        name as campaign_desc
    
    FROM 
    (
    SELECT
        customer_key,
        NAME,
    FROM 
        //--WUDNA.SUMMARY_GEN.BIRD_WU_MARKETING_SMS_SENT_VW B
        AK_BIRD_WU_MARKETING_SMS_SENT_BASE B
    WHERE 
        customer_key IS NOT NULL 
        AND DELIVERED < 1
    )
    
    //-- WHERE
    //--     DELIVERED < 1
),


LS_sfmc_CEM_SMS_CAMPAIGN_v4 as

(
select 
    distinct A.*,
    //date_trunc('DAY',CLICK_TIMESTAMP) as event_captured_day,
    CLICK_TIMESTAMP as event_captured_day,

from 
    (
    SELECT 
    CASE  
    
        WHEN A.customer_key IS NULL OR A.customer_key ='' then B.cuid
        ELSE A.customer_key
            END AS customer_key,
    
        LAST_ATTRIBUTED_TOUCH_DATA_CUSTOM_FIELDS,
        BRANCH_REFERRER,
        LOG_TITLE,
        LOG_DESCRIPTION,
        DOMAIN,
        URL,
        WEB_ONLY,
        DESKTOP_URL,
        FALLBACK_URL,
        CANONICAL_URL,
        ANDROID_URL,
        IOS_URL,
        CUID,
        UTM_CAMPAIGN,
        UTM_MEDIUM,
        UTM_SOURCE,
        CREATION_SOURCE,
        CLICK_TIMESTAMP_RAW,
        CLICK_TIMESTAMP,
        CAN
    
    
    FROM 
        "WUDNA"."SUMMARY_GEN"."WU_MARKETING_SMS_CLICK_VW" B
    LEFT JOIN 
        "WUDNA"."SUMMARY_GEN".WUDNA_ACCOUNT_MASTER_VW A ON B.CUID  = A.CUSTOMER_UMN
    
    WHERE  
        B.CUID IS NOT NULL 
        //AND UPPER(URL) NOT LIKE '%UNSUB%'
        //AND (URL IS NULL OR UPPER(URL) NOT LIKE '%UNSUB%')


    )a


where 
    a.customer_key is not null 
    and year(CLICK_TIMESTAMP) >= 2024

),


AK_BIRD_MARKETING_SMS_OPT_OUT_VW as
(
select 
    * 
from 
    (
    select 
        distinct a.customer_key,
        upper(campaign_desc) campaign_name,
        release_2_vendor_Date,
        WEB_TIMESTAMP ,
        row_number() over (partition by a.customer_key order by release_2_vendor_Date desc) rnk //
    from 
        AK_BIRD_CAMPAIGN_WISE_SMS_COMMUNICATIONS a
    inner join 

    (
        SELECT 
  

            customer_key,
            MOBILE_COUNTRY_CODE,
            WEB_TIMESTAMP ,
            SMS_TIMEZONE,
            SMS_FLAG
        FROM 
            summary_gen.BIRD_WU_MARKETING_SMS_OPT_OUT_VW B
        WHERE  
            B.customer_key IS NOT NULL
    )b on a.customer_key = b.customer_key and a.release_2_vendor_Date <= b.WEB_TIMESTAMP 
)
where rnk = 1
),

LS_sfmc_SMS_OPT_OUT as
(
select distinct a.*,
date_trunc('DAY',TO_DATE(WEB_TIMESTAMP)) as event_captured_day,


from  
(
SELECT 

customer_key,

CAMPAIGN_NAME,

CAST(WEB_TIMESTAMP AS DATE) AS WEB_TIMESTAMP,
from  AK_BIRD_MARKETING_SMS_OPT_OUT_VW B

WHERE  B.customer_key IS NOT NULL 
)a,


where A.customer_key is not null and year(WEB_TIMESTAMP) >= 2024
),

campaign_wise_sms_communications_main as 
(
select 
 a.customer_key,
 a.country,
 a.release_2_vendor_date,
 a.activity_code,
 a.campaign_desc,
 upper(a.campaign_desc) as campaign_desc_1,
 prev_event_captured_dt,
 days_between_communication,
 case when b.customer_id is not null then 'UNDELIVERED' else 'DELIVERED' end  delivery_flag,
 case when upper(nvl(a.CAMPAIGN_desc,'UNKNOWN'))  like '%RESEND%' or 
		upper(nvl(a.CAMPAIGN_desc,'UNKNOWN'))  like '%RE SEND%' or 
		upper(nvl(a.CAMPAIGN_desc,'UNKNOWN'))  like '%RE_SEND%' or 
		upper(nvl(a.CAMPAIGN_desc,'UNKNOWN'))  like '%RE-SEND%'
		then 'Y' else 'N' end as RESEND_FLAG,
case when d.EVENT_CAPTURED_DAY is not null and d.EVENT_CAPTURED_DAY >= a.release_2_vendor_date 
		then 'Y' else 'N' end click_flag,
case when  
d.EVENT_CAPTURED_DAY >= a.release_2_vendor_date then d.EVENT_CAPTURED_DAY end as click_date,
case when
d.EVENT_CAPTURED_DAY >= a.release_2_vendor_date then d.url end offer_url,
g.event_captured_day as optout_date,
case when delivery_flag = 'DELIVERED' and click_flag='Y' and   d.EVENT_CAPTURED_DAY >= a.release_2_vendor_date
and (extract(epoch from d.EVENT_CAPTURED_DAY)-extract(epoch from a.release_2_vendor_date)) <= 2592000 then 'Y' else 'N' end as  sms_clicked_in_30_Days,
case when delivery_flag = 'DELIVERED' and click_flag='Y' and   d.EVENT_CAPTURED_DAY >= a.release_2_vendor_date
and (extract(epoch from d.EVENT_CAPTURED_DAY)-extract(epoch from a.release_2_vendor_date)) <= 604800 then 'Y' else 'N' end as  sms_clicked_in_7_Days 
from AK_BIRD_CAMPAIGN_WISE_SMS_COMMUNICATIONS a 
left outer join LS_sfmc_CEM_SMS_CAMPAIGN_v4 d on
a.customer_key=d.customer_key and lower(a.campaign_desc)=lower(d.can)
left join LS_SFMC_SMS_OPT_OUT g on
a.customer_key = g.customer_key and lower(a.campaign_desc) = lower(g.campaign_name)
                
left outer join 
SMS_Undelivered_main b on 
a.customer_key=b.customer_id 
       and upper(a.campaign_desc)=upper(b.campaign_desc)
       )
 
     SELECT * FROM campaign_wise_sms_communications_main`;



//-----------------------------------------------------------------------
/*
SELECT 
    CAMPAIGN_DESC,
    COUNT(CUSTOMER_KEY),
    COUNT(case when DELIVERY_FLAG='UNDELIVERED' then 1 end) EMAILS_UN_DELIVERED
    --DELIVERY_FLAG
FROM 
AK_BIRD_CAMPAIGN_WISE_SMS_COMMUNICATIONS_MAIN_TEST
WHERE
    CAMPAIGN_DESC = 'SMS_OFFERPROMOCODE_AGENTLOCATOR_CTARETAIL_LAPSEDUKPOSTOFFICE0FEE_WAVE1EUGBACTIVE'
GROUP BY ALL;
*/

//-----------------------------------------------------------------------


var sql_command_17 = 
	`INSERT INTO BIRD_CAMPAIGN_LOG
Select 
    'AK_BIRD_campaign_wise_sms_communications_main',
    CURRENT_TIMESTAMP,
    count(1) , 
    Count(distinct CAMPAIGN_DESC_1), 
    0,
    sum(CASE WHEN SMS_CLICKED_IN_30_DAYS = 'Y' THEN 1 ELSE 0 END) 
from AK_BIRD_campaign_wise_sms_communications_main`;




//=======================================================================================================================================
//===============================(SMS FINAL TABLE WITH ALL ENGAGEMENT COUNTS)============================================================
//=======================================================================================================================================


//SELECT * FROM BIRD_CAMPAIGN_LOG;

//SELECT * FROM AK_BIRD_campaign_wise_sms_communications_main LIMIT 100;

//Call BIRD_CAMPAIGN_TRACKER_WEEKLY_7_DAYS();


var sql_command_18 = 
`CREATE or replace TABLE AK_BIRD_campaign_wise_sms_communications_main_FINAL as

SELECT 
    CUSTOMER_KEY, 
    COUNTRY, 
    RELEASE_2_VENDOR_DATE, 
    ACTIVITY_CODE, 
    CAMPAIGN_DESC, 
    CAMPAIGN_DESC_1, 
    PREV_EVENT_CAPTURED_DT, 
    DAYS_BETWEEN_COMMUNICATION, 
    DELIVERY_FLAG, 
    RESEND_FLAG, 
    CLICK_FLAG, 
    OFFER_URL,
    MODE(sms_clicked_in_30_Days) AS sms_clicked_in_30_Days,
    --case when DELIVERY_FLAG='UNDELIVERED' then 1 else 0 end EMAILS_UN_DELIVERED,
    --case when optout_date is not null then 1 else 0 end CUSTOMERS_OPTING_OUT_OF_EMAIL_MARKETING,
    COUNT(DISTINCT CUSTOMER_KEY) AS COMMUNICATIONS_SENT,
    COUNT(DISTINCT CASE WHEN SMS_CLICKED_IN_7_DAYS = 'Y' THEN CUSTOMER_KEY END) AS CLICK_COUNT,
    MIN(CASE WHEN CLICK_DATE >= RELEASE_2_VENDOR_DATE THEN CLICK_DATE END) AS CLICK_DATE, 
    MIN(CASE WHEN OPTOUT_DATE >= RELEASE_2_VENDOR_DATE THEN OPTOUT_DATE END) AS OPTOUT_DATE    
FROM AK_BIRD_campaign_wise_sms_communications_main

GROUP BY ALL`;


//-----------------------------------------------------------------------


var sql_command_19 = 
	`INSERT INTO BIRD_CAMPAIGN_LOG
Select 
    'AK_BIRD_campaign_wise_sms_communications_main_FINAL',
    CURRENT_TIMESTAMP,
    count(1) , 
    Count(distinct CAMPAIGN_DESC_1), 
    0,
    0 
from AK_BIRD_campaign_wise_sms_communications_main_FINAL`;



//---------------------APP DATA-----------------------------------------------------------------------------------------------------------

var sql_command_20 = 
`create or replace table AES_SENT_VW AS
         select distinct customer_key, 
         concat(NVL(UPPER(campaign_canvas_name),'NA'),'_',NVL(UPPER(CANVAS_STEP_NAME),'NA'),'_',nvl(UPPER(APP_TYPE_NAME),'NA')) campaign_name,
		 CAMPAIGN_CANVAS_NAME,CANVAS_STEP_NAME_NEW,

         
case when substr(ACTIVITY_CODE_NEW,3,1)='P' AND push_sent_date IS NOT NULL then push_sent_date 
        when substr(ACTIVITY_CODE_NEW,3,1)='I' AND inappmsg_viewed_date IS NOT NULL then inappmsg_viewed_date
        when substr(ACTIVITY_CODE_NEW,3,1)='C' AND cc_sent_date IS NOT NULL then cc_sent_date
        else TO_DATE('9999-01-01')
        END AS event_captured_dt,
        'APP' Channel,ACTIVITY_CODE_NEW ACTIVITY_CODE,push_sent_count push_sent_count_1,
         lead(event_captured_dt) over(partition by customer_key,campaign_name order by event_captured_dt asc) next_communication_date,type
         from summary_gen.braze_summary_vw
         WHERE  substr(activity_code_new,1,1) in ('S') and event_captured_dt is not null 
		 and event_captured_dt <> '9999-01-01' AND year(event_captured_dt) >= 2024`;




var sql_command_21 =
	`INSERT INTO BIRD_CAMPAIGN_LOG
Select 
    'AES_SENT_VW',
    CURRENT_TIMESTAMP,
    count(1) , 
    Count(distinct CAMPAIGN_NAME), 
    0,
    0 
from AES_SENT_VW`;



//=======================================================================================================================================
//=======================================================================================================================================



var sql_command_22 = 
`create or replace table AES_EVENT_VW AS
        select distinct a.customer_key, 
        concat(NVL(UPPER(campaign_canvas_name),'NA'),'_',NVL(UPPER(CANVAS_STEP_NAME),'NA'),'_',nvl(UPPER(APP_TYPE_NAME),'NA')) campaign_name ,
        PUSH_SENT_DATE,	PUSH_OPENED_DATE,	PUSH_INFLU_OPENED_DATE,	PUSH_BOUNCED_DATE,	
        PUSH_ABORTED_DATE,	INAPPMSG_VIEWED_DATE,	INAPPMSG_CLICKED_DATE,	CC_SENT_DATE,	CC_CLICKED_DATE,	
        CC_VIEWED_DATE,	CC_DISMISSED_DATE,	CC_ABORTED_DATE,
        COALESCE(PUSH_SENT_DATE,	PUSH_OPENED_DATE,	PUSH_INFLU_OPENED_DATE,	PUSH_BOUNCED_DATE,	PUSH_ABORTED_DATE,	INAPPMSG_VIEWED_DATE,	INAPPMSG_CLICKED_DATE,	CC_SENT_DATE,	CC_CLICKED_DATE,	CC_VIEWED_DATE,	CC_DISMISSED_DATE,	CC_ABORTED_DATE) EVENT_DATE,
        'APP' Channel,type
        from summary_gen.braze_summary_vw a
        WHERE  substr(activity_code_new,1,1) in ('S')
        and year(EVENT_DATE) >= 2024`;




var sql_command_23 = 
	`INSERT INTO BIRD_CAMPAIGN_LOG
Select 
    'AES_EVENT_VW',
    CURRENT_TIMESTAMP,
    count(1) , 
    Count(distinct CAMPAIGN_NAME), 
    0,
    0 
from AES_EVENT_VW`;
        

//=======================================================================================================================================
//=======================================================================================================================================


var sql_command_24 = 
`create or replace table aes_aggregated_event_vw as 
          with table_1 as
          (
          SELECT distinct a.*,
          case when a.event_captured_dt <= PUSH_SENT_DATE and a.NEXT_COMMUNICATION_DATE is not null and a.next_communication_date > PUSH_SENT_DATE then push_sent_count_1
               when a.NEXT_COMMUNICATION_DATE is null and a.event_captured_dt <= PUSH_SENT_DATE then push_sent_count_1 end push_sent_count_attr,  
          
          case when a.event_captured_dt <= PUSH_OPENED_DATE and a.NEXT_COMMUNICATION_DATE is not null and a.next_communication_date > PUSH_OPENED_DATE then PUSH_OPENED_DATE
               when a.NEXT_COMMUNICATION_DATE is null and a.event_captured_dt <= PUSH_OPENED_DATE then PUSH_OPENED_DATE end push_open_date,
                    
          case when  a.event_captured_dt <= PUSH_INFLU_OPENED_DATE and a.NEXT_COMMUNICATION_DATE is not null and a.next_communication_date > PUSH_INFLU_OPENED_DATE then PUSH_INFLU_OPENED_DATE
               when a.NEXT_COMMUNICATION_DATE is null and a.event_captured_dt <= PUSH_INFLU_OPENED_DATE then PUSH_INFLU_OPENED_DATE end push_INFLU_open_date,

          case when a.event_captured_dt <= PUSH_BOUNCED_DATE and a.NEXT_COMMUNICATION_DATE is not null and a.next_communication_date > PUSH_BOUNCED_DATE then PUSH_BOUNCED_DATE
               when a.NEXT_COMMUNICATION_DATE is null and a.event_captured_dt <= PUSH_BOUNCED_DATE then PUSH_BOUNCED_DATE end push_bounce_date,
               
          case when a.event_captured_dt <= PUSH_ABORTED_DATE and a.NEXT_COMMUNICATION_DATE is not null and a.next_communication_date > PUSH_ABORTED_DATE then PUSH_ABORTED_DATE 
               when a.NEXT_COMMUNICATION_DATE is null and a.event_captured_dt <= PUSH_ABORTED_DATE then PUSH_ABORTED_DATE end push_aborted_date,
          
          case when a.event_captured_dt <= INAPPMSG_VIEWED_DATE and a.NEXT_COMMUNICATION_DATE is not null and a.next_communication_date > INAPPMSG_VIEWED_DATE then INAPPMSG_VIEWED_DATE 
               when a.NEXT_COMMUNICATION_DATE is null and a.event_captured_dt <= INAPPMSG_VIEWED_DATE then INAPPMSG_VIEWED_DATE end INAPPMSG_VIEWED_DATE,
             
          case when a.event_captured_dt <= INAPPMSG_CLICKED_DATE and a.NEXT_COMMUNICATION_DATE is not null and a.next_communication_date > INAPPMSG_CLICKED_DATE then INAPPMSG_CLICKED_DATE 
               when a.NEXT_COMMUNICATION_DATE is null and a.event_captured_dt <= INAPPMSG_CLICKED_DATE then  INAPPMSG_CLICKED_DATE end INAPPMSG_CLICKED_DATE,
               
          case when a.event_captured_dt <= CC_SENT_DATE and a.NEXT_COMMUNICATION_DATE is not null and a.next_communication_date > CC_SENT_DATE then CC_SENT_DATE 
               when a.NEXT_COMMUNICATION_DATE is null and a.event_captured_dt <= CC_SENT_DATE then CC_SENT_DATE end CC_SENT_DATE,
            
          case when a.event_captured_dt <= CC_CLICKED_DATE and a.NEXT_COMMUNICATION_DATE is not null and a.next_communication_date > CC_CLICKED_DATE then CC_CLICKED_DATE 
               when a.NEXT_COMMUNICATION_DATE is null and a.event_captured_dt <= CC_CLICKED_DATE then CC_CLICKED_DATE end CC_CLICKED_DATE,
               
          case when a.event_captured_dt <= CC_VIEWED_DATE and a.NEXT_COMMUNICATION_DATE is not null and a.next_communication_date > CC_VIEWED_DATE then CC_VIEWED_DATE 
               when a.NEXT_COMMUNICATION_DATE is null and a.event_captured_dt <= CC_VIEWED_DATE then CC_VIEWED_DATE end CC_VIEWED_DATE,
            
               
          case when a.event_captured_dt <= CC_DISMISSED_DATE and a.NEXT_COMMUNICATION_DATE is not null and a.next_communication_date > CC_DISMISSED_DATE then CC_DISMISSED_DATE 
               when a.NEXT_COMMUNICATION_DATE is null and a.event_captured_dt <= CC_DISMISSED_DATE then CC_DISMISSED_DATE end CC_DISMISSED_DATE,
            
          case when a.event_captured_dt <= CC_ABORTED_DATE and a.NEXT_COMMUNICATION_DATE is not null and a.next_communication_date > CC_ABORTED_DATE then CC_ABORTED_DATE 
               when a.NEXT_COMMUNICATION_DATE is null and a.event_captured_dt <= CC_ABORTED_DATE then CC_ABORTED_DATE end CC_ABORTED_DATE
               
          FROM AES_SENT_VW A
          LEFT JOIN AES_EVENT_VW B ON 
          A.CUSTOMER_KEY = B.CUSTOMER_KEY AND 
          A.CAMPAIGN_NAME = B.CAMPAIGN_NAME ),
            
          table_2 as 
          (
            select customer_key,campaign_name,event_captured_Dt,ACTIVITY_CODE,type,CAMPAIGN_CANVAS_NAME,CANVAS_STEP_NAME_NEW,
            MIN(COALESCE(push_open_date, push_INFLU_open_date, INAPPMSG_CLICKED_DATE, CC_CLICKED_DATE)) AS CLICK_DATE, //ADDED_CLICK_DATE
            sum(push_sent_count_attr) push_sent_count,
            count(push_open_date) push_open_count,
            count(case when datediff(day,event_captured_Dt,push_open_date)<30 then push_open_date end) push_open_count_30days,
            count(case when datediff(day,event_captured_Dt,push_open_date)<7 then push_open_date end) push_open_count_7days,
            
            count(push_INFLU_open_date) push_influ_open_count,
            count(case when datediff(day,event_captured_Dt,push_INFLU_open_date)<30 then push_INFLU_open_date end) push_influ_open_count_30days,
            count(case when datediff(day,event_captured_Dt,push_INFLU_open_date)<7 then push_INFLU_open_date end) push_influ_open_count_7days,
            
            count(push_bounce_date) push_bounce_count,
            count(push_aborted_date) push_aborted_count,
            
            count(distinct INAPPMSG_VIEWED_DATE) INAPPMSG_VIEWED_count,
            
            count(INAPPMSG_CLICKED_DATE) INAPPMSG_CLICKED_COUNT,
            count(case when datediff(day,event_captured_Dt,INAPPMSG_CLICKED_DATE)<30 then INAPPMSG_CLICKED_DATE end) INAPPMSG_CLICKED_count_30days,
            count(case when datediff(day,event_captured_Dt,INAPPMSG_CLICKED_DATE)<7 then  INAPPMSG_CLICKED_DATE end) INAPPMSG_CLICKED_count_7days,
            
            count(cc_sent_Date) cc_sent_count,
            count(CC_CLICKED_DATE) CC_CLICKED_count,
            count(case when datediff(day,event_captured_Dt,CC_CLICKED_DATE)<30 then CC_CLICKED_DATE end) CC_CLICKED_count_30days,
            count(case when datediff(day,event_captured_Dt,CC_CLICKED_DATE)<7 then  CC_CLICKED_DATE end) CC_CLICKED_count_7days,
            
            count(CC_VIEWED_DATE) CC_VIEWED_DATE,
            count(CC_DISMISSED_DATE) CC_DISMISSED_count,
            count(CC_ABORTED_DATE) CC_ABORTED_count
            
           from table_1 group by 1,2,3,4,5,6,7
          )
          select * from table_2`;



var sql_command_25 = 
	`INSERT INTO BIRD_CAMPAIGN_LOG
Select 
    'aes_aggregated_event_vw',
    CURRENT_TIMESTAMP,
    count(1) , 
    Count(distinct CAMPAIGN_NAME), 
    sum(PUSH_OPEN_COUNT_30DAYS),
    0 
from aes_aggregated_event_vw`;

//=======================================================================================================================================
//=======================================================================================================================================


var sql_command_26 = 
`CREATE OR REPLACE TABLE AES_AGGREGATED_EVENT_VW_2 AS 
               select 
                c.country_code,
                a.EVENT_CAPTURED_DT,
                'NA' CAMPAIGN_ID,
                a.CUSTOMER_KEY,
                a.CAMPAIGN_NAME,
                'NA' MARKETING_STRATEGY,
                'NA' RESEND_FLAG,
                ACTIVITY_CODE,
                push_sent_count + INAPPMSG_VIEWED_count + cc_sent_count TOTAL_EMAILS_SENT,
               0 EMAILS_UN_DELIVERED,
               PUSH_OPEN_COUNT + PUSH_INFLU_OPEN_COUNT EMAILS_OPENED_ATLEAST_ONCE_WITHIN_30_DAYS_OF_COMMUNICATION,
               CC_CLICKED_COUNT + INAPPMSG_CLICKED_COUNT EMAILS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_30_DAYS_OF_COMMUNICATION,
               0 A,0 B,0 C,0 D,0 E,0 F,
               0 G,0 H,0 I,0 J,0 K,0 L,0 M,0 N,0 O,0 P,
               case when substr(activity_Code,1,1) = 'S' THEN 1 END CUSTOMERS_CONTACTED_ATLEAST_ONCE_BY_EMAIL,
               0 CUSTOMERS_BOUNCED_ATLEAST_ONE_EMAIL,
               PUSH_OPEN_COUNT + PUSH_INFLU_OPEN_COUNT CUSTOMERS_OPENING_ATLEAST_ONE_MAIL_WITHIN_30_DAYS_OF_COMMUNICATION,
               CC_CLICKED_COUNT + INAPPMSG_CLICKED_COUNT CUSTOMERS_CLICKING_ATLEAST_ONE_MAIL_WITHIN_30_DAYS_OF_COMMUNICATION,
               0 CUSTOMERS_COMPLAINING_ABOUT_SPAM,
               0 CUSTOMERS_OPTING_OUT_OF_EMAIL_MARKETING,
               0 Q,
               0 BAD_CLICKS,
               0 UNIQUE_CLICKS,
               PUSH_OPEN_COUNT_7days + PUSH_INFLU_OPEN_COUNT_7days EMAILS_OPENED_ATLEAST_ONCE_WITHIN_7_DAYS_OF_COMMUNICATION,
               CC_CLICKED_COUNT_7days + INAPPMSG_CLICKED_COUNT_7days EMAILS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_7_DAYS_OF_COMMUNICATION,
               PUSH_OPEN_COUNT,
               PUSH_INFLU_OPEN_COUNT,
               PUSH_BOUNCE_COUNT,
               INAPPMSG_VIEWED_COUNT,
               INAPPMSG_CLICKED_COUNT,
               CC_CLICKED_COUNT,
               CC_VIEWED_DATE CC_VIEWED_COUNT,
               CC_DISMISSED_COUNT,
               CC_ABORTED_COUNT,
               push_sent_count,
               cc_sent_count,
			   type,
			   CAMPAIGN_CANVAS_NAME,
			   CANVAS_STEP_NAME_NEW,
               CLICK_DATE //ADDED_CLICK_DATE
               from 
               (SELECT 
                    case 
                    
					WHEN A.customer_key IS NULL OR A.customer_key ='' then B.customer_key
                    else A.CUSTOMER_KEY
                end as CUSTOMER_KEY,

                
                CAMPAIGN_NAME,
                EVENT_CAPTURED_DT,
                ACTIVITY_CODE,
                TYPE,
                CAMPAIGN_CANVAS_NAME,
                CANVAS_STEP_NAME_NEW,
                PUSH_SENT_COUNT,
                PUSH_OPEN_COUNT,
                PUSH_OPEN_COUNT_30DAYS,
                PUSH_OPEN_COUNT_7DAYS,
                PUSH_INFLU_OPEN_COUNT,
                PUSH_INFLU_OPEN_COUNT_30DAYS,
                PUSH_INFLU_OPEN_COUNT_7DAYS,
                PUSH_BOUNCE_COUNT,
                PUSH_ABORTED_COUNT,
                INAPPMSG_VIEWED_COUNT,
                INAPPMSG_CLICKED_COUNT,
                INAPPMSG_CLICKED_COUNT_30DAYS,
                INAPPMSG_CLICKED_COUNT_7DAYS,
                CC_SENT_COUNT,
                CC_CLICKED_COUNT,
                CC_CLICKED_COUNT_30DAYS,
                CC_CLICKED_COUNT_7DAYS,
                CC_VIEWED_DATE,
                CC_DISMISSED_COUNT,
                CC_ABORTED_COUNT,
                CLICK_DATE //ADDED_CLICK_DATE
                
                FROM aes_aggregated_event_vw B
                LEFT JOIN  "WUDNA"."SUMMARY_GEN".WUDNA_ACCOUNT_MASTER_VW A 
                ON B.CUSTOMER_KEY = A.CUSTOMER_UMN
                WHERE  B.CUSTOMER_KEY IS NOT NULL) a
                
                
               
               
                left join "WUDNA"."SUMMARY_GEN"."WUDNA_CUSTOMER_MASTER_VW" b on a.customer_key = b.customer_key
                left join WUDNA.SUMMARY_GEN.COUNTRY_VW c on b.country_code = c.country_code
                where YEAR(a.EVENT_CAPTURED_DT) >= 2024`;




var sql_command_27 = 
     `INSERT INTO BIRD_CAMPAIGN_LOG
Select 
    'AES_AGGREGATED_EVENT_VW_2',
    CURRENT_TIMESTAMP,
    count(1) , 
    Count(distinct CAMPAIGN_NAME), 
    sum(CUSTOMERS_OPENING_ATLEAST_ONE_MAIL_WITHIN_30_DAYS_OF_COMMUNICATION),
    sum(CUSTOMERS_CLICKING_ATLEAST_ONE_MAIL_WITHIN_30_DAYS_OF_COMMUNICATION) 
from AES_AGGREGATED_EVENT_VW_2`;






//=======================================================================================================================================
//===============================(EMAIL-SMS UNION TABLE AT CUSTOMER-CAMPAIGN LEVEL)======================================================
//=======================================================================================================================================



var sql_command_28 = 
`CREATE or replace TABLE AK_BIRD_CAMPAIGN_EMAIL_SMS_UNION AS

select 
    country,
    RELEASE_2_VENDOR_DATE as EVENT_CAPTURED_DT,
    CUSTOMER_KEY,
    c.campaign_desc_1 as CAMPAIGN_NAME,
    ' ' marketing_strategy,
    RESEND_FLAG,ACTIVITY_CODE,
    CASE WHEN COMMUNICATIONS_SENT > 0 THEN 1 ELSE 0 END AS TOTAL_EMAILS_SENT,
    case when DELIVERY_FLAG='UNDELIVERED' then 1 else 0 end EMAILS_UN_DELIVERED,
    0 EMAILS_OPENED_ATLEAST_ONCE_WITHIN_30_DAYS_OF_COMMUNICATION,
    case when sms_clicked_in_30_Days='Y' then 1 else 0 end EMAILS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_30_DAYS_OF_COMMUNICATION,
    0 EMAILS_LEADING_TO_A_WU_COM_HIT_WITHIN_30_DAYS_OF_COMMUNICATION,
    0 EMAILS_REGISTRATIONS,
    0 EMAILS_SIGN_INS,
    0 EMAILS_REG_ATTEMPTS,
    0 EMAILS_LOGIN_ATTEMPTS,
    0 EMAILS_TXN_STARTS,
    0 EMAILS_TXN_SUBMITS,
    0 EMAILS_RECEIPTS,
    0 REGISTRATIONS,
    0 SIGN_INS,
    0 REG_ATTEMPTS,
    0 LOGIN_ATTEMPTS,
    0 TXN_STARTS,
    0 TXN_SUBMITS,
    0 RECEIPTS,
    0 receipts_revenue,
    0 CUSTOMERS_CONTACTED_ATLEAST_ONCE_BY_EMAIL,
    case when DELIVERY_FLAG='UNDELIVERED' then 1 else 0 end CUSTOMERS_BOUNCED_ATLEAST_ONE_EMAIL,
    0 CUSTOMERS_OPENING_ATLEAST_ONE_MAIL_WITHIN_30_DAYS_OF_COMMUNICATION,
    0 CUSTOMERS_CLICKING_ATLEAST_ONE_MAIL_WITHIN_30_DAYS_OF_COMMUNICATION,
    0 CUSTOMERS_COMPLAINING_ABOUT_SPAM,
    case when optout_date is not null then 1 else 0 end CUSTOMERS_OPTING_OUT_OF_EMAIL_MARKETING,
    0 CUSTOMERS_VISITING_WU_COM_IN_30_DAYS,
    0 BAD_CLICKS,
    0 UNIQUE_CLICKS,
    0 EMAILS_OPENED_ATLEAST_ONCE_WITHIN_7_DAYS_OF_COMMUNICATION,
    //case when sms_clicked_in_7_Days='Y' then 1 else 0 end EMAILS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_7_DAYS_OF_COMMUNICATION,
    CASE WHEN CLICK_COUNT > 0 THEN 1 ELSE 0 END EMAILS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_7_DAYS_OF_COMMUNICATION,
    CLICK_DATE //ADDED_CLICK_DATE
from AK_BIRD_campaign_wise_sms_communications_main_FINAL c    

UNION all

select a.country,EVENT_CAPTURED_DT,
    a.CUSTOMER_KEY,a.CAMPAIGN_NAME,a.MARKETING_STRATEGY,RESEND_FLAG,ACTIVITY_CODE,TOTAL_EMAILS_SENT,
EMAILS_UN_DELIVERED,
EMAILS_OPENED_ATLEAST_ONCE_WITHIN_30_DAYS_OF_COMMUNICATION,EMAILS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_30_DAYS_OF_COMMUNICATION,
0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,CUSTOMERS_CONTACTED_ATLEAST_ONCE_BY_EMAIL,
CUSTOMERS_BOUNCED_ATLEAST_ONE_EMAIL,CUSTOMERS_OPENING_ATLEAST_ONE_MAIL_WITHIN_30_DAYS_OF_COMMUNICATION,CUSTOMERS_CLICKING_ATLEAST_ONE_MAIL_WITHIN_30_DAYS_OF_COMMUNICATION,

CUSTOMERS_COMPLAINING_ABOUT_SPAM,CUSTOMERS_OPTING_OUT_OF_EMAIL_MARKETING,0,BAD_CLICKS, UNIQUE_CLICKS,
EMAILS_OPENED_ATLEAST_ONCE_WITHIN_7_DAYS_OF_COMMUNICATION,EMAILS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_7_DAYS_OF_COMMUNICATION,
CLICK_DATE //ADDED_CLICK_DATE
 
 from AK_campaign_wise_BIRD_communications_EMAIL_FINAL a `;




var sql_command_29 = 
    `INSERT INTO BIRD_CAMPAIGN_LOG
Select 
    'AK_BIRD_CAMPAIGN_EMAIL_SMS_UNION',
    CURRENT_TIMESTAMP,
    count(1) , 
    Count(distinct CAMPAIGN_NAME), 
    sum(CUSTOMERS_OPENING_ATLEAST_ONE_MAIL_WITHIN_30_DAYS_OF_COMMUNICATION),
    sum(CUSTOMERS_CLICKING_ATLEAST_ONE_MAIL_WITHIN_30_DAYS_OF_COMMUNICATION) 
from AK_BIRD_CAMPAIGN_EMAIL_SMS_UNION`;	




//=======================================================================================================================================
//===============================(EMAIL-SMS-APP UNION TABLE AT CUSTOMER-CAMPAIGN LEVEL)==================================================
//=======================================================================================================================================


var sql_command_30 = 
 `CREATE OR REPLACE TABLE AK_BIRD_CAMPAIGN_EMAIL_SMS_APP_UNION  AS
	WITH AK_SJ_CAMPAIGN_WISE_EMAIL_SMS_COMMUNICATIONS_MAIN_2020_21_CTE AS
        (
        SELECT *,
        0 PUSH_OPEN_COUNT,
        0 PUSH_INFLU_OPEN_COUNT,
        0 PUSH_BOUNCE_COUNT,
        0 INAPPMSG_VIEWED_COUNT,
        0 INAPPMSG_CLICKED_COUNT,
        0 CC_CLICKED_COUNT,
        0 CC_VIEWED_COUNT,
        0 CC_DISMISSED_COUNT,
        0 CC_ABORTED_COUNT,
        0 push_sent_count,
        0 cc_sent_count,
		' ' type,
		' ' CAMPAIGN_CANVAS_NAME,
		' 'CANVAS_STEP_NAME_NEW,
        'EMAIL/SMS' COMM_CHANNEL FROM AK_BIRD_CAMPAIGN_EMAIL_SMS_UNION WHERE YEAR(EVENT_CAPTURED_dT) >= 2024
        
        UNION ALL
        
        SELECT COUNTRY_CODE, 
        EVENT_CAPTURED_DT, 
        //CAMPAIGN_ID, 
        CUSTOMER_KEY, 
        CAMPAIGN_NAME, 
        MARKETING_STRATEGY, 
        RESEND_FLAG, 
        ACTIVITY_CODE, 
        TOTAL_EMAILS_SENT, 
        EMAILS_UN_DELIVERED, 
        EMAILS_OPENED_ATLEAST_ONCE_WITHIN_30_DAYS_OF_COMMUNICATION, 
        EMAILS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_30_DAYS_OF_COMMUNICATION, 
        A, 
        B, 
        C, 
        D, 
        E, 
        F, 
        G, 
        H, 
        I, 
        J, 
        K, 
        L, 
        M, 
        N, 
        O, 
        P, 
        CUSTOMERS_CONTACTED_ATLEAST_ONCE_BY_EMAIL, 
        CUSTOMERS_BOUNCED_ATLEAST_ONE_EMAIL, 
        CUSTOMERS_OPENING_ATLEAST_ONE_MAIL_WITHIN_30_DAYS_OF_COMMUNICATION, 
        CUSTOMERS_CLICKING_ATLEAST_ONE_MAIL_WITHIN_30_DAYS_OF_COMMUNICATION, 
        CUSTOMERS_COMPLAINING_ABOUT_SPAM, 
        CUSTOMERS_OPTING_OUT_OF_EMAIL_MARKETING, 
        Q, 
        BAD_CLICKS, 
        UNIQUE_CLICKS, 
        EMAILS_OPENED_ATLEAST_ONCE_WITHIN_7_DAYS_OF_COMMUNICATION, 
        EMAILS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_7_DAYS_OF_COMMUNICATION, 
        CLICK_DATE, //ADDED_CLICK_DATE
        PUSH_OPEN_COUNT, 
        PUSH_INFLU_OPEN_COUNT, 
        PUSH_BOUNCE_COUNT, 
        INAPPMSG_VIEWED_COUNT, 
        INAPPMSG_CLICKED_COUNT, 
        CC_CLICKED_COUNT, 
        CC_VIEWED_COUNT, 
        CC_DISMISSED_COUNT, 
        CC_ABORTED_COUNT, 
        PUSH_SENT_COUNT, 
        CC_SENT_COUNT, 
        TYPE, 
        CAMPAIGN_CANVAS_NAME, 
        CANVAS_STEP_NAME_NEW,
        'APP' CHANNEL FROM AES_AGGREGATED_EVENT_VW_2
        )

    select 
a.COUNTRY, EVENT_CAPTURED_DT, //CAMPAIGN_ID,
a.CAMPAIGN_NAME, MARKETING_STRATEGY, RESEND_FLAG, 
ACTIVITY_CODE, TOTAL_EMAILS_SENT, EMAILS_UN_DELIVERED, EMAILS_OPENED_ATLEAST_ONCE_WITHIN_30_DAYS_OF_COMMUNICATION, 
EMAILS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_30_DAYS_OF_COMMUNICATION, EMAILS_LEADING_TO_A_WU_COM_HIT_WITHIN_30_DAYS_OF_COMMUNICATION, 
EMAILS_REGISTRATIONS, EMAILS_SIGN_INS, EMAILS_REG_ATTEMPTS, EMAILS_LOGIN_ATTEMPTS, 
EMAILS_TXN_STARTS, EMAILS_TXN_SUBMITS, EMAILS_RECEIPTS, REGISTRATIONS, SIGN_INS, 
REG_ATTEMPTS, LOGIN_ATTEMPTS, TXN_STARTS, TXN_SUBMITS, RECEIPTS, RECEIPTS_REVENUE, 
CUSTOMERS_CONTACTED_ATLEAST_ONCE_BY_EMAIL, CUSTOMERS_BOUNCED_ATLEAST_ONE_EMAIL, 
CUSTOMERS_OPENING_ATLEAST_ONE_MAIL_WITHIN_30_DAYS_OF_COMMUNICATION, 
CUSTOMERS_CLICKING_ATLEAST_ONE_MAIL_WITHIN_30_DAYS_OF_COMMUNICATION, 
CUSTOMERS_COMPLAINING_ABOUT_SPAM, CUSTOMERS_OPTING_OUT_OF_EMAIL_MARKETING, 
CUSTOMERS_VISITING_WU_COM_IN_30_DAYS, BAD_CLICKS, UNIQUE_CLICKS, EMAILS_OPENED_ATLEAST_ONCE_WITHIN_7_DAYS_OF_COMMUNICATION, 
EMAILS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_7_DAYS_OF_COMMUNICATION, 
CLICK_DATE, //ADDED_CLICK_DATE
PUSH_OPEN_COUNT, PUSH_INFLU_OPEN_COUNT, 
PUSH_BOUNCE_COUNT, INAPPMSG_VIEWED_COUNT, INAPPMSG_CLICKED_COUNT, CC_CLICKED_COUNT, CC_VIEWED_COUNT, CC_DISMISSED_COUNT, 
CC_ABORTED_COUNT, PUSH_SENT_COUNT, CC_SENT_COUNT, TYPE,CAMPAIGN_CANVAS_NAME,CANVAS_STEP_NAME_NEW, COMM_CHANNEL,

nvl(CUSTOMER_UMN,nvl(RTRA_GALACTIC_ID,TO_VARCHAR(PROSPECT_ID))) AS Customer_ID,

CASE 
WHEN substr(ACTIVITY_CODE,3,1) IN ('E','S') AND LEN (CUSTOMER_KEY) = 15 THEN Customer_ID ELSE CUSTOMER_KEY END CUSTOMER_KEY


from AK_SJ_CAMPAIGN_WISE_EMAIL_SMS_COMMUNICATIONS_MAIN_2020_21_CTE a 

LEFT JOIN summary_gen.WUDNA_SFMC_PROSPECT_CUSTOMER_SUMMARY_NONPII_VW b on a.CUSTOMER_KEY = TO_VARCHAR(b.PROSPECT_ID)

WHERE
    (DATE(EVENT_CAPTURED_DT) < '2025-08-01'
    OR (DATE(EVENT_CAPTURED_DT) >= '2025-08-01'  AND UPPER(A.CAMPAIGN_NAME) NOT LIKE '%SERVICE%'))
    AND NOT UPPER(A.CAMPAIGN_CANVAS_NAME) IN (SELECT UPPER(C1) FROM "WUDNA"."CEX_SANDBOX"."APP_SERVICE_CAMPAIGNS_TO_REMOVE")
    //AND upper(A.campaign_name) not like 'TEST%' and upper(A.campaign_name) not like '%UNKNOWN%' 
    //AND upper(A.campaign_name) not like '%RCVX%'
    AND not Upper(A.campaign_name) ilike any ('%FULFILLMENT%','%STAGE_%','STGE_%','TEST%','%WUPLUS%','%LIFECYCLE_ONBOARDING_CTADIGITAL_WP%','%UNKNOWN%','%APOLOGY%','%SURVEY%','%RCVX%')
    `;





var sql_command_31 =  
    `INSERT INTO BIRD_CAMPAIGN_LOG
Select 
    'AK_BIRD_CAMPAIGN_EMAIL_SMS_APP_UNION',
    CURRENT_TIMESTAMP,
    count(1) , 
    Count(distinct CAMPAIGN_NAME), 
    sum(CUSTOMERS_OPENING_ATLEAST_ONE_MAIL_WITHIN_30_DAYS_OF_COMMUNICATION),
    sum(CUSTOMERS_CLICKING_ATLEAST_ONE_MAIL_WITHIN_30_DAYS_OF_COMMUNICATION) 
from AK_BIRD_CAMPAIGN_EMAIL_SMS_APP_UNION`;



//=======================================================================================================================================
//===============================(FINAL CUSTOMER-CAMPAIGN LEVEL WITH ALL AATTRIBUTES AND ENGAGEMENT METRICS)=============================
//=======================================================================================================================================






var sql_command_32 = 
`CREATE or replace TABLE AK_BIRD_CAMPAIGN_COMMUNICATION_CUSTOMER_LEVEL AS
WITH TXN_MASTER_DATA as
(
	select 
	TXN_ID,MTCN,SNDCUSTOMER_KEY,RCVCUSTOMER_KEY,SNDCARD_NUMBER,RCVCARD_NUMBER,COMPANY_BRAND,RCV_COMPANY_BRAND,
	RECORD_DATETIME as RECORD_DATETIME,
	SETTLEMENT_DATE,SNDCOUNTRY_CODE,SEND_SUPER_REGION,SEND_COUNTRY_NAME,RCVCOUNTRY_CODE,RCV_SUPER_REGION,
	RCV_COUNTRY_NAME,DIRECTION,SNDAGENT_NUMBER,AGENT_NAID,NETWORK_CODE,SUB_NETWORK_CODE,RCVAGENT_NUMBER,RCV_AGENT_NAID,
	SNDPRINCIPAL_USD,RCVPRINCIPAL_USD,SNDPRINCIPAL_AMOUNT,RCVPRINCIPAL_AMOUNT,SNDCURRENCY_CODE,RCVCURRENCY_CODE,TOTAL_CHARGES_USD,
	NET_FOREIGN_EXCHANGE,REVENUE,SNDPRINCIPAL_FC,TOTAL_CHARGES_FC,NET_FOREIGN_EXCHANGE_FC,REVENUE_FC,SNDLEVEL_CODE,RCVLEVEL_CODE,
	PROMOTION_CODE,PAYOUT_CODE,PAYIN_CODE,SUB_PAYIN_TYPE,PAYIN_TYPE,SUB_PAYOUT_TYPE,PAYOUT_TYPE,PAYIN_CARD_TYPE,SND_PURPOSE_PURCHASE,
	RCV_PURPOSE_PURCHASE,SND_SOURCE_OF_FUNDS,RCV_SOURCE_OF_FUNDS,SND_COMMERCIAL_PURPOSE_FLAG,RCV_COMMERCIAL_PURPOSE_FLAG,PRODUCT_GROUP,
	PRODUCT_VALUE,SEND_SOFTWARE_VERSION,RCV_SOFTWARE_VERSION,SEND_DEVICE,RCV_DEVICE,OS_TYPE,SPEED_OF_DELIVERY,ATTRIBUTE_CHANNEL,PRIMARY_CHANNEL,
	SUB_CHANNEL,PRICING_CHANNEL,RCV_CHANNEL_CODE,BUSINESS_NAME,AGENT_NETWORK,RCV_BUSINESS_NAME,RCV_AGENT_NETWORK,NEXT_GEN_KIOSK_FLAG,REFUND_TRXN,
	SEND_STATE,RECEIVE_STATE,DELIVERY_SVC_CD,FEE_SEGMENT_USED,FX_SEGMENT_USED,TXN.PRODUCT_CODE,--LEVEL_CODE,
	TXN.CREATED_DATE,TXN.UPDATED_DATE,TXN.PROCESS_DATE,
	TXN.VALID_TXN_TYPE_CODE
	
	
	from 
	
	"WUDNA"."SUMMARY_GEN"."WUDNA_TXN_MASTER_ANALYTICS_VW" txn
	
	
	left outer join "WUDNA"."SUMMARY_GEN"."WUDNA_CUSTOMER_MASTER_VW" cm on txn.SNDCUSTOMER_KEY=cm.CUSTOMER_KEY
	
	left join WUDNA.SUMMARY_GEN.country_vw cn3 on cm.country_code=cn3.country_code

    //where year(record_datetime) = 2024 //DELETE AFTER CHANGE	
	),


BI_email_cust_main as 
(select
DISTINCT a.customer_key
from AK_BIRD_CAMPAIGN_EMAIL_SMS_APP_UNION a
WHERE 
    ((SUBSTR(ACTIVITY_CODE,3,1) ='P' AND  EMAILS_OPENED_ATLEAST_ONCE_WITHIN_7_DAYS_OF_COMMUNICATION > 0 )   //7_DAYS_ATTRIBUTION_CHANGE_FROM_30_DAYS
        OR
        (SUBSTR(ACTIVITY_CODE,3,1) IN ('E','S','I','C') AND  EMAILS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_7_DAYS_OF_COMMUNICATION > 0 ))  //7_DAYS_ATTRIBUTION_CHANGE_FROM_30_DAYS
),


BI_email_cust_with_txns_main  as 
(select 
a.customer_key,b.*
from
BI_email_cust_main a 
inner join 
(Select * from TXN_MASTER_DATA where year(record_datetime) >= 2024) b 
on  a.customer_key=b.sndcustomer_key ),




BI_email_with_txns_1_main  as  
(select  
//a.campaign_id,
a.campaign_name,
a.event_captured_dt,
//a.CLICK_DATE,   //ADDED_CLICK_DATE
a.type,
b.*,


case 
    when date_trunc('DAY',record_datetime) >= event_captured_dt  then datediff('DAY',event_captured_dt,record_datetime) 
end as  days_bw_commu_to_txn

from 
(select 
       //distinct campaign_id,
	   customer_key,
	   campaign_name,
	   event_captured_dt,
       CLICK_DATE,   //ADDED_CLICK_DATE
	   type 
from AK_BIRD_CAMPAIGN_EMAIL_SMS_APP_UNION 
where 
    (year(event_captured_Dt) >= 2024)
    AND 
        ((SUBSTR(ACTIVITY_CODE,3,1) ='P' AND  EMAILS_OPENED_ATLEAST_ONCE_WITHIN_7_DAYS_OF_COMMUNICATION > 0 )   //7_DAYS_ATTRIBUTION_CHANGE_FROM_30_DAYS
        OR
        (SUBSTR(ACTIVITY_CODE,3,1) IN ('E','S','I','C') AND  EMAILS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_7_DAYS_OF_COMMUNICATION > 0 ))) a  //7_DAYS_ATTRIBUTION_CHANGE_FROM_30_DAYS
  

inner join BI_email_CUST_with_txns_main b  
on a.CUSTOMER_key=b.customer_key 

where record_datetime >= event_captured_dt AND record_datetime >= CLICK_DATE  //ADDED_CLICK_DATE
and 
datediff('DAY',event_captured_dt,record_datetime) < 8),




BI_email_cust_with_txns_2_main as 
(select *,
datediff(day,event_captured_dt,record_datetime) as txn_gap

from 

(select a.*,row_number () over ( partition by  txn_id order by event_captured_dt desc ) as top 

from BI_email_with_txns_1_main a) a where  top=1),



BI_email_cust_with_txns_2_main_1 as
(

SELECT * FROM 
(
SELECT *,row_number () over (partition by CUSTOMER_KEY, CAMPAIGN_NAME, EVENT_CAPTURED_DT order by RECORD_DATETIME asc) as Recent_FIX
FROM (select * from BI_email_cust_with_txns_2_main))
),



BI_email_cust_with_txns_3_main_v1 as 
(select 
//campaign_id,
campaign_name,
type,
customer_key,
event_captured_dt,
count(1) txns,


count(case when pricing_channel in ('POS','TMT','AIR','APP','WEB') and days_bw_commu_to_txn < 8 then 1 end) txns_7days,  //7_DAYS_ATTRIBUTION_CHANGE_FROM_30_DAYS - replaced value from 7-8
sum(total_charges_usd) revenue,
sum(case when pricing_channel in ('POS','TMT','AIR','APP','WEB') and days_bw_commu_to_txn < 8 then total_charges_usd end) revenue_7days, //7_DAYS_ATTRIBUTION_CHANGE_FROM_30_DAYS - replaced value from 7-8

count(case when pricing_channel in ('POS','TMT','AIR') then 1 end) retail_txns,
count(case when pricing_channel in ('AIR') then 1 end) air_txns,
count(case when pricing_channel in ('TMT') then 1 end) TMT_txns,
count(case when pricing_channel in ('POS') then 1 end) POS_txns,
count(case when pricing_channel in ('WEB','APP') then 1 end) digital_txns,
count(case when pricing_channel in ('APP') then 1 end) app_txns,

sum(case when pricing_channel in ('POS','TMT','AIR') then total_charges_usd end) retail_revenue,
sum(case when pricing_channel in ('AIR') then total_charges_usd end) air_revenue,
sum(case when pricing_channel in ('WEB','APP') then total_charges_usd end) digital_revenue,
sum(case when pricing_channel in ('APP') then total_charges_usd end) app_revenue,

count(case when pricing_channel in ('POS','TMT','AIR') and days_bw_commu_to_txn < 8 then 1 end) retail_txns_7days,  //7_DAYS_ATTRIBUTION_CHANGE_FROM_30_DAYS - replaced value from 7-8
count(case when pricing_channel in ('AIR') and days_bw_commu_to_txn < 8 then 1 end) air_txns_7days, //7_DAYS_ATTRIBUTION_CHANGE_FROM_30_DAYS - replaced value from 7-8
count(case when pricing_channel in ('POS') and days_bw_commu_to_txn < 8 then 1 end) POS_txns_7days, //7_DAYS_ATTRIBUTION_CHANGE_FROM_30_DAYS - replaced value from 7-8
count(case when pricing_channel in ('WEB','APP') and days_bw_commu_to_txn < 8 then 1 end) digital_txns_7days,   //7_DAYS_ATTRIBUTION_CHANGE_FROM_30_DAYS - replaced value from 7-8
count(case when pricing_channel in ('APP') and days_bw_commu_to_txn < 8 then 1 end) app_txns_7days, //7_DAYS_ATTRIBUTION_CHANGE_FROM_30_DAYS - replaced value from 7-8


sum(case when Recent_FIX = 1 then 1 else 0 end) txns_recent, 
count(case when Recent_FIX = 1 and pricing_channel in ('POS','TMT','AIR','APP','WEB') and days_bw_commu_to_txn < 8 then 1 end) txns_recent_7days,   //7_DAYS_ATTRIBUTION_CHANGE_FROM_30_DAYS - replaced value from 7-8 
sum(case when Recent_FIX = 1 then total_charges_usd else 0 end) revenue_recent, 
sum(case when Recent_FIX = 1 and pricing_channel in ('POS','TMT','AIR','APP','WEB') and days_bw_commu_to_txn < 8 then total_charges_usd end) revenue_recent_7days,  //7_DAYS_ATTRIBUTION_CHANGE_FROM_30_DAYS - replaced value from 7-8

mode(case when Recent_FIX = 1 then pricing_channel end) as txn_mode,
 
count(case when Recent_FIX = 1 and pricing_channel in ('POS','TMT','AIR') then 1 end) RETAIL_RECENT_TXNS,
count(case when Recent_FIX = 1 and pricing_channel in ('AIR') then 1 end) AIR_RECENT_TXNS,
count(case when Recent_FIX = 1 and pricing_channel in ('POS') then 1 end) POS_RECENT_TXNS,
count(case when Recent_FIX = 1 and pricing_channel in ('WEB','APP') then 1 end) DIGITAL_RECENT_TXNS,
count(case when Recent_FIX = 1 and pricing_channel in ('APP') then 1 end) app_recent_txns,

sum(case when Recent_FIX = 1 and pricing_channel in ('POS','TMT','AIR') then total_charges_usd end) retail_recent_revenue,
sum(case when Recent_FIX = 1 and pricing_channel in ('AIR') then total_charges_usd end) air_recent_revenue,
sum(case when Recent_FIX = 1 and pricing_channel in ('WEB','APP') then total_charges_usd end) digital_recent_revenue,
sum(case when Recent_FIX = 1 and pricing_channel in ('APP') then total_charges_usd end) app_recent_revenue,

count(case when Recent_FIX = 1 and pricing_channel in ('POS','TMT','AIR') and days_bw_commu_to_txn < 8 then 1 end) retail_txns_recent_7days, //7_DAYS_ATTRIBUTION_CHANGE_FROM_30_DAYS - replaced value from 7-8
count(case when Recent_FIX = 1 and pricing_channel in ('AIR') and days_bw_commu_to_txn < 8 then 1 end) air_txns_recent_7days, //7_DAYS_ATTRIBUTION_CHANGE_FROM_30_DAYS - replaced value from 7-8
count(case when Recent_FIX = 1 and pricing_channel in ('POS') and days_bw_commu_to_txn < 8 then 1 end) POS_txns_recent_7days, //7_DAYS_ATTRIBUTION_CHANGE_FROM_30_DAYS - replaced value from 7-8
count(case when Recent_FIX = 1 and pricing_channel in ('WEB','APP') and days_bw_commu_to_txn < 8 then 1 end) digital_txns_recent_7days, //7_DAYS_ATTRIBUTION_CHANGE_FROM_30_DAYS - replaced value from 7-8
count(case when Recent_FIX = 1 and pricing_channel in ('APP') and days_bw_commu_to_txn < 8 then 1 end) app_txns_recent_7days //7_DAYS_ATTRIBUTION_CHANGE_FROM_30_DAYS - replaced value from 7-8

from BI_email_cust_with_txns_2_main_1 group by 1,2,3,4),


BI_r2d_1x_lapsed_flags_v2_main as 
(select 
  //a.campaign_id,
  campaign_name,a.type,a.customer_key,event_captured_dt,
  count(case when datediff('DAY',e.record_datetime,event_captured_dt) < 182 then e.txn_id end ) as r6_txns,     //Churn_reduction_metric
  count(case when datediff('DAY',e.record_datetime,event_captured_dt) < 365 then e.txn_id end ) as r12_txns,
  count(case when datediff('DAY',e.record_datetime,event_captured_dt) < 730 then e.txn_id end ) as r24_txns,
  count(case when datediff('DAY',e.record_datetime,event_captured_dt) < 1095 then e.txn_id end ) as r36_txns,
  count(case when datediff('DAY',e.record_datetime,event_captured_dt) < 1460 then e.txn_id end ) as r48_txns,

  MODE(CASE WHEN datediff('DAY',e.record_datetime,event_captured_dt) < 182 THEN PRICING_CHANNEL END) AS R6_CHANNEL,     //Churn_reduction_metric
  MODE(CASE WHEN datediff('DAY',e.record_datetime,event_captured_dt) < 365 THEN PRICING_CHANNEL END) AS R12_CHANNEL,
  MODE(CASE WHEN datediff('DAY',e.record_datetime,event_captured_dt) < 730 THEN PRICING_CHANNEL END) AS R24_CHANNEL,
  MODE(CASE WHEN datediff('DAY',e.record_datetime,event_captured_dt) < 1095 THEN PRICING_CHANNEL END) AS R36_CHANNEL,
  MODE(CASE WHEN datediff('DAY',e.record_datetime,event_captured_dt) < 1460 THEN PRICING_CHANNEL END) AS R48_CHANNEL,

  COUNT(CASE WHEN datediff('DAY',e.record_datetime,event_captured_dt) < 182 AND pricing_channel in ('APP') THEN 1 END) AS R6_APP_COUNT,     //Churn_reduction_metric
  COUNT(CASE WHEN datediff('DAY',e.record_datetime,event_captured_dt) < 365 AND pricing_channel in ('APP') THEN 1 END) AS R12_APP_COUNT,
  COUNT(CASE WHEN datediff('DAY',e.record_datetime,event_captured_dt) < 730 AND pricing_channel in ('APP') THEN 1 END) AS R24_APP_COUNT,
  COUNT(CASE WHEN datediff('DAY',e.record_datetime,event_captured_dt) < 1095 AND pricing_channel in ('APP') THEN 1 END) AS R36_APP_COUNT,
  COUNT(CASE WHEN datediff('DAY',e.record_datetime,event_captured_dt) < 1460 AND pricing_channel in ('APP') THEN 1 END) AS R48_APP_COUNT,
  
  count(case when datediff('DAY',e.record_datetime,event_captured_dt) < 365 and 
        pricing_channel in ('POS','AIR','TMT') then e.txn_id end ) R12_retail_txns,
        
  count   (case when datediff('DAY',e.record_datetime,event_captured_dt) < 365 and 
        pricing_channel in ('WEB','APP') then e.txn_id end ) R12_digital_txns,
        
  count(case when datediff('DAY',e.record_datetime,event_captured_dt) < 730 and 
        pricing_channel in ('POS','AIR','TMT') then e.txn_id end ) R24_retail_txns,
        
  count(case when datediff('DAY',e.record_datetime,event_captured_dt) < 730 and 
        pricing_channel in ('WEB','APP') then e.txn_id end ) R24_digital_txns,
        
  count(case when datediff('DAY',e.record_datetime,event_captured_dt) < 1095 and 
        pricing_channel in ('POS','AIR','TMT') then e.txn_id end ) R36_retail_txns,
        
  count(case when datediff('DAY',e.record_datetime,event_captured_dt) < 1095 and 
        pricing_channel in ('WEB','APP') then e.txn_id end ) R36_digital_txns,
  
  count(case when datediff('DAY',e.record_datetime,event_captured_dt) < 1460 and 
        pricing_channel in ('POS','AIR','TMT') then e.txn_id end ) R48_retail_txns,
        
  count(case when datediff('DAY',e.record_datetime,event_captured_dt) < 1460 and 
        pricing_channel in ('WEB','APP') then e.txn_id end ) R48_digital_txns,
        
 mode( 
  case when datediff('DAY',e.record_datetime,event_captured_dt) < 365 then rcvcountry_code end
       ) as corridor,
       
  case when r12_txns=1 then 'Y' else 'N' end one_x,
  case when R12_retail_txns > 0 and R12_digital_txns=0 then 'Y' else 'N' end retail_only,
  case when r48_txns > 0 and r12_txns=0 then 'Y' else 'N' end Lapsed

from 
(select distinct //campaign_id,
        campaign_name,customer_key,event_captured_dt,type from AK_BIRD_CAMPAIGN_EMAIL_SMS_APP_UNION) a 
left outer join 
(select sndcustomer_key,
 txn.record_datetime ,txn.txn_id,txn.pricing_channel,rcvcountry_code
 from TXN_MASTER_DATA txn
)e  
on a.CUSTOMER_key=e.sndcustomer_key
where date_trunc('DAY',e.record_datetime) <= event_captured_dt and 
datediff('DAY',e.record_datetime,event_captured_dt) < 1460 and
(year(event_captured_Dt) >= 2024) 
group by 1,2,3,4),



BI_r2d_1x_lapsed_30days_flags_v2_main as 
(select 
        //a.campaign_id,
		a.campaign_name,
		a.type,
		a.customer_key,
		a.event_captured_dt,
        one_x,retail_only,
		Lapsed,r12_txns,
        r6_txns,        //Churn_reduction_metric
        R6_CHANNEL,     //Churn_reduction_metric
        R6_APP_COUNT,       //Churn_reduction_metric
		r24_txns,
		r36_txns,
		r48_txns,
        r12_retail_txns,
		r12_digital_txns,
		r24_retail_txns,
		r24_digital_txns,
		r36_retail_txns,
		r36_digital_txns,
		r48_retail_txns,
		r48_digital_txns,
        r12_channel,
		r24_channel,
		r36_channel,
		r48_channel,
        corridor,
        r12_app_Count,
		r24_app_Count,
		r36_app_Count,
		r48_app_Count,
        count(b.txn_id) as txns_30_days,
        count(case when pricing_channel in ('WEB','APP') then b.txn_id end ) as digital_txns_30days,
        case when r12_retail_txns > 0 and r12_digital_txns =0 and digital_txns_30days > 0 then 'Y' else 'N' end R2D,
        case when r36_txns > 0 and r12_txns =0 and txns_30_days > 0 then 'Y' else 'N' end winbacks,
        case when r36_txns = 0 and r12_txns =0 and txns_30_days > 0 then 'Y' else 'N' end new_customer,
        case when r12_txns=1 and txns_30_days > 0 then 'Y' else 'N' end onex_to_twox_and_plus,
        case when r12_txns=2 and txns_30_days > 0 THEN 'Y' else 'N' end twox_to_threex_and_plus,
        case when r12_txns=3 and txns_30_days > 0 THEN 'Y' else 'N' end threex_to_fourx_and_plus,
        case when r12_txns=4 and txns_30_days > 0 THEN 'Y' else 'N' end fourx_to_fivex_and_plus
from 
      BI_r2d_1x_lapsed_flags_v2_main a 
left outer join  
(select 
       case when length(sndcustomer_key) IN (9,15,19) then sndcustomer_key else to_char(g.cdb_customer_id) end as sndcustomer_key,
       txn.record_datetime ,txn.txn_id,txn.pricing_channel,rcvcountry_code//,funds_in,funds_out
 from TXN_MASTER_DATA txn
left outer join "WUDNA"."SUMMARY_GEN"."CDB_ID_GALACTIC_ID_MAPPING_VW" G on txn.sndcustomer_key=to_char(g.rtra_galactic_id)
)b  

on a.CUSTOMER_key=b.sndcustomer_key 

and date_trunc('DAY',b.record_datetime) >= event_captured_dt and 
datediff('DAY',event_captured_dt,b.record_datetime) < 8         //7_DAYS_ATTRIBUTION_CHANGE_FROM_30_DAYS - replaced value from 32-8
group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31),


BI_r2d_1x_lapsed_30days_flags_v3_main as
(select 
a.*,
  case when r6_txns > 0 then 'R6 Active'        //Churn_reduction_metric    //Replaced 'r6_active' to 'R6 Active'
       when r12_txns > 0 then 'R7 to R12 Active'    //Replaced 'r12_active' to 'R7 to R12 Active'   
       when r12_txns = 0 and r24_txns > 0 then 'Lapsing'
       when r24_txns = 0 and r36_txns > 0 then 'Lapsed'
       when r36_txns = 0 and r48_txns > 0 then 'Uber Lapsed'
       end as Activity_status,
       
  CASE WHEN Activity_status IN ('R6 Active','R7 to R12 Active') and R12_CHANNEL NOT IN ('WEB','APP') THEN 'RETAIL'  
       when Activity_status IN ('R6 Active','R7 to R12 Active') and R12_CHANNEL IN ('WEB','APP') THEN R12_CHANNEL
       WHEN Activity_status IN ('Lapsing') and R24_CHANNEL NOT IN ('WEB','APP') THEN 'RETAIL'  
       when Activity_status IN ('Lapsing') and R24_CHANNEL IN ('WEB','APP') THEN R24_CHANNEL
       WHEN Activity_status IN ('Lapsed') and R36_CHANNEL NOT IN ('WEB','APP') THEN 'RETAIL'  
       when Activity_status IN ('Lapsed') and R36_CHANNEL IN ('WEB','APP') THEN R36_CHANNEL  
       WHEN Activity_status IN ('Uber Lapsed') and R48_CHANNEL NOT IN ('WEB','APP') THEN 'RETAIL'  
       when Activity_status IN ('Uber Lapsed') and R48_CHANNEL IN ('WEB','APP') THEN R48_CHANNEL end channel_dominance,
  case when r12_txns > 0 and r12_txns <> r48_txns then 'Existing'
       when r12_txns > 0 and r12_txns = r48_txns then 'New' end tenure_status,
       
  case when Activity_status in ('R6 Active','R7 to R12 Active') and R12_retail_txns > 0 and R12_digital_txns=0 then 'RETAIL'
       when Activity_status in ('R6 Active','R7 to R12 Active') and R12_retail_txns = 0 and R12_digital_txns > 0 then 'DIGITAL'
       when Activity_status in ('R6 Active','R7 to R12 Active') and R12_retail_txns > 0 and R12_digital_txns > 0 THEN 'OMNI' 
       when Activity_status in ('Lapsing') and R24_retail_txns > 0 and R24_digital_txns=0 then 'RETAIL'
       when Activity_status in ('Lapsing') and R24_retail_txns = 0 and R24_digital_txns > 0 then 'DIGITAL'
       when Activity_status in ('Lapsing') and R24_retail_txns > 0 and R24_digital_txns > 0 THEN 'OMNI'
       when Activity_status in ('Lapsed') and R36_retail_txns > 0 and R36_digital_txns=0 then 'RETAIL'
       when Activity_status in ('Lapsed') and R36_retail_txns = 0 and R36_digital_txns > 0 then 'DIGITAL'
       when Activity_status in ('Lapsed') and R36_retail_txns > 0 and R36_digital_txns > 0 THEN 'OMNI' 
       when Activity_status in ('Uber Lapsed') and R48_retail_txns > 0 and R48_digital_txns=0 then 'RETAIL'
       when Activity_status in ('Uber Lapsed') and R48_retail_txns = 0 and R48_digital_txns > 0 then 'DIGITAL'
       when Activity_status in ('Uber Lapsed') and R48_retail_txns > 0 and R48_digital_txns > 0 THEN 'OMNI' end txn_channel,

 CASE WHEN Activity_status IN ('R6 Active','R7 to R12 Active') and R12_APP_COUNT > 0 THEN 'Y'
        else 'N' end APP_MARKETABLE

from BI_r2d_1x_lapsed_30days_flags_v2_main a),

pre_joined as
(
  select
   a.*,
   f.REDEMPTION_DATE as mth_yr,
   f.REDEEMED_POINTS as POINTS_REDEEMED_TM,
   e.membership_date,
   EMAIL_ADDRESS_ON_FILE_FLAG,
   MOBILE_NUMBER_ON_FILE_FLAG,
   opt_email,opt_sms,
   b.hvc_flag,
   b.country_code,
   marketing_flag,
   b.PREFERRED_REGISTRATION_CHANNEL,
   b.loyalty_member_flag,
   b.DOUBLE_OPT_SMS
 from
  BI_r2d_1x_lapsed_30days_flags_v3_main a
 left join


"WUDNA"."SUMMARY_GEN"."WUDNA_CUSTOMER_MASTER_VW" b ON 
a.customer_key = b.customer_key 

left join 

(select 
         CUSTOMER_KEY, 
        -- date_trunc(month,REDEMPTION_DATE) as REDEMPTION_DATE,
        REDEMPTION_DATE,
        sum(REDEEMED_POINTS) as REDEEMED_POINTS
		from 
summary_gen.WUDNA_REDEEMED_POINTS_RCX_VW
group by 1,2) f ON 

a.customer_key = f.CUSTOMER_KEY

LEFT JOIN
SJ_CS_CUST_MEMBERSHIP_DATE e
on a.customer_key = e.customer_key
),

BI_R2D_1X_LAPSED_30DAYS_FLAGS_V2_MAIN_UPDATED AS
(
select
      customer_key, 
	  event_captured_Dt, 
	  campaign_name,
	  //campaign_id,
	  type,
	  activity_status,
      one_x,
	  retail_only,
	  Lapsed,
      r6_txns,        //Churn_reduction_metric
      R6_CHANNEL,     //Churn_reduction_metric
      R6_APP_COUNT,       //Churn_reduction_metric
	  r12_txns,
	  r24_txns,
	  r36_txns,
	  r12_retail_txns,
	  r12_digital_txns,
	  corridor,
	  digital_txns_30days,
	  r48_txns,
      r2d,
	  winbacks,
	  onex_to_twox_and_plus,
	  txn_channel,
	  NEW_CUSTOMER,
	  TWOX_TO_THREEX_AND_PLUS,
	  THREEX_TO_FOURX_AND_PLUS,
      FOURX_TO_FIVEX_AND_PLUS,
	  r24_retail_txns,
	  r24_digital_txns,
	  r36_retail_txns,
	  r36_digital_txns,
	  channel_dominance,
	  tenure_status,
      txns_30_days,APP_MARKETABLE,

case when (EMAIL_ADDRESS_ON_FILE_FLAG = 'Y' OR  MOBILE_NUMBER_ON_FILE_FLAG = 'Y' or App_marketable='Y' ) then 'Y' else 'N' end as Flag_addressable,

case when COUNTRY_CODE not in ('US','CA') and ((EMAIL_ADDRESS_ON_FILE_FLAG = 'Y' and opt_email='I' and marketing_flag='Y') OR  (MOBILE_NUMBER_ON_FILE_FLAG = 'Y' AND opt_sms = 'I' and marketing_flag='Y') or App_marketable='Y')  then 'Y'  
    when COUNTRY_CODE in ('US','CA') and ((EMAIL_ADDRESS_ON_FILE_FLAG = 'Y' and opt_email='I' and marketing_flag='Y') OR  
    (MOBILE_NUMBER_ON_FILE_FLAG = 'Y' AND opt_sms = 'I' AND DOUBLE_OPT_SMS = 'I' and marketing_flag='Y') 
    or App_marketable='Y') then 'Y' ELSE 'N' end as Flag_marketable,

case when email_address_on_file_flag = 'Y' then 1 else 0 end as email_addressable,

case when mobile_number_on_File_Flag ='Y' then 1 else 0 end as sms_addressable,

case when email_address_on_file_flag = 'Y' and opt_email = 'I' and marketing_flag='Y' then 'Y' else 'N' end as Email_Marketable,

case when country_code not in ('US','CA') 
        and OPT_SMS = 'I' and mobile_number_on_File_Flag ='Y' and marketing_flag='Y' then 'Y' 
	when country_code in ('US','CA') AND MOBILE_NUMBER_ON_FILE_FLAG = 'Y' AND opt_sms = 'I' AND DOUBLE_OPT_SMS = 'I' and marketing_flag='Y' then 'Y' else 'N' end as SMS_Marketable ,
    
 
 sum(case when date_trunc('DAY',mth_yr) < EVENT_CAPTURED_DT and
 datediff('DAY',mth_yr,EVENT_CAPTURED_DT) < 365 AND POINTS_REDEEMED_TM > 0 then 1 ELSE null END) R12_REDEEMER,
 
 sum(case when date_trunc('DAY',mth_yr) < EVENT_CAPTURED_DT and
 datediff('DAY',mth_yr,EVENT_CAPTURED_DT) < 720 AND POINTS_REDEEMED_TM > 0 then 1 ELSE null END) R24_REDEEMER,
     
 sum(case when date_trunc('DAY',mth_yr) < EVENT_CAPTURED_DT and
 datediff('DAY',mth_yr,EVENT_CAPTURED_DT) < 1095 AND POINTS_REDEEMED_TM > 0 then 1 ELSE null END) R36_REDEEMER,
 
 sum(case when date_trunc('DAY',mth_yr) < EVENT_CAPTURED_DT and
 datediff('DAY',mth_yr,EVENT_CAPTURED_DT) < 1460 AND POINTS_REDEEMED_TM > 0 then 1 ELSE null END) R48_REDEEMER,
 
 sum(CASE WHEN date_trunc('DAY',MEMBERSHIP_DATE) < EVENT_CAPTURED_DT and  
           datediff('DAY',MEMBERSHIP_DATE,EVENT_CAPTURED_DT) is not null then 1 ELSE null END) LOYALTY,
 
 case when activity_status in ('R6 Active','R7 to R12 Active') and R12_REDEEMER > 0 AND LOYALTY > 0 then 'Member_Redeemer'
      when activity_status in ('R6 Active','R7 to R12 Active') and (R12_REDEEMER = 0 OR r12_redeemer is null) AND LOYALTY > 0 then 'Member_Non-Redeemer'
      when LOYALTY = 0 or loyalty is null then 'Non_Member'
      when activity_status in ('Lapsing') and R24_REDEEMER > 0 AND LOYALTY > 0 then 'Member_Redeemer'
      when activity_status in ('Lapsing') and (R24_REDEEMER = 0 OR r24_redeemer is null) AND LOYALTY > 0 then 'Member_Non-Redeemer'
      when activity_status in ('Lapsed') and R36_REDEEMER > 0 AND LOYALTY > 0 then 'Member_Redeemer'
      when activity_status in ('Lapsed') and (R36_REDEEMER = 0 OR r36_redeemer is null) AND LOYALTY > 0 then 'Member_Non-Redeemer'
      when activity_status in ('Uber Lapsed') and R48_REDEEMER > 0 AND LOYALTY > 0 then 'Member_Redeemer'
      when activity_status in ('Uber Lapsed') and (R48_REDEEMER = 0 OR r48_redeemer is null) AND LOYALTY > 0 then 'Member_Non-Redeemer'
      else 'Non_Member'
      END MyWU_flag,
 
sum(case when date_trunc('DAY',MEMBERSHIP_DATE) >= event_captured_dt and
datediff('DAY',event_captured_dt,MEMBERSHIP_DATE) < 8 then 1 ELSE null end) registered_30_days_1,	//7_DAYS_ATTRIBUTION_CHANGE_FROM_30_DAYS - replaced value from 30-8
 
sum(case when date_trunc('DAY',MEMBERSHIP_DATE) >= event_captured_dt and
datediff('DAY',event_captured_dt,MEMBERSHIP_DATE) < 8 and LOYALTY_MEMBER_FLAG IN ('Y') then 1 ELSE null END) LOYALTY_REGISTRATION_1,
                                                       
sum(CASE WHEN date_trunc('DAY',MEMBERSHIP_DATE) >= event_captured_dt and
datediff('DAY',event_captured_dt,MEMBERSHIP_DATE) < 8
and PREFERRED_REGISTRATION_CHANNEL IN ('WEB','SmartPhone - R2','WEB - R1','WEB - R2') then 1 ELSE null END) DIGITAL_REGISTRATION_1,
 
sum(CASE WHEN date_trunc('DAY',MEMBERSHIP_DATE) < event_captured_dt and
datediff('DAY',MEMBERSHIP_DATE,event_captured_dt) < 1095 then 1 ELSE null END) PRIOR_REGISTRATION_1,  

sum(case when event_captured_dt <= date_trunc('DAY',mth_yr) and
datediff('DAY',event_captured_dt,mth_yr) < 8 AND POINTS_REDEEMED_TM > 0 then 1 ELSE null END) redeem_30_days_1,	//7_DAYS_ATTRIBUTION_CHANGE_FROM_30_DAYS - replaced value from 30-8
 
case when registered_30_days_1 > 0 then 'Y' ELSE 'N' END AS registered_30_days,
CASE WHEN redeem_30_days_1 > 0 then 'Y' ELSE 'N' END AS redeem_30_days,
case when PRIOR_REGISTRATION_1 > 0 then 'Y' ELSE 'N' END AS PRIOR_REGISTRATION,
CASE WHEN LOYALTY_REGISTRATION_1 > 0 THEN 'Y' ELSE 'N' END AS LOYALTY_REGISTRATION,
CASE WHEN DIGITAL_REGISTRATION_1 > 0 THEN 'Y' ELSE 'N' END AS DIGITAL_REGISTRATION                                                       
 
from 
pre_joined a 
group by 
customer_key, event_captured_Dt, campaign_name,type,//campaign_id,
activity_status,
one_x,retail_only,Lapsed,
r6_txns,        //Churn_reduction_metric
R6_CHANNEL,     //Churn_reduction_metric
R6_APP_COUNT,       //Churn_reduction_metric
r12_txns,r24_txns,r36_txns,r12_retail_txns,r12_digital_txns,corridor,digital_txns_30days,r48_txns,
r2d,winbacks,onex_to_twox_and_plus,txn_channel,NEW_CUSTOMER,TWOX_TO_THREEX_AND_PLUS,THREEX_TO_FOURX_AND_PLUS,
FOURX_TO_FIVEX_AND_PLUS,r24_retail_txns,r24_digital_txns,r36_retail_txns,r36_digital_txns,channel_dominance,tenure_status,
txns_30_days,FLAG_ADDRESSABLE,FLAG_MARKETABLE,EMAIL_ADDRESSABLE,EMAIL_MARKETABLE,SMS_ADDRESSABLE,SMS_MARKETABLE,APP_MARKETABLE),

BI_email_cust_migrated_v2_main  as  
(select  
distinct 
a.*,
r6_txns,        //Churn_reduction_metric
R6_CHANNEL,     //Churn_reduction_metric
R6_APP_COUNT,       //Churn_reduction_metric
one_x,retail_only,Lapsed,r12_txns,r24_txns,r36_txns,r12_retail_txns,r12_digital_txns,corridor,digital_txns_30days,r48_txns,
r2d,winbacks,onex_to_twox_and_plus,txn_channel,NEW_CUSTOMER,TWOX_TO_THREEX_AND_PLUS,THREEX_TO_FOURX_AND_PLUS,
FOURX_TO_FIVEX_AND_PLUS,REGISTERED_30_DAYS,LOYALTY_REGISTRATION,DIGITAL_REGISTRATION,txns_30_days AS TXNS_30_DAYS_1,PRIOR_REGISTRATION,
r24_retail_txns,r24_digital_txns,r36_retail_txns,r36_digital_txns,Activity_status,MyWU_flag,channel_dominance,
FLAG_ADDRESSABLE,FLAG_MARKETABLE,EMAIL_ADDRESSABLE,EMAIL_MARKETABLE,SMS_ADDRESSABLE,SMS_MARKETABLE,tenure_status,redeem_30_days,APP_MARKETABLE
from 
(select distinct //campaign_id,
            campaign_name,customer_key,event_captured_dt from AK_BIRD_CAMPAIGN_EMAIL_SMS_APP_UNION 
where 
(year(event_captured_Dt) >= 2024)) a 
left outer join BI_R2D_1X_LAPSED_30DAYS_FLAGS_V2_MAIN_UPDATED e 
on //nvl(a.campaign_id,'NA')=nvl(e.campaign_id,'NA') and 
    a.campaign_name=e.campaign_name and a.customer_key=e.customer_key and a.event_captured_dt=e.event_captured_dt), 

BI_campaign_wise_email_communications_1_v2_main as 
(select 
a.*,
TXNS,
REVENUE,
RETAIL_TXNS,
air_txns,
pos_txns,
DIGITAL_TXNS,
APP_TXNS,
TXNS_7days,
RETAIL_TXNS_7days,
air_txns_7days,
pos_txns_7days,
DIGITAL_TXNS_7days,
APP_TXNS_7days, 
TMT_txns,
r6_txns,        //Churn_reduction_metric
R6_CHANNEL,     //Churn_reduction_metric
R6_APP_COUNT,       //Churn_reduction_metric
one_x,retail_only,Lapsed,r12_txns,r24_txns,r36_txns,r12_retail_txns,r12_digital_txns,corridor,
digital_txns_30days,r2d,winbacks,onex_to_twox_and_plus,txn_channel,r48_txns,
NEW_CUSTOMER,TWOX_TO_THREEX_AND_PLUS,THREEX_TO_FOURX_AND_PLUS,
FOURX_TO_FIVEX_AND_PLUS,REGISTERED_30_DAYS,LOYALTY_REGISTRATION,DIGITAL_REGISTRATION,TXNS_30_DAYS_1,PRIOR_REGISTRATION,
r24_retail_txns,r24_digital_txns,r36_retail_txns,r36_digital_txns,Activity_status,MyWU_flag,channel_dominance,
FLAG_ADDRESSABLE,FLAG_MARKETABLE,EMAIL_ADDRESSABLE,EMAIL_MARKETABLE,SMS_ADDRESSABLE,SMS_MARKETABLE,tenure_status,redeem_30_days,APP_MARKETABLE,TXNS_RECENT,TXNS_RECENT_7DAYS,
REVENUE_RECENT,REVENUE_RECENT_7DAYS,TXN_MODE,RETAIL_RECENT_TXNS,AIR_RECENT_TXNS,POS_RECENT_TXNS,DIGITAL_RECENT_TXNS,APP_RECENT_TXNS,RETAIL_RECENT_REVENUE,AIR_RECENT_REVENUE,
DIGITAL_RECENT_REVENUE,APP_RECENT_REVENUE,RETAIL_TXNS_RECENT_7DAYS,AIR_TXNS_RECENT_7DAYS,POS_TXNS_RECENT_7DAYS,DIGITAL_TXNS_RECENT_7DAYS,APP_TXNS_RECENT_7DAYS
from AK_BIRD_CAMPAIGN_EMAIL_SMS_APP_UNION  a 
left outer join BI_email_cust_with_txns_3_main_v1 b 
on //nvl(a.campaign_id,'NA')=nvl(b.campaign_id,'NA') and 
    a.campaign_name=b.campaign_name and a.customer_key=b.customer_key and a.event_captured_dt=b.event_captured_dt
left outer join BI_EMAIL_CUST_MIGRATED_V2_MAIN d
on //nvl(a.campaign_id,'NA')=nvl(d.campaign_id,'NA') and 
    a. campaign_name=d.campaign_name and a.customer_key=d.customer_key and a.event_captured_dt=d.event_captured_dt
where 
(year(a.event_captured_Dt) >= 2024)),

BI_CAMPAIGN_WISE_EMAIL_COMMUNICATIONS_1_V2_updated_main as 
(select a.*,
CASE WHEN ACTIVITY_STATUS IN ('R6 Active','R7 to R12 Active') and R12_TXNs <= 3 THEN CAST(R12_TXNs AS VARCHAR)
     when ACTIVITY_STATUS IN ('R6 Active','R7 to R12 Active') and R12_TXNs > 3 then '4XandPlus'
       WHEN ACTIVITY_STATUS IN ('Lapsing') and R24_TXNs <= 3 THEN CAST(R24_TXNs AS VARCHAR)
       when ACTIVITY_STATUS IN ('Lapsing') and R24_TXNs > 3 then '4XandPlus'
       WHEN ACTIVITY_STATUS IN ('Lapsed') and R36_TXNs  <= 3 THEN CAST(R36_TXNs AS VARCHAR)
       WHEN ACTIVITY_STATUS IN ('Lapsed') and R36_TXNs  > 3 THEN '4XandPlus'
       WHEN ACTIVITY_STATUS IN ('Uber Lapsed') and R48_TXNs  <= 3 THEN CAST(R48_TXNs AS VARCHAR)
       WHEN ACTIVITY_STATUS IN ('Uber Lapsed') and R48_TXNs  > 3 THEN '4XandPlus'
       else 'RNT'
       end TPC_FLAG,
b.hvc_flag
from BI_CAMPAIGN_WISE_EMAIL_COMMUNICATIONS_1_V2_main a

left join "WUDNA"."SUMMARY_GEN"."WUDNA_CUSTOMER_MASTER_VW" b on a.customer_key = b.customer_key),	

BI_CAMPAIGN_WISE_RFM_PERSONA as (	
select	
    a.*,    	
    b.RFM_PERSONA	
from	
    BI_CAMPAIGN_WISE_EMAIL_COMMUNICATIONS_1_V2_updated_main as a	
left join	
    WUDNA.CEX_SANDBOX.SK_CONSOLIDATED_PROPENSITY_SCORES as b	
on	
    a.customer_key=b.sndcustomer_key	
AND	
     date_trunc('month',date(a.event_captured_dt)) = date(b.MTH_YR))	
select * from BI_CAMPAIGN_WISE_RFM_PERSONA`;





var sql_command_33 = 
	`INSERT INTO BIRD_CAMPAIGN_LOG
Select 
    'AK_BIRD_CAMPAIGN_COMMUNICATION_CUSTOMER_LEVEL',
    CURRENT_TIMESTAMP,
    count(1) , 
    Count(distinct CAMPAIGN_NAME), 
    sum(CUSTOMERS_OPENING_ATLEAST_ONE_MAIL_WITHIN_30_DAYS_OF_COMMUNICATION),
    sum(CUSTOMERS_CLICKING_ATLEAST_ONE_MAIL_WITHIN_30_DAYS_OF_COMMUNICATION) 
from AK_BIRD_CAMPAIGN_COMMUNICATION_CUSTOMER_LEVEL`;


//=======================================================================================================================================
//===============================(FINAL CUSTOMER-CAMPAIGN LEVEL WITH ALL AATTRIBUTES AND ENGAGEMENT METRICS)=============================
//=======================================================================================================================================


var sql_command_34 =
`CREATE or replace TABLE SJ_BI_CAMPAIGN_WISE_EMAIL_COMMUNICATIONS_2_V2_MYWU_UPDATE_CUSTOMER_LEVEL AS

WITH BIRD_SFMC_CUSTOMER_CAMPAIGN_LEVEL_UNION AS 

    (
select 
    COUNTRY, EVENT_CAPTURED_DT, CAMPAIGN_NAME, MARKETING_STRATEGY, RESEND_FLAG, ACTIVITY_CODE, TOTAL_EMAILS_SENT, EMAILS_UN_DELIVERED, EMAILS_OPENED_ATLEAST_ONCE_WITHIN_30_DAYS_OF_COMMUNICATION, EMAILS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_30_DAYS_OF_COMMUNICATION, EMAILS_LEADING_TO_A_WU_COM_HIT_WITHIN_30_DAYS_OF_COMMUNICATION, EMAILS_REGISTRATIONS, EMAILS_SIGN_INS, EMAILS_REG_ATTEMPTS, EMAILS_LOGIN_ATTEMPTS, EMAILS_TXN_STARTS, EMAILS_TXN_SUBMITS, EMAILS_RECEIPTS, REGISTRATIONS, SIGN_INS, REG_ATTEMPTS, LOGIN_ATTEMPTS, TXN_STARTS, TXN_SUBMITS, RECEIPTS, RECEIPTS_REVENUE, CUSTOMERS_CONTACTED_ATLEAST_ONCE_BY_EMAIL, CUSTOMERS_BOUNCED_ATLEAST_ONE_EMAIL, CUSTOMERS_OPENING_ATLEAST_ONE_MAIL_WITHIN_30_DAYS_OF_COMMUNICATION, CUSTOMERS_CLICKING_ATLEAST_ONE_MAIL_WITHIN_30_DAYS_OF_COMMUNICATION, CUSTOMERS_COMPLAINING_ABOUT_SPAM, CUSTOMERS_OPTING_OUT_OF_EMAIL_MARKETING, CUSTOMERS_VISITING_WU_COM_IN_30_DAYS, BAD_CLICKS, UNIQUE_CLICKS, EMAILS_OPENED_ATLEAST_ONCE_WITHIN_7_DAYS_OF_COMMUNICATION, EMAILS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_7_DAYS_OF_COMMUNICATION, PUSH_OPEN_COUNT, PUSH_INFLU_OPEN_COUNT, PUSH_BOUNCE_COUNT, INAPPMSG_VIEWED_COUNT, INAPPMSG_CLICKED_COUNT, CC_CLICKED_COUNT, CC_VIEWED_COUNT, CC_DISMISSED_COUNT, CC_ABORTED_COUNT, PUSH_SENT_COUNT, CC_SENT_COUNT, TYPE, CAMPAIGN_CANVAS_NAME, CANVAS_STEP_NAME_NEW, COMM_CHANNEL, CUSTOMER_ID, CUSTOMER_KEY, TXNS, REVENUE, RETAIL_TXNS, AIR_TXNS, POS_TXNS, DIGITAL_TXNS, APP_TXNS, TXNS_7DAYS, RETAIL_TXNS_7DAYS, AIR_TXNS_7DAYS, POS_TXNS_7DAYS, DIGITAL_TXNS_7DAYS, APP_TXNS_7DAYS, TMT_TXNS, ONE_X, RETAIL_ONLY, LAPSED,
R6_TXNS,    //Churn_reduction_metric 
R6_CHANNEL,     //Churn_reduction_metric
R6_APP_COUNT,   //Churn_reduction_metric

    R12_TXNS, R24_TXNS, R36_TXNS, R12_RETAIL_TXNS, R12_DIGITAL_TXNS, CORRIDOR, DIGITAL_TXNS_30DAYS, R2D, WINBACKS, ONEX_TO_TWOX_AND_PLUS, TXN_CHANNEL, R48_TXNS, NEW_CUSTOMER, TWOX_TO_THREEX_AND_PLUS, THREEX_TO_FOURX_AND_PLUS, FOURX_TO_FIVEX_AND_PLUS, REGISTERED_30_DAYS, LOYALTY_REGISTRATION, DIGITAL_REGISTRATION, TXNS_30_DAYS_1, PRIOR_REGISTRATION, R24_RETAIL_TXNS, R24_DIGITAL_TXNS, R36_RETAIL_TXNS, R36_DIGITAL_TXNS, ACTIVITY_STATUS, MYWU_FLAG, CHANNEL_DOMINANCE, FLAG_ADDRESSABLE, FLAG_MARKETABLE, EMAIL_ADDRESSABLE, EMAIL_MARKETABLE, SMS_ADDRESSABLE, SMS_MARKETABLE, TENURE_STATUS, REDEEM_30_DAYS, APP_MARKETABLE, TXNS_RECENT, TXNS_RECENT_7DAYS, REVENUE_RECENT, REVENUE_RECENT_7DAYS, TXN_MODE, RETAIL_RECENT_TXNS, AIR_RECENT_TXNS, POS_RECENT_TXNS, DIGITAL_RECENT_TXNS, APP_RECENT_TXNS, RETAIL_RECENT_REVENUE, AIR_RECENT_REVENUE, DIGITAL_RECENT_REVENUE, APP_RECENT_REVENUE, RETAIL_TXNS_RECENT_7DAYS, AIR_TXNS_RECENT_7DAYS, POS_TXNS_RECENT_7DAYS, DIGITAL_TXNS_RECENT_7DAYS, APP_TXNS_RECENT_7DAYS, TPC_FLAG, HVC_FLAG, RFM_PERSONA

from AK_BIRD_CAMPAIGN_COMMUNICATION_CUSTOMER_LEVEL

union all

select
    COUNTRY, EVENT_CAPTURED_DT, //CAMPAIGN_ID, 
    CAMPAIGN_NAME, MARKETING_STRATEGY, RESEND_FLAG, ACTIVITY_CODE, TOTAL_EMAILS_SENT, EMAILS_UN_DELIVERED, EMAILS_OPENED_ATLEAST_ONCE_WITHIN_30_DAYS_OF_COMMUNICATION, EMAILS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_30_DAYS_OF_COMMUNICATION, EMAILS_LEADING_TO_A_WU_COM_HIT_WITHIN_30_DAYS_OF_COMMUNICATION, EMAILS_REGISTRATIONS, EMAILS_SIGN_INS, EMAILS_REG_ATTEMPTS, EMAILS_LOGIN_ATTEMPTS, EMAILS_TXN_STARTS, EMAILS_TXN_SUBMITS, EMAILS_RECEIPTS, REGISTRATIONS, SIGN_INS, REG_ATTEMPTS, LOGIN_ATTEMPTS, TXN_STARTS, TXN_SUBMITS, RECEIPTS, RECEIPTS_REVENUE, CUSTOMERS_CONTACTED_ATLEAST_ONCE_BY_EMAIL, CUSTOMERS_BOUNCED_ATLEAST_ONE_EMAIL, CUSTOMERS_OPENING_ATLEAST_ONE_MAIL_WITHIN_30_DAYS_OF_COMMUNICATION, CUSTOMERS_CLICKING_ATLEAST_ONE_MAIL_WITHIN_30_DAYS_OF_COMMUNICATION, CUSTOMERS_COMPLAINING_ABOUT_SPAM, CUSTOMERS_OPTING_OUT_OF_EMAIL_MARKETING, CUSTOMERS_VISITING_WU_COM_IN_30_DAYS, BAD_CLICKS, UNIQUE_CLICKS, EMAILS_OPENED_ATLEAST_ONCE_WITHIN_7_DAYS_OF_COMMUNICATION, EMAILS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_7_DAYS_OF_COMMUNICATION, PUSH_OPEN_COUNT, PUSH_INFLU_OPEN_COUNT, PUSH_BOUNCE_COUNT, INAPPMSG_VIEWED_COUNT, INAPPMSG_CLICKED_COUNT, CC_CLICKED_COUNT, CC_VIEWED_COUNT, CC_DISMISSED_COUNT, CC_ABORTED_COUNT, PUSH_SENT_COUNT, CC_SENT_COUNT, TYPE, CAMPAIGN_CANVAS_NAME, CANVAS_STEP_NAME_NEW, COMM_CHANNEL, CUSTOMER_ID, CUSTOMER_KEY, TXNS, REVENUE, RETAIL_TXNS, AIR_TXNS, POS_TXNS, DIGITAL_TXNS, APP_TXNS, TXNS_7DAYS, RETAIL_TXNS_7DAYS, AIR_TXNS_7DAYS, POS_TXNS_7DAYS, DIGITAL_TXNS_7DAYS, APP_TXNS_7DAYS, TMT_TXNS, ONE_X, RETAIL_ONLY, LAPSED,
R6_TXNS,    //Churn_reduction_metric 
R6_CHANNEL,     //Churn_reduction_metric
R6_APP_COUNT,   //Churn_reduction_metric
R12_TXNS, R24_TXNS, R36_TXNS, R12_RETAIL_TXNS, R12_DIGITAL_TXNS, CORRIDOR, DIGITAL_TXNS_30DAYS, R2D, WINBACKS, ONEX_TO_TWOX_AND_PLUS, TXN_CHANNEL, R48_TXNS, NEW_CUSTOMER, TWOX_TO_THREEX_AND_PLUS, THREEX_TO_FOURX_AND_PLUS, FOURX_TO_FIVEX_AND_PLUS, REGISTERED_30_DAYS, LOYALTY_REGISTRATION, DIGITAL_REGISTRATION, TXNS_30_DAYS_1, PRIOR_REGISTRATION, R24_RETAIL_TXNS, R24_DIGITAL_TXNS, R36_RETAIL_TXNS, R36_DIGITAL_TXNS, ACTIVITY_STATUS, MYWU_FLAG, CHANNEL_DOMINANCE, FLAG_ADDRESSABLE, FLAG_MARKETABLE, EMAIL_ADDRESSABLE, EMAIL_MARKETABLE, SMS_ADDRESSABLE, SMS_MARKETABLE, TENURE_STATUS, REDEEM_30_DAYS, APP_MARKETABLE, TXNS_RECENT, TXNS_RECENT_7DAYS, REVENUE_RECENT, REVENUE_RECENT_7DAYS, TXN_MODE, RETAIL_RECENT_TXNS, AIR_RECENT_TXNS, POS_RECENT_TXNS, DIGITAL_RECENT_TXNS, APP_RECENT_TXNS, RETAIL_RECENT_REVENUE, AIR_RECENT_REVENUE, DIGITAL_RECENT_REVENUE, APP_RECENT_REVENUE, RETAIL_TXNS_RECENT_7DAYS, AIR_TXNS_RECENT_7DAYS, POS_TXNS_RECENT_7DAYS, DIGITAL_TXNS_RECENT_7DAYS, APP_TXNS_RECENT_7DAYS, TPC_FLAG, HVC_FLAG, RFM_PERSONA

from SJ_bi_campaign_wise_email_communications_2_v2_MYWU_UPDATE_CUSTOMER_level_BACKUP_EMAIL_SMS_FULL_7_DAYS
//-- where year(EVENT_CAPTURED_DT) >= year(dateadd(year,-2,(select max(EVENT_CAPTURED_DT) from SJ_bi_campaign_wise_email_communications_2_v2_MYWU_UPDATE_CUSTOMER_level_Backup)))
//-- 		and year(EVENT_CAPTURED_DT) < year(current_date)

union all

select
    COUNTRY, EVENT_CAPTURED_DT, //CAMPAIGN_ID, 
    CAMPAIGN_NAME, MARKETING_STRATEGY, RESEND_FLAG, ACTIVITY_CODE, TOTAL_EMAILS_SENT, EMAILS_UN_DELIVERED, EMAILS_OPENED_ATLEAST_ONCE_WITHIN_30_DAYS_OF_COMMUNICATION, EMAILS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_30_DAYS_OF_COMMUNICATION, EMAILS_LEADING_TO_A_WU_COM_HIT_WITHIN_30_DAYS_OF_COMMUNICATION, EMAILS_REGISTRATIONS, EMAILS_SIGN_INS, EMAILS_REG_ATTEMPTS, EMAILS_LOGIN_ATTEMPTS, EMAILS_TXN_STARTS, EMAILS_TXN_SUBMITS, EMAILS_RECEIPTS, REGISTRATIONS, SIGN_INS, REG_ATTEMPTS, LOGIN_ATTEMPTS, TXN_STARTS, TXN_SUBMITS, RECEIPTS, RECEIPTS_REVENUE, CUSTOMERS_CONTACTED_ATLEAST_ONCE_BY_EMAIL, CUSTOMERS_BOUNCED_ATLEAST_ONE_EMAIL, CUSTOMERS_OPENING_ATLEAST_ONE_MAIL_WITHIN_30_DAYS_OF_COMMUNICATION, CUSTOMERS_CLICKING_ATLEAST_ONE_MAIL_WITHIN_30_DAYS_OF_COMMUNICATION, CUSTOMERS_COMPLAINING_ABOUT_SPAM, CUSTOMERS_OPTING_OUT_OF_EMAIL_MARKETING, CUSTOMERS_VISITING_WU_COM_IN_30_DAYS, BAD_CLICKS, UNIQUE_CLICKS, EMAILS_OPENED_ATLEAST_ONCE_WITHIN_7_DAYS_OF_COMMUNICATION, EMAILS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_7_DAYS_OF_COMMUNICATION, PUSH_OPEN_COUNT, PUSH_INFLU_OPEN_COUNT, PUSH_BOUNCE_COUNT, INAPPMSG_VIEWED_COUNT, INAPPMSG_CLICKED_COUNT, CC_CLICKED_COUNT, CC_VIEWED_COUNT, CC_DISMISSED_COUNT, CC_ABORTED_COUNT, PUSH_SENT_COUNT, CC_SENT_COUNT, TYPE, CAMPAIGN_CANVAS_NAME, CANVAS_STEP_NAME_NEW, COMM_CHANNEL, CUSTOMER_ID, CUSTOMER_KEY, TXNS, REVENUE, RETAIL_TXNS, AIR_TXNS, POS_TXNS, DIGITAL_TXNS, APP_TXNS, TXNS_7DAYS, RETAIL_TXNS_7DAYS, AIR_TXNS_7DAYS, POS_TXNS_7DAYS, DIGITAL_TXNS_7DAYS, APP_TXNS_7DAYS, TMT_TXNS, ONE_X, RETAIL_ONLY, LAPSED, 
r6_txns,        //Churn_reduction_metric
R6_CHANNEL,     //Churn_reduction_metric
R6_APP_COUNT,       //Churn_reduction_metric    
R12_TXNS, R24_TXNS, R36_TXNS, R12_RETAIL_TXNS, R12_DIGITAL_TXNS, CORRIDOR, DIGITAL_TXNS_30DAYS, R2D, WINBACKS, ONEX_TO_TWOX_AND_PLUS, TXN_CHANNEL, R48_TXNS, NEW_CUSTOMER, TWOX_TO_THREEX_AND_PLUS, THREEX_TO_FOURX_AND_PLUS, FOURX_TO_FIVEX_AND_PLUS, REGISTERED_30_DAYS, LOYALTY_REGISTRATION, DIGITAL_REGISTRATION, TXNS_30_DAYS_1, PRIOR_REGISTRATION, R24_RETAIL_TXNS, R24_DIGITAL_TXNS, R36_RETAIL_TXNS, R36_DIGITAL_TXNS, ACTIVITY_STATUS, MYWU_FLAG, CHANNEL_DOMINANCE, FLAG_ADDRESSABLE, FLAG_MARKETABLE, EMAIL_ADDRESSABLE, EMAIL_MARKETABLE, SMS_ADDRESSABLE, SMS_MARKETABLE, TENURE_STATUS, REDEEM_30_DAYS, APP_MARKETABLE, TXNS_RECENT, TXNS_RECENT_7DAYS, REVENUE_RECENT, REVENUE_RECENT_7DAYS, TXN_MODE, RETAIL_RECENT_TXNS, AIR_RECENT_TXNS, POS_RECENT_TXNS, DIGITAL_RECENT_TXNS, APP_RECENT_TXNS, RETAIL_RECENT_REVENUE, AIR_RECENT_REVENUE, DIGITAL_RECENT_REVENUE, APP_RECENT_REVENUE, RETAIL_TXNS_RECENT_7DAYS, AIR_TXNS_RECENT_7DAYS, POS_TXNS_RECENT_7DAYS, DIGITAL_TXNS_RECENT_7DAYS, APP_TXNS_RECENT_7DAYS, TPC_FLAG, HVC_FLAG, RFM_PERSONA

from SJ_bi_campaign_wise_email_communications_2_v2_MYWU_UPDATE_CUSTOMER_level_BACKUP_APP_2023_7_DAYS

    ),
    

CUSTOMER_REGISTRATION_BASE AS

    (select 
    
    COUNTRY, EVENT_CAPTURED_DT, //CAMPAIGN_ID, 
    CAMPAIGN_NAME, MARKETING_STRATEGY, RESEND_FLAG, ACTIVITY_CODE, TOTAL_EMAILS_SENT, EMAILS_UN_DELIVERED, EMAILS_OPENED_ATLEAST_ONCE_WITHIN_30_DAYS_OF_COMMUNICATION, 
	EMAILS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_30_DAYS_OF_COMMUNICATION, EMAILS_LEADING_TO_A_WU_COM_HIT_WITHIN_30_DAYS_OF_COMMUNICATION, EMAILS_REGISTRATIONS, EMAILS_SIGN_INS, EMAILS_REG_ATTEMPTS, 
	EMAILS_LOGIN_ATTEMPTS, EMAILS_TXN_STARTS, EMAILS_TXN_SUBMITS, EMAILS_RECEIPTS, REGISTRATIONS, SIGN_INS, REG_ATTEMPTS, LOGIN_ATTEMPTS, TXN_STARTS, TXN_SUBMITS, RECEIPTS, RECEIPTS_REVENUE, 
	CUSTOMERS_CONTACTED_ATLEAST_ONCE_BY_EMAIL, CUSTOMERS_BOUNCED_ATLEAST_ONE_EMAIL, CUSTOMERS_OPENING_ATLEAST_ONE_MAIL_WITHIN_30_DAYS_OF_COMMUNICATION, CUSTOMERS_CLICKING_ATLEAST_ONE_MAIL_WITHIN_30_DAYS_OF_COMMUNICATION, 
	CUSTOMERS_COMPLAINING_ABOUT_SPAM, CUSTOMERS_OPTING_OUT_OF_EMAIL_MARKETING, CUSTOMERS_VISITING_WU_COM_IN_30_DAYS, BAD_CLICKS, UNIQUE_CLICKS, EMAILS_OPENED_ATLEAST_ONCE_WITHIN_7_DAYS_OF_COMMUNICATION, 
	EMAILS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_7_DAYS_OF_COMMUNICATION, PUSH_OPEN_COUNT, PUSH_INFLU_OPEN_COUNT, PUSH_BOUNCE_COUNT, INAPPMSG_VIEWED_COUNT, INAPPMSG_CLICKED_COUNT, CC_CLICKED_COUNT, CC_VIEWED_COUNT, 
	CC_DISMISSED_COUNT, CC_ABORTED_COUNT, PUSH_SENT_COUNT, CC_SENT_COUNT, TYPE, CAMPAIGN_CANVAS_NAME, CANVAS_STEP_NAME_NEW, COMM_CHANNEL, CUSTOMER_ID, a.CUSTOMER_KEY, TXNS, REVENUE, RETAIL_TXNS, AIR_TXNS, POS_TXNS, 
	DIGITAL_TXNS, APP_TXNS, TXNS_7DAYS, RETAIL_TXNS_7DAYS, AIR_TXNS_7DAYS, POS_TXNS_7DAYS, DIGITAL_TXNS_7DAYS, APP_TXNS_7DAYS, TMT_TXNS, ONE_X, RETAIL_ONLY, LAPSED, 
r6_txns,        //Churn_reduction_metric
R6_CHANNEL,     //Churn_reduction_metric
R6_APP_COUNT,       //Churn_reduction_metric

R12_TXNS, R24_TXNS, R36_TXNS, R12_RETAIL_TXNS, 
	R12_DIGITAL_TXNS, CORRIDOR, DIGITAL_TXNS_30DAYS, R2D, WINBACKS, ONEX_TO_TWOX_AND_PLUS, TXN_CHANNEL, R48_TXNS, NEW_CUSTOMER, TWOX_TO_THREEX_AND_PLUS, THREEX_TO_FOURX_AND_PLUS, FOURX_TO_FIVEX_AND_PLUS, REGISTERED_30_DAYS, 
	LOYALTY_REGISTRATION, DIGITAL_REGISTRATION, TXNS_30_DAYS_1, PRIOR_REGISTRATION, R24_RETAIL_TXNS, R24_DIGITAL_TXNS, R36_RETAIL_TXNS, R36_DIGITAL_TXNS, MYWU_FLAG, CHANNEL_DOMINANCE, FLAG_ADDRESSABLE, FLAG_MARKETABLE, 
	EMAIL_ADDRESSABLE, EMAIL_MARKETABLE, SMS_ADDRESSABLE, SMS_MARKETABLE, TENURE_STATUS, REDEEM_30_DAYS, APP_MARKETABLE, TXNS_RECENT, TXNS_RECENT_7DAYS, REVENUE_RECENT, REVENUE_RECENT_7DAYS, TXN_MODE, RETAIL_RECENT_TXNS, 
	AIR_RECENT_TXNS, POS_RECENT_TXNS, DIGITAL_RECENT_TXNS, APP_RECENT_TXNS, RETAIL_RECENT_REVENUE, AIR_RECENT_REVENUE, DIGITAL_RECENT_REVENUE, APP_RECENT_REVENUE, RETAIL_TXNS_RECENT_7DAYS, AIR_TXNS_RECENT_7DAYS, 
	POS_TXNS_RECENT_7DAYS, DIGITAL_TXNS_RECENT_7DAYS, APP_TXNS_RECENT_7DAYS, TPC_FLAG, a.HVC_FLAG, RFM_PERSONA,


    
    
    ACTIVITY_STATUS as ACTIVITY_STATUS_1, 
    date(PREFERRED_REGISTRATION_DATE) as PREFERRED_REGISTRATION_DATE,
    case when PREFERRED_REGISTRATION_DATE is not null 
                and ACTIVITY_STATUS_1 is null then datediff('DAY',PREFERRED_REGISTRATION_DATE,CURRENT_DATE) end as DAYS_BTW_REGISTRATION_TO_TXN,
    
from 
    BIRD_SFMC_CUSTOMER_CAMPAIGN_LEVEL_UNION a
left join 
    WUDNA.SUMMARY_GEN.WUDNA_CUSTOMER_MASTER_VW b on a.CUSTOMER_KEY = b.CUSTOMER_KEY

    )

SELECT


    COUNTRY, EVENT_CAPTURED_DT, //CAMPAIGN_ID, 
    CAMPAIGN_NAME, MARKETING_STRATEGY, RESEND_FLAG, ACTIVITY_CODE, TOTAL_EMAILS_SENT, EMAILS_UN_DELIVERED, EMAILS_OPENED_ATLEAST_ONCE_WITHIN_30_DAYS_OF_COMMUNICATION, 
    EMAILS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_30_DAYS_OF_COMMUNICATION, EMAILS_LEADING_TO_A_WU_COM_HIT_WITHIN_30_DAYS_OF_COMMUNICATION, EMAILS_REGISTRATIONS, EMAILS_SIGN_INS, EMAILS_REG_ATTEMPTS, EMAILS_LOGIN_ATTEMPTS, EMAILS_TXN_STARTS, 
    EMAILS_TXN_SUBMITS, EMAILS_RECEIPTS, REGISTRATIONS, SIGN_INS, REG_ATTEMPTS, LOGIN_ATTEMPTS, TXN_STARTS, TXN_SUBMITS, RECEIPTS, RECEIPTS_REVENUE, CUSTOMERS_CONTACTED_ATLEAST_ONCE_BY_EMAIL, CUSTOMERS_BOUNCED_ATLEAST_ONE_EMAIL, 
    CUSTOMERS_OPENING_ATLEAST_ONE_MAIL_WITHIN_30_DAYS_OF_COMMUNICATION, CUSTOMERS_CLICKING_ATLEAST_ONE_MAIL_WITHIN_30_DAYS_OF_COMMUNICATION, CUSTOMERS_COMPLAINING_ABOUT_SPAM, CUSTOMERS_OPTING_OUT_OF_EMAIL_MARKETING, 
    CUSTOMERS_VISITING_WU_COM_IN_30_DAYS, BAD_CLICKS, UNIQUE_CLICKS, EMAILS_OPENED_ATLEAST_ONCE_WITHIN_7_DAYS_OF_COMMUNICATION, EMAILS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_7_DAYS_OF_COMMUNICATION, PUSH_OPEN_COUNT, PUSH_INFLU_OPEN_COUNT, 
    PUSH_BOUNCE_COUNT, INAPPMSG_VIEWED_COUNT, INAPPMSG_CLICKED_COUNT, CC_CLICKED_COUNT, CC_VIEWED_COUNT, CC_DISMISSED_COUNT, CC_ABORTED_COUNT, PUSH_SENT_COUNT, CC_SENT_COUNT, TYPE, CAMPAIGN_CANVAS_NAME, CANVAS_STEP_NAME_NEW, COMM_CHANNEL, 
    CUSTOMER_ID, CUSTOMER_KEY, TXNS, REVENUE, RETAIL_TXNS, AIR_TXNS, POS_TXNS, DIGITAL_TXNS, APP_TXNS, TXNS_7DAYS, RETAIL_TXNS_7DAYS, AIR_TXNS_7DAYS, POS_TXNS_7DAYS, DIGITAL_TXNS_7DAYS, APP_TXNS_7DAYS, TMT_TXNS, ONE_X, RETAIL_ONLY, LAPSED,
r6_txns,        //Churn_reduction_metric
R6_CHANNEL,     //Churn_reduction_metric
R6_APP_COUNT,       //Churn_reduction_metric

    R12_TXNS, R24_TXNS, R36_TXNS, R12_RETAIL_TXNS, R12_DIGITAL_TXNS, CORRIDOR, DIGITAL_TXNS_30DAYS, R2D, WINBACKS, ONEX_TO_TWOX_AND_PLUS, TXN_CHANNEL, R48_TXNS, NEW_CUSTOMER, TWOX_TO_THREEX_AND_PLUS, THREEX_TO_FOURX_AND_PLUS, 
    FOURX_TO_FIVEX_AND_PLUS, REGISTERED_30_DAYS, LOYALTY_REGISTRATION, DIGITAL_REGISTRATION, TXNS_30_DAYS_1, PRIOR_REGISTRATION, R24_RETAIL_TXNS, R24_DIGITAL_TXNS, R36_RETAIL_TXNS, R36_DIGITAL_TXNS, 
    
    case 
        when ACTIVITY_STATUS_1 is null and DAYS_BTW_REGISTRATION_TO_TXN < 31 then 'RNT'
        when ACTIVITY_STATUS_1 is null and DAYS_BTW_REGISTRATION_TO_TXN >= 31 then 'Post 30 Days RNT'
        when ACTIVITY_STATUS_1 is not null and PREFERRED_REGISTRATION_DATE is null then ACTIVITY_STATUS_1
        when PREFERRED_REGISTRATION_DATE is null then 'Not Registered'
        else ACTIVITY_STATUS_1 end as ACTIVITY_STATUS, 
        
    
    MYWU_FLAG, CHANNEL_DOMINANCE, 
    FLAG_ADDRESSABLE, FLAG_MARKETABLE, EMAIL_ADDRESSABLE, EMAIL_MARKETABLE, SMS_ADDRESSABLE, SMS_MARKETABLE, TENURE_STATUS, REDEEM_30_DAYS, APP_MARKETABLE, TXNS_RECENT, TXNS_RECENT_7DAYS, REVENUE_RECENT, REVENUE_RECENT_7DAYS, TXN_MODE, 
    RETAIL_RECENT_TXNS, AIR_RECENT_TXNS, POS_RECENT_TXNS, DIGITAL_RECENT_TXNS, APP_RECENT_TXNS, RETAIL_RECENT_REVENUE, AIR_RECENT_REVENUE, DIGITAL_RECENT_REVENUE, APP_RECENT_REVENUE, RETAIL_TXNS_RECENT_7DAYS, AIR_TXNS_RECENT_7DAYS, 
    POS_TXNS_RECENT_7DAYS, DIGITAL_TXNS_RECENT_7DAYS, APP_TXNS_RECENT_7DAYS, TPC_FLAG, HVC_FLAG, RFM_PERSONA,

        
    
    from CUSTOMER_REGISTRATION_BASE a
        `;





var sql_command_35 = 
	`INSERT INTO BIRD_CAMPAIGN_LOG
Select 
    'SJ_BI_CAMPAIGN_WISE_EMAIL_COMMUNICATIONS_2_V2_MYWU_UPDATE_CUSTOMER_LEVEL',
    CURRENT_TIMESTAMP,
    count(1) , 
    Count(distinct CAMPAIGN_NAME), 
    sum(CUSTOMERS_OPENING_ATLEAST_ONE_MAIL_WITHIN_30_DAYS_OF_COMMUNICATION),
    sum(CUSTOMERS_CLICKING_ATLEAST_ONE_MAIL_WITHIN_30_DAYS_OF_COMMUNICATION) 
from SJ_BI_CAMPAIGN_WISE_EMAIL_COMMUNICATIONS_2_V2_MYWU_UPDATE_CUSTOMER_LEVEL`;




//=======================================================================================================================================
//===============================(CAMPAIGN AGGREGATED TABLE)=============================================================================
//=======================================================================================================================================




var sql_command_36 = 
`CREATE or replace TABLE SJ_bi_campaign_wise_email_communications_2_v2_mywu_UPDATE AS
with AK_BIRD_SFMC_CAMPAIGN_AGGREGATED_CTE as (
select 
resend_flag,
/*a.campaign_id,*/
a.campaign_name as campaign_name,
a.RFM_PERSONA,
substr(activity_code,3,1) as channel,
nvl(b.country_name,'Not_Available') as country_name,
b.super_region as region,
TO_DATE(event_captured_dt) AS EVENT_CAPTURED_dT,
date_trunc(week,event_captured_dt) as release_week,
nvl(txn_channel,'RNT') as txn_channel,
tpc_flag,
a.hvc_flag,
nvl(Activity_STATUS,'RNT') as activity_status,
nvl(MyWU_flag,'Non_Member') as loyalty_flag,
nvl(channel_dominance,'RNT') as channel_dominance,
a.type,
FLAG_ADDRESSABLE,
FLAG_MARKETABLE,EMAIL_ADDRESSABLE,EMAIL_MARKETABLE,SMS_ADDRESSABLE,e.campaign_canvas_name,CANVAS_STEP_NAME,APP_TYPE_NAME,APP_MARKETABLE,
SMS_MARKETABLE,
NVL(tenure_status,'R12 Inactive') as tenure_status,
SUM(REVENUE_RECENT_7DAYS) AS REVENUE,
COUNT(CASE WHEN ACTIVITY_STATUS IN ('R6 Active') AND txns_7days > 0 THEN 1 END) AS CHURN_TRANSACTION_7DAYS,     //Churn_reduction_metric
count(case when upper(txn_channel) in ('RETAIL') and digital_recent_txns > 0 then 1 end ) as test_communications_r2d,
count(case when upper(txn_channel) in ('RETAIL') and digital_txns_7days > 0 then 1 end ) as test_communications_r2d_7DAYS,	//7_DAYS_ATTRIBUTION_CHANGE_FROM_30_DAYS

count(case when activity_status not in ('R6 Active','R7 to R12 Active','RNT') and lapsed='Y' and txns_7days > 0 then 1 end ) as test_communications_winbacks_RNT_exCLUDED,

count(case when activity_status not in ('R6 Active','R7 to R12 Active','RNT') and retail_txns_7days > 0 then 1 end) as test_communications_winbacks_with_atleast_1_retail_txn_RNT_EXCLUDED,

count(case when activity_status not in ('R6 Active','R7 to R12 Active','RNT') and digital_txns_7days > 0 then 1 end) as test_communications_winbacks_with_atleast_1_digital_txn_RNT_EXCLUDED, 
count(case when activity_status not in ('R6 Active','R7 to R12 Active') and txns_recent > 0 then 1 end ) as test_communications_winbacks,

count(case when lapsed='Y' and txns_7days > 0 then 1 end ) as test_communications_winbacks_7DAYS, //7_DAYS_ATTRIBUTION_CHANGE_FROM_30_DAYS

count(case when activity_status not in ('R6 Active','R7 to R12 Active') and retail_txns_7days > 0 then 1 end) as test_communications_winbacks_with_atleast_1_retail_txn,

count(case when activity_status not in ('R6 Active','R7 to R12 Active') and digital_txns_7days > 0 then 1 end) as test_communications_winbacks_with_atleast_1_digital_txn, 
count(case when one_x='Y' and txns_recent > 0 then 1 end ) as test_communications_ONEX_TO_TWOX_AND_PLUS,
count(case when one_x='Y' and txns_7days > 0 then 1 end ) as test_communications_ONEX_TO_TWOX_AND_PLUS_7DAYS, //7_DAYS_ATTRIBUTION_CHANGE_FROM_30_DAYS

count(case when TWOX_TO_THREEX_AND_PLUS='Y' then 1 end ) as test_communications_TWOX_TO_THREEX_AND_PLUS,
count(case when THREEX_TO_FOURX_AND_PLUS='Y' then 1 end ) as test_communications_THREEX_TO_FOURX_AND_PLUS,
count(case when FOURX_TO_FIVEX_AND_PLUS='Y' then 1 end ) as test_communications_FOURX_TO_FIVEX_AND_PLUS,
count(case when NEW_CUSTOMER='Y' then 1 end ) as test_communications_NEW_CUSTOMER,
count(case when emails_un_delivered=0 and redeem_30_days = 'Y' 
			AND ((SUBSTR(ACTIVITY_CODE,3,1) IN ('P') AND EMAILS_OPENED_ATLEAST_ONCE_WITHIN_7_DAYS_OF_COMMUNICATION > 0) 
				or
				(SUBSTR(ACTIVITY_CODE,3,1) IN ('E','S','I','C') AND  EMAILS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_7_DAYS_OF_COMMUNICATION > 0))
					then 1 end) as test_communications_EXISTING_CUSTOMER,		//7_DAYS_ATTRIBUTION_CHANGE_FROM_30_DAYS
count(case when emails_un_delivered=0 and MyWU_flag not in ('Non_Member') then 1 end ) as test_communications_LOYALTY_REGISTRATION,

count(case when emails_un_delivered=0 and MyWU_flag not in ('Non_Member') 
			AND ((SUBSTR(ACTIVITY_CODE,3,1) IN ('P') AND EMAILS_OPENED_ATLEAST_ONCE_WITHIN_7_DAYS_OF_COMMUNICATION > 0)
				or
				(SUBSTR(ACTIVITY_CODE,3,1) IN ('E','S','I','C') AND  EMAILS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_7_DAYS_OF_COMMUNICATION > 0))
				then 1 end ) as test_communications_LOYALTY_REGISTRATION_OPENED_CLICKED_7DAYS,	//7_DAYS_ATTRIBUTION_CHANGE_FROM_30_DAYS
				
count(case when emails_un_delivered=0 and registered_30_days = 'Y' 
				AND ((SUBSTR(ACTIVITY_CODE,3,1) IN ('P') AND EMAILS_OPENED_ATLEAST_ONCE_WITHIN_7_DAYS_OF_COMMUNICATION > 0) 
				or
				(SUBSTR(ACTIVITY_CODE,3,1) IN ('E','S','I','C') AND  EMAILS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_7_DAYS_OF_COMMUNICATION > 0))
				then 1 end) as test_communications_DIGITAL_REGISTRATION, //7_DAYS_ATTRIBUTION_CHANGE_FROM_30_DAYS

count(case when emails_un_delivered=0 and MyWU_flag in ('Non_Member') then 1 end) as test_communications_REGISTERED_30_DAYS,

count(case when emails_un_delivered=0 and MyWU_flag in ('Non_Member') 
			AND ((SUBSTR(ACTIVITY_CODE,3,1) IN ('P') AND EMAILS_OPENED_ATLEAST_ONCE_WITHIN_7_DAYS_OF_COMMUNICATION > 0 )
				or
				(SUBSTR(ACTIVITY_CODE,3,1) IN ('E','S','I','C') AND  EMAILS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_7_DAYS_OF_COMMUNICATION > 0))
				then 1 end) as test_communications_REGISTERED_7_DAYS,  //7_DAYS_ATTRIBUTION_CHANGE_FROM_30_DAYS

count(case when emails_un_delivered=0 and retail_only='Y' then 1 end ) as test_retail_only_delivered,

count(case when emails_un_delivered=0 
			and retail_only='Y' 
			AND ((SUBSTR(ACTIVITY_CODE,3,1) IN ('P') AND EMAILS_OPENED_ATLEAST_ONCE_WITHIN_7_DAYS_OF_COMMUNICATION > 0) 
				or
				(SUBSTR(ACTIVITY_CODE,3,1) IN ('E','S','I','C') AND  EMAILS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_7_DAYS_OF_COMMUNICATION > 0))
					then 1 end ) as test_retail_only_delivered_7DAYS, //7_DAYS_ATTRIBUTION_CHANGE_FROM_30_DAYS

count(case when emails_un_delivered=0 and lapsed='Y' then 1 end ) as test_lapsed_only_delivered,	 

count(case when emails_un_delivered=0 
			and lapsed='Y' 
			AND ((SUBSTR(ACTIVITY_CODE,3,1) IN ('P') AND EMAILS_OPENED_ATLEAST_ONCE_WITHIN_7_DAYS_OF_COMMUNICATION > 0 )
				or
				(SUBSTR(ACTIVITY_CODE,3,1) IN ('E','S','I','C') AND  EMAILS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_7_DAYS_OF_COMMUNICATION > 0))
					then 1 end ) as test_lapsed_only_delivered_opened_clicked_7days, //7_DAYS_ATTRIBUTION_CHANGE_FROM_30_DAYS

count(case when emails_un_delivered=0 and one_x='Y' then 1 end ) as test_1x_delivered,

count(case when emails_un_delivered=0 
			and one_x='Y' 
			AND ((SUBSTR(ACTIVITY_CODE,3,1) IN ('P') AND EMAILS_OPENED_ATLEAST_ONCE_WITHIN_7_DAYS_OF_COMMUNICATION > 0 )
				or
				(SUBSTR(ACTIVITY_CODE,3,1) IN ('E','S','I','C') AND  EMAILS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_7_DAYS_OF_COMMUNICATION > 0))
					then 1 end ) as test_1x_delivered_OPENED_CLICKED_7DAYS,	//7_DAYS_ATTRIBUTION_CHANGE_FROM_30_DAYS


count(case when emails_un_delivered=0 and r6_txns>0 then 1 end ) as test_R6_CHURN_delivered,        //Churn_reduction_metric
count(case when emails_un_delivered=0 and r12_txns=2 then 1 end ) as test_2x_delivered,
count(case when emails_un_delivered=0 and r12_txns=3 then 1 end ) as test_3x_delivered,
count(case when emails_un_delivered=0 and r12_txns=4 then 1 end ) as test_4x_delivered,
count(case when emails_un_delivered=0 and r36_txns=0 then 1 end ) as test_new_delivered,
count(case when emails_un_delivered=0 and r12_txns>0 then 1 end ) as test_existing_delivered,
count(case when emails_un_delivered=0 and PRIOR_REGISTRATION='N'then 1 end ) as test_NON_REGISTRED_delivered,
SUM(Case when Channel = 'P' THEN (TOTAL_EMAILS_SENT) ELSE 1 END) as communications_sent,
count(case when EMAILS_UN_DELIVERED > 0 then 1 end) as Communications_undelivered,
SUM(case when EMAILS_OPENED_ATLEAST_ONCE_WITHIN_30_DAYS_OF_COMMUNICATION > 0 then EMAILS_OPENED_ATLEAST_ONCE_WITHIN_30_DAYS_OF_COMMUNICATION end) as communications_OPENED_ATLEAST_ONCE_WITHIN_30_DAYS_OF_COMMUNICATION,
SUM(case when EMAILS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_30_DAYS_OF_COMMUNICATION > 0  then EMAILS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_30_DAYS_OF_COMMUNICATION end) as communications_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_30_DAYS_OF_COMMUNICATION,
count(case when CUSTOMERS_COMPLAINING_ABOUT_SPAM > 0  then 1 end) as complaints,
count(case when CUSTOMERS_OPTING_OUT_OF_EMAIL_MARKETING > 0 then 1 end) as opt_outs,
count(case when EMAILS_OPENED_ATLEAST_ONCE_WITHIN_7_DAYS_OF_COMMUNICATION > 0 then 1 end) as communications_OPENED_ATLEAST_ONCE_WITHIN_7_DAYS_OF_COMMUNICATION,
count(case when EMAILS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_7_DAYS_OF_COMMUNICATION > 0  then 1 end) as communications_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_7_DAYS_OF_COMMUNICATION, 
count(case when EMAILS_LEADING_TO_A_WU_COM_HIT_WITHIN_30_DAYS_OF_COMMUNICATION > 0 then 1 end ) as communications_LEADING_TO_A_WU_COM_HIT_WITHIN_30_DAYS_OF_COMMUNICATION,
//count(case when EMAILS_REGISTRATIONS_1 > 0 then 1 end ) as communications_REGISTRATIONS,
//count(case when EMAILS_SIGN_INS_1 > 0 then 1 end ) as communications_SIGN_INS,
//count(case when EMAILS_REG_ATTEMPTS_1 > 0 then 1 end ) as communications_REG_ATTEMPTS,
//count(case when EMAILS_LOGIN_ATTEMPTS_1 > 0 then 1 end ) as communications_login_ATTEMPTS,
//count(case when EMAILS_TXN_STARTS_1 > 0 then 1 end ) as communications_TXN_STARTS,
//count(case when EMAILS_TXN_SUBMITS_1 > 0 then 1 end ) as communications_TXN_SUBMITS,
//count(case when EMAILS_RECEIPTS_1 > 0 then 1 end ) as communications_RECEIPTS,
//sum(REGISTRATIONS_1 ) as REGISTRATIONS,
//sum(SIGN_INS_1) as SIGN_INS,
//sum(REG_ATTEMPTS_1) as REG_ATTEMPTS,
//sum(LOGIN_ATTEMPTS_1) as login_ATTEMPTS,
//sum(TXN_STARTS_1) as TXN_STARTS,
//sum(TXN_SUBMITS_1) as TXN_SUBMITS,
//sum(RECEIPTS_1) as RECEIPTS,
//sum(receipts_revenue_1) receipt_revenue_1,
//sum(session_count) session_count,
//sum(visitor_count) visitor_count,
count(case when txns > 0 then 1 end ) as communications_with_atleast_1_txn,
count(case when retail_txns > 0 then 1 end ) as communications_with_atleast_1_retail_txn,
count(case when air_txns > 0 then 1 end ) as communications_with_atleast_1_air_txn,
count(case when pos_txns > 0 then 1 end ) as communications_with_atleast_1_pos_txn,
count(case when digital_txns > 0 then 1 end ) as communications_with_atleast_1_digital_txn,
count(case when app_txns > 0 then 1 end ) as communications_with_atleast_1_app_txn,
count(case when txns > 0 then 1 end ) as test_communications_with_atleast_1_txn,
count(case when retail_txns > 0 then 1 end ) as test_communications_with_atleast_1_retail_txn,
count(case when air_txns > 0 then 1 end ) as test_communications_with_atleast_1_air_txn,
count(case when pos_txns > 0 then 1 end ) as test_communications_with_atleast_1_pos_txn,
count(case when digital_txns > 0 then 1 end ) as test_communications_with_atleast_1_digital_txn,
count(case when app_txns > 0 then 1 end ) as test_communications_with_atleast_1_app_txn,
count(case when txns_7days > 0 then 1 end ) as test_communications_with_atleast_1_txn_7days,
count(case when retail_txns_7days > 0 then 1 end ) as test_communications_with_atleast_1_retail_txn_7days,
count(case when air_txns_7days > 0 then 1 end ) as test_communications_with_atleast_1_air_txn_7days,
count(case when pos_txns_7days > 0 then 1 end ) as test_communications_with_atleast_1_pos_txn_7days,
count(case when digital_txns_7days > 0 then 1 end ) as test_communications_with_atleast_1_digital_txn_7days,
count(case when app_txns_7days > 0 then 1 end ) as test_communications_with_atleast_1_app_txn_7days,
sum(txns) as txns,
sum(retail_txns) as retail_txns,
sum(air_txns) as air_txns,
sum(digital_txns) as digital_txns,
sum(app_txns) as app_txns,
sum(pos_txns) as pos_txns,
count(case when emails_un_delivered=0 and redeem_30_days = 'Y' then 1 end ) as test_redeem_only_delivered,
count(case when emails_un_delivered=0 and MyWU_flag not in ('Non_Member') then 1 end ) as test_member_only_delivered,
count(case when emails_un_delivered=0 and registered_30_days = 'Y' then 1 end ) as test_enrolled_only_delivered,
count(case when emails_un_delivered=0 and MyWU_flag in ('Non_Member') then 1 end ) as test_non_member_only_delivered,  
sum(PUSH_OPEN_COUNT) PUSH_OPEN_COUNT,
sum(PUSH_INFLU_OPEN_COUNT ) PUSH_INFLU_OPEN_COUNT,
sum(PUSH_BOUNCE_COUNT) PUSH_BOUNCE_COUNT,
sum(INAPPMSG_VIEWED_COUNT) INAPPMSG_VIEWED_COUNT,
sum(INAPPMSG_CLICKED_COUNT) INAPPMSG_CLICKED_COUNT,
sum(CC_CLICKED_COUNT) CC_CLICKED_COUNT,
sum(CC_VIEWED_COUNT) CC_VIEWED_COUNT,
sum(CC_DISMISSED_COUNT) CC_DISMISSED_COUNT,
sum(CC_ABORTED_COUNT) CC_ABORTED_COUNT,
sum(push_sent_count) push_sent_count,
sum(cc_sent_count) cc_sent_count
 
from SJ_BI_CAMPAIGN_WISE_EMAIL_COMMUNICATIONS_2_V2_MYWU_UPDATE_CUSTOMER_LEVEL a

left outer join "WUDNA"."SUMMARY_GEN"."WUDNA_CUSTOMER_MASTER_VW"  d on a.customer_key=d.customer_key

left outer join "WUDNA"."SUMMARY_GEN"."COUNTRY_VW" b on d.COUNTRY_CODE = b.country_code 

left outer join (select distinct marketing_strategies,campaign_category 
                  from cex_sandbox.campaign_category_V where marketing_strategies is not null) g on a.marketing_strategy=g.marketing_strategies

left join 
(select 
       distinct concat(NVL(UPPER(campaign_canvas_name),'NA'),'_',NVL(UPPER(CANVAS_STEP_NAME),'NA'),'_',nvl(UPPER(APP_TYPE_NAME),'NA')) 
       campaign_name_2,
       UPPER(campaign_canvas_name) campaign_canvas_name,
       UPPER(CANVAS_STEP_NAME) CANVAS_STEP_NAME,
       UPPER(APP_TYPE_NAME) APP_TYPE_NAME,
       UPPER(type) type
from 

(SELECT 
     case 
         
		 WHEN A.customer_key IS NULL OR A.customer_key ='' then B.customer_key
         else A.CUSTOMER_KEY
     end as CUSTOMER_KEY,
    
     campaign_canvas_name,
     CANVAS_STEP_NAME,
     APP_TYPE_NAME,
     type
FROM  summary_gen.braze_summary_vw B
LEFT JOIN  "WUDNA"."SUMMARY_GEN".WUDNA_ACCOUNT_MASTER_VW A 
ON B.CUSTOMER_KEY = A.CUSTOMER_UMN
WHERE  B.CUSTOMER_KEY IS NOT NULL)



) e on a.campaign_name = e.campaign_name_2 
where len(a.CUSTOMER_KEY) IN (9,15,19)                                                        
group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26)



Select *, 
CASE 
WHEN CHANNEL = 'E' THEN 'EMAIL'
WHEN CHANNEL = 'S' THEN 'SMS'
WHEN CHANNEL = 'I' THEN 'IN-APP'
WHEN CHANNEL = 'C' THEN 'CONTENT CARD'
WHEN CHANNEL = 'P' THEN 'PUSH' END AS CHANNEL_TYPE,
CASE 
WHEN CHANNEL IN ('I','C','P') THEN 'APP'
WHEN CHANNEL = 'S' THEN 'SMS' 
WHEN CHANNEL = 'E' THEN 'EMAIL' END AS CHANNELS,
CHARINDEX('_',CAMPAIGN_NAME,1) as par_1,
CHARINDEX('_',CAMPAIGN_NAME,CHARINDEX('_',campaign_name,1)+1) as par_2,
upper(substrING(campaign_name,par_1+1,par_2 - par_1-1)) AS Category_1,
CASE 
WHEN UPPER(CAMPAIGN_NAME) LIKE '%LIFECYCLE%' then 'JOURNEY'
WHEN UPPER(CAMPAIGN_NAME) like '%TRIGGER%' then 'JOURNEY'
ELSE 'AD-HOC' END AS JOURNEY,
CASE 
WHEN UPPER(CAMPAIGN_NAME) LIKE '%OFFER%' then 'PROMO'
WHEN UPPER(CAMPAIGN_NAME) like '%PROMO%' and UPPER(CAMPAIGN_NAME) Not like '%PROMOTION%' then 'PROMO'
ELSE 'NON-PROMO' END AS PRO_NONPROMO,
CASE 
WHEN PRO_NONPROMO = 'PROMO' AND UPPER(category_1) LIKE '%OFFER%' THEN SUBSTR(category_1,1,LEN(category_1)) // Changed from WHEN PRO_NONPROMO = 'PROMO' AND UPPER(category_1) LIKE '%OFFER%' THEN SUBSTR(category_1,6,LEN(category_1))
WHEN PRO_NONPROMO = 'PROMO' THEN 'UNKNOWN' //Changed from "WHEN PRO_NONPROMO = 'PROMO' THEN category_1" Changed because "Raminta" came under this segment
ELSE 'OTHER' END AS OFFER_SEGMENT,
CASE
WHEN UPPER(CAMPAIGN_NAME) LIKE '%CTADIGITAL%' then 'CTADIGITAL'
WHEN UPPER(CAMPAIGN_NAME) LIKE '%CTAOMNICHANNEL%' then 'CTAOMNICHANNEL'
WHEN UPPER(CAMPAIGN_NAME) LIKE '%CTARETAIL%' then 'CTARETAIL'
WHEN UPPER(CAMPAIGN_NAME) LIKE '%ENGAGEMENT%' then 'ENGAGEMENT'
WHEN UPPER(CAMPAIGN_NAME) LIKE '%FUNNEL%' then 'FUNNEL'
WHEN UPPER(CAMPAIGN_NAME) LIKE '%LAPSED2ACTIVE%' then 'LAPSED2ACTIVE'
WHEN UPPER(CAMPAIGN_NAME) LIKE '%NONTRANSACTIONAL%' then 'NONTRANSACTIONAL'
WHEN UPPER(CAMPAIGN_NAME) LIKE '%R2D%' then 'R2D'
WHEN UPPER(CAMPAIGN_NAME) LIKE '%RETENTION%' then 'RETENTION'
WHEN UPPER(CAMPAIGN_NAME) LIKE '%TPCLIFT%' then 'TPCLIFT'
ELSE 'OTHERS' END AS CTA,
CASE
WHEN UPPER(CAMPAIGN_NAME) LIKE '%APN%' then 'APN'
WHEN UPPER(CAMPAIGN_NAME) LIKE '%ONBOARDING%' then 'ONBOARDING'
WHEN UPPER(CAMPAIGN_NAME) LIKE '%REDEMPTION%' then 'REDEMPTION'
WHEN UPPER(CAMPAIGN_NAME) LIKE '%RNT%' then 'RNT'
WHEN UPPER(CAMPAIGN_NAME) LIKE '%STATEMENT%' then 'STATEMENT'
WHEN UPPER(CAMPAIGN_NAME) LIKE '%WALLET%' then 'WALLET'
WHEN UPPER(CAMPAIGN_NAME) LIKE '%MULTIPRODUCT%' then 'MULTIPRODUCT'
WHEN UPPER(CAMPAIGN_NAME) LIKE '%DIGITAL%' then 'DIGITAL'
WHEN UPPER(CAMPAIGN_NAME) LIKE '%AGENTLOCATOR%' then 'AGENTLOCATOR'
WHEN UPPER(CAMPAIGN_NAME) LIKE '%1XTO2X%' then '1XTO2X'
ELSE 'OTHERS' END AS PRODUCT,
CASE
WHEN JOURNEY ='JOURNEY' AND CHANNEL IN ('E','S') AND UPPER(CAMPAIGN_NAME) LIKE '%WELCOME%' then 'WELCOME'
WHEN JOURNEY ='JOURNEY' AND CHANNEL IN ('E','S') AND UPPER(CAMPAIGN_NAME) LIKE '%ONBOARDING%' then 'ONBOARDING'
WHEN JOURNEY ='JOURNEY' AND CHANNEL IN ('E','S') AND UPPER(CAMPAIGN_NAME) LIKE '%NURTURING%' then 'NURTURING'
WHEN JOURNEY ='JOURNEY' AND CHANNEL IN ('E','S') AND UPPER(CAMPAIGN_NAME) LIKE '%EARNEDENOUGHPOINT%' then 'EARNED ENOUGH POINT'
WHEN JOURNEY ='JOURNEY' AND CHANNEL IN ('E','S') AND UPPER(CAMPAIGN_NAME) LIKE '%ACTIVEJOURNEY%' then 'ACTIVE JOURNEY'
WHEN JOURNEY ='JOURNEY' AND CHANNEL IN ('E','S') AND UPPER(CAMPAIGN_NAME) LIKE '%MYWULAPSED%' then 'MYWULAPSED'
WHEN JOURNEY ='JOURNEY' AND CHANNEL IN ('E','S') AND UPPER(CAMPAIGN_NAME) LIKE '%LAPSING/LAPSED%' then 'LAPSING/LAPSED'
WHEN JOURNEY ='JOURNEY' AND CHANNEL IN ('E','S') AND UPPER(CAMPAIGN_NAME) LIKE '%STATEMENT%' then 'WU STATEMENT'
WHEN JOURNEY ='JOURNEY' AND CHANNEL IN ('E','S') AND UPPER(CAMPAIGN_NAME) LIKE '%1XTO2X%' then '1XTO2X'
WHEN JOURNEY ='JOURNEY' AND CHANNEL IN ('E','S') AND UPPER(CAMPAIGN_NAME) LIKE '%ACHIEVEMENT%' then 'ACHIEVEMENT'
WHEN JOURNEY ='JOURNEY' AND CHANNEL IN ('E','S') AND UPPER(CAMPAIGN_NAME) LIKE '%BIRTHDAY%' then 'BIRTHDAY'
WHEN JOURNEY ='JOURNEY' AND CHANNEL IN ('E','S') AND UPPER(CAMPAIGN_NAME) LIKE '%ABANDONED%' then 'ABANDONED CART'
WHEN JOURNEY ='JOURNEY' AND CHANNEL IN ('E','S') AND UPPER(CAMPAIGN_NAME) LIKE '%REGISTEREDNOTTRANSACTED%' then 'RNT'
WHEN JOURNEY ='JOURNEY' AND CHANNEL IN ('E','S') AND UPPER(CAMPAIGN_NAME) LIKE '%RNT%' then 'RNT'
WHEN JOURNEY ='JOURNEY' AND CHANNEL IN ('E','S') AND UPPER(CAMPAIGN_NAME) LIKE '%OPTIN%' then 'OPT-IN TRIGGER'
WHEN JOURNEY ='JOURNEY' AND CHANNEL IN ('P','I','C') AND UPPER(CAMPAIGN_NAME) LIKE '%WELCOME%' then 'WELCOME'
WHEN JOURNEY ='JOURNEY' AND CHANNEL IN ('P','I','C') AND UPPER(CAMPAIGN_NAME) LIKE '%ONBOARDING%' then 'ONBOARDING'
WHEN JOURNEY ='JOURNEY' AND CHANNEL IN ('P','I','C') AND UPPER(CAMPAIGN_NAME) LIKE '%LAUNCHEDNOTREGISTERED%' then 'LAUNCHED NOT REGISTERED'
WHEN JOURNEY ='JOURNEY' AND CHANNEL IN ('P','I','C') AND UPPER(CAMPAIGN_NAME) LIKE '%KYC%' then 'KYC'
WHEN JOURNEY ='JOURNEY' AND CHANNEL IN ('P','I','C') AND UPPER(CAMPAIGN_NAME) LIKE '%THANKYOU%' then 'POST TRANSACTION THANK YOU'
WHEN JOURNEY ='JOURNEY' AND CHANNEL IN ('P','I','C') AND UPPER(CAMPAIGN_NAME) LIKE '%JOINMYWU%' then 'JOIN MYWU'
WHEN JOURNEY ='JOURNEY' AND CHANNEL IN ('P','I','C') AND UPPER(CAMPAIGN_NAME) LIKE '%BIRTHDAY%' then 'BIRTHDAY'
WHEN JOURNEY ='JOURNEY' AND CHANNEL IN ('P','I','C') AND UPPER(CAMPAIGN_NAME) LIKE '%STATEMENT%' then 'WU STATEMENT'
WHEN JOURNEY ='JOURNEY' AND CHANNEL IN ('P','I','C') AND UPPER(CAMPAIGN_NAME) LIKE '%SENDAGAIN%' then 'SENDAGAIN'
WHEN JOURNEY ='JOURNEY' AND CHANNEL IN ('P','I','C') AND UPPER(CAMPAIGN_NAME) LIKE '%ACHIEVEMENT%' then 'ACHIEVEMENT'
WHEN JOURNEY ='JOURNEY' AND CHANNEL IN ('P','I','C') AND UPPER(CAMPAIGN_NAME) LIKE '%FXGENERIC%' then 'FX GENERIC'
WHEN JOURNEY ='JOURNEY' AND CHANNEL IN ('P','I','C') AND UPPER(CAMPAIGN_NAME) LIKE '%ABANDONED%' then 'ABANDONED CART'
WHEN JOURNEY ='JOURNEY' AND CHANNEL IN ('P','I','C') AND UPPER(CAMPAIGN_NAME) LIKE '%REGISTEREDNOTTRANSACTED%' then 'RNT'
WHEN JOURNEY ='JOURNEY' AND CHANNEL IN ('P','I','C') AND UPPER(CAMPAIGN_NAME) LIKE '%RNT%' then 'RNT'
WHEN JOURNEY ='JOURNEY' AND CHANNEL IN ('P','I','C') AND UPPER(CAMPAIGN_NAME) LIKE '%FXFAVORABLE%' then 'FX FAVORABLE'
WHEN JOURNEY ='JOURNEY' AND CHANNEL IN ('P','I','C') AND UPPER(CAMPAIGN_NAME) LIKE '%FXSCHEDULED%' then 'FX SCHEDULED REMINDER'
WHEN JOURNEY ='JOURNEY' AND CHANNEL IN ('P','I','C') AND UPPER(CAMPAIGN_NAME) LIKE '%LAPSED30%' then 'LAPSED 30 DAYS'
WHEN JOURNEY ='JOURNEY' AND CHANNEL IN ('P','I','C') AND UPPER(CAMPAIGN_NAME) LIKE '%LAPSED90%' then 'LAPSED 90 DAYS'
WHEN JOURNEY ='JOURNEY' AND CHANNEL IN ('P','I','C') AND UPPER(CAMPAIGN_NAME) LIKE '%REFER%' then 'REFER A FRIEND'
ELSE 'OTHERS' END AS JOURNEY_SEGMENT
from AK_BIRD_SFMC_CAMPAIGN_AGGREGATED_CTE
WHERE 
    upper(campaign_name) not like 'TEST%' and upper(campaign_name) not like '%UNKNOWN%' AND upper(campaign_name) not like '%RCVX%'`;




var sql_command_37 = 
	`INSERT INTO BIRD_CAMPAIGN_LOG
Select 
    'SJ_bi_campaign_wise_email_communications_2_v2_mywu_UPDATE',
    CURRENT_TIMESTAMP,
    count(1) , 
    Count(distinct CAMPAIGN_NAME), 
    sum(COMMUNICATIONS_OPENED_ATLEAST_ONCE_WITHIN_30_DAYS_OF_COMMUNICATION),
    sum(COMMUNICATIONS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_30_DAYS_OF_COMMUNICATION) 
from SJ_bi_campaign_wise_email_communications_2_v2_mywu_UPDATE`;



var sql_command_38 = 
`CREATE OR REPLACE TABLE AK_BIRD_SFMC_CAMPAIGN_AGGREGATED_BACKUP_2024_2025 AS 
SELECT * FROM SJ_bi_campaign_wise_email_communications_2_v2_mywu_UPDATE
WHERE YEAR(EVENT_CAPTURED_DT) >= 2024
`;





var sql_command_39 =
	`CREATE OR REPLACE SECURE VIEW SJ_BI_CAMPAIGN_WISE_EMAIL_COMMUNICATIONS_2_V2_MYWU_UPDATE_CUSTOMER_LEVEL_VW COPY GRANTS AS
		SELECT * FROM SJ_BI_CAMPAIGN_WISE_EMAIL_COMMUNICATIONS_2_V2_MYWU_UPDATE_CUSTOMER_LEVEL`;



var sql_command_40 =
	`CREATE OR REPLACE SECURE VIEW SJ_bi_campaign_wise_email_communications_2_v2_mywu_UPDATE_VW COPY GRANTS AS
		SELECT * FROM SJ_bi_campaign_wise_email_communications_2_v2_mywu_UPDATE`;


//===========================================================================================================
//==============(EXECUTIVE DASHBOARD SCRIPT)=================================================================
//===========================================================================================================



var sql_command_41 = 
`Create or Replace Table EXE_DATE_REFERENCE_TABLE as
Select 
    Max(EVENT_CAPTURED_DT)          LATEST_DATE,
    Month(Max(EVENT_CAPTURED_DT))   LATEST_MONTH,
    YEAR(Max(EVENT_CAPTURED_DT))    LATEST_YEAR
FROM
    WUDNA.CEX_SANDBOX.SJ_bi_campaign_wise_email_communications_2_v2_mywu_UPDATE`;
	
	
	
	
var sql_command_42 = 
	`INSERT INTO BIRD_CAMPAIGN_LOG
Select 
    DISTINCT 'EXE_DATE_REFERENCE_TABLE',
    CURRENT_TIMESTAMP,
    0, 
    0, 
    0,
    0
from EXE_DATE_REFERENCE_TABLE`;
	
	
	

var sql_command_43 = 
`CREATE OR REPLACE TABLE AK_EXECUTIVE_DB_PLACEHOLDER_TEST AS
SELECT
    'MTD' AS PERIOD,
    REGION,
    CHANNEL,
	JOURNEY,
    COUNTRY_NAME,
	CTA_BASED,
    SERVICE_VS_MARKETING,
    MIN(CASE WHEN SUBPERIOD = 'MTD' THEN b.EVENT_CAPTURED_DT END) AS START_DATE,
    MAX(CASE WHEN SUBPERIOD = 'MTD' THEN b.EVENT_CAPTURED_DT END) AS END_DATE,
    SUM(CASE WHEN SUBPERIOD = 'MTD' THEN COMMUNICATIONS_SENT END) AS SENT,
    COUNT(DISTINCT CASE WHEN SUBPERIOD = 'MTD' THEN CAMPAIGN_NAME END) AS CAMPAIGN_COUNT,
    SUM(CASE WHEN SUBPERIOD = 'MTD' THEN COMMUNICATIONS_SENT - COMMUNICATIONS_UNDELIVERED END) AS DELIVERED,
    SUM(CASE WHEN SUBPERIOD = 'MTD' THEN COMMUNICATIONS_OPENED_ATLEAST_ONCE_WITHIN_7_DAYS_OF_COMMUNICATION END) AS OPENED,      //7_DAYS_ATTRIBUTION_CHANGES
    SUM(CASE WHEN SUBPERIOD = 'MTD' THEN COMMUNICATIONS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_7_DAYS_OF_COMMUNICATION END) AS CLICKED,     //7_DAYS_ATTRIBUTION_CHANGES
    SUM(CASE WHEN SUBPERIOD = 'MTD' THEN COMMUNICATIONS_UNDELIVERED END) AS HARD_BOUNCED,
    SUM(CASE WHEN SUBPERIOD = 'MTD' THEN OPT_OUTS END) AS UNSUBSCRIBED,
    SUM(CASE WHEN SUBPERIOD = 'MTD' THEN TEST_COMMUNICATIONS_WITH_ATLEAST_1_TXN_7DAYS END) AS CONVERSIONS,  //7_DAYS_ATTRIBUTION_CHANGES
    SUM(CASE WHEN SUBPERIOD = 'MTD' THEN REVENUE END) AS REVENUE1,
    //SUM(CASE WHEN SUBPERIOD = 'MTD' THEN SESSION_COUNT END) AS VISITS,
    //SUM(CASE WHEN SUBPERIOD = 'MTD' THEN TXN_STARTS END) AS MT_STARTS,
    //SUM(CASE WHEN SUBPERIOD = 'MTD' THEN RECEIPTS END) AS RECEIPTS,
    SUM(CASE WHEN SUBPERIOD = 'MTD' THEN test_communications_DIGITAL_REGISTRATION END) AS MEMBERSHIP,
    SUM(CASE WHEN SUBPERIOD = 'MTD' AND ACTIVITY_STATUS IN ('RNT','Post 30 Days RNT') THEN TEST_COMMUNICATIONS_WITH_ATLEAST_1_TXN_7DAYS END) AS RNT_To_1Xer,  //7_DAYS_ATTRIBUTION_CHANGES
    SUM(CASE WHEN SUBPERIOD = 'MTD' THEN TEST_COMMUNICATIONS_ONEX_TO_TWOX_AND_PLUS_7DAYS END) AS onex_To_2Xer,
    SUM(CASE WHEN SUBPERIOD = 'MTD' THEN TEST_COMMUNICATIONS_WINBACKS_RNT_EXCLUDED END) AS WINBACKS,
    SUM(CASE WHEN SUBPERIOD = 'MTD' THEN TEST_COMMUNICATIONS_R2D_7DAYS END) AS R2D,
    SUM(CASE WHEN SUBPERIOD = 'MTD' THEN TEST_RETAIL_ONLY_DELIVERED END) AS R2D_DELIVERED,
    SUM(CASE WHEN SUBPERIOD = 'MTD' THEN CHURN_TRANSACTION_7DAYS END) AS CHURN_TRANSACTION,     //Churn_reduction_metric
    SUM(CASE WHEN SUBPERIOD = 'MTD' THEN test_R6_CHURN_delivered END) AS CHURN_DELIVERED,       //Churn_reduction_metric
    
    MIN(CASE WHEN SUBPERIOD = 'PYMTD' THEN b.EVENT_CAPTURED_DT END) AS PY_START_DATE,
    MAX(CASE WHEN SUBPERIOD = 'PYMTD' THEN b.EVENT_CAPTURED_DT END) AS PY_END_DATE,
    SUM(CASE WHEN SUBPERIOD = 'PYMTD' THEN COMMUNICATIONS_SENT END) AS PY_SENT,
    COUNT(DISTINCT CASE WHEN SUBPERIOD = 'PYMTD' THEN CAMPAIGN_NAME END) AS PY_CAMPAIGN_COUNT,
    SUM(CASE WHEN SUBPERIOD = 'PYMTD' THEN COMMUNICATIONS_SENT - COMMUNICATIONS_UNDELIVERED END) AS PY_DELIVERED,
    SUM(CASE WHEN SUBPERIOD = 'PYMTD' THEN COMMUNICATIONS_OPENED_ATLEAST_ONCE_WITHIN_7_DAYS_OF_COMMUNICATION END) AS PY_OPENED,     //7_DAYS_ATTRIBUTION_CHANGES
    SUM(CASE WHEN SUBPERIOD = 'PYMTD' THEN COMMUNICATIONS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_7_DAYS_OF_COMMUNICATION END) AS PY_CLICKED,        //7_DAYS_ATTRIBUTION_CHANGES
    SUM(CASE WHEN SUBPERIOD = 'PYMTD' THEN COMMUNICATIONS_UNDELIVERED END) AS PY_HARD_BOUNCED,
    SUM(CASE WHEN SUBPERIOD = 'PYMTD' THEN OPT_OUTS END) AS PY_UNSUBSCRIBED,
    SUM(CASE WHEN SUBPERIOD = 'PYMTD' THEN TEST_COMMUNICATIONS_WITH_ATLEAST_1_TXN_7DAYS END) AS PY_CONVERSIONS, //7_DAYS_ATTRIBUTION_CHANGES
    SUM(CASE WHEN SUBPERIOD = 'PYMTD' THEN REVENUE END) AS PY_REVENUE1,
    //SUM(CASE WHEN SUBPERIOD = 'PYMTD' THEN SESSION_COUNT END) AS PY_VISITS,
    //SUM(CASE WHEN SUBPERIOD = 'PYMTD' THEN TXN_STARTS END) AS PY_MT_STARTS,
    //SUM(CASE WHEN SUBPERIOD = 'PYMTD' THEN RECEIPTS END) AS PY_RECEIPTS,
    SUM(CASE WHEN SUBPERIOD = 'PYMTD' THEN test_communications_DIGITAL_REGISTRATION END) AS PY_MEMBERSHIP,
    SUM(CASE WHEN SUBPERIOD = 'PYMTD' AND ACTIVITY_STATUS IN ('RNT','Post 30 Days RNT') THEN TEST_COMMUNICATIONS_WITH_ATLEAST_1_TXN_7DAYS END) AS PY_RNT_To_1Xer, //7_DAYS_ATTRIBUTION_CHANGES
    SUM(CASE WHEN SUBPERIOD = 'PYMTD' THEN TEST_COMMUNICATIONS_ONEX_TO_TWOX_AND_PLUS_7DAYS END) AS PY_onex_To_2Xer,
    SUM(CASE WHEN SUBPERIOD = 'PYMTD' THEN TEST_COMMUNICATIONS_WINBACKS_RNT_EXCLUDED END) AS PY_WINBACKS,
    SUM(CASE WHEN SUBPERIOD = 'PYMTD' THEN TEST_COMMUNICATIONS_R2D_7DAYS END) AS PY_R2D,
    SUM(CASE WHEN SUBPERIOD = 'PYMTD' THEN TEST_RETAIL_ONLY_DELIVERED END) AS PY_R2D_DELIVERED,
    SUM(CASE WHEN SUBPERIOD = 'PYMTD' THEN CHURN_TRANSACTION_7DAYS END) AS PY_CHURN_TRANSACTION,        //Churn_reduction_metric
    SUM(CASE WHEN SUBPERIOD = 'PYMTD' THEN test_R6_CHURN_delivered END) AS PY_CHURN_DELIVERED       //Churn_reduction_metric
FROM
    (SELECT
        a.EVENT_CAPTURED_DT,
        CASE WHEN (YEAR(a.EVENT_CAPTURED_DT) = YEAR(LATEST_DATE)  
             AND MONTH(a.EVENT_CAPTURED_DT) = MONTH(LATEST_DATE)
             AND DATE(a.EVENT_CAPTURED_DT) <= DATE(LATEST_DATE)) THEN 'MTD'
        WHEN (YEAR(a.EVENT_CAPTURED_DT) = YEAR(LATEST_DATE) - 1  
             AND MONTH(a.EVENT_CAPTURED_DT) = MONTH(LATEST_DATE)
             AND DATE(a.EVENT_CAPTURED_DT) <= DATEADD(YEAR, -1, LATEST_DATE)) THEN 'PYMTD' 
        ELSE 'OTHER' END AS SUBPERIOD,
        a.REGION,
        CASE 
        WHEN a.CHANNEL = 'P' THEN 'PUSH'
        WHEN a.CHANNEL = 'C' THEN 'CONTENT CARD'
        WHEN a.CHANNEL = 'I' THEN 'IN-APP'
        WHEN a.CHANNEL = 'E' THEN 'EMAIL'
        WHEN a.CHANNEL = 'S' THEN 'SMS' END AS CHANNEL,
		a.JOURNEY,
        a.COUNTRY_NAME,
		a.CTA CTA_BASED,
        a.COMMUNICATIONS_SENT,
        a.CAMPAIGN_NAME,
        CASE 
            WHEN UPPER(A.CAMPAIGN_NAME) LIKE '%SERVICE%' THEN 'SERVICE' ELSE 'MARKETING'
            END AS SERVICE_VS_MARKETING,
        a.COMMUNICATIONS_UNDELIVERED,
        a.COMMUNICATIONS_OPENED_ATLEAST_ONCE_WITHIN_7_DAYS_OF_COMMUNICATION,        //7_DAYS_ATTRIBUTION_CHANGES
        a.COMMUNICATIONS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_7_DAYS_OF_COMMUNICATION,        //7_DAYS_ATTRIBUTION_CHANGES
        a.OPT_OUTS,
        a.TEST_COMMUNICATIONS_WITH_ATLEAST_1_TXN_7DAYS, //7_DAYS_ATTRIBUTION_CHANGES
        a.REVENUE,
        //a.SESSION_COUNT,
        //a.TXN_STARTS,
        //a.RECEIPTS,
        a.test_communications_DIGITAL_REGISTRATION,
        a.ACTIVITY_STATUS,
        a.TEST_COMMUNICATIONS_ONEX_TO_TWOX_AND_PLUS_7DAYS,
        a.TEST_COMMUNICATIONS_WINBACKS_RNT_EXCLUDED,
        A.TEST_COMMUNICATIONS_R2D_7DAYS,
        A.TEST_RETAIL_ONLY_DELIVERED,
        A.CHURN_TRANSACTION_7DAYS,      //Churn_reduction_metric
        A.test_R6_CHURN_delivered       //Churn_reduction_metric
    FROM
        WUDNA.CEX_SANDBOX.SJ_bi_campaign_wise_email_communications_2_v2_mywu_UPDATE a
        INNER JOIN WUDNA.CEX_SANDBOX.EXE_DATE_REFERENCE_TABLE b 
        ON (YEAR(a.EVENT_CAPTURED_DT) = YEAR(LATEST_DATE)  
        AND MONTH(a.EVENT_CAPTURED_DT) = MONTH(LATEST_DATE)
        AND DATE(a.EVENT_CAPTURED_DT) <= DATE(LATEST_DATE))
        OR
        (YEAR(a.EVENT_CAPTURED_DT) = YEAR(LATEST_DATE) - 1  
        AND MONTH(a.EVENT_CAPTURED_DT) = MONTH(LATEST_DATE)
        AND DATE(a.EVENT_CAPTURED_DT) <= DATEADD(YEAR, -1, LATEST_DATE))
    ) AS b
GROUP BY ALL

UNION ALL

SELECT
    'Q1Q2' AS PERIOD,
    REGION,
    CHANNEL,
	JOURNEY,
    COUNTRY_NAME,
	CTA_BASED,
    SERVICE_VS_MARKETING,
    MIN(CASE WHEN SUBPERIOD = 'Q1Q2' THEN b.EVENT_CAPTURED_DT END) AS START_DATE,
    MAX(CASE WHEN SUBPERIOD = 'Q1Q2' THEN b.EVENT_CAPTURED_DT END) AS END_DATE,
    SUM(CASE WHEN SUBPERIOD = 'Q1Q2' THEN COMMUNICATIONS_SENT END) AS SENT,
    COUNT(DISTINCT CASE WHEN SUBPERIOD = 'Q1Q2' THEN CAMPAIGN_NAME END) AS CAMPAIGN_COUNT,
    SUM(CASE WHEN SUBPERIOD = 'Q1Q2' THEN COMMUNICATIONS_SENT - COMMUNICATIONS_UNDELIVERED END) AS DELIVERED,
    SUM(CASE WHEN SUBPERIOD = 'Q1Q2' THEN COMMUNICATIONS_OPENED_ATLEAST_ONCE_WITHIN_7_DAYS_OF_COMMUNICATION END) AS OPENED,     //7_DAYS_ATTRIBUTION_CHANGES
    SUM(CASE WHEN SUBPERIOD = 'Q1Q2' THEN COMMUNICATIONS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_7_DAYS_OF_COMMUNICATION END) AS CLICKED,        //7_DAYS_ATTRIBUTION_CHANGES
    SUM(CASE WHEN SUBPERIOD = 'Q1Q2' THEN COMMUNICATIONS_UNDELIVERED END) AS HARD_BOUNCED,
    SUM(CASE WHEN SUBPERIOD = 'Q1Q2' THEN OPT_OUTS END) AS UNSUBSCRIBED,
    SUM(CASE WHEN SUBPERIOD = 'Q1Q2' THEN TEST_COMMUNICATIONS_WITH_ATLEAST_1_TXN_7DAYS END) AS CONVERSIONS, //7_DAYS_ATTRIBUTION_CHANGES
    SUM(CASE WHEN SUBPERIOD = 'Q1Q2' THEN REVENUE END) AS REVENUE1,
    //SUM(CASE WHEN SUBPERIOD = 'Q1Q2' THEN SESSION_COUNT END) AS VISITS,
    //SUM(CASE WHEN SUBPERIOD = 'Q1Q2' THEN TXN_STARTS END) AS MT_STARTS,
    //SUM(CASE WHEN SUBPERIOD = 'Q1Q2' THEN RECEIPTS END) AS MTD_RECEIPTS,
    SUM(CASE WHEN SUBPERIOD = 'Q1Q2' THEN test_communications_DIGITAL_REGISTRATION END) AS MEMBERSHIP,
    SUM(CASE WHEN SUBPERIOD = 'Q1Q2' AND ACTIVITY_STATUS IN ('RNT','Post 30 Days RNT') THEN TEST_COMMUNICATIONS_WITH_ATLEAST_1_TXN_7DAYS END) AS RNT_To_1Xer, //7_DAYS_ATTRIBUTION_CHANGES
    SUM(CASE WHEN SUBPERIOD = 'Q1Q2' THEN TEST_COMMUNICATIONS_ONEX_TO_TWOX_AND_PLUS_7DAYS END) AS onex_To_2Xer,
    SUM(CASE WHEN SUBPERIOD = 'Q1Q2' THEN TEST_COMMUNICATIONS_WINBACKS_RNT_EXCLUDED END) AS WINBACKS,
    SUM(CASE WHEN SUBPERIOD = 'Q1Q2' THEN TEST_COMMUNICATIONS_R2D_7DAYS END) AS R2D,
    SUM(CASE WHEN SUBPERIOD = 'Q1Q2' THEN TEST_RETAIL_ONLY_DELIVERED END) AS R2D_DELIVERED,
    SUM(CASE WHEN SUBPERIOD = 'Q1Q2' THEN CHURN_TRANSACTION_7DAYS END) AS CHURN_TRANSACTION,        //Churn_reduction_metric
    SUM(CASE WHEN SUBPERIOD = 'Q1Q2' THEN test_R6_CHURN_delivered END) AS CHURN_DELIVERED,      //Churn_reduction_metric
    
    MIN(CASE WHEN SUBPERIOD = 'PYQ1Q2' THEN b.EVENT_CAPTURED_DT END) AS PY_START_DATE,
    MAX(CASE WHEN SUBPERIOD = 'PYQ1Q2' THEN b.EVENT_CAPTURED_DT END) AS PY_END_DATE,
    SUM(CASE WHEN SUBPERIOD = 'PYQ1Q2' THEN COMMUNICATIONS_SENT END) AS PY_SENT,
    COUNT(DISTINCT CASE WHEN SUBPERIOD = 'PYQ1Q2' THEN CAMPAIGN_NAME END) AS PY_CAMPAIGN_COUNT,
    SUM(CASE WHEN SUBPERIOD = 'PYQ1Q2' THEN COMMUNICATIONS_SENT - COMMUNICATIONS_UNDELIVERED END) AS PY_DELIVERED,
    SUM(CASE WHEN SUBPERIOD = 'PYQ1Q2' THEN COMMUNICATIONS_OPENED_ATLEAST_ONCE_WITHIN_7_DAYS_OF_COMMUNICATION END) AS PY_OPENED,        //7_DAYS_ATTRIBUTION_CHANGES
    SUM(CASE WHEN SUBPERIOD = 'PYQ1Q2' THEN COMMUNICATIONS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_7_DAYS_OF_COMMUNICATION END) AS PY_CLICKED,       //7_DAYS_ATTRIBUTION_CHANGES
    SUM(CASE WHEN SUBPERIOD = 'PYQ1Q2' THEN COMMUNICATIONS_UNDELIVERED END) AS PY_HARD_BOUNCED,
    SUM(CASE WHEN SUBPERIOD = 'PYQ1Q2' THEN OPT_OUTS END) AS PY_UNSUBSCRIBED,
    SUM(CASE WHEN SUBPERIOD = 'PYQ1Q2' THEN TEST_COMMUNICATIONS_WITH_ATLEAST_1_TXN_7DAYS END) AS PY_CONVERSIONS,    //7_DAYS_ATTRIBUTION_CHANGES
    SUM(CASE WHEN SUBPERIOD = 'PYQ1Q2' THEN REVENUE END) AS PY_REVENUE1,
    //SUM(CASE WHEN SUBPERIOD = 'PYQ1Q2' THEN SESSION_COUNT END) AS PY_VISITS,
    //SUM(CASE WHEN SUBPERIOD = 'PYQ1Q2' THEN TXN_STARTS END) AS PY_MT_STARTS,
    //SUM(CASE WHEN SUBPERIOD = 'PYQ1Q2' THEN RECEIPTS END) AS PY_RECEIPTS,
    SUM(CASE WHEN SUBPERIOD = 'PYQ1Q2' THEN test_communications_DIGITAL_REGISTRATION END) AS PY_MEMBERSHIP,
    SUM(CASE WHEN SUBPERIOD = 'PYQ1Q2' AND ACTIVITY_STATUS IN ('RNT','Post 30 Days RNT') THEN TEST_COMMUNICATIONS_WITH_ATLEAST_1_TXN_7DAYS END) AS PY_RNT_To_1Xer,    //7_DAYS_ATTRIBUTION_CHANGES
    SUM(CASE WHEN SUBPERIOD = 'PYQ1Q2' THEN TEST_COMMUNICATIONS_ONEX_TO_TWOX_AND_PLUS_7DAYS END) AS PY_onex_To_2Xer,
    SUM(CASE WHEN SUBPERIOD = 'PYQ1Q2' THEN TEST_COMMUNICATIONS_WINBACKS_RNT_EXCLUDED END) AS PY_WINBACKS,
    SUM(CASE WHEN SUBPERIOD = 'PYQ1Q2' THEN TEST_COMMUNICATIONS_R2D_7DAYS END) AS PY_R2D,
    SUM(CASE WHEN SUBPERIOD = 'PYQ1Q2' THEN TEST_RETAIL_ONLY_DELIVERED END) AS PY_R2D_DELIVERED,
    SUM(CASE WHEN SUBPERIOD = 'PYQ1Q2' THEN CHURN_TRANSACTION_7DAYS END) AS PY_CHURN_TRANSACTION,       //Churn_reduction_metric
    SUM(CASE WHEN SUBPERIOD = 'PYQ1Q2' THEN test_R6_CHURN_delivered END) AS PY_CHURN_DELIVERED      //Churn_reduction_metric
FROM
    (SELECT
        a.EVENT_CAPTURED_DT,
        CASE 
        WHEN (YEAR(a.EVENT_CAPTURED_DT) = YEAR(LATEST_DATE)
                AND  (
                       QUARTER(a.EVENT_CAPTURED_DT) = 1 OR 
                       QUARTER(a.EVENT_CAPTURED_DT) = 2
                     )
                AND DATE(a.EVENT_CAPTURED_DT) <= DATE(LATEST_DATE)) THEN 'Q1Q2'
        WHEN (YEAR(a.EVENT_CAPTURED_DT) = YEAR(LATEST_DATE) - 1
                AND  (
                       QUARTER(a.EVENT_CAPTURED_DT) = 1 OR 
                       QUARTER(a.EVENT_CAPTURED_DT) = 2
                     )
                AND DATE(a.EVENT_CAPTURED_DT) <= DATEADD(YEAR, -1, LATEST_DATE)) THEN 'PYQ1Q2' 
        ELSE 'OTHER' END AS SUBPERIOD,
        a.REGION,
        CASE 
        WHEN a.CHANNEL = 'P' THEN 'PUSH'
        WHEN a.CHANNEL = 'C' THEN 'CONTENT CARD'
        WHEN a.CHANNEL = 'I' THEN 'IN-APP'
        WHEN a.CHANNEL = 'E' THEN 'EMAIL'
        WHEN a.CHANNEL = 'S' THEN 'SMS' END AS CHANNEL,
		a.JOURNEY,
        A.COUNTRY_NAME,
		a.CTA CTA_BASED,
        a.COMMUNICATIONS_SENT,
        a.CAMPAIGN_NAME,
        CASE 
            WHEN UPPER(A.CAMPAIGN_NAME) LIKE '%SERVICE%' THEN 'SERVICE' ELSE 'MARKETING'
            END AS SERVICE_VS_MARKETING,
        a.COMMUNICATIONS_UNDELIVERED,
        a.COMMUNICATIONS_OPENED_ATLEAST_ONCE_WITHIN_7_DAYS_OF_COMMUNICATION,        //7_DAYS_ATTRIBUTION_CHANGES
        a.COMMUNICATIONS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_7_DAYS_OF_COMMUNICATION,        //7_DAYS_ATTRIBUTION_CHANGES
        a.OPT_OUTS,
        a.TEST_COMMUNICATIONS_WITH_ATLEAST_1_TXN_7DAYS, //7_DAYS_ATTRIBUTION_CHANGES
        a.REVENUE,
        //a.SESSION_COUNT,
        //a.TXN_STARTS,
        //a.RECEIPTS,
        a.test_communications_DIGITAL_REGISTRATION,
        a.ACTIVITY_STATUS,
        a.TEST_COMMUNICATIONS_ONEX_TO_TWOX_AND_PLUS_7DAYS,
        a.TEST_COMMUNICATIONS_WINBACKS_RNT_EXCLUDED,
        A.TEST_COMMUNICATIONS_R2D_7DAYS,
        A.TEST_RETAIL_ONLY_DELIVERED,
        A.CHURN_TRANSACTION_7DAYS,      //Churn_reduction_metric
        A.test_R6_CHURN_delivered       //Churn_reduction_metric
    FROM
        WUDNA.CEX_SANDBOX.SJ_bi_campaign_wise_email_communications_2_v2_mywu_UPDATE a
        INNER JOIN WUDNA.CEX_SANDBOX.EXE_DATE_REFERENCE_TABLE b 
        ON (YEAR(a.EVENT_CAPTURED_DT) = YEAR(LATEST_DATE)
           AND
            (
               QUARTER(a.EVENT_CAPTURED_DT) = 1 OR 
               QUARTER(a.EVENT_CAPTURED_DT) = 2
            )
           AND DATE(a.EVENT_CAPTURED_DT) <= DATE(LATEST_DATE))
        OR 
            (YEAR(a.EVENT_CAPTURED_DT) = YEAR(LATEST_DATE) - 1
            AND 
            (
               QUARTER(a.EVENT_CAPTURED_DT) = 1 OR 
               QUARTER(a.EVENT_CAPTURED_DT) = 2
            )
           AND DATE(a.EVENT_CAPTURED_DT) <= DATEADD(YEAR, -1, LATEST_DATE))
    ) AS b
GROUP BY ALL

UNION ALL

SELECT
    'Q1Q3' AS PERIOD,
    REGION,
    CHANNEL,
	JOURNEY,
    COUNTRY_NAME,
	CTA_BASED,
    SERVICE_VS_MARKETING,
    MIN(CASE WHEN SUBPERIOD = 'Q1Q3' THEN b.EVENT_CAPTURED_DT END) AS START_DATE,
    MAX(CASE WHEN SUBPERIOD = 'Q1Q3' THEN b.EVENT_CAPTURED_DT END) AS END_DATE,
    SUM(CASE WHEN SUBPERIOD = 'Q1Q3' THEN COMMUNICATIONS_SENT END) AS SENT,
    COUNT(DISTINCT CASE WHEN SUBPERIOD = 'Q1Q3' THEN CAMPAIGN_NAME END) AS CAMPAIGN_COUNT,
    SUM(CASE WHEN SUBPERIOD = 'Q1Q3' THEN COMMUNICATIONS_SENT - COMMUNICATIONS_UNDELIVERED END) AS DELIVERED,
    SUM(CASE WHEN SUBPERIOD = 'Q1Q3' THEN COMMUNICATIONS_OPENED_ATLEAST_ONCE_WITHIN_7_DAYS_OF_COMMUNICATION END) AS OPENED,     //7_DAYS_ATTRIBUTION_CHANGES
    SUM(CASE WHEN SUBPERIOD = 'Q1Q3' THEN COMMUNICATIONS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_7_DAYS_OF_COMMUNICATION END) AS CLICKED,        //7_DAYS_ATTRIBUTION_CHANGES
    SUM(CASE WHEN SUBPERIOD = 'Q1Q3' THEN COMMUNICATIONS_UNDELIVERED END) AS HARD_BOUNCED,
    SUM(CASE WHEN SUBPERIOD = 'Q1Q3' THEN OPT_OUTS END) AS UNSUBSCRIBED,
    SUM(CASE WHEN SUBPERIOD = 'Q1Q3' THEN TEST_COMMUNICATIONS_WITH_ATLEAST_1_TXN_7DAYS END) AS CONVERSIONS, //7_DAYS_ATTRIBUTION_CHANGES
    SUM(CASE WHEN SUBPERIOD = 'Q1Q3' THEN REVENUE END) AS REVENUE1,
    //SUM(CASE WHEN SUBPERIOD = 'Q1Q3' THEN SESSION_COUNT END) AS VISITS,
    //SUM(CASE WHEN SUBPERIOD = 'Q1Q3' THEN TXN_STARTS END) AS MT_STARTS,
    //SUM(CASE WHEN SUBPERIOD = 'Q1Q3' THEN RECEIPTS END) AS MTD_RECEIPTS,
    SUM(CASE WHEN SUBPERIOD = 'Q1Q3' THEN test_communications_DIGITAL_REGISTRATION END) AS MEMBERSHIP,
    SUM(CASE WHEN SUBPERIOD = 'Q1Q3' AND ACTIVITY_STATUS IN ('RNT','Post 30 Days RNT') THEN TEST_COMMUNICATIONS_WITH_ATLEAST_1_TXN_7DAYS END) AS RNT_To_1Xer, //7_DAYS_ATTRIBUTION_CHANGES
    SUM(CASE WHEN SUBPERIOD = 'Q1Q3' THEN TEST_COMMUNICATIONS_ONEX_TO_TWOX_AND_PLUS_7DAYS END) AS onex_To_2Xer,
    SUM(CASE WHEN SUBPERIOD = 'Q1Q3' THEN TEST_COMMUNICATIONS_WINBACKS_RNT_EXCLUDED END) AS WINBACKS,
    SUM(CASE WHEN SUBPERIOD = 'Q1Q3' THEN TEST_COMMUNICATIONS_R2D_7DAYS END) AS R2D,
    SUM(CASE WHEN SUBPERIOD = 'Q1Q3' THEN TEST_RETAIL_ONLY_DELIVERED END) AS R2D_DELIVERED,
    SUM(CASE WHEN SUBPERIOD = 'Q1Q3' THEN CHURN_TRANSACTION_7DAYS END) AS CHURN_TRANSACTION,        //Churn_reduction_metric
    SUM(CASE WHEN SUBPERIOD = 'Q1Q3' THEN test_R6_CHURN_delivered END) AS CHURN_DELIVERED,      //Churn_reduction_metric
    
    MIN(CASE WHEN SUBPERIOD = 'PYQ1Q3' THEN b.EVENT_CAPTURED_DT END) AS PY_START_DATE,
    MAX(CASE WHEN SUBPERIOD = 'PYQ1Q3' THEN b.EVENT_CAPTURED_DT END) AS PY_END_DATE,
    SUM(CASE WHEN SUBPERIOD = 'PYQ1Q3' THEN COMMUNICATIONS_SENT END) AS PY_SENT,
    COUNT(DISTINCT CASE WHEN SUBPERIOD = 'PYQ1Q3' THEN CAMPAIGN_NAME END) AS PY_CAMPAIGN_COUNT,
    SUM(CASE WHEN SUBPERIOD = 'PYQ1Q3' THEN COMMUNICATIONS_SENT - COMMUNICATIONS_UNDELIVERED END) AS PY_DELIVERED,
    SUM(CASE WHEN SUBPERIOD = 'PYQ1Q3' THEN COMMUNICATIONS_OPENED_ATLEAST_ONCE_WITHIN_7_DAYS_OF_COMMUNICATION END) AS PY_OPENED,        //7_DAYS_ATTRIBUTION_CHANGES
    SUM(CASE WHEN SUBPERIOD = 'PYQ1Q3' THEN COMMUNICATIONS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_7_DAYS_OF_COMMUNICATION END) AS PY_CLICKED,       //7_DAYS_ATTRIBUTION_CHANGES
    SUM(CASE WHEN SUBPERIOD = 'PYQ1Q3' THEN COMMUNICATIONS_UNDELIVERED END) AS PY_HARD_BOUNCED,
    SUM(CASE WHEN SUBPERIOD = 'PYQ1Q3' THEN OPT_OUTS END) AS PY_UNSUBSCRIBED,
    SUM(CASE WHEN SUBPERIOD = 'PYQ1Q3' THEN TEST_COMMUNICATIONS_WITH_ATLEAST_1_TXN_7DAYS END) AS PY_CONVERSIONS,    //7_DAYS_ATTRIBUTION_CHANGES
    SUM(CASE WHEN SUBPERIOD = 'PYQ1Q3' THEN REVENUE END) AS PY_REVENUE1,
    //SUM(CASE WHEN SUBPERIOD = 'PYQ1Q3' THEN SESSION_COUNT END) AS PY_VISITS,
    //SUM(CASE WHEN SUBPERIOD = 'PYQ1Q3' THEN TXN_STARTS END) AS PY_MT_STARTS,
    //SUM(CASE WHEN SUBPERIOD = 'PYQ1Q3' THEN RECEIPTS END) AS PY_RECEIPTS,
    SUM(CASE WHEN SUBPERIOD = 'PYQ1Q3' THEN test_communications_DIGITAL_REGISTRATION END) AS PY_MEMBERSHIP,
    SUM(CASE WHEN SUBPERIOD = 'PYQ1Q3' AND ACTIVITY_STATUS IN ('RNT','Post 30 Days RNT') THEN TEST_COMMUNICATIONS_WITH_ATLEAST_1_TXN_7DAYS END) AS PY_RNT_To_1Xer,    //7_DAYS_ATTRIBUTION_CHANGES
    SUM(CASE WHEN SUBPERIOD = 'PYQ1Q3' THEN TEST_COMMUNICATIONS_ONEX_TO_TWOX_AND_PLUS_7DAYS END) AS PY_onex_To_2Xer,
    SUM(CASE WHEN SUBPERIOD = 'PYQ1Q3' THEN TEST_COMMUNICATIONS_WINBACKS_RNT_EXCLUDED END) AS PY_WINBACKS,
    SUM(CASE WHEN SUBPERIOD = 'PYQ1Q3' THEN TEST_COMMUNICATIONS_R2D_7DAYS END) AS PY_R2D,
    SUM(CASE WHEN SUBPERIOD = 'PYQ1Q3' THEN TEST_RETAIL_ONLY_DELIVERED END) AS PY_R2D_DELIVERED,
    SUM(CASE WHEN SUBPERIOD = 'PYQ1Q3' THEN CHURN_TRANSACTION_7DAYS END) AS PY_CHURN_TRANSACTION,       //Churn_reduction_metric
    SUM(CASE WHEN SUBPERIOD = 'PYQ1Q3' THEN test_R6_CHURN_delivered END) AS PY_CHURN_DELIVERED      //Churn_reduction_metric
FROM
    (SELECT
        a.EVENT_CAPTURED_DT,
        CASE 
        WHEN (YEAR(a.EVENT_CAPTURED_DT) = YEAR(LATEST_DATE)
                AND  (
                   QUARTER(a.EVENT_CAPTURED_DT) = 1 OR 
                   QUARTER(a.EVENT_CAPTURED_DT) = 2 OR
                   QUARTER(a.EVENT_CAPTURED_DT) = 3
                     )
                AND DATE(a.EVENT_CAPTURED_DT) <= DATE(LATEST_DATE)) THEN 'Q1Q3'
        WHEN (YEAR(a.EVENT_CAPTURED_DT) = YEAR(LATEST_DATE) - 1
                AND  (
                   QUARTER(a.EVENT_CAPTURED_DT) = 1 OR 
                   QUARTER(a.EVENT_CAPTURED_DT) = 2 OR
                   QUARTER(a.EVENT_CAPTURED_DT) = 3
                     )
                AND DATE(a.EVENT_CAPTURED_DT) <= DATEADD(YEAR, -1, LATEST_DATE)) THEN 'PYQ1Q3' 
        ELSE 'OTHER' END AS SUBPERIOD,
        a.REGION,
        CASE 
        WHEN a.CHANNEL = 'P' THEN 'PUSH'
        WHEN a.CHANNEL = 'C' THEN 'CONTENT CARD'
        WHEN a.CHANNEL = 'I' THEN 'IN-APP'
        WHEN a.CHANNEL = 'E' THEN 'EMAIL'
        WHEN a.CHANNEL = 'S' THEN 'SMS' END AS CHANNEL,
		a.JOURNEY,
        A.COUNTRY_NAME,
		a.CTA CTA_BASED,
        a.COMMUNICATIONS_SENT,
        a.CAMPAIGN_NAME,
        CASE 
            WHEN UPPER(A.CAMPAIGN_NAME) LIKE '%SERVICE%' THEN 'SERVICE' ELSE 'MARKETING'
            END AS SERVICE_VS_MARKETING,
        a.COMMUNICATIONS_UNDELIVERED,
        a.COMMUNICATIONS_OPENED_ATLEAST_ONCE_WITHIN_7_DAYS_OF_COMMUNICATION,        //7_DAYS_ATTRIBUTION_CHANGES
        a.COMMUNICATIONS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_7_DAYS_OF_COMMUNICATION,        //7_DAYS_ATTRIBUTION_CHANGES
        a.OPT_OUTS,
        a.TEST_COMMUNICATIONS_WITH_ATLEAST_1_TXN_7DAYS, //7_DAYS_ATTRIBUTION_CHANGES
        a.REVENUE,
        //a.SESSION_COUNT,
        //a.TXN_STARTS,
        //a.RECEIPTS,
        a.test_communications_DIGITAL_REGISTRATION,
        a.ACTIVITY_STATUS,
        a.TEST_COMMUNICATIONS_ONEX_TO_TWOX_AND_PLUS_7DAYS,
        a.TEST_COMMUNICATIONS_WINBACKS_RNT_EXCLUDED,
        A.TEST_COMMUNICATIONS_R2D_7DAYS,
        A.TEST_RETAIL_ONLY_DELIVERED,
        A.CHURN_TRANSACTION_7DAYS,      //Churn_reduction_metric
        A.test_R6_CHURN_delivered       //Churn_reduction_metric
    FROM
        WUDNA.CEX_SANDBOX.SJ_bi_campaign_wise_email_communications_2_v2_mywu_UPDATE a
        INNER JOIN WUDNA.CEX_SANDBOX.EXE_DATE_REFERENCE_TABLE b 
        ON (YEAR(a.EVENT_CAPTURED_DT) = YEAR(LATEST_DATE)
           AND
            (
                   QUARTER(a.EVENT_CAPTURED_DT) = 1 OR 
                   QUARTER(a.EVENT_CAPTURED_DT) = 2 OR
                   QUARTER(a.EVENT_CAPTURED_DT) = 3
            )
           AND DATE(a.EVENT_CAPTURED_DT) <= DATE(LATEST_DATE))
        OR 
            (YEAR(a.EVENT_CAPTURED_DT) = YEAR(LATEST_DATE) - 1
            AND 
            (
                   QUARTER(a.EVENT_CAPTURED_DT) = 1 OR 
                   QUARTER(a.EVENT_CAPTURED_DT) = 2 OR
                   QUARTER(a.EVENT_CAPTURED_DT) = 3
            )
           AND DATE(a.EVENT_CAPTURED_DT) <= DATEADD(YEAR, -1, LATEST_DATE))
    ) AS b
GROUP BY ALL

UNION ALL

SELECT
    'YTD' AS PERIOD,
    REGION,
    CHANNEL,
	JOURNEY,
    COUNTRY_NAME,
	CTA_BASED,
    SERVICE_VS_MARKETING,
    MIN(CASE WHEN SUBPERIOD = 'YTD' THEN b.EVENT_CAPTURED_DT END) AS START_DATE,
    MAX(CASE WHEN SUBPERIOD = 'YTD' THEN b.EVENT_CAPTURED_DT END) AS END_DATE,
    SUM(CASE WHEN SUBPERIOD = 'YTD' THEN COMMUNICATIONS_SENT END) AS SENT,
    COUNT(DISTINCT CASE WHEN SUBPERIOD = 'YTD' THEN CAMPAIGN_NAME END) AS CAMPAIGN_COUNT,
    SUM(CASE WHEN SUBPERIOD = 'YTD' THEN COMMUNICATIONS_SENT - COMMUNICATIONS_UNDELIVERED END) AS DELIVERED,
    SUM(CASE WHEN SUBPERIOD = 'YTD' THEN COMMUNICATIONS_OPENED_ATLEAST_ONCE_WITHIN_7_DAYS_OF_COMMUNICATION END) AS OPENED,      //7_DAYS_ATTRIBUTION_CHANGES
    SUM(CASE WHEN SUBPERIOD = 'YTD' THEN COMMUNICATIONS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_7_DAYS_OF_COMMUNICATION END) AS CLICKED,     //7_DAYS_ATTRIBUTION_CHANGES
    SUM(CASE WHEN SUBPERIOD = 'YTD' THEN COMMUNICATIONS_UNDELIVERED END) AS HARD_BOUNCED,
    SUM(CASE WHEN SUBPERIOD = 'YTD' THEN OPT_OUTS END) AS UNSUBSCRIBED,
    SUM(CASE WHEN SUBPERIOD = 'YTD' THEN TEST_COMMUNICATIONS_WITH_ATLEAST_1_TXN_7DAYS END) AS CONVERSIONS,  //7_DAYS_ATTRIBUTION_CHANGES
    SUM(CASE WHEN SUBPERIOD = 'YTD' THEN REVENUE END) AS REVENUE1,
    //SUM(CASE WHEN SUBPERIOD = 'YTD' THEN SESSION_COUNT END) AS VISITS,
    //SUM(CASE WHEN SUBPERIOD = 'YTD' THEN TXN_STARTS END) AS MT_STARTS,
    //SUM(CASE WHEN SUBPERIOD = 'YTD' THEN RECEIPTS END) AS MTD_RECEIPTS,
    SUM(CASE WHEN SUBPERIOD = 'YTD' THEN test_communications_DIGITAL_REGISTRATION END) AS MEMBERSHIP,
    SUM(CASE WHEN SUBPERIOD = 'YTD' AND ACTIVITY_STATUS IN ('RNT','Post 30 Days RNT') THEN TEST_COMMUNICATIONS_WITH_ATLEAST_1_TXN_7DAYS END) AS RNT_To_1Xer,  //7_DAYS_ATTRIBUTION_CHANGES
    SUM(CASE WHEN SUBPERIOD = 'YTD' THEN TEST_COMMUNICATIONS_ONEX_TO_TWOX_AND_PLUS_7DAYS END) AS onex_To_2Xer,
    SUM(CASE WHEN SUBPERIOD = 'YTD' THEN TEST_COMMUNICATIONS_WINBACKS_RNT_EXCLUDED END) AS WINBACKS,
    SUM(CASE WHEN SUBPERIOD = 'YTD' THEN TEST_COMMUNICATIONS_R2D_7DAYS END) AS R2D,
    SUM(CASE WHEN SUBPERIOD = 'YTD' THEN TEST_RETAIL_ONLY_DELIVERED END) AS R2D_DELIVERED,
    SUM(CASE WHEN SUBPERIOD = 'YTD' THEN CHURN_TRANSACTION_7DAYS END) AS CHURN_TRANSACTION,     //Churn_reduction_metric
    SUM(CASE WHEN SUBPERIOD = 'YTD' THEN test_R6_CHURN_delivered END) AS CHURN_DELIVERED,       //Churn_reduction_metric
    
    MIN(CASE WHEN SUBPERIOD = 'PYYTD' THEN b.EVENT_CAPTURED_DT END) AS PY_START_DATE,
    MAX(CASE WHEN SUBPERIOD = 'PYYTD' THEN b.EVENT_CAPTURED_DT END) AS PY_END_DATE,
    SUM(CASE WHEN SUBPERIOD = 'PYYTD' THEN COMMUNICATIONS_SENT END) AS PY_SENT,
    COUNT(DISTINCT CASE WHEN SUBPERIOD = 'PYYTD' THEN CAMPAIGN_NAME END) AS PY_CAMPAIGN_COUNT,
    SUM(CASE WHEN SUBPERIOD = 'PYYTD' THEN COMMUNICATIONS_SENT - COMMUNICATIONS_UNDELIVERED END) AS PY_DELIVERED,
    SUM(CASE WHEN SUBPERIOD = 'PYYTD' THEN COMMUNICATIONS_OPENED_ATLEAST_ONCE_WITHIN_7_DAYS_OF_COMMUNICATION END) AS PY_OPENED,     //7_DAYS_ATTRIBUTION_CHANGES
    SUM(CASE WHEN SUBPERIOD = 'PYYTD' THEN COMMUNICATIONS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_7_DAYS_OF_COMMUNICATION END) AS PY_CLICKED,        //7_DAYS_ATTRIBUTION_CHANGES
    SUM(CASE WHEN SUBPERIOD = 'PYYTD' THEN COMMUNICATIONS_UNDELIVERED END) AS PY_HARD_BOUNCED,
    SUM(CASE WHEN SUBPERIOD = 'PYYTD' THEN OPT_OUTS END) AS PY_UNSUBSCRIBED,
    SUM(CASE WHEN SUBPERIOD = 'PYYTD' THEN TEST_COMMUNICATIONS_WITH_ATLEAST_1_TXN_7DAYS END) AS PY_CONVERSIONS, //7_DAYS_ATTRIBUTION_CHANGES
    SUM(CASE WHEN SUBPERIOD = 'PYYTD' THEN REVENUE END) AS PY_REVENUE1,
    //SUM(CASE WHEN SUBPERIOD = 'PYYTD' THEN SESSION_COUNT END) AS PY_VISITS,
    //SUM(CASE WHEN SUBPERIOD = 'PYYTD' THEN TXN_STARTS END) AS PY_MT_STARTS,
    //SUM(CASE WHEN SUBPERIOD = 'PYYTD' THEN RECEIPTS END) AS PY_RECEIPTS,
    SUM(CASE WHEN SUBPERIOD = 'PYYTD' THEN test_communications_DIGITAL_REGISTRATION END) AS PY_MEMBERSHIP,
    SUM(CASE WHEN SUBPERIOD = 'PYYTD' AND ACTIVITY_STATUS IN ('RNT','Post 30 Days RNT') THEN TEST_COMMUNICATIONS_WITH_ATLEAST_1_TXN_7DAYS END) AS PY_RNT_To_1Xer, //7_DAYS_ATTRIBUTION_CHANGES
    SUM(CASE WHEN SUBPERIOD = 'PYYTD' THEN TEST_COMMUNICATIONS_ONEX_TO_TWOX_AND_PLUS_7DAYS END) AS PY_onex_To_2Xer,
    SUM(CASE WHEN SUBPERIOD = 'PYYTD' THEN TEST_COMMUNICATIONS_WINBACKS_RNT_EXCLUDED END) AS PY_WINBACKS,
    SUM(CASE WHEN SUBPERIOD = 'PYYTD' THEN TEST_COMMUNICATIONS_R2D_7DAYS END) AS PY_R2D,
    SUM(CASE WHEN SUBPERIOD = 'PYYTD' THEN TEST_RETAIL_ONLY_DELIVERED END) AS PY_R2D_DELIVERED,
    SUM(CASE WHEN SUBPERIOD = 'PYYTD' THEN CHURN_TRANSACTION_7DAYS END) AS PY_CHURN_TRANSACTION,        //Churn_reduction_metric
    SUM(CASE WHEN SUBPERIOD = 'PYYTD' THEN test_R6_CHURN_delivered END) AS PY_CHURN_DELIVERED       //Churn_reduction_metric
FROM
    (SELECT
        a.EVENT_CAPTURED_DT,
        CASE WHEN (YEAR(a.EVENT_CAPTURED_DT) = YEAR(LATEST_DATE)
              AND DATE(a.EVENT_CAPTURED_DT) <= DATE(LATEST_DATE)) THEN 'YTD'
        WHEN (YEAR(a.EVENT_CAPTURED_DT) = YEAR(LATEST_DATE) - 1
            AND DATE(a.EVENT_CAPTURED_DT) <= DATEADD(YEAR, -1, LATEST_DATE)) THEN 'PYYTD' 
        ELSE 'OTHER' END AS SUBPERIOD,
        a.REGION,
        CASE 
        WHEN a.CHANNEL = 'P' THEN 'PUSH'
        WHEN a.CHANNEL = 'C' THEN 'CONTENT CARD'
        WHEN a.CHANNEL = 'I' THEN 'IN-APP'
        WHEN a.CHANNEL = 'E' THEN 'EMAIL'
        WHEN a.CHANNEL = 'S' THEN 'SMS' END AS CHANNEL,
		a.JOURNEY,
        A.COUNTRY_NAME,
		a.CTA CTA_BASED,
        a.COMMUNICATIONS_SENT,
        a.CAMPAIGN_NAME,
        CASE 
            WHEN UPPER(A.CAMPAIGN_NAME) LIKE '%SERVICE%' THEN 'SERVICE' ELSE 'MARKETING'
            END AS SERVICE_VS_MARKETING,
        a.COMMUNICATIONS_UNDELIVERED,
        a.COMMUNICATIONS_OPENED_ATLEAST_ONCE_WITHIN_7_DAYS_OF_COMMUNICATION,        //7_DAYS_ATTRIBUTION_CHANGES
        a.COMMUNICATIONS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_7_DAYS_OF_COMMUNICATION,        //7_DAYS_ATTRIBUTION_CHANGES
        a.OPT_OUTS,
        a.TEST_COMMUNICATIONS_WITH_ATLEAST_1_TXN_7DAYS, //7_DAYS_ATTRIBUTION_CHANGES
        a.REVENUE,
        //a.SESSION_COUNT,
        //a.TXN_STARTS,
        //a.RECEIPTS,
        a.test_communications_DIGITAL_REGISTRATION,
        a.ACTIVITY_STATUS,
        a.TEST_COMMUNICATIONS_ONEX_TO_TWOX_AND_PLUS_7DAYS,
        a.TEST_COMMUNICATIONS_WINBACKS_RNT_EXCLUDED,
        A.TEST_COMMUNICATIONS_R2D_7DAYS,
        A.TEST_RETAIL_ONLY_DELIVERED,
        A.CHURN_TRANSACTION_7DAYS,      //Churn_reduction_metric
        A.test_R6_CHURN_delivered       //Churn_reduction_metric
    FROM
        WUDNA.CEX_SANDBOX.SJ_bi_campaign_wise_email_communications_2_v2_mywu_UPDATE a
        INNER JOIN WUDNA.CEX_SANDBOX.EXE_DATE_REFERENCE_TABLE b 
        ON (YEAR(a.EVENT_CAPTURED_DT) = YEAR(LATEST_DATE)
            AND DATE(a.EVENT_CAPTURED_DT) <= DATE(LATEST_DATE))
        OR 
            (YEAR(a.EVENT_CAPTURED_DT) = YEAR(LATEST_DATE) - 1
            AND DATE(a.EVENT_CAPTURED_DT) <= DATEADD(YEAR, -1, LATEST_DATE))
    ) AS b
GROUP BY ALL

UNION ALL

SELECT
    'PYYR' AS PERIOD,
    REGION,
    CHANNEL,
	JOURNEY,
    COUNTRY_NAME,
	CTA_BASED,
    SERVICE_VS_MARKETING,
    MIN(CASE WHEN SUBPERIOD = 'PYYR' THEN b.EVENT_CAPTURED_DT END) AS START_DATE,
    MAX(CASE WHEN SUBPERIOD = 'PYYR' THEN b.EVENT_CAPTURED_DT END) AS END_DATE,
    SUM(CASE WHEN SUBPERIOD = 'PYYR' THEN COMMUNICATIONS_SENT END) AS SENT,
    COUNT(DISTINCT CASE WHEN SUBPERIOD = 'PYYR' THEN CAMPAIGN_NAME END) AS CAMPAIGN_COUNT,
    SUM(CASE WHEN SUBPERIOD = 'PYYR' THEN COMMUNICATIONS_SENT - COMMUNICATIONS_UNDELIVERED END) AS DELIVERED,
    SUM(CASE WHEN SUBPERIOD = 'PYYR' THEN COMMUNICATIONS_OPENED_ATLEAST_ONCE_WITHIN_7_DAYS_OF_COMMUNICATION END) AS OPENED,     //7_DAYS_ATTRIBUTION_CHANGES
    SUM(CASE WHEN SUBPERIOD = 'PYYR' THEN COMMUNICATIONS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_7_DAYS_OF_COMMUNICATION END) AS CLICKED,        //7_DAYS_ATTRIBUTION_CHANGES
    SUM(CASE WHEN SUBPERIOD = 'PYYR' THEN COMMUNICATIONS_UNDELIVERED END) AS HARD_BOUNCED,
    SUM(CASE WHEN SUBPERIOD = 'PYYR' THEN OPT_OUTS END) AS UNSUBSCRIBED,
    SUM(CASE WHEN SUBPERIOD = 'PYYR' THEN TEST_COMMUNICATIONS_WITH_ATLEAST_1_TXN_7DAYS END) AS CONVERSIONS, //7_DAYS_ATTRIBUTION_CHANGES
    SUM(CASE WHEN SUBPERIOD = 'PYYR' THEN REVENUE END) AS REVENUE1,
    //SUM(CASE WHEN SUBPERIOD = 'PYYR' THEN SESSION_COUNT END) AS VISITS,
    //SUM(CASE WHEN SUBPERIOD = 'PYYR' THEN TXN_STARTS END) AS MT_STARTS,
    //SUM(CASE WHEN SUBPERIOD = 'PYYR' THEN RECEIPTS END) AS MTD_RECEIPTS,
    SUM(CASE WHEN SUBPERIOD = 'PYYR' THEN test_communications_DIGITAL_REGISTRATION END) AS MEMBERSHIP,
    SUM(CASE WHEN SUBPERIOD = 'PYYR' AND ACTIVITY_STATUS IN ('RNT','Post 30 Days RNT') THEN TEST_COMMUNICATIONS_WITH_ATLEAST_1_TXN_7DAYS END) AS RNT_To_1Xer, //7_DAYS_ATTRIBUTION_CHANGES
    SUM(CASE WHEN SUBPERIOD = 'PYYR' THEN TEST_COMMUNICATIONS_ONEX_TO_TWOX_AND_PLUS_7DAYS END) AS onex_To_2Xer,
    SUM(CASE WHEN SUBPERIOD = 'PYYR' THEN TEST_COMMUNICATIONS_WINBACKS_RNT_EXCLUDED END) AS WINBACKS,
    SUM(CASE WHEN SUBPERIOD = 'PYYR' THEN TEST_COMMUNICATIONS_R2D_7DAYS END) AS R2D,
    SUM(CASE WHEN SUBPERIOD = 'PYYR' THEN TEST_RETAIL_ONLY_DELIVERED END) AS R2D_DELIVERED,
    SUM(CASE WHEN SUBPERIOD = 'PYYR' THEN CHURN_TRANSACTION_7DAYS END) AS CHURN_TRANSACTION,        //Churn_reduction_metric
    SUM(CASE WHEN SUBPERIOD = 'PYYR' THEN test_R6_CHURN_delivered END) AS CHURN_DELIVERED,      //Churn_reduction_metric
    
    MIN(CASE WHEN SUBPERIOD = 'P2PYR' THEN b.EVENT_CAPTURED_DT END) AS PY_START_DATE,
    MAX(CASE WHEN SUBPERIOD = 'P2PYR' THEN b.EVENT_CAPTURED_DT END) AS PY_END_DATE,
    SUM(CASE WHEN SUBPERIOD = 'P2PYR' THEN COMMUNICATIONS_SENT END) AS PY_SENT,
    COUNT(DISTINCT CASE WHEN SUBPERIOD = 'P2PYR' THEN CAMPAIGN_NAME END) AS PY_CAMPAIGN_COUNT,
    SUM(CASE WHEN SUBPERIOD = 'P2PYR' THEN COMMUNICATIONS_SENT - COMMUNICATIONS_UNDELIVERED END) AS PY_DELIVERED,
    SUM(CASE WHEN SUBPERIOD = 'P2PYR' THEN COMMUNICATIONS_OPENED_ATLEAST_ONCE_WITHIN_7_DAYS_OF_COMMUNICATION END) AS PY_OPENED,     //7_DAYS_ATTRIBUTION_CHANGES
    SUM(CASE WHEN SUBPERIOD = 'P2PYR' THEN COMMUNICATIONS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_7_DAYS_OF_COMMUNICATION END) AS PY_CLICKED,        //7_DAYS_ATTRIBUTION_CHANGES
    SUM(CASE WHEN SUBPERIOD = 'P2PYR' THEN COMMUNICATIONS_UNDELIVERED END) AS PY_HARD_BOUNCED,
    SUM(CASE WHEN SUBPERIOD = 'P2PYR' THEN OPT_OUTS END) AS PY_UNSUBSCRIBED,
    SUM(CASE WHEN SUBPERIOD = 'P2PYR' THEN TEST_COMMUNICATIONS_WITH_ATLEAST_1_TXN_7DAYS END) AS PY_CONVERSIONS, //7_DAYS_ATTRIBUTION_CHANGES
    SUM(CASE WHEN SUBPERIOD = 'P2PYR' THEN REVENUE END) AS PY_REVENUE1,
    //SUM(CASE WHEN SUBPERIOD = 'P2PYR' THEN SESSION_COUNT END) AS PY_VISITS,
    //SUM(CASE WHEN SUBPERIOD = 'P2PYR' THEN TXN_STARTS END) AS PY_MT_STARTS,
    //SUM(CASE WHEN SUBPERIOD = 'P2PYR' THEN RECEIPTS END) AS PY_RECEIPTS,
    SUM(CASE WHEN SUBPERIOD = 'P2PYR' THEN test_communications_DIGITAL_REGISTRATION END) AS PY_MEMBERSHIP,
    SUM(CASE WHEN SUBPERIOD = 'P2PYR' AND ACTIVITY_STATUS IN ('RNT','Post 30 Days RNT') THEN TEST_COMMUNICATIONS_WITH_ATLEAST_1_TXN_7DAYS END) AS PY_RNT_To_1Xer, //7_DAYS_ATTRIBUTION_CHANGES
    SUM(CASE WHEN SUBPERIOD = 'P2PYR' THEN TEST_COMMUNICATIONS_ONEX_TO_TWOX_AND_PLUS_7DAYS END) AS PY_onex_To_2Xer,
    SUM(CASE WHEN SUBPERIOD = 'P2PYR' THEN TEST_COMMUNICATIONS_WINBACKS_RNT_EXCLUDED END) AS PY_WINBACKS,
    SUM(CASE WHEN SUBPERIOD = 'P2PYR' THEN TEST_COMMUNICATIONS_R2D_7DAYS END) AS PY_R2D,
    SUM(CASE WHEN SUBPERIOD = 'P2PYR' THEN TEST_RETAIL_ONLY_DELIVERED END) AS PY_R2D_DELIVERED,     
    SUM(CASE WHEN SUBPERIOD = 'P2PYR' THEN CHURN_TRANSACTION_7DAYS END) AS PY_CHURN_TRANSACTION,    //Churn_reduction_metric
    SUM(CASE WHEN SUBPERIOD = 'P2PYR' THEN test_R6_CHURN_delivered END) AS PY_CHURN_DELIVERED //Churn_reduction_metric
FROM
    (SELECT
        a.EVENT_CAPTURED_DT,
        CASE WHEN YEAR(a.EVENT_CAPTURED_DT) = YEAR(LATEST_DATE) - 1    THEN 'PYYR'
        WHEN YEAR(a.EVENT_CAPTURED_DT) = YEAR(LATEST_DATE) - 2         THEN 'P2PYR' 
        ELSE 'OTHER' END AS SUBPERIOD,
        a.REGION,
        CASE 
        WHEN a.CHANNEL = 'P' THEN 'PUSH'
        WHEN a.CHANNEL = 'C' THEN 'CONTENT CARD'
        WHEN a.CHANNEL = 'I' THEN 'IN-APP'
        WHEN a.CHANNEL = 'E' THEN 'EMAIL'
        WHEN a.CHANNEL = 'S' THEN 'SMS' END AS CHANNEL,
		a.JOURNEY,
        A.COUNTRY_NAME,
		a.CTA CTA_BASED,
        a.COMMUNICATIONS_SENT,
        a.CAMPAIGN_NAME,
        CASE 
            WHEN UPPER(A.CAMPAIGN_NAME) LIKE '%SERVICE%' THEN 'SERVICE' ELSE 'MARKETING'
            END AS SERVICE_VS_MARKETING,
        a.COMMUNICATIONS_UNDELIVERED,
        a.COMMUNICATIONS_OPENED_ATLEAST_ONCE_WITHIN_7_DAYS_OF_COMMUNICATION,        //7_DAYS_ATTRIBUTION_CHANGES
        a.COMMUNICATIONS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_7_DAYS_OF_COMMUNICATION,        //7_DAYS_ATTRIBUTION_CHANGES
        a.OPT_OUTS,
        a.TEST_COMMUNICATIONS_WITH_ATLEAST_1_TXN_7DAYS, //7_DAYS_ATTRIBUTION_CHANGES
        a.REVENUE,
        //a.SESSION_COUNT,
        //a.TXN_STARTS,
        //a.RECEIPTS,
        a.test_communications_DIGITAL_REGISTRATION,
        a.ACTIVITY_STATUS,
        a.TEST_COMMUNICATIONS_ONEX_TO_TWOX_AND_PLUS_7DAYS,
        a.TEST_COMMUNICATIONS_WINBACKS_RNT_EXCLUDED,
        a.TEST_COMMUNICATIONS_R2D_7DAYS,
        A.TEST_RETAIL_ONLY_DELIVERED,
        A.CHURN_TRANSACTION_7DAYS,      //Churn_reduction_metric
        A.test_R6_CHURN_delivered       //Churn_reduction_metric
    FROM
        WUDNA.CEX_SANDBOX.SJ_bi_campaign_wise_email_communications_2_v2_mywu_UPDATE a
        INNER JOIN WUDNA.CEX_SANDBOX.EXE_DATE_REFERENCE_TABLE b 
        ON 
            YEAR(a.EVENT_CAPTURED_DT) = YEAR(LATEST_DATE) -1
        OR 
            YEAR(a.EVENT_CAPTURED_DT) = YEAR(LATEST_DATE) - 2
    ) AS b
GROUP BY ALL`;




var sql_command_44 = 
	`INSERT INTO BIRD_CAMPAIGN_LOG
Select 
    DISTINCT 'AK_EXECUTIVE_DB_PLACEHOLDER_TEST',
    CURRENT_TIMESTAMP,
    0, 
    0, 
    0,
    0
from AK_EXECUTIVE_DB_PLACEHOLDER_TEST`;


//=======(Added service vs marketing campaign column split)==========================================
//=======(2025-04-01)================================================================================




var sql_command_45 = 
`CREATE OR REPLACE TABLE AK_EXECUTIVE_TREND_PLACEHOLDER AS
SELECT
        DATE_TRUNC(month,a.EVENT_CAPTURED_DT) AS MTH_YR,
        //a.REGION,
        CASE 
            WHEN REGION = 'NORTH AMERICA' THEN '1) NA'
            WHEN REGION = 'EU and CIS' THEN '2) EUCIS'
            WHEN REGION = 'APAC' THEN '3) APAC'
            WHEN REGION = 'LACA' THEN '4) LACA'
            WHEN REGION = 'MEPA' THEN '5) MEPA'
            WHEN REGION = 'AFRICA' THEN '6) AFRICA'
        ELSE '7) BLANK' END AS REGION,
        A.COUNTRY_NAME,
        CASE 
        WHEN a.CHANNEL = 'P' THEN 'PUSH'
        WHEN a.CHANNEL = 'C' THEN 'CONTENT CARD'
        WHEN a.CHANNEL = 'I' THEN 'IN-APP'
        WHEN a.CHANNEL = 'E' THEN 'EMAIL'
        WHEN a.CHANNEL = 'S' THEN 'SMS' END AS CHANNEL,
		a.JOURNEY,
		a.CTA CTA_BASED,
        a.ACTIVITY_STATUS,

        CASE 
            WHEN UPPER(CAMPAIGN_NAME) LIKE '%SERVICE%' THEN 'SERVICE' ELSE 'MARKETING'
            END AS SERVICE_VS_MARKETING,
        
        SUM(a.COMMUNICATIONS_SENT) AS COMMUNICATIONS_SENT,
        COUNT(DISTINCT a.CAMPAIGN_NAME) AS CAMPAIGN_COUNT,
        SUM(a.COMMUNICATIONS_UNDELIVERED) AS COMMUNICATIONS_UNDELIVERED,
        SUM(a.COMMUNICATIONS_OPENED_ATLEAST_ONCE_WITHIN_7_DAYS_OF_COMMUNICATION) AS COMMUNICATIONS_OPENED_ATLEAST_ONCE_WITHIN_7_DAYS_OF_COMMUNICATION,
        SUM(a.COMMUNICATIONS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_7_DAYS_OF_COMMUNICATION) AS COMMUNICATIONS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_7_DAYS_OF_COMMUNICATION,
        SUM(a.OPT_OUTS) AS OPT_OUTS,
        SUM(a.TEST_COMMUNICATIONS_WITH_ATLEAST_1_TXN_7DAYS) AS COMMUNICATIONS_WITH_ATLEAST_1_TXN,
        SUM(a.REVENUE) AS REVENUE,
        //SUM(a.SESSION_COUNT) AS SESSION_COUNT,
        //SUM(a.TXN_STARTS) AS TXN_STARTS,
        //SUM(a.RECEIPTS) AS RECEIPTS,
        SUM(a.test_communications_DIGITAL_REGISTRATION) AS test_communications_LOYALTY_REGISTRATION_OPENED_CLICKED_7DAYS,
        
        SUM(a.TEST_COMMUNICATIONS_ONEX_TO_TWOX_AND_PLUS_7DAYS) AS TEST_COMMUNICATIONS_ONEX_TO_TWOX_AND_PLUS,
        SUM(a.TEST_COMMUNICATIONS_WINBACKS_RNT_EXCLUDED) AS TEST_COMMUNICATIONS_WINBACKS_RNT_EXCLUDED,
        SUM(a.TEST_COMMUNICATIONS_R2D_7DAYS) AS TEST_COMMUNICATIONS_R2D,
        SUM(A.TEST_RETAIL_ONLY_DELIVERED) AS TEST_RETAIL_ONLY_DELIVERED,
        SUM(A.CHURN_TRANSACTION_7DAYS) AS CHURN_TRANSACTION_7DAYS,      //Churn_reduction_metric
        SUM(A.test_R6_CHURN_delivered) AS test_R6_CHURN_delivered
    FROM
        WUDNA.CEX_SANDBOX.SJ_bi_campaign_wise_email_communications_2_v2_mywu_UPDATE a
        INNER JOIN WUDNA.CEX_SANDBOX.EXE_DATE_REFERENCE_TABLE b
WHere DATE_TRUNC(month,a.EVENT_CAPTURED_DT) >= dateadd(month, -25, DATE_TRUNC(month, LATEST_DATE))   and DATE_TRUNC(month,a.EVENT_CAPTURED_DT) < DATE_TRUNC(month, LATEST_DATE)         
Group By all`;





var sql_command_46 = 
	`INSERT INTO BIRD_CAMPAIGN_LOG
Select 
    DISTINCT 'AK_EXECUTIVE_TREND_PLACEHOLDER',
    CURRENT_TIMESTAMP,
    0, 
    0, 
    0,
    0
from AK_EXECUTIVE_TREND_PLACEHOLDER`;



//================================================================================================
//=============(AI/ML SCORE TABLE QUERY)==========================================================
//================================================================================================


var sql_command_47 = 
`CREATE OR REPLACE TABLE AK_CAM_43_AI_ML_SCORE_FINAL AS

//---ADDED CAMPAIGN ENGAGEMENT AND TXN DATA LAUNCHED AFTER 2025
WITH CAMP_ENGAGEMENT AS (
Select 
     Customer_Key
    
    ,SUM(CASE WHEN SUBSTR(ACTIVITY_CODE,3,1) IN ('P') THEN (TOTAL_EMAILS_SENT) ELSE 1 END) AS Sent

    ,SUM(CASE WHEN EMAILS_UN_DELIVERED > 0 THEN 1 END) AS COMMUNICATIONS_UNDELIVERED
    ,SUM(CASE WHEN EMAILS_OPENED_ATLEAST_ONCE_WITHIN_7_DAYS_OF_COMMUNICATION > 0 THEN 1 END) Opened
    ,SUM(CASE WHEN EMAILS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_7_DAYS_OF_COMMUNICATION > 0  THEN 1 END) Clicked
    
    ,SUM(Case WHEN SUBSTR(ACTIVITY_CODE,3,1) = 'P' and EMAILS_OPENED_ATLEAST_ONCE_WITHIN_7_DAYS_OF_COMMUNICATION > 0 THEN 1 END) Push_Opened
    ,SUM(Case WHEN SUBSTR(ACTIVITY_CODE,3,1) != 'P' and EMAILS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_7_DAYS_OF_COMMUNICATION > 0 THEN 1 END) WO_Push_Clicked
    ,nvl(PUSH_OPENED,0) + nvl(WO_PUSH_CLICKED,0) as Opened_Clicked

    ,SUM(Case WHEN SUBSTR(ACTIVITY_CODE,3,1) IN ('P','E') and EMAILS_OPENED_ATLEAST_ONCE_WITHIN_7_DAYS_OF_COMMUNICATION > 0 THEN 1 END) Push_Email_Opened
    ,SUM(Case WHEN SUBSTR(ACTIVITY_CODE,3,1) NOT IN ('P','E') and EMAILS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_7_DAYS_OF_COMMUNICATION > 0 THEN 1 END) SMS_CC_IAM_Clicked
    ,nvl(Push_Email_Opened,0) + nvl(SMS_CC_IAM_Clicked,0) as All_Engage_Opened_Clicked

    ,SUM(CASE WHEN RETAIL_TXNS_7DAYS > 0 THEN 1 END ) AS RETAIL_TXNS7
    ,SUM(CASE WHEN DIGITAL_TXNS_7DAYS > 0 THEN 1 END ) AS DIGITAL_TXNS7
    ,SUM(CASE WHEN TXNS_7DAYS > 0 THEN 1 END ) as TOTAL_TXNS7
        
    ,Case When TIMESTAMPDIFF(MONTH,MIN(EVENT_CAPTURED_DT),Max(EVENT_CAPTURED_DT))=0 
     Then 1 else TIMESTAMPDIFF(MONTH,MIN(EVENT_CAPTURED_DT),Max(EVENT_CAPTURED_DT)) END AS Month_Difference
    ,Round(Sent / Month_Difference,2) As Comm_Per_Month

 
from 
    WUDNA.CEX_SANDBOX.SJ_BI_CAMPAIGN_WISE_EMAIL_COMMUNICATIONS_2_V2_MYWU_UPDATE_CUSTOMER_LEVEL
where Year(EVENT_CAPTURED_DT) in ('2025') 
Group by All

),


AI_ML_01 AS (
SELECT 
    COUNT(CEM.SNDCUSTOMER_KEY) AS CUST_COUNT,
    A.COUNTRY_CODE,
    D.SUPER_REGION AS REGION,
    D.COUNTRY_NAME,
    A.HVC_FLAG,
            
    CASE 
        WHEN CEM.RETAIL_DIGITAL_FLAG IS NOT NULL THEN CEM.RETAIL_DIGITAL_FLAG ELSE 'N/A' END AS RETAIL_DIGITAL_FLAG,
    
    A.MYWU_STATUS,
    
    CASE 
        WHEN A.RFM_PERSONA IS NOT NULL THEN A.RFM_PERSONA ELSE 'N/A' END AS RFM_PERSONA,
    CASE 
        WHEN A.CHURN_RISK IS NOT NULL THEN A.CHURN_RISK ELSE 'N/A' END AS CHURN_RISK_SEGMENT,

    CASE WHEN CEM.IPF_CHANGE IS NOT NULL THEN CEM.IPF_CHANGE ELSE '<3 times transactor' END AS IPF_CHANGE,
    
    CASE WHEN CEM.BEATS IS NOT NULL THEN CEM.BEATS ELSE '<3 times transactor' END AS IPF_BEATS,
    

                    
    C.DOMINANT_CORRIDOR,
    C.DOMINANT_CORRIDOR_TYPE,
    C.DOMINANT_CORRIDOR_NAME,
    C.MTH_YR,

//-------------------------------------------------------------------------------------------------------------------------
    
    -- CASE WHEN A.R2D_PROPENSITY IS NOT NULL THEN A.R2D_PROPENSITY ELSE 'N/A' END AS R2D_CONVERSION,

    CASE 
        WHEN AIML.R2D_EQUAL_DENSITY_DECILE IN ('10') THEN 'd) 10 Decile'
        WHEN AIML.R2D_EQUAL_DENSITY_DECILE IN ('9') THEN 'c) 9 Decile'
        WHEN AIML.R2D_EQUAL_DENSITY_DECILE IN ('8') THEN 'b) 8 Decile'
        WHEN AIML.R2D_EQUAL_DENSITY_DECILE IN ('7','6','5','4','3','2','1') THEN 'a) 1-7 Decile'
            ELSE 'e) N/A' END AS R2D_CONVERSION,
    
//-------------------------------------------------------------------------------------------------------------------------

    CASE 
        WHEN A.R6_TXNS > 0 THEN 'R6 ACTIVE' ELSE 'R7 TO R12 ACTIVE' END AS ACTIVITY_STATUS,
//------------------------------------------------------------------------------------------------------------------------- 
    CASE 
        WHEN CEM.R12_PAYIN_CASH_TXNS IS NOT NULL AND CEM.R12_PAYIN_CASH_TXNS > 0 THEN 'CASH' END AS PAYIN_CASH_FLAG,
    CASE
        WHEN CEM.R12_PAYIN_ACCOUNT_TXNS IS NOT NULL AND CEM.R12_PAYIN_ACCOUNT_TXNS > 0 THEN 'ACCOUNT' END AS PAYIN_ACCOUNT_FLAG,
    CASE 
        WHEN PAYIN_CASH_FLAG = 'CASH' AND (PAYIN_ACCOUNT_FLAG <> 'ACCOUNT' OR PAYIN_ACCOUNT_FLAG IS NULL) THEN 'CASH ONLY'
        WHEN (PAYIN_CASH_FLAG <> 'CASH' OR PAYIN_CASH_FLAG IS NULL) AND PAYIN_ACCOUNT_FLAG = 'ACCOUNT' THEN 'ACCOUNT ONLY'
        WHEN PAYIN_CASH_FLAG IS NULL AND PAYIN_ACCOUNT_FLAG IS NULL THEN 'N/A'
            ELSE 'CASH + ACCOUNT' END AS PAYIN_FLAG,
//-------------------------------------------------------------------------------------------------------------------------
    CASE 
        WHEN CEM.R12_PAYOUT_CASH_TXNS IS NOT NULL AND CEM.R12_PAYOUT_CASH_TXNS > 0 THEN 'CASH' END AS PAYOUT_CASH_FLAG,
    CASE
        WHEN CEM.R12_PAYOUT_ACCOUNT_TXNS IS NOT NULL AND CEM.R12_PAYOUT_ACCOUNT_TXNS > 0 THEN 'ACCOUNT' END AS PAYOUT_ACCOUNT_FLAG,
    CASE 
        WHEN PAYOUT_CASH_FLAG = 'CASH' AND (PAYOUT_ACCOUNT_FLAG <> 'ACCOUNT' OR PAYOUT_ACCOUNT_FLAG IS NULL) THEN 'CASH ONLY'
        WHEN (PAYOUT_CASH_FLAG <> 'CASH' OR PAYOUT_CASH_FLAG IS NULL) AND PAYOUT_ACCOUNT_FLAG = 'ACCOUNT' THEN 'ACCOUNT ONLY'
        WHEN PAYOUT_CASH_FLAG IS NULL AND PAYOUT_ACCOUNT_FLAG IS NULL THEN 'N/A'
            ELSE 'CASH + ACCOUNT' END AS PAYOUT_FLAG,
//-------------------------------------------------------------------------------------------------------------------------

    CASE 
        WHEN CUST.MARKETING_FLAG = 'Y' AND CUST.OPT_WHATSAPP = 'I' THEN 'Y' ELSE 'N' END AS WHATSAPP_MARKETABLE,



//-------------------------------------------------------------------------------------------------------------------------

    
        Case 
        when CEM.SMS_MARKETABLE = 'Y' and CEM.EMAIL_MARKETABLE = 'Y' and CEM.R12_APP_TXNS > 0 Then 'EMAIL, SMS & APP'
        when CEM.SMS_MARKETABLE = 'Y' and CEM.EMAIL_MARKETABLE = 'Y' and CEM.R12_APP_TXNS = 0 Then 'EMAIL & SMS'
        when CEM.SMS_MARKETABLE = 'N' and CEM.EMAIL_MARKETABLE = 'Y' and CEM.R12_APP_TXNS > 0 Then 'EMAIL & APP'
        when CEM.SMS_MARKETABLE = 'Y' and CEM.EMAIL_MARKETABLE = 'N' and CEM.R12_APP_TXNS > 0 Then 'SMS & APP'
        when CEM.SMS_MARKETABLE = 'Y' and CEM.EMAIL_MARKETABLE = 'N' and CEM.R12_APP_TXNS = 0 Then 'SMS only'
        when CEM.SMS_MARKETABLE = 'N' and CEM.EMAIL_MARKETABLE = 'Y' and CEM.R12_APP_TXNS = 0 Then 'EMAIL only'
        when CEM.SMS_MARKETABLE = 'N' and CEM.EMAIL_MARKETABLE = 'N' and CEM.R12_APP_TXNS > 0 Then 'APP only'
        
        else 'Neither SMS nor EMAIL nor APP' end MARKETABILTY,
        

    CASE 
        WHEN MARKETABILTY <> 'Neither SMS nor EMAIL nor APP' THEN '1.Marketable' ELSE '2.Non Marketable' END AS MARKETABLE_FLAG,

//-------------------------------------------------------------------------------------------------------------

    CASE 
        WHEN CEM.R12_TXNS = 1 THEN 'A.1x' 
        WHEN CEM.R12_TXNS = 2 THEN 'B.2x'
        WHEN CEM.R12_TXNS >= 2 AND CEM.R12_TXNS < 6 THEN 'C.3x to 5x'
        WHEN CEM.R12_TXNS >= 6 AND CEM.R12_TXNS < 11 THEN 'D.6x to 10x'
            ELSE 'E.11x and Plus'  END AS TPC_FLAG,

    C.DOMINANT_AGENT_NETWORK_2,

//-------------------------------------------------------------------------------------------------------------

//-----CAMPAIGN ENGAGEMENT AND TXNS DATA-----------------------------------------------------------------------

        Case   when  Sent > 100 then '7.Sent >101'
                when  Sent > 50 then '6.Sent 51 to 100'
                when  Sent > 25 then '5.Sent 26 to 50'
                when  Sent > 10 then '4.Sent 11 to 25'
                when  Sent > 5 then '3.Sent 6 to 10'
                when  Sent > 1 then '2.Sent 2 to 5'
                when  Sent >= 1 then '1.Sent 1'                
                when Sent = 0 or Sent is null then '8.No Communications Sent'
                else '9.Other'
                END  Sent_Bucket

            ,Case  When  nvl(Opened_Clicked,0) = 0 then '2.No_Engagement'
                   When  nvl(Opened_Clicked,0) >= 1 then '1.Engagement'
                else '3.Other' END  Opened_Clicked_Bucket_Flag

                
        ,Case   When  nvl(TOTAL_TXNS7,0) = 0 then '2.No_Txns'
                When  nvl(TOTAL_TXNS7,0) >= 1 then '1.Txns'
                else '3.Other' END  Conversion_Bucket_Flag

//-------------------------------------------------------------------------------------------------------------

        ,CASE 
            WHEN GLOBAL_HOLDOUT = 'Y' THEN '2.Global Holdout'
            WHEN GLOBAL_HOLDOUT = 'N' THEN '1.Test'
        ELSE '3.Not Found' END AS GLOBAL_HOLDOUT_FLAG

//-------------------------------------------------------------------------------------------------------------
    
FROM
    CEX_SANDBOX.YN_Va_kpi_2020_output_engagement_cust_level CEM
LEFT JOIN 
    WUDNA.CEX_SANDBOX.SK_DOMINANCY_METRICS C ON CEM.SNDCUSTOMER_KEY = C.SNDCUSTOMER_KEY AND C.MTH_YR = CEM.MTH_YR
LEFT JOIN 
    WUDNA.SUMMARY_GEN.COUNTRY_VW D ON CEM.COUNTRY_CODE = D.COUNTRY_CODE
LEFT JOIN 
    WUDNA.CEX_SANDBOX.CUSTOMER_ENGAGEMENT_FRAMEWORK_CUST_LEVEL A ON A.SNDCUSTOMER_KEY = CEM.SNDCUSTOMER_KEY and CEM.MTH_YR = A.MTH_YR
LEFT JOIN 
    WUDNA.SUMMARY_GEN.WUDNA_CUSTOMER_MASTER_VW CUST ON CEM.SNDCUSTOMER_KEY = CUST.CUSTOMER_KEY
LEFT JOIN 
    CAMP_ENGAGEMENT CAMP ON CEM.SNDCUSTOMER_KEY = CAMP.CUSTOMER_KEY
LEFT JOIN 
    WUDATA_CDO_AIML.SHARE_SECURE.CUSTOMER_DAILY_SCORES_VW AIML ON A.SNDCUSTOMER_KEY = AIML.SNDCUSTOMER_KEY

WHERE CEM.R12_TXNS > 0 AND CEM.R12_TXNS IS NOT NULL AND CEM.MTH_YR = DATEADD(MONTH,-1,DATE_TRUNC(MONTH,CURRENT_DATE))

GROUP BY ALL
),

TOP_Send_Agent_AI_ML as                        
(SELECT MTH_YR, DOMINANT_SNDCOUNTRY_NAME, DOMINANT_AGENT_NETWORK_2,
--COUNT(CASE WHEN R12_ACTIVE = 'Y' THEN SNDCUSTOMER_KEY END) AS R12_ACTIVE,
ROW_NUMBER() OVER (PARTITION BY MTH_YR, DOMINANT_SNDCOUNTRY_NAME ORDER BY COUNT(CASE WHEN DATE(mth_yr) = DATEADD(MONTH,-1,DATE_TRUNC(MONTH,CURRENT_DATE)) THEN SNDCUSTOMER_KEY END) DESC) AS TOP_10_AGENT_RANK
FROM WUDNA.CEX_SANDBOX.SK_DOMINANCY_METRICS
where DATE(mth_yr) = DATEADD(MONTH,-1,DATE_TRUNC(MONTH,CURRENT_DATE))
GROUP BY 1,2,3)


SELECT 
    A.*,
    CASE WHEN TOP_10_AGENT_RANK < 11 THEN B.DOMINANT_AGENT_NETWORK_2 ELSE 'OTHERS' END AS TOP_10_AGENT
FROM AI_ML_01 A
LEFT JOIN TOP_Send_Agent_AI_ML B ON A.COUNTRY_NAME = B.DOMINANT_SNDCOUNTRY_NAME AND A.MTH_YR = DATE(B.MTH_YR) AND A.DOMINANT_AGENT_NETWORK_2 = B.DOMINANT_AGENT_NETWORK_2
WHERE 
    COUNTRY_NAME IS NOT NULL`;





var sql_command_48 = 
	`INSERT INTO BIRD_CAMPAIGN_LOG
Select 
    DISTINCT 'AK_CAM_43_AI_ML_SCORE_FINAL',
    CURRENT_TIMESTAMP,
    0, 
    0, 
    0,
    0
from AK_CAM_43_AI_ML_SCORE_FINAL`;




 var loop_list = 
            [sql_command_1,sql_command_1_1,sql_command_1_2,sql_command_1_3,sql_command_2,sql_command_3,sql_command_4,sql_command_5,sql_command_6,sql_command_7,sql_command_8,sql_command_9,sql_command_10,
            sql_command_11,sql_command_12,sql_command_13,sql_command_14,sql_command_15,sql_command_16,sql_command_17,sql_command_18,sql_command_19,sql_command_20,
			sql_command_21,sql_command_22,sql_command_23,sql_command_24,sql_command_25,sql_command_26,sql_command_27,sql_command_28,sql_command_29,sql_command_30,
			sql_command_31,sql_command_32,sql_command_33,sql_command_34,sql_command_35,sql_command_36,sql_command_37,sql_command_38,sql_command_39,sql_command_40,
			sql_command_41,sql_command_42,sql_command_43,sql_command_44,sql_command_45,sql_command_46,sql_command_47,sql_command_48];       
        
        for(yr_i = 0;yr_i < loop_list.length;yr_i++)
        {
                    try {
                snowflake.execute (
                    {sqlText: loop_list[yr_i]}
                                    )
                            }
            catch (err)  {
                return "Failed: " + err;   // Return a success/error indicator.
       
                         }
        };
    return "Stored Prcedure Completed Successfully"
	
	  $$
    ;
    
	
	
	Call BIRD_CAMPAIGN_TRACKER_WEEKLY_7_DAYS();








//=====================Task===============================

CREATE OR REPLACE TASK BIRD_CAMPAIGN_TRACKER_WEEKLY_7_DAYS_TASK
 WAREHOUSE = CEX_XLARGE_WH
   SCHEDULE = 'USING CRON 10 17 * * 6 Asia/Kolkata'
   USER_TASK_TIMEOUT_MS = 25200000
  AS
CALL BIRD_CAMPAIGN_TRACKER_WEEKLY_7_DAYS();

SELECT * FROM BIRD_CAMPAIGN_LOG;

show tasks;

ALTER TASK BIRD_CAMPAIGN_TRACKER_WEEKLY_7_DAYS_TASK resume;
 
ALTER TASK BIRD_CAMPAIGN_TRACKER_WEEKLY_7_DAYS_TASK suspend;

select * from table (information_schema.task_history())
where name = 'BIRD_CAMPAIGN_TRACKER_WEEKLY_7_DAYS_TASK';



//======================================================================================
//=====(DO NOT RUN)=================================================================================

CREATE TABLE BIRD_CAMPAIGN_LOG (
    TABLE_NAME VARCHAR(200),
    LOG_DATE TIMESTAMP_LTZ(9),
    COMMUNICATIONS_SENT_COUNT NUMBER(38,0),
    CAMPAIGN_COUNT NUMBER(38,0),
    OPENED_COUNT NUMBER(38,0),
    CLICKED_COUNT NUMBER(38,0)  
);

//======================================================================================


SELECT MAX(EVENT_CAPTURED_DT) FROM SJ_BI_CAMPAIGN_WISE_EMAIL_COMMUNICATIONS_2_V2_MYWU_UPDATE_CUSTOMER_LEVEL;

SELECT MAX(EVENT_CAPTURED_DT), 
    CHANNEL, 
    SUM(COMMUNICATIONS_SENT), 
    SUM(COMMUNICATIONS_OPENED_ATLEAST_ONCE_WITHIN_7_DAYS_OF_COMMUNICATION) AS OPEN, 
    SUM(COMMUNICATIONS_WITH_ATLEAST_ONE_LINK_CLICK_WITHIN_7_DAYS_OF_COMMUNICATION) AS CLICK
FROM SJ_bi_campaign_wise_email_communications_2_v2_mywu_UPDATE 
WHERE YEAR(EVENT_CAPTURED_DT) >= 2024
GROUP BY ALL;



SELECT CHURN_RISK FROM YN_Va_kpi_2020_output_engagement_cust_level LIMIT 100;




//===============================================================================================

-- SJ_BI_CAMPAIGN_WISE_EMAIL_COMMUNICATIONS_2_V2_MYWU_UPDATE_CUSTOMER_LEVEL
-- SJ_bi_campaign_wise_email_communications_2_v2_mywu_UPDATE

CREATE OR REPLACE TABLE WITH_UNSUBS_CLICK_SJ_BI_CAMPAIGN_WISE_EMAIL_COMMUNICATIONS_2_V2_MYWU_UPDATE_CUSTOMER_LEVEL AS
SELECT * FROM SJ_BI_CAMPAIGN_WISE_EMAIL_COMMUNICATIONS_2_V2_MYWU_UPDATE_CUSTOMER_LEVEL;


CREATE OR REPLACE TABLE WITH_UNSUBS_CLICK_SJ_bi_campaign_wise_email_communications_2_v2_mywu_UPDATE AS
SELECT * FROM SJ_bi_campaign_wise_email_communications_2_v2_mywu_UPDATE;



SELECT MAX(MTH_YR) FROM YN_Va_kpi_2020_output_engagement_cust_level;
SELECT COUNT(SNDCUSTOMER_KEY),MTH_YR FROM YN_Va_kpi_2020_output_engagement_cust_level GROUP BY ALL;

SELECT COUNT(SNDCUSTOMER_KEY),MTH_YR FROM SK_DOMINANCY_METRICS GROUP BY ALL;





SELECT COUNT(*) FROM SJ_bi_campaign_wise_email_communications_2_v2_mywu_UPDATE WHERE CAMPAIGN_NAME LIKE '%APOLOGY%';
--108,319,891

SELECT COUNT(*) FROM SJ_bi_campaign_wise_email_communications_2_v2_mywu_UPDATE_BACKUP_2025;
--108,506,986

SELECT COUNT(*)  FROM AK_BIRD_SFMC_CAMPAIGN_AGGREGATED_BACKUP_2024_2025 WHERE CAMPAIGN_NAME LIKE '%SURVEY%';
--84,579,369


SELECT *  FROM AK_BIRD_SFMC_CAMPAIGN_AGGREGATED_BACKUP_2024_2025 LIMIT 100;

DESC TABLE SJ_bi_campaign_wise_email_communications_2_v2_mywu_UPDATE_BACKUP_2025;

DESC TABLE SJ_bi_campaign_wise_email_communications_2_v2_mywu_UPDATE;

DESC TABLE AK_BIRD_SFMC_CAMPAIGN_AGGREGATED_BACKUP_2024_2025;
