CREATE OR REPLACE TABLE CAR_841_HISTORICAL_TXNS AS
SELECT DISTINCT
    SNDCUSTOMER_KEY,
    RCVPAYING_DATETIME,
    PRICING_CHANNEL,
    -- Channel classification
    CASE
        WHEN PRICING_CHANNEL IN ('WEB', 'APP') THEN 'DIGITAL'
        WHEN PRICING_CHANNEL IN ('POS', 'TMT', 'AIR') THEN 'RETAIL'
        ELSE 'OTHER'
    END AS channel_group,
    -- Time period classification
    CASE
        WHEN DATE(RCVPAYING_DATETIME) >= DATEADD(MONTH, -12, DATE('2025-01-26'))
             AND DATE(RCVPAYING_DATETIME) < DATE('2025-01-26')
        THEN 'R12'
        
        WHEN DATE(RCVPAYING_DATETIME) >= DATEADD(MONTH, -48, DATE('2025-01-26'))
             AND DATE(RCVPAYING_DATETIME) < DATEADD(MONTH, -12, DATE('2025-01-26'))
        THEN 'R13_PLUS'
    END AS history_period
FROM SUMMARY_GEN.WUDNA_TXN_MASTER_ANALYTICS_VW
WHERE DATE(RCVPAYING_DATETIME) >= DATEADD(MONTH, -48, DATE('2025-01-26'))
  AND DATE(RCVPAYING_DATETIME) < DATE('2025-01-26')
  AND SNDCOUNTRY_CODE = 'CA'
  AND RCVPAYING_DATETIME IS NOT NULL;

  -- App users in R12
CREATE OR REPLACE TEMP TABLE CAR_841_CA_APP_USERS_R12 AS
SELECT DISTINCT SNDCUSTOMER_KEY AS customer_key
FROM CAR_841_HISTORICAL_TXNS
WHERE history_period = 'R12' AND PRICING_CHANNEL = 'APP';

select count(distinct customer_key), count(customer_key) from CAR_841_CA_APP_USERS_R12;--327,290	327,290

-- Master marketability snapshot for Canada
CREATE OR REPLACE TABLE CAR_841_CA_MARKETABILITY AS
SELECT
    cm.customer_key,
    cm.country_code,
    cm.global_holdout,

    -- Email marketable (marketing + email on file + opt-in)
    CASE
      WHEN cm.marketing_flag = 'Y'
       AND cm.email_address_on_file_flag = 'Y'
       AND cm.opt_email = 'I'
      THEN 'Y' ELSE 'N' END AS email_marketability_flag,

    -- SMS marketable 
    CASE 
        WHEN cm.marketing_flag = 'Y' AND cm.mobile_number_on_file_flag = 'Y' AND cm.opt_sms = 'I' THEN 'Y'
        ELSE 'N'
    END AS sms_marketability_flag,

    -- App reachable = had APP txn in R12
    CASE WHEN au.customer_key IS NOT NULL THEN 'Y' ELSE 'N' END AS app_marketability_flag,

    -- Overall CEM addressable (any of email/sms/app)
    CASE
      WHEN (
        (cm.marketing_flag = 'Y' AND cm.email_address_on_file_flag = 'Y' AND cm.opt_email = 'I') OR
        (
          (cm.mobile_number_on_file_flag = 'Y' AND cm.opt_sms = 'I' AND cm.double_opt_sms = 'I' AND cm.marketing_flag = 'Y')
          OR
          ( cm.mobile_number_on_file_flag = 'Y' AND cm.opt_sms = 'I' AND cm.marketing_flag = 'Y')
        ) OR
        (au.customer_key IS NOT NULL)
      )
      THEN 'Y' ELSE 'N'
    END AS marketability_flag

FROM SUMMARY_GEN.WUDNA_CUSTOMER_MASTER_VW cm
LEFT JOIN CAR_841_CA_APP_USERS_R12 au
  ON cm.customer_key = au.customer_key
WHERE cm.country_code = 'CA';

select count(distinct customer_key), count(customer_key) FROM CAR_841_CA_MARKETABILITY;--9,134,584	9,134,584

I have written a script for the below request, i want you to check and complete the script and make the code simple and ensure
the proper flow of numbers.

1.overall audience of size of Canada CEM audience - the total number of Canadian users that we can send a cem communication to,
this can include both active and lapsed(Havenâ€™t transacted in the past 12 months but have transacted before that).
2.total number of addressable lapsed customers that can be reached by CEM (email/in-app/push notification/sms)-
3.total addressable RNT audience - People who have Registered in R12 and have not transacted in that time Frame
4. total audience we can message via service email - Service email would be sent to all users , so that would be the total size
Whereas addressable lapsed would only be for users that specifically opted in for marketing emails / communications
