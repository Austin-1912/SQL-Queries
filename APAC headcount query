select RFM_PERSONA from WUDNA.CEX_SANDBOX.YN_VA_KPI_2020_OUTPUT_ENGAGEMENT_CUST_LEVEL limit 100;

select max(MTH_YR) from  WUDNA.CEX_SANDBOX.YN_VA_KPI_2020_OUTPUT_ENGAGEMENT_CUST_LEVEL;

select max(MTH_YR) from WUDNA.CEX_SANDBOX.SK_CONSOLIDATED_PROPENSITY_SCORES;


/*CASE WHEN CHURN_DECILE IN (1,2,3,4,5,6,7,8) THEN '2.Low-Risk' 
       WHEN CHURN_DECILE IN (9,10)  THEN '1.High-Risk'
     ELSE 
           CASE WHEN IPF_BEATS IN ('On Schedule','Ahead Schedule','1 beat late','2 beats late') THEN '2.Low-Risk'
                WHEN IPF_BEATS IN ('3 beats late','4 beats late','5 beats plus late') THEN '1.High-Risk'
                ELSE 
                     CASE WHEN RFM_PERSONA IN ('7.LOST','5.SPORADICS','6.SLIPPING') THEN '1.High-Risk'
                          WHEN RFM_PERSONA IN ('4.WHALES','2.LOYALS','1.UBER','3.PROMISING','8.ONE AND DONES') THEN '2.Low-Risk'
                     ELSE '4: NA' END
                END
END AS CHURN_RISK,*/ 












select * from WUDNA.CEX_SANDBOX.CUSTOMER_ENGAGEMENT_FRAMEWORK_CUST_LEVEL limit 100;

select max(mth_yr) from WUDNA.CEX_SANDBOX.CUSTOMER_ENGAGEMENT_FRAMEWORK_CUST_LEVEL;

select count(*), count(distinct customer_key) from CAR_574_AU_NZ_CUSTOMER_BASE;--850,532	850,532

select * from CAR_574_AU_NZ_CUSTOMER_BASE limit 1000;


CREATE OR REPLACE TABLE AU_NZ_R12_CUSTOMERS_L0_PRICING as 
select 
    distinct sndcustomer_key,
    CASE WHEN FEE_SEGMENT_USED IN ('N0','P0','S1') THEN 'N0'
WHEN FEE_SEGMENT_USED IN ('N6','N7','M1','S0','S2','S3') THEN 'N6'
WHEN FX_SEGMENT_USED IN ('N0','P0','S1') AND FEE_SEGMENT_USED  = 'L0' THEN 'N0'
WHEN FX_SEGMENT_USED IN ('N6','N7','M1','S0','S2','S3') AND FEE_SEGMENT_USED  = 'L0' THEN 'N6'
ELSE 'L0'
END AS PRICING_SEGMENT
FROM
    WUDNA.SUMMARY_GEN.WUDNA_TXN_MASTER_ANALYTICS_VW
WHERE
    SNDCOUNTRY_CODE in ('AU','NZ')
AND
    DATE(RCVPAYING_DATETIME)>='2024-07-01'
AND
    DATE(RCVPAYING_DATETIME)<='2025-06-30'
and
    PRICING_SEGMENT='L0'
and sndcustomer_key is not null;
    
select count(*), count(distinct sndcustomer_key) from AU_NZ_R12_CUSTOMERS_L0_PRICING;

CREATE OR REPLACE TABLE CAR_574_AU_NZ_R12_ACTIVE_TXN_BASE AS
select
    SNDCOUNTRY_CODE,
    SEND_COUNTRY_NAME,
    SNDCUSTOMER_KEY,
    TXN_ID,
    RCVPAYING_DATETIME,
    PRICING_CHANNEL,
    case when PRICING_CHANNEL in ('POS','AIR','TMT') THEN 'RETAIL'
    WHEN PRICING_CHANNEL IN ('WEB','APP') THEN 'DIGITAL'
    ELSE 'OTHERS' END AS TRANSACTION_CHANNEL,
    SNDPRINCIPAL_AMOUNT,
    
    CASE WHEN FEE_SEGMENT_USED IN ('N0','P0','S1') THEN 'N0'
WHEN FEE_SEGMENT_USED IN ('N6','N7','M1','S0','S2','S3') THEN 'N6'
WHEN FX_SEGMENT_USED IN ('N0','P0','S1') AND FEE_SEGMENT_USED  = 'L0' THEN 'N0'
WHEN FX_SEGMENT_USED IN ('N6','N7','M1','S0','S2','S3') AND FEE_SEGMENT_USED  = 'L0' THEN 'N6'
ELSE 'L0'
END AS PRICING_SEGMENT
    
FROM
    WUDNA.SUMMARY_GEN.WUDNA_TXN_MASTER_ANALYTICS_VW A
WHERE
    SNDCOUNTRY_CODE in ('AU','NZ')
AND
    DATE(RCVPAYING_DATETIME)>='2024-07-01'
AND
    DATE(RCVPAYING_DATETIME)<='2025-06-30';
--AND
   -- SNDCUSTOMER_KEY in (select distinct sndcustomer_key from AU_NZ_R12_CUSTOMERS_L0_PRICING);


select count(*),count(distinct sndcustomer_key) from CAR_574_AU_NZ_R12_ACTIVE_TXN_BASE;--6,413,320	634,329





select * from CAR_574_AU_NZ_R12_ACTIVE_TXN_BASE limit 100;

select
    PRICING_SEGMENT,
    COUNT(*),
    COUNT(DISTINCT SNDCUSTOMER_KEY)
FROM
    CAR_574_AU_NZ_R12_ACTIVE_TXN_BASE
GROUP BY 1;


select
    SNDCOUNTRY_CODE,
    COUNT(*),
    COUNT(DISTINCT SNDCUSTOMER_KEY)
FROM
    CAR_574_AU_NZ_R12_ACTIVE_TXN_BASE
GROUP BY 1;



CREATE OR REPLACE TABLE CAR_574_AU_NZ_R12_ACTIVE_CUST_SEGMENT_LEVEL_DIGITAL_ONLY_L0 AS 
SELECT
    *,
    CASE WHEN RETAIL_TXN>0 and DIGITAL_TXN>0 THEN 'OMNI_CUST'
    WHEN RETAIL_TXN>0 and DIGITAL_TXN=0 THEN 'RETAIL_ONLY'
    WHEN RETAIL_TXN=0 and DIGITAL_TXN>0 THEN 'DIGITAL_ONLY'
    WHEN RETAIL_TXN=0 and DIGITAL_TXN=0 THEN 'R12_INACTIVE'
    ELSE 'OTHERS' END AS NATIVE_CHANNEL
FROM
    (
select
    SNDCUSTOMER_KEY,
    SEND_COUNTRY_NAME,
    --'L0' as PRICING_SEGMENT,
    COUNT(TXN_ID) as TOTAL_TXN,
    COUNT(case when TRANSACTION_CHANNEL='RETAIL' THEN TXN_ID END) as RETAIL_TXN,
    COUNT(case when TRANSACTION_CHANNEL='DIGITAL' THEN TXN_ID END) as DIGITAL_TXN,
    SUM(SNDPRINCIPAL_AMOUNT) as TOTAL_PRINCIPAL

    
FROM
    CAR_574_AU_NZ_R12_ACTIVE_TXN_BASE
GROUP BY ALL
)
where NATIVE_CHANNEL='DIGITAL_ONLY' ;

CREATE OR REPLACE TABLE CAR_574_AU_NZ_R12_ACTIVE_CUST_SEGMENT_LEVEL_DIGITAL_ONLY_L0_1 AS 
select 
    a.*,
    case when B.SNDCUSTOMER_KEY is null then 'OTHERS' ELSE 'L0' END PRICING_SEGMENT
FROM
    CAR_574_AU_NZ_R12_ACTIVE_CUST_SEGMENT_LEVEL_DIGITAL_ONLY_L0 A
LEFT JOIN
    AU_NZ_R12_CUSTOMERS_L0_PRICING B
ON
    A.SNDCUSTOMER_KEY=B.SNDCUSTOMER_KEY;


select * from CAR_574_AU_NZ_R12_ACTIVE_CUST_SEGMENT_LEVEL_DIGITAL_ONLY_L0_1;

select NATIVE_CHANNEL, count(*), count(distinct sndcustomer_key) from CAR_574_AU_NZ_R12_ACTIVE_CUST_SEGMENT_LEVEL_DIGITAL_ONLY_L0 group by 1;--292,331	292,085

select * from CAR_574_AU_NZ_R12_ACTIVE_CUST_SEGMENT_LEVEL_DIGITAL_ONLY_L0 where NATIVE_CHANNEL='OMNI_CUST' and RETAIL_TXN>0 and DIGITAL_TXN=0;--OMNI_CUST

select * from CAR_574_AU_NZ_R12_ACTIVE_CUST_SEGMENT_LEVEL_DIGITAL_ONLY_L0 where sndcustomer_key in ('4000000000077050236');



create or replace table CAR_574_AU_NZ_CUSTOMER_BASE as 
select
    SNDCUSTOMER_KEY as CUSTOMER_KEY,
    RETAIL_DIGITAL_FLAG as NATIVE_CHANNEL,
    COUNTRY_CODE,
    --COUNTRY_NAME,
    case when R12_APP_TXNS>=1 then 'YES' ELSE 'NO' END APP_MARKETABLE_FLAG,
    --IPF_BEATS,
    --RFM_PERSONA,
    IPF,
    --RFM_PERSONA,
    CASE WHEN CHURN_DECILE IN (1,2,3,4,5,6,7,8) THEN '2.Low-Risk' 
       WHEN CHURN_DECILE IN (9,10)  THEN '1.High-Risk'
     ELSE 
           CASE WHEN IPF_BEATS IN ('On Schedule','Ahead Schedule','1 beat late','2 beats late') THEN '2.Low-Risk'
                WHEN IPF_BEATS IN ('3 beats late','4 beats late','5 beats plus late') THEN '1.High-Risk'
                ELSE 
                     CASE WHEN RFM_PERSONA IN ('7.LOST','5.SPORADICS','6.SLIPPING') THEN '1.High-Risk'
                          WHEN RFM_PERSONA IN ('4.WHALES','2.LOYALS','1.UBER','3.PROMISING','8.ONE AND DONES') THEN '2.Low-Risk'
                     ELSE '4: NA' END
                END
END AS CHURN_RISK
    
FROM
   --WUDNA.CEX_SANDBOX.CUSTOMER_ENGAGEMENT_FRAMEWORK_CUST_LEVEL
   WUDNA.CEX_SANDBOX.YN_VA_KPI_2020_OUTPUT_ENGAGEMENT_CUST_LEVEL
WHERE
    COUNTRY_CODE in ('AU','NZ')
AND
  NATIVE_CHANNEL in ('Digital Only')  
AND
    MTH_YR='2025-06-01'
AND
    SNDCUSTOMER_KEY in (select distinct sndcustomer_key from CAR_574_AU_NZ_R12_ACTIVE_CUST_SEGMENT_LEVEL_DIGITAL_ONLY_L0_1);

SELECT MAX(MTH_YR) FROM  WUDNA.CEX_SANDBOX.CUSTOMER_ENGAGEMENT_FRAMEWORK_CUST_LEVEL; --2025-06-01


select count(*), count(distinct CUSTOMER_KEY) from CAR_574_AU_NZ_CUSTOMER_BASE;--289,616	289,616

select * from CAR_574_AU_NZ_CUSTOMER_BASE;


select * from CAR_574_AU_NZ_R12_ACTIVE_CUST_SEGMENT_LEVEL_DIGITAL_ONLY_L0;

select 289951-292331;


CREATE OR REPLACE TABLE CAR_574_AU_NZ_R12_ACTIVE_CUST_LEVEL_DIGITAL_ONLY_WITH_IPF_RFM as 
select
    a.sndcustomer_key,
    a.send_country_name,
    a.pricing_segment,
    a.total_txn,
    a.total_principal,
    a.native_channel,
    --b.customer_key,
    b.APP_MARKETABLE_FLAG,
    b.IPF_BEATS,
    b.RFM_PERSONA,
    b.CHURN_RISK
    
FROM
    CAR_574_AU_NZ_R12_ACTIVE_CUST_SEGMENT_LEVEL_DIGITAL_ONLY_L0_1 AS A
INNER JOIN
    CAR_574_AU_NZ_CUSTOMER_BASE B
ON
    A.SNDCUSTOMER_KEY=B.CUSTOMER_KEY;


select count(*), count(distinct sndcustomer_key) from CAR_574_AU_NZ_R12_ACTIVE_CUST_LEVEL_DIGITAL_ONLY_WITH_IPF_RFM;--289,835	289,591

select * from WUDNA.SUMMARY_GEN.WUDNA_CUSTOMER_MASTER_VW limit 199;

CREATE OR REPLACE TABLE CAR_574_AU_NZ_R12_ACTIVE_CUST_LEVEL_DIGITAL_ONLY_WITH_IPF_RFM_MARKETABLE_FLAG as 
select
    a.*,
    b.customer_UMN,
    case when b.MARKETING_FLAG='Y' and b.EMAIL_ADDRESS_ON_FILE_FLAG='Y' and b.OPT_EMAIL='I' then 'YES' ELSE 'NO' END AS EMAIL_MARKETABLE_FLAG, 
    case when b.MARKETING_FLAG='Y' and b.mobile_number_on_file_flag='Y' and b.OPT_SMS='I' then 'YES' ELSE 'NO' END AS SMS_MARKETABLE_FLAG ,
    b.GLOBAL_HOLDOUT,
    case when a.app_marketable_flag='YES' or EMAIL_MARKETABLE_FLAG='YES' or SMS_MARKETABLE_FLAG='YES' THEN 'YES' ELSE 'NO' END AS MARKETABILITY_FLAG
    
FROM
    CAR_574_AU_NZ_R12_ACTIVE_CUST_LEVEL_DIGITAL_ONLY_WITH_IPF_RFM A
LEFT JOIN
    WUDNA.SUMMARY_GEN.WUDNA_CUSTOMER_MASTER_VW B
ON
    A.SNDCUSTOMER_KEY=B.CUSTOMER_KEY;


select * from CAR_574_AU_NZ_R12_ACTIVE_CUST_LEVEL_DIGITAL_ONLY_WITH_IPF_RFM_MARKETABLE_FLAG;
select * from WUDNA.CEX_SANDBOX.SK_CONSOLIDATED_PROPENSITY_SCORES limit 100;



select * from 

select
    a.*,
    B.R2D_DECILE,
    B.R2D_SCORES
FROM
   CAR_574_AU_NZ_R12_ACTIVE_CUST_LEVEL_DIGITAL_ONLY_WITH_IPF_RFM_MARKETABLE_FLAG A
LEFT JOIN
   WUDNA.CEX_SANDBOX.SK_CONSOLIDATED_PROPENSITY_SCORES B
ON
    A.SNDCUSTOMER_KEY=B.SNDCUSTOMER_KEY;

--CUSTOMER LIST EXTRACTION

--AUSTRALIA HIGH CHURN DIGITAL ONLY L0 MARKETABLE CUSTOMERS 

select 
'@'|| SNDCUSTOMER_KEY as CUSTOMER_KEY, 
SEND_COUNTRY_NAME, 
PRICING_SEGMENT, 
TOTAL_TXN, 
TOTAL_PRINCIPAL as TOTAL_PRINCIPAL_AMT_AUD, 
NATIVE_CHANNEL, 
APP_MARKETABLE_FLAG, 
IPF_BEATS, 
RFM_PERSONA, 
CHURN_RISK, 
CUSTOMER_UMN, 
EMAIL_MARKETABLE_FLAG, 
SMS_MARKETABLE_FLAG, 
GLOBAL_HOLDOUT, 
MARKETABILITY_FLAG
from 
    CAR_574_AU_NZ_R12_ACTIVE_CUST_LEVEL_DIGITAL_ONLY_WITH_IPF_RFM_MARKETABLE_FLAG 
where 
    CHURN_RISK='1.High-Risk' 
and SEND_COUNTRY_NAME='AUSTRALIA' 
and PRICING_SEGMENT='L0' 
and MARKETABILITY_FLAG='YES';

--AUSTRALIA LOW CHURN DIGITAL ONLY L0 MARKETABLE CUSTOMERS 

select 
'@'|| SNDCUSTOMER_KEY as CUSTOMER_KEY, 
SEND_COUNTRY_NAME, 
PRICING_SEGMENT, 
TOTAL_TXN, 
TOTAL_PRINCIPAL as TOTAL_PRINCIPAL_AMT_AUD, 
NATIVE_CHANNEL, 
APP_MARKETABLE_FLAG, 
IPF_BEATS, 
RFM_PERSONA, 
CHURN_RISK, 
CUSTOMER_UMN, 
EMAIL_MARKETABLE_FLAG, 
SMS_MARKETABLE_FLAG, 
GLOBAL_HOLDOUT, 
MARKETABILITY_FLAG
from 
    CAR_574_AU_NZ_R12_ACTIVE_CUST_LEVEL_DIGITAL_ONLY_WITH_IPF_RFM_MARKETABLE_FLAG 
where 
    CHURN_RISK='2.Low-Risk' 
and SEND_COUNTRY_NAME='AUSTRALIA' 
and PRICING_SEGMENT='L0' 
and MARKETABILITY_FLAG='YES';


--NEW-ZEALAND HIGH CHURN DIGITAL ONLY L0 MARKETABLE CUSTOMERS
select 
'@'|| SNDCUSTOMER_KEY as CUSTOMER_KEY, 
SEND_COUNTRY_NAME, 
PRICING_SEGMENT, 
TOTAL_TXN, 
TOTAL_PRINCIPAL as TOTAL_PRINCIPAL_AMT_AUD, 
NATIVE_CHANNEL, 
APP_MARKETABLE_FLAG, 
IPF_BEATS, 
RFM_PERSONA, 
CHURN_RISK, 
CUSTOMER_UMN, 
EMAIL_MARKETABLE_FLAG, 
SMS_MARKETABLE_FLAG, 
GLOBAL_HOLDOUT, 
MARKETABILITY_FLAG
from 
    CAR_574_AU_NZ_R12_ACTIVE_CUST_LEVEL_DIGITAL_ONLY_WITH_IPF_RFM_MARKETABLE_FLAG 
where 
    CHURN_RISK='1.High-Risk' 
and SEND_COUNTRY_NAME='NEW ZEALAND' 
and PRICING_SEGMENT='L0' 
and MARKETABILITY_FLAG='YES';


--NEW-ZEALAND LOW CHURN DIGITAL ONLY L0 MARKETABLE CUSTOMERS
select 
'@'|| SNDCUSTOMER_KEY as CUSTOMER_KEY, 
SEND_COUNTRY_NAME, 
PRICING_SEGMENT, 
TOTAL_TXN, 
TOTAL_PRINCIPAL as TOTAL_PRINCIPAL_AMT_AUD, 
NATIVE_CHANNEL, 
APP_MARKETABLE_FLAG, 
IPF_BEATS, 
RFM_PERSONA, 
CHURN_RISK, 
CUSTOMER_UMN, 
EMAIL_MARKETABLE_FLAG, 
SMS_MARKETABLE_FLAG, 
GLOBAL_HOLDOUT, 
MARKETABILITY_FLAG
from 
    CAR_574_AU_NZ_R12_ACTIVE_CUST_LEVEL_DIGITAL_ONLY_WITH_IPF_RFM_MARKETABLE_FLAG 
where 
    CHURN_RISK='2.Low-Risk' 
and SEND_COUNTRY_NAME='NEW ZEALAND' 
and PRICING_SEGMENT='L0' 
and MARKETABILITY_FLAG='YES';




select 
* 
from 
    CAR_574_AU_NZ_R12_ACTIVE_CUST_LEVEL_DIGITAL_ONLY_WITH_IPF_RFM_MARKETABLE_FLAG 
where 
    CHURN_RISK='2.Low-Risk' 
and SEND_COUNTRY_NAME='AUSTRALIA' 
and PRICING_SEGMENT='L0' 
and MARKETABILITY_FLAG='YES';
    
CREATE OR REPLACE TABLE CAR_574_AU_NZ_R12_ACTIVE_CUST_LEVEL_DIGITAL_ONLY_WITH_IPF_RFM_MARKETABLE_FLAG_DOMINANT_CORRIDOR_NZ_TO_IN_PH AS 
select 
    a.*,
    b.dominant_corridor,
    b.DOMINANT_SNDCOUNTRY_NAME,
    b.dominant_rcvcountry_name
from
   CAR_574_AU_NZ_R12_ACTIVE_CUST_LEVEL_DIGITAL_ONLY_WITH_IPF_RFM_MARKETABLE_FLAG A
LEFT JOIN
    WUDNA.CEX_SANDBOX.SK_DOMINANCY_METRICS B
ON
    A.SNDCUSTOMER_KEY=B.SNDCUSTOMER_KEY
where
    B.MTH_YR='2025-06-01'
AND
    a.send_country_name in ('NEW ZEALAND')
AND
    b.dominant_corridor in ('NZ-PH','NZ-IN');


select * from CAR_574_AU_NZ_R12_ACTIVE_CUST_LEVEL_DIGITAL_ONLY_WITH_IPF_RFM_MARKETABLE_FLAG_DOMINANT_CORRIDOR_NZ_TO_IN_PH where CHURN_RISK='1.High-Risk'
and PRICING_SEGMENT='L0' and marketability_flag='YES';


select
    SEND_COUNTRY_NAME,
    CHURN_RISK,
    PRICING_SEGMENT,
    COUNT(DISTINCT SNDCUSTOMER_KEY),
    COUNT(SNDCUSTOMER_KEY)
FROM
    CAR_574_AU_NZ_R12_ACTIVE_CUST_LEVEL_DIGITAL_ONLY_WITH_IPF_RFM_MARKETABLE_FLAG_DOMINANT_CORRIDOR_NZ_TO_IN_PH
where 
    CHURN_RISK='1.High-Risk'
GROUP BY ALL;


CREATE OR REPLACE TABLE CAR_574_AU_NZ_R12_ACTIVE_CUST_LEVEL_DIGITAL_ONLY_WITH_IPF_RFM_MARKETABLE_FLAG_DOMINANT_CORRIDOR_AU_TO_IN_PH AS 
select 
    a.*,
    b.dominant_corridor,
    b.DOMINANT_SNDCOUNTRY_NAME,
    b.dominant_rcvcountry_name
from
   CAR_574_AU_NZ_R12_ACTIVE_CUST_LEVEL_DIGITAL_ONLY_WITH_IPF_RFM_MARKETABLE_FLAG A
LEFT JOIN
    WUDNA.CEX_SANDBOX.SK_DOMINANCY_METRICS B
ON
    A.SNDCUSTOMER_KEY=B.SNDCUSTOMER_KEY
where
    B.MTH_YR='2025-06-01'
AND
    a.send_country_name in ('AUSTRALIA')
AND
    b.dominant_corridor in ('AU-PH','AU-IN');

select * from CAR_574_AU_NZ_R12_ACTIVE_CUST_LEVEL_DIGITAL_ONLY_WITH_IPF_RFM_MARKETABLE_FLAG_DOMINANT_CORRIDOR_AU_TO_IN_PH where CHURN_RISK='1.High-Risk'
and PRICING_SEGMENT='L0' and MARKETABILITY_FLAG='YES';--17k



select
    SEND_COUNTRY_NAME,
    CHURN_RISK,
    PRICING_SEGMENT,
    COUNT(DISTINCT SNDCUSTOMER_KEY),
    COUNT(SNDCUSTOMER_KEY)
FROM
    CAR_574_AU_NZ_R12_ACTIVE_CUST_LEVEL_DIGITAL_ONLY_WITH_IPF_RFM_MARKETABLE_FLAG_DOMINANT_CORRIDOR_AU_TO_IN_PH
where 
    CHURN_RISK='1.High-Risk'
GROUP BY ALL;
