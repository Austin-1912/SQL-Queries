CREATE OR REPLACE TABLE CG_PRODUCT_ANALYTICS_EVENTS_WITH_USERID AS
SELECT
    a.amplitude_id,
    a.platform,
DATE_TRUNC(MONTH, DATE(EVENT_TIME)) AS MTH_YR,
COUNT(DISTINCT a.AMPLITUDE_ID) AS VOLUME,
CASE WHEN a.EVENT_PROPERTIES:a.sender_country :: text = 'PH' THEN 'PHILIPPINES'
     WHEN a.EVENT_PROPERTIES:a.sender_country :: text = 'IN' THEN 'INDIA' END SEND_COUNTRY,
    b.user_id
FROM
    WUDNA.SUMMARY_GEN.EVENTS_351757_VW A
LEFT JOIN
    (SELECT
        amplitude_id,
        MAX(user_id) as user_id
     FROM WUDNA.SUMMARY_GEN.EVENTS_351757_VW
     WHERE  DATE_TRUNC(MONTH, EVENT_TIME) >= '2025-12-01'
    AND EVENT_PROPERTIES:sender_country IN ('PH', 'IN')
    GROUP BY ALL) B
ON
    A.amplitude_id = B.amplitude_id
WHERE
    DATE_TRUNC(MONTH, EVENT_TIME) >= '2025-12-01'
    AND EVENT_PROPERTIES:sender_country IN ('PH', 'IN')
    GROUP BY ALL
    LIMIT 50;

create or replace table CG_PRODUCT_ANALYTICS_EVENTS_WITH_Customer_Key as
    select
        a.*,
        b.customer_key as GID, 
        b.customer_umn,
   
    from
        CG_PRODUCT_ANALYTICS_EVENTS_WITH_USERID A
    LEFT JOIN
        WUDNA.SUMMARY_GEN.WUDNA_ACCOUNT_MASTER_VW B
    ON
        A.USER_ID=MD5(B.CUSTOMER_UMN);
