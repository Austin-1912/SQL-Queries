-- 7. Active, acquisitions, churn
WITH PR12 AS (
    SELECT DISTINCT SNDCUSTOMER_KEY
    FROM SUMMARY_GEN.WUDNA_TXN_MASTER_ANALYTICS_VW
    WHERE DATE(RCVPAYING_DATETIME) BETWEEN '2023-10-01' AND '2024-09-30'
),
R12 AS (
    SELECT DISTINCT SNDCUSTOMER_KEY
    FROM SUMMARY_GEN.WUDNA_TXN_MASTER_ANALYTICS_VW
    WHERE DATE(RCVPAYING_DATETIME) BETWEEN '2024-10-01' AND '2025-09-30'
)
SELECT
    COUNT(DISTINCT p.SNDCUSTOMER_KEY) AS active_start_2023,
    COUNT(DISTINCT r.SNDCUSTOMER_KEY) AS active_end_2023,
    COUNT(DISTINCT r.SNDCUSTOMER_KEY)
        - COUNT(DISTINCT CASE WHEN p.SNDCUSTOMER_KEY IS NOT NULL THEN r.SNDCUSTOMER_KEY END) AS acquisition_2023,
    COUNT(DISTINCT p.SNDCUSTOMER_KEY)
        - COUNT(DISTINCT CASE WHEN r.SNDCUSTOMER_KEY IS NOT NULL THEN p.SNDCUSTOMER_KEY END) AS churned_2023
FROM PR12 p
FULL OUTER JOIN R12 r
    ON p.SNDCUSTOMER_KEY = r.SNDCUSTOMER_KEY;
