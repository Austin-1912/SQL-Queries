 -----------------------------------------------------------------------------------
-- STEP 1: RNT Customers Table
-----------------------------------------------------------------------------------
CREATE OR REPLACE TABLE LACA_RNT_CUSTOMERS AS
WITH params AS (
  SELECT 12 AS rnt_window_mths
),
-- Generate months from Jan 2024 up to the last completed month

months AS (
  SELECT DISTINCT DATE_TRUNC('MONTH', MTH_YR) AS ref_date
  FROM WUDNA.CEX_SANDBOX.VA_KPI_2020_2
  WHERE MTH_YR >= TO_DATE('2024-01-01')
    AND MTH_YR < DATE_TRUNC('MONTH', CURRENT_DATE)
),

-- Registered customers
cust_reg AS (
  SELECT
    c.customer_key,
    DATE_TRUNC('MONTH', c.first_registration_date) AS reg_month,
    first_registration_date,
    c.country_code,
    CASE
    WHEN c.email_address_on_file_flag = 'Y'
     AND c.opt_email = 'I'
     AND c.marketing_flag = 'Y'
    THEN 'Y'
    ELSE 'N'
  END AS email_marketable,
  CASE
    WHEN (c.opt_sms = 'I'
      AND c.mobile_number_on_file_flag = 'Y'
      AND c.marketing_flag = 'Y'
      AND c.country_code NOT IN ('US','CA'))
    OR (c.mobile_number_on_file_flag = 'Y'
      AND c.opt_sms = 'I'
      AND c.double_opt_sms = 'I'
      AND c.marketing_flag = 'Y'
      AND c.country_code IN ('US','CA'))
    THEN 'Y'
    ELSE 'N'
  END AS sms_marketable
  FROM SUMMARY_GEN.WUDNA_CUSTOMER_MASTER_VW c
  JOIN SUMMARY_GEN.COUNTRY_VW cnt
    ON c.country_code = cnt.country_code
  WHERE cnt.super_region = 'LACA'
    AND c.first_registration_date IS NOT NULL
),
-- Transactions
txns_rnt AS (
  SELECT DISTINCT
    t.sndcustomer_key AS customer_key,
    MIN(rcvpaying_datetime) as first_txn_date
  FROM SUMMARY_GEN.WUDNA_TXN_MASTER_ANALYTICS_VW t
JOIN SUMMARY_GEN.COUNTRY_VW snd
  ON t.sndcountry_code = snd.country_code
  WHERE snd.super_region = 'LACA'
    and t.rcvpaying_datetime >= '2023-01-01'
    Group by  all
),
-- RNT logic: registered in R12 window and no transactions in same R12 window

rnt_no_txn AS (
  SELECT
  distinct
    m.ref_date,
    r.customer_key,
    r.country_code,
    r.reg_month,
    email_marketable,
 sms_marketable
  FROM months m
  JOIN cust_reg r
    ON r.reg_month BETWEEN DATEADD(MONTH, - (SELECT rnt_window_mths FROM params) + 1, m.ref_date)
                      AND m.ref_date
  LEFT JOIN txns_rnt t
    ON r.customer_key = t.customer_key
   AND t.first_txn_date BETWEEN date(r.first_registration_date) AND LAST_DAY(m.ref_date)
   --and date(r.first_registration_date) <= date(t.first_txn_date)
  WHERE t.customer_key IS NULL --and first_txn_date <= LAST_DAY(m.ref_date)

)
-- Final RNT customer table
SELECT DISTINCT
  rnt.ref_date,
  rnt.customer_key,
  rnt.country_code,
  rnt.reg_month,
  'Y' AS rnt_flag,
 email_marketable,
 sms_marketable
FROM rnt_no_txn rnt;
i want you to keep this query dont use YN_KPI table for getting the transactions , what we can do is to 
check for RNT transactions go back 48 months from the ref date and check for transactions.
So the logic now would be RNT are those customers who have registered in the R12 month from the ref month , but 
have not transacted in the R48 month from the ref month and we wont be using YN_VA_KPI_2020_OUTPUT_ENGAGEMENT_CUST_LEVEL to 
get the transactions just bring all transactions from 2021 using the above query 
and then in RNt no transactions check for transactions 48 months 
from the ref month 48 months from the ref data and get all the transactions. Also i have corrected the RNT for blanks however
i am still getting blanks in dominant sndcountry and dominant rcvcountry and i can see they fall under lapsed R12+ and active R12 
customers why are they falling under this category could you check and correct where we are going wrong.
