I'll fix both issues. Let me update the RNT logic and investigate why you're getting blanks in dominant countries for non-RNT customers.
Issue 1: Updated RNT Logic - Check R48 from Ref Date
-----------------------------------------------------------------------------------
-- STEP 1: RNT Customers Table (UPDATED - R48 lookback from ref_date)
-----------------------------------------------------------------------------------
CREATE OR REPLACE TABLE LACA_RNT_CUSTOMERS AS
WITH params AS (
  SELECT 12 AS rnt_window_mths,
         48 AS txn_lookback_mths  -- Check 48 months back for transactions
),

-- Generate months from Jan 2024 up to the last completed month
months AS (
  SELECT DISTINCT DATE_TRUNC('MONTH', MTH_YR) AS ref_date
  FROM WUDNA.CEX_SANDBOX.VA_KPI_2020_2
  WHERE MTH_YR >= TO_DATE('2024-01-01')
    AND MTH_YR < DATE_TRUNC('MONTH', CURRENT_DATE)
),

-- Registered customers
cust_reg AS (
  SELECT
    c.customer_key,
    DATE_TRUNC('MONTH', c.first_registration_date) AS reg_month,
    first_registration_date,
    c.country_code,
    CASE
      WHEN c.email_address_on_file_flag = 'Y'
       AND c.opt_email = 'I'
       AND c.marketing_flag = 'Y'
      THEN 'Y'
      ELSE 'N'
    END AS email_marketable,
    CASE
      WHEN (c.opt_sms = 'I'
        AND c.mobile_number_on_file_flag = 'Y'
        AND c.marketing_flag = 'Y'
        AND c.country_code NOT IN ('US','CA'))
      OR (c.mobile_number_on_file_flag = 'Y'
        AND c.opt_sms = 'I'
        AND c.double_opt_sms = 'I'
        AND c.marketing_flag = 'Y'
        AND c.country_code IN ('US','CA'))
      THEN 'Y'
      ELSE 'N'
    END AS sms_marketable
  FROM SUMMARY_GEN.WUDNA_CUSTOMER_MASTER_VW c
  JOIN SUMMARY_GEN.COUNTRY_VW cnt
    ON c.country_code = cnt.country_code
  WHERE cnt.super_region = 'LACA'
    AND c.first_registration_date IS NOT NULL
),

-- All transactions from 2021 onwards
all_txns AS (
  SELECT DISTINCT
    t.sndcustomer_key AS customer_key,
    DATE_TRUNC('MONTH', t.rcvpaying_datetime) AS txn_month,
    t.rcvpaying_datetime AS txn_date
  FROM SUMMARY_GEN.WUDNA_TXN_MASTER_ANALYTICS_VW t
  JOIN SUMMARY_GEN.COUNTRY_VW snd
    ON t.sndcountry_code = snd.country_code
  WHERE snd.super_region = 'LACA'
    AND t.rcvpaying_datetime >= '2021-01-01'  -- Get all transactions from 2021
),

-- RNT logic: 
-- 1. Registered in R12 window (from ref_date)
-- 2. NO transactions in R48 window (from ref_date)
rnt_no_txn AS (
  SELECT DISTINCT
    m.ref_date,
    r.customer_key,
    r.country_code,
    r.reg_month,
    r.email_marketable,
    r.sms_marketable
  FROM months m
  JOIN cust_reg r
    ON r.reg_month BETWEEN DATEADD(MONTH, - (SELECT rnt_window_mths FROM params) + 1, m.ref_date)
                      AND m.ref_date
  LEFT JOIN all_txns t
    ON r.customer_key = t.customer_key
    -- Check for ANY transaction in the R48 window from ref_date
    AND t.txn_date BETWEEN DATEADD(MONTH, - (SELECT txn_lookback_mths FROM params), m.ref_date)
                       AND LAST_DAY(m.ref_date)
  WHERE t.customer_key IS NULL  -- No transactions found in R48 window
)

-- Final RNT customer table
SELECT DISTINCT
  rnt.ref_date,
  rnt.customer_key,
  rnt.country_code,
  rnt.reg_month,
  'Y' AS rnt_flag,
  rnt.email_marketable,
  rnt.sms_marketable
FROM rnt_no_txn rnt;
Issue 2: Blanks in Dominant Countries for Active/Lapsed Customers
The blanks are coming from your engagement source table. Let's diagnose:
Diagnostic Query:
-- Find customers with blank dominant countries
SELECT 
  ref_date,
  r12_active,
  lapsed_r12_plus,
  rnt_flag,
  dominant_corridor_name,
  dominant_sndcountry_name,
  dominant_rcvcountry_name,
  COUNT(DISTINCT customer_key) AS customer_count,
  SUM(r12_txns) AS total_r12_txns,
  SUM(pr12_txns) AS total_pr12_txns
FROM LACA_ENGAGEMENT_CORRIDOR_CUSTOMERS
WHERE (dominant_sndcountry_name IS NULL OR dominant_rcvcountry_name IS NULL)
  AND ref_date = (SELECT MAX(ref_date) FROM LACA_ENGAGEMENT_CORRIDOR_CUSTOMERS)
GROUP BY ref_date, r12_active, lapsed_r12_plus, rnt_flag, 
         dominant_corridor_name, dominant_sndcountry_name, dominant_rcvcountry_name
ORDER BY customer_count DESC;
Root Cause:
The blanks come from the LEFT JOIN to SK_DOMINANCY_METRICS in Step 2:
LEFT JOIN WUDNA.CEX_SANDBOX.SK_DOMINANCY_METRICS d
  ON e.sndcustomer_key = d.sndcustomer_key
 AND e.mth_yr = d.mth_yr
If a customer doesn't have dominancy data, these fields will be NULL.
Solution: Add Default Values in Step 2
-----------------------------------------------------------------------------------
-- STEP 2: Engagement + Corridor Customers Table (UPDATED - Handle NULLs)
-----------------------------------------------------------------------------------
CREATE OR REPLACE TABLE LACA_ENGAGEMENT_CORRIDOR_CUSTOMERS AS
SELECT
  e.sndcustomer_key AS customer_key,
  e.country_code,
  DATE_TRUNC('MONTH', e.mth_yr) AS ref_date,
  DATE_TRUNC('MONTH', cm.first_registration_date) AS reg_month,
  e.r12_txns,
  CASE WHEN e.r12_txns > 0 THEN 'Y' ELSE 'N' END AS r12_active,
  e.r6_txns,
  CASE WHEN e.r6_txns = 0 AND e.r12_txns > 0 THEN 'Y' ELSE 'N' END AS active_churn_r7_r12,
  e.pr12_txns,
  e.ppr12_txns,
  e.pppr12_txns,
  CASE WHEN e.r12_txns = 0 AND (e.pr12_txns > 0 OR e.ppr12_txns > 0 OR e.pppr12_txns > 0) 
    THEN 'Y' ELSE 'N' END AS lapsed_r12_plus,
  e.email_marketable,
  e.sms_marketable,
  CASE WHEN e.R12_App_txns > 0 THEN 'Y' ELSE 'N' END AS app_marketable_flag,
  e.retail_digital_flag,
  e.Web_App_Flag, 
  e.r12_dominant_channel AS channel_dominance,
  
  CASE
    WHEN e.retail_digital_flag = 'R12_INACTIVE' THEN 'R12 Inactive'
    WHEN e.retail_digital_flag = 'Digital_only' THEN 'Digital Only'
    WHEN e.retail_digital_flag = 'Retail_only' THEN 'Retail Only'
    WHEN e.retail_digital_flag = 'Retail+Digital' THEN 'Retail + Digital'
    ELSE 'Other'
  END AS channel_native,
  
  -- ✅ HANDLE NULL DOMINANT COUNTRIES
  COALESCE(d.dominant_corridor_name, 'Unknown') AS dominant_corridor_name,
  COALESCE(d.dominant_sndcountry_name, 'Unknown') AS dominant_sndcountry_name,
  COALESCE(d.dominant_rcvcountry_name, 'Unknown') AS dominant_rcvcountry_name,
  COALESCE(d.dominant_pricing_channel, 'Unknown') AS dominant_pricing_channel,
  
  'N' AS rnt_flag
FROM WUDNA.CEX_SANDBOX.YN_VA_KPI_2020_OUTPUT_ENGAGEMENT_CUST_LEVEL e
INNER JOIN SUMMARY_GEN.COUNTRY_VW c
  ON e.country_code = c.country_code
  AND c.super_region = 'LACA'
LEFT JOIN WUDNA.CEX_SANDBOX.SK_DOMINANCY_METRICS d
  ON e.sndcustomer_key = d.sndcustomer_key
  AND e.mth_yr = d.mth_yr 
LEFT JOIN SUMMARY_GEN.WUDNA_CUSTOMER_MASTER_VW cm               
  ON e.sndcustomer_key = cm.customer_key 
WHERE e.r48_txns > 0;  -- Only include customers who have transacted in R48
Issue 3: Why Are They in Active/Lapsed?
If customers have blank dominant countries but are classified as Active R1-R12 or Lapsed R12+, it means:
They have transactions (r12_txns > 0 or pr12_txns > 0)
BUT they don't have dominancy data in SK_DOMINANCY_METRICS
This could happen if:
The dominancy calculation hasn't run for those customers
They transacted very recently and dominancy hasn't been updated
Data quality issue in the dominancy table
Validation Query:
-- Check if these customers have transactions but no dominancy
SELECT 
  e.ref_date,
  COUNT(DISTINCT e.customer_key) AS customers_without_dominancy,
  SUM(e.r12_txns) AS total_r12_txns,
  SUM(e.pr12_txns) AS total_pr12_txns,
  COUNT(DISTINCT d.sndcustomer_key) AS customers_with_dominancy
FROM WUDNA.CEX_SANDBOX.YN_VA_KPI_2020_OUTPUT_ENGAGEMENT_CUST_LEVEL e
LEFT JOIN WUDNA.CEX_SANDBOX.SK_DOMINANCY_METRICS d
  ON e.sndcustomer_key = d.sndcustomer_key
  AND e.mth_yr = d.mth_yr
WHERE e.r12_txns > 0
  AND e.mth_yr >= '2024-01-01'
  AND d.sndcustomer_key IS NULL
GROUP BY e.ref_date
ORDER BY e.ref_date DESC;
Summary of Changes:
✅ RNT Logic: Now checks R48 months back from ref_date (not from registration)
✅ All Transactions from 2021: Captures full transaction history
✅ Handle NULL Dominant Countries: Set to 'Unknown' instead of NULL
✅ RNT Countries: Already set to 'RNT' in Step 4
After running these updates:
RNT customers will only include those with NO transactions in R48 window
Blanks will be replaced with 'Unknown' for engagement customers
'RNT' will show for RNT-only customers
Run the diagnostic query first to see how many customers are affected, then apply the fixes!
