

--To create backup tables
CREATE OR REPLACE TABLE Country_Packet_CUST_LEVEL_R12_Backup clone Country_Packet_CUST_LEVEL_R12;

select distinct DOMINANT_RCVAGENT_NETWORK_2 from CEX_SANDBOX.SK_DOMINANCY_METRICS;
	
CREATE OR REPLACE TABLE Country_Packet_CUST_LEVEL_R12  AS
SELECT
 distinct 
DATE(CEM.MTH_YR) AS MTH_YR,
CEM.SNDCUSTOMER_KEY,
CV.SUPER_REGION AS REGION,
CEM.COUNTRY_CODE,
CV.COUNTRY_NAME,

CASE WHEN CEM.FLAG_CONTACTABLE = 'N' THEN 'Not Contactable'
     ELSE 'Contactable' END FLAG_CONTACTABLE,
CASE WHEN CEM.FLAG_MARKETABLE = 'N' THEN 'Not Marketable'
     ELSE 'Marketable' END AS FLAG_MARKETABLE,
     
CASE WHEN CEM.EMAIL_MARKETABLE = 'Y' AND CEM.SMS_MARKETABLE = 'N' THEN 'Email Only ' 
     WHEN CEM.SMS_MARKETABLE = 'Y' AND CEM.EMAIL_MARKETABLE = 'N' THEN 'SMS Only'
     WHEN CEM.SMS_MARKETABLE = 'Y' AND CEM.EMAIL_MARKETABLE = 'Y' THEN 'SMS + Email'
     ELSE 'Non Marketable' END AS EMAIL_SMS_MARKETABLE,

CEM.R1_TXNS,
CEM.R12_TXNS,
CEM.R1_PRINCIPAL,
CEM.R12_PRINCIPAL,
CEM.R1_REVENUE,
CEM.R12_REVENUE,
CEM.R1_FEE,
CEM.R12_FEE,
CEM.R1_NET_FX,
CEM.R12_NET_FX,
--CEM.MYWU_status,-------AK----------------------------------
--DOM_CM.DOMINANT_CORRIDOR_TYPE,-------AK----------------------------------

CASE WHEN CEM.R1_TXNS > 0 AND CEM.R2_TO_R13_TXNS=0 AND CEM.R14_TO_R25_TXNS = 0  AND CEM.R26_TO_R37_TXNS=0 AND CEM.R38_TO_R49_TXNS=0 THEN 'Y' ELSE 'N' END AS AQUISITION,
CASE WHEN CEM.R1_TXNS > 0 AND CEM.R2_TO_R13_TXNS=0 AND (CEM.R14_TO_R25_TXNS > 0 OR CEM.R26_TO_R37_TXNS > 0 OR CEM.R38_TO_R49_TXNS>0) THEN 'Y' ELSE 'N' END AS WINBACK,
CASE WHEN CEM.R12_TXNS = 0 AND  CEM.R2_TO_R13_TXNS > 0 THEN 'Y' ELSE 'N' END AS CHURN,
CEM.New_Existing_flag as R12_active_breakup, --Added retained customers
ret.txns_in_60_days,  --60 days return customers


CASE WHEN CEM.R12_TXNS > 0 THEN  'Y' ELSE 'N' END AS R12_ACTIVE,
CASE WHEN CEM.R1_TXNS > 0 THEN  'Y' ELSE 'N' END AS R1_ACTIVE,


CASE WHEN CEM.R12_TXNS = 0 AND CEM.R2_TO_R13_TXNS > 0 THEN RFM_R13.RFM_PERSONA ELSE RFM_CM.RFM_PERSONA END AS RFM__PERSONA,

CASE WHEN CEM.R12_TXNS = 0 AND CEM.R2_TO_R13_TXNS > 0 THEN CEM_R13.R12_DOMINANT_CHANNEL ELSE CEM.R12_DOMINANT_CHANNEL END AS DOMINANT_CHANNEL, 


CASE WHEN CEM.R12_TXNS = 0 AND CEM.R2_TO_R13_TXNS > 0 THEN UPPER(NVL(DOM_R13.DOMINANT_AGENT_NETWORK_2,DOM_R13.DOMINANT_AGENT_BUSINESS_NAME)) 
          ELSE UPPER(NVL(DOM_CM.DOMINANT_AGENT_NETWORK_2,DOM_CM.DOMINANT_AGENT_BUSINESS_NAME)) END AS DOMINANT_AGENT_OLD,
		  
CASE WHEN DOMINANT_AGENT_OLD = 'NA' THEN 'DIGITAL' ELSE DOMINANT_AGENT_OLD END AS DOMINANT_AGENT,-------AK----------------------------------
	 
CASE WHEN CEM.R12_TXNS = 0 AND CEM.R2_TO_R13_TXNS > 0 THEN UPPER(NVL(DOM_R13.DOMINANT_RCVAGENT_NETWORK_2,DOM_R13.DOMINANT_RCVAGENT_BUSINESS_NAME)) 
          ELSE UPPER(NVL(DOM_CM.DOMINANT_RCVAGENT_NETWORK_2,DOM_CM.DOMINANT_RCVAGENT_BUSINESS_NAME)) END AS DOMINANT_RCV_AGENT,   --Dominant Receive Agent Added

CASE WHEN CEM.R12_TXNS = 0 AND CEM.R2_TO_R13_TXNS > 0 THEN DOM_R13.DOMINANT_AGENT_DMA_DESC
          ELSE DOM_CM.DOMINANT_AGENT_DMA_DESC END AS DOMINANT_AGENT_DMA,

CASE WHEN CEM.R12_TXNS = 0 AND CEM.R2_TO_R13_TXNS > 0 THEN DOM_R13.DOMINANT_CORRIDOR_TYPE
          ELSE DOM_CM.DOMINANT_CORRIDOR_TYPE END AS DOMINANT_CORRIDOR_TYPE_1,
 
CASE WHEN CEM.R12_TXNS = 0 AND CEM.R2_TO_R13_TXNS > 0 THEN DOM_R13.DOMINANT_CORRIDOR_NAME ELSE DOM_CM.DOMINANT_CORRIDOR_NAME END AS DOMINANT__CORRIDOR,  --CAM-1174 Add Country Name along with Country Code Across all Report
CASE WHEN CEM.R12_TXNS = 0 AND CEM.R2_TO_R13_TXNS > 0 THEN DOM_R13.DOMINANT_SNDCOUNTRY_NAME ELSE DOM_CM.DOMINANT_SNDCOUNTRY_NAME END AS DOMINANT__SNDCOUNTRY_NAME,
CASE WHEN CEM.R12_TXNS = 0 AND CEM.R2_TO_R13_TXNS > 0 THEN DOM_R13.DOMINANT_RCVCOUNTRY_NAME ELSE DOM_CM.DOMINANT_RCVCOUNTRY_NAME END AS DOMINANT__RCVCOUNTRY_NAME,
CASE WHEN CEM.R12_TXNS = 0 AND CEM.R2_TO_R13_TXNS > 0 THEN DOM_R13.DOMINANT_ATTRBUTE_FUNDS_IN ELSE DOM_CM.DOMINANT_ATTRBUTE_FUNDS_IN END AS DOMINANT_ATTRBUTE_FUNDS_IN,  -- Dominant metrics added
CASE WHEN CEM.R12_TXNS = 0 AND CEM.R2_TO_R13_TXNS > 0 THEN DOM_R13.DOMINANT_ATTRBUTE_FUNDS_OUT ELSE DOM_CM.DOMINANT_ATTRBUTE_FUNDS_OUT END AS DOMINANT_ATTRBUTE_FUNDS_OUT, --Dominant metrics added

CASE WHEN CEM.R12_TXNS = 0 AND CEM.R2_TO_R13_TXNS > 0 THEN CEM_R13.RETAIL_DIGITAL_FLAG ELSE CEM.RETAIL_DIGITAL_FLAG END AS RETAIL_DIGITAL__FLAG,

CASE WHEN CEM.R12_TXNS = 0 AND CEM.R2_TO_R13_TXNS > 0 THEN CEM_R13.MYWU_status ELSE CEM.MYWU_status END AS MYWU_status_1

FROM (SELECT C.*, DATEADD(MONTH,-12, DATE(MTH_YR)) AS R12_MTH_YR FROM CEX_SANDBOX.YN_VA_KPI_2020_OUTPUT_ENGAGEMENT_CUST_LEVEL C) CEM
LEFT JOIN CEX_SANDBOX.YN_VA_KPI_2020_OUTPUT_ENGAGEMENT_CUST_LEVEL CEM_R13 ON CEM.SNDCUSTOMER_KEY = CEM_R13.SNDCUSTOMER_KEY AND CEM_R13.MTH_YR = CEM.R12_MTH_YR

LEFT JOIN (SELECT C.*, DATEADD(MONTH,-12, DATE(MTH_YR)) AS R12_MTH_YR FROM CEX_SANDBOX.SK_DOMINANCY_METRICS C) DOM_CM ON CEM.SNDCUSTOMER_KEY = DOM_CM.SNDCUSTOMER_KEY AND DATE(CEM.MTH_YR) = DATE(DOM_CM.MTH_YR)
LEFT JOIN CEX_SANDBOX.SK_DOMINANCY_METRICS DOM_R13 ON CEM.SNDCUSTOMER_KEY = DOM_R13.SNDCUSTOMER_KEY AND DOM_R13.MTH_YR = CEM.R12_MTH_YR

LEFT JOIN (SELECT C.*, DATEADD(MONTH,-12, DATE(MTH_YR)) AS R12_MTH_YR FROM CEX_SANDBOX.SK_CONSOLIDATED_PROPENSITY_SCORES C) RFM_CM ON CEM.SNDCUSTOMER_KEY = RFM_CM.SNDCUSTOMER_KEY AND DATE(RFM_CM.MTH_YR) = DATE(CEM.MTH_YR) and RFM_CM.RFM_Persona is not null
LEFT JOIN CEX_SANDBOX.SK_CONSOLIDATED_PROPENSITY_SCORES RFM_R13 ON CEM.SNDCUSTOMER_KEY = RFM_R13.SNDCUSTOMER_KEY AND DATE(RFM_R13.MTH_YR) = CEM.R12_MTH_YR and RFM_R13.RFM_Persona is not null

INNER JOIN SUMMARY_GEN.COUNTRY_VW CV ON CV.COUNTRY_CODE = CEM.COUNTRY_CODE AND CV.SUPER_REGION IS NOT NULL
LEFT JOIN yn_R1_return_rate_in_60_days_1 ret on CEM.SNDCUSTOMER_KEY = ret.SNDCUSTOMER_KEY and ret.mth_yr = CEM.mth_yr
                
WHERE CEM.MTH_YR IN (SELECT DISTINCT MTH_YR FROM CEX_SANDBOX.YN_VA_KPI_2020_OUTPUT_ENGAGEMENT_CUST_LEVEL ORDER BY MTH_YR DESC LIMIT 13);

	








create or replace table TOP_Send_Agent_backup clone TOP_Send_Agent;


create or replace table TOP_Send_Agent as                          -------AK----------------------------------
SELECT MTH_YR, COUNTRY_NAME, DOMINANT_AGENT,
COUNT(CASE WHEN R12_ACTIVE = 'Y' THEN SNDCUSTOMER_KEY END) AS R12_ACTIVE,
ROW_NUMBER() OVER (PARTITION BY MTH_YR, COUNTRY_NAME ORDER BY COUNT(CASE WHEN R12_ACTIVE = 'Y' THEN SNDCUSTOMER_KEY END) DESC) AS TOP_10_AGENT_RANK
FROM Country_Packet_CUST_LEVEL_R12
where mth_yr <> date_trunc('MONTH',sysdate())
GROUP BY 1,2,3; 




create or replace table TOP_RCV_Agent AS
SELECT MTH_YR,COUNTRY_NAME, DOMINANT_RCV_AGENT,
COUNT(CASE WHEN R12_ACTIVE = 'Y' THEN SNDCUSTOMER_KEY END) AS R12_ACTIVE,
ROW_NUMBER() OVER (PARTITION BY MTH_YR,COUNTRY_NAME ORDER BY COUNT(CASE WHEN R12_ACTIVE = 'Y' THEN SNDCUSTOMER_KEY END) DESC) AS TOP_10_RCV_Agent_RANK
FROM Country_Packet_CUST_LEVEL_R12
where mth_yr <> date_trunc('MONTH',sysdate())
GROUP BY 1,2,3;--2 Min 47 sec





create or replace table TOP_50_CORRIDORS_COUNTRY as                            -------AK----------------------------------
SELECT MTH_YR, COUNTRY_NAME, DOMINANT__CORRIDOR,
COUNT(CASE WHEN R12_ACTIVE = 'Y' THEN SNDCUSTOMER_KEY END) AS R12_ACTIVE,
ROW_NUMBER() OVER (PARTITION BY MTH_YR, COUNTRY_NAME ORDER BY COUNT(CASE WHEN R12_ACTIVE = 'Y' THEN SNDCUSTOMER_KEY END) DESC) AS TOP_50_DOMINANT_CORRIDOR_RANK
FROM Country_Packet_CUST_LEVEL_R12
where mth_yr <> date_trunc('MONTH',sysdate())
GROUP BY 1,2,3; 





create or replace table TOP_20_COUNTRIES_BY_REGION as                          -------AK----------------------------------
SELECT MTH_YR, REGION, COUNTRY_NAME,
COUNT(CASE WHEN R12_ACTIVE = 'Y' THEN SNDCUSTOMER_KEY END) AS R12_ACTIVE,
ROW_NUMBER() OVER (PARTITION BY MTH_YR, REGION ORDER BY COUNT(CASE WHEN R12_ACTIVE = 'Y' THEN SNDCUSTOMER_KEY END) DESC) AS TOP_20_COUNTRIES_RANK
FROM Country_Packet_CUST_LEVEL_R12
where mth_yr <> date_trunc('MONTH',sysdate())
GROUP BY 1,2,3; 









create or replace table Country_Packet_CUST_LEVEL_DATA_AGGREGATED_R12_Backup clone Country_Packet_CUST_LEVEL_DATA_AGGREGATED_R12;


CREATE OR REPLACE TABLE Country_Packet_CUST_LEVEL_DATA_AGGREGATED_R12 AS 
SELECT 
AWC.REGION,

CASE 
WHEN RC.TOP_20_COUNTRIES_RANK <= 20 THEN AWC.COUNTRY_NAME  -------AK----------------------------------
ELSE 'Others' END AS COUNTRY_NAME,

AWC.MTH_YR,
AWC.MYWU_status_1,-------AK----------
AWC.DOMINANT_CORRIDOR_TYPE_1,

CASE WHEN NVL(RFM__PERSONA,'5.SPORADICS') = '1.UBER' THEN '1.LOYALS'
     WHEN NVL(RFM__PERSONA,'5.SPORADICS') = '2.LOYALS' THEN '2.ENGAGED' 
     ELSE NVL(RFM__PERSONA,'9.NO PERSONA') END AS RFM_PERSONA,

     
CASE 
WHEN CC.TOP_50_DOMINANT_CORRIDOR_RANK <= 50 THEN AWC.DOMINANT__CORRIDOR  -------AK----------------------------------
ELSE 'Others' END AS DOMINANT_CORRIDOR,


DOMINANT__SNDCOUNTRY_NAME as DOMINANT_SNDCOUNTRY_NAME,
DOMINANT__RCVCOUNTRY_NAME as DOMINANT_RCVCOUNTRY_NAME,

CASE
WHEN ag.TOP_10_AGENT_RANK <= 10 THEN AWC.DOMINANT_AGENT-------AK----------------------------------
ELSE 'Others'END AS DOMINANT_AGENT,

CASE
WHEN rcv_ag.TOP_10_RCV_Agent_RANK <= 10 THEN AWC.DOMINANT_RCV_AGENT
ELSE 'Others'END AS DOMINANT_RCV_AGENT,

-- CASE 
-- WHEN CC.TOP_50_DOMINANT_CORRIDOR_RANK <= 50 THEN AWC.DOMINANT__CORRIDOR  -------AK----------------------------------
-- ELSE 'Others' END AS TOP_50_DOMINANT_CORRIDOR,

-- CASE 
-- WHEN RC.TOP_20_COUNTRIES_RANK <= 20 THEN AWC.COUNTRY_NAME  -------AK----------------------------------
-- ELSE 'Others' END AS TOP_20_COUNTRIES,

-- CASE 
-- WHEN AC.TOP_10_AGENT_RANK <= 10 THEN AWC.DOMINANT_AGENT  -------AK----------------------------------
-- ELSE 'Others' END AS TOP_10_DOMINANT_AGENT,


DOMINANT_AGENT_DMA,
DOMINANT_CHANNEL,
FLAG_CONTACTABLE,
EMAIL_SMS_MARKETABLE,
CASE WHEN RETAIL_DIGITAL__FLAG = 'Digital_only' THEN 'Digital Only'
     WHEN RETAIL_DIGITAL__FLAG = 'Retail_only' THEN 'Retail Only'
     WHEN RETAIL_DIGITAL__FLAG = 'Retail+Digital' THEN 'Retail+Digital'
     WHEN RETAIL_DIGITAL__FLAG = 'R12_INACTIVE' THEN 'R12 Inactive'
     ELSE 'NA'  END AS RETAIL_DIGITAL_FLAG,
DOMINANT_ATTRBUTE_FUNDS_IN,
DOMINANT_ATTRBUTE_FUNDS_OUT,
R12_active_breakup,


COUNT(CASE WHEN AQUISITION = 'Y' THEN SNDCUSTOMER_KEY END) AS AQUISITION,
COUNT(CASE WHEN WINBACK = 'Y' THEN SNDCUSTOMER_KEY END) AS WINBACK,
COUNT(CASE WHEN CHURN = 'Y' THEN SNDCUSTOMER_KEY END) AS CHURNS,
COUNT(CASE WHEN AWC.R12_ACTIVE = 'Y' THEN SNDCUSTOMER_KEY END) AS R12_ACTIVE,
COUNT(CASE WHEN R1_ACTIVE = 'Y' THEN SNDCUSTOMER_KEY END) AS R1_Cust,
count(distinct case when TXNS_IN_60_DAYS > 0 then sndcustomer_key end) as RETAINED_IN_TWO_MONTHS,
COUNT(CASE WHEN R12_active_breakup = 'EXISTING' THEN SNDCUSTOMER_KEY END) AS RETAINED_CUST,

sum(R1_TXNS) as R1_TXNS,
sum(R12_TXNS) as R12_TXNS,
sum(R1_PRINCIPAL) as R1_PRINCIPAL,
sum(R12_PRINCIPAL) as R12_PRINCIPAL,
sum(R1_REVENUE) as R1_REVENUE,
sum(R12_REVENUE) as R12_REVENUE,
sum(R1_FEE) as R1_FEE,
sum(R12_FEE) as R12_FEE ,
sum(R1_NET_FX) as R1_NET_FX,
sum(R12_NET_FX) as R12_NET_FX

     
FROM Country_Packet_CUST_LEVEL_R12 AWC 
left join TOP_Send_Agent ag on ag.MTH_YR = AWC.MTH_YR and ag.COUNTRY_NAME = AWC.COUNTRY_NAME and ag.DOMINANT_AGENT = AWC.DOMINANT_AGENT
left join TOP_RCV_Agent rcv_ag on rcv_ag.MTH_YR = AWC.MTH_YR and rcv_ag.COUNTRY_NAME = AWC.COUNTRY_NAME and rcv_ag.DOMINANT_RCV_AGENT = AWC.DOMINANT_RCV_AGENT

--LEFT JOIN SUMMARY_GEN.COUNTRY_VW CC ON AWC.COUNTRY_CODE = CC.COUNTRY_CODE
--WHERE AWC.REGION IS NOT NULL

left join TOP_50_CORRIDORS_COUNTRY CC on CC.MTH_YR = AWC.MTH_YR and CC.DOMINANT__CORRIDOR = AWC.DOMINANT__CORRIDOR and CC.COUNTRY_NAME = AWC.COUNTRY_NAME -------AK----------------------------------
left join TOP_20_COUNTRIES_BY_REGION RC on RC.MTH_YR = AWC.MTH_YR and RC.REGION = AWC.REGION and RC.COUNTRY_NAME = AWC.COUNTRY_NAME -------AK----------------------------------
-- left join TOP_10_AGENTS_BY_COUNTRIES_TEST AC on AC.MTH_YR = AWC.MTH_YR and AC.COUNTRY_NAME = AWC.COUNTRY_NAME and AC.DOMINANT_AGENT = AWC.DOMINANT_AGENT  -------AK----------------------------------
where AWC.mth_yr <> date_trunc('MONTH',sysdate())
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19
; 







create or replace table Country_Packet_CUST_LEVEL_PR12_backup clone Country_Packet_CUST_LEVEL_PR12;



--PR12 Cust Level Details
CREATE OR REPLACE TABLE Country_Packet_CUST_LEVEL_PR12  AS
SELECT
 distinct 
add_months(CEM.mth_yr,12) as mth_yr,
CEM.SNDCUSTOMER_KEY,
t.sndcustomer_key as ret_sndcustomer_key, --Retained customers added
CV.SUPER_REGION AS REGION,
CEM.COUNTRY_CODE,
CV.COUNTRY_NAME,

CASE WHEN CEM.FLAG_CONTACTABLE = 'N' THEN 'Not Contactable'
     ELSE 'Contactable' END FLAG_CONTACTABLE,
CASE WHEN CEM.FLAG_MARKETABLE = 'N' THEN 'Not Marketable'
     ELSE 'Marketable' END AS FLAG_MARKETABLE,
     
CASE WHEN CEM.EMAIL_MARKETABLE = 'Y' AND CEM.SMS_MARKETABLE = 'N' THEN 'Email Only ' 
     WHEN CEM.SMS_MARKETABLE = 'Y' AND CEM.EMAIL_MARKETABLE = 'N' THEN 'SMS Only'
     WHEN CEM.SMS_MARKETABLE = 'Y' AND CEM.EMAIL_MARKETABLE = 'Y' THEN 'SMS + Email'
     ELSE 'Non Marketable' END AS EMAIL_SMS_MARKETABLE,

CEM.R1_TXNS as PR1_TXNS,
CEM.R12_TXNS as PR12_TXNS,
CEM.R1_PRINCIPAL as PR1_PRINCIPAL,
CEM.R12_PRINCIPAL as PR12_PRINCIPAL,
CEM.R1_REVENUE as PR1_REVENUE,
CEM.R12_REVENUE as PR12_REVENUE,
CEM.R1_FEE as PR1_FEE,
CEM.R12_FEE as PR12_FEE,
CEM.R1_NET_FX as PR1_NET_FX,
CEM.R12_NET_FX as PR12_NET_FX,
--CEM.MYWU_status,-------AK----------------------------------
--DOM_CM.DOMINANT_CORRIDOR_TYPE,

CASE WHEN CEM.R1_TXNS > 0 AND CEM.R2_TO_R13_TXNS=0 AND CEM.R14_TO_R25_TXNS = 0  AND CEM.R26_TO_R37_TXNS=0 AND CEM.R38_TO_R49_TXNS=0 THEN 'Y' ELSE 'N' END AS PR1_AQUISITION,-------AK----------------------------------
CASE WHEN CEM.R1_TXNS > 0 AND CEM.R2_TO_R13_TXNS=0 AND (CEM.R14_TO_R25_TXNS > 0 OR CEM.R26_TO_R37_TXNS > 0 OR CEM.R38_TO_R49_TXNS>0) THEN 'Y' ELSE 'N' END AS PR1_WINBACK,-------AK----------------------------------
CASE WHEN CEM.R12_TXNS = 0 AND  CEM.R2_TO_R13_TXNS > 0 THEN 'Y' ELSE 'N' END AS PR1_CHURN,-------AK----------------------------------

CEM.New_Existing_flag as R12_active_breakup,


CASE WHEN CEM.R12_TXNS > 0 THEN  'Y' ELSE 'N' END AS PR12_ACTIVE,
CASE WHEN CEM.R1_TXNS > 0 THEN  'Y' ELSE 'N' END AS PR1_ACTIVE,


'N/A' AS RFM__PERSONA,

CEM.R12_DOMINANT_CHANNEL AS DOMINANT_CHANNEL, 


UPPER(NVL(DOM_CM.DOMINANT_AGENT_NETWORK_2,DOM_CM.DOMINANT_AGENT_BUSINESS_NAME)) AS DOMINANT_AGENT_OLD,-------AK-----------

CASE WHEN DOMINANT_AGENT_OLD = 'NA' THEN 'DIGITAL' ELSE DOMINANT_AGENT_OLD END AS DOMINANT_AGENT,-------AK-----------
	 
UPPER(NVL(DOM_CM.DOMINANT_RCVAGENT_NETWORK_2,DOM_CM.DOMINANT_RCVAGENT_BUSINESS_NAME)) AS DOMINANT_RCV_AGENT,   --Dominant Receive Agent Added

DOM_CM.DOMINANT_AGENT_DMA_DESC AS DOMINANT_AGENT_DMA,

DOM_CM.DOMINANT_CORRIDOR_TYPE AS DOMINANT_CORRIDOR_TYPE_1,

DOM_CM.DOMINANT_CORRIDOR_NAME AS DOMINANT__CORRIDOR,  --CAM-1174 Add Country Name along with Country Code Across all Report
DOM_CM.DOMINANT_SNDCOUNTRY_NAME,
DOM_CM.DOMINANT_RCVCOUNTRY_NAME,
DOM_CM.DOMINANT_ATTRBUTE_FUNDS_IN AS DOMINANT_ATTRBUTE_FUNDS_IN,  -- Dominant metrics added
DOM_CM.DOMINANT_ATTRBUTE_FUNDS_OUT AS DOMINANT_ATTRBUTE_FUNDS_OUT, --Dominant metrics added

CEM.RETAIL_DIGITAL_FLAG AS RETAIL_DIGITAL__FLAG,

CEM.MYWU_status AS MYWU_status_1

FROM (SELECT C.* FROM CEX_SANDBOX.YN_VA_KPI_2020_OUTPUT_ENGAGEMENT_CUST_LEVEL C
where R12_TXNS > 0 and MTH_YR < (select DATEADD(MONTH,-12, max(DATE(MTH_YR))) from CEX_SANDBOX.YN_VA_KPI_2020_OUTPUT_ENGAGEMENT_CUST_LEVEL) and
mth_yr >= (select DATEADD(MONTH,-24, max(DATE(MTH_YR))) from CEX_SANDBOX.YN_VA_KPI_2020_OUTPUT_ENGAGEMENT_CUST_LEVEL)
) CEM -- Includeing txn from previous reference month 13 to 24
left join (select * from CEX_SANDBOX.YN_VA_KPI_2020_OUTPUT_ENGAGEMENT_CUST_LEVEL where R12_TXNS > 0) t on CEM.mth_yr=add_months(t.mth_yr,-12) and CEM.sndcustomer_key=t.sndcustomer_key

LEFT JOIN CEX_SANDBOX.SK_DOMINANCY_METRICS DOM_CM ON CEM.SNDCUSTOMER_KEY = DOM_CM.SNDCUSTOMER_KEY AND DATE(CEM.MTH_YR) = DATE(DOM_CM.MTH_YR)

INNER JOIN SUMMARY_GEN.COUNTRY_VW CV ON CV.COUNTRY_CODE = CEM.COUNTRY_CODE AND CV.SUPER_REGION IS NOT NULL;






--PR12 data aggregated
create or replace table Country_Packet_CUST_LEVEL_DATA_AGGREGATED_PR12_backup clone Country_Packet_CUST_LEVEL_DATA_AGGREGATED_PR12;


CREATE OR REPLACE TABLE Country_Packet_CUST_LEVEL_DATA_AGGREGATED_PR12 AS 
SELECT 
AWC.REGION,

CASE 
WHEN RC.TOP_20_COUNTRIES_RANK <= 20 THEN AWC.COUNTRY_NAME  -------AK----------------------------------
ELSE 'Others' END AS COUNTRY_NAME,


AWC.MTH_YR,

'N/A' AS RFM_PERSONA,

CASE 
WHEN CC.TOP_50_DOMINANT_CORRIDOR_RANK <= 50 THEN AWC.DOMINANT__CORRIDOR  -------AK----------------------------------
ELSE 'Others' END AS DOMINANT_CORRIDOR,

DOMINANT_SNDCOUNTRY_NAME,
DOMINANT_RCVCOUNTRY_NAME,
AWC.MYWU_status_1,-------AK----------
AWC.DOMINANT_CORRIDOR_TYPE_1,

CASE
WHEN ag.TOP_10_AGENT_RANK <= 10 THEN AWC.DOMINANT_AGENT-------AK----------------------------------
ELSE 'Others'END AS DOMINANT_AGENT,

CASE
WHEN rcv_ag.TOP_10_RCV_Agent_RANK <= 10 THEN AWC.DOMINANT_RCV_AGENT
ELSE 'Others'END AS DOMINANT_RCV_AGENT,


-- CASE 
-- WHEN CC.TOP_50_DOMINANT_CORRIDOR_RANK <= 50 THEN AWC.DOMINANT__CORRIDOR  -------AK----------------------------------
-- ELSE 'Others' END AS TOP_50_DOMINANT_CORRIDOR,

-- CASE 
-- WHEN RC.TOP_20_COUNTRIES_RANK <= 20 THEN AWC.COUNTRY_NAME  -------AK----------------------------------
-- ELSE 'Others' END AS TOP_20_COUNTRIES,

-- CASE 
-- WHEN AC.TOP_10_AGENT_RANK <= 10 THEN AWC.DOMINANT_AGENT  -------AK----------------------------------
-- ELSE 'Others' END AS TOP_10_DOMINANT_AGENT,


DOMINANT_AGENT_DMA,
DOMINANT_CHANNEL,
FLAG_CONTACTABLE,
EMAIL_SMS_MARKETABLE,
CASE WHEN RETAIL_DIGITAL__FLAG = 'Digital_only' THEN 'Digital Only'
     WHEN RETAIL_DIGITAL__FLAG = 'Retail_only' THEN 'Retail Only'
     WHEN RETAIL_DIGITAL__FLAG = 'Retail+Digital' THEN 'Retail+Digital'
     WHEN RETAIL_DIGITAL__FLAG = 'R12_INACTIVE' THEN 'R12 Inactive'
     ELSE 'NA'  END AS RETAIL_DIGITAL_FLAG,
DOMINANT_ATTRBUTE_FUNDS_IN,
DOMINANT_ATTRBUTE_FUNDS_OUT,
R12_active_breakup,

COUNT(CASE WHEN PR1_AQUISITION = 'Y' THEN SNDCUSTOMER_KEY END) AS PR1_AQUISITION,-------AK----------------------------
COUNT(CASE WHEN PR1_WINBACK = 'Y' THEN SNDCUSTOMER_KEY END) AS PR1_WINBACK,-------AK----------------------------
COUNT(CASE WHEN PR1_CHURN = 'Y' THEN SNDCUSTOMER_KEY END) AS PR1_CHURN,-------AK----------------------------



COUNT(CASE WHEN PR12_ACTIVE = 'Y' THEN SNDCUSTOMER_KEY END) AS PR12_ACTIVE,
COUNT(CASE WHEN PR1_ACTIVE = 'Y' THEN SNDCUSTOMER_KEY END) AS PR1_Cust,
count(ret_sndcustomer_key) as Retained_Cust_New,

sum(PR1_TXNS) as PR1_TXNS,
sum(PR12_TXNS) as PR12_TXNS,
sum(PR1_PRINCIPAL) as PR1_PRINCIPAL,
sum(PR12_PRINCIPAL) as PR12_PRINCIPAL,
sum(PR1_REVENUE) as PR1_REVENUE,
sum(PR12_REVENUE) as PR12_REVENUE,
sum(PR1_FEE) as PR1_FEE,
sum(PR12_FEE) as PR12_FEE ,
sum(PR1_NET_FX) as PR1_NET_FX,
sum(PR12_NET_FX) as PR12_NET_FX

     
FROM Country_Packet_CUST_LEVEL_PR12 AWC
left join TOP_Send_Agent ag on ag.MTH_YR = AWC.MTH_YR and ag.COUNTRY_NAME = AWC.COUNTRY_NAME and ag.DOMINANT_AGENT = AWC.DOMINANT_AGENT
left join TOP_RCV_Agent rcv_ag on rcv_ag.MTH_YR = AWC.MTH_YR and rcv_ag.COUNTRY_NAME = AWC.COUNTRY_NAME and rcv_ag.DOMINANT_RCV_AGENT = AWC.DOMINANT_RCV_AGENT

left join TOP_50_CORRIDORS_COUNTRY CC on CC.MTH_YR = AWC.MTH_YR and CC.DOMINANT__CORRIDOR = AWC.DOMINANT__CORRIDOR and CC.COUNTRY_NAME = AWC.COUNTRY_NAME -------AK----------------------------------
left join TOP_20_COUNTRIES_BY_REGION RC on RC.MTH_YR = AWC.MTH_YR and RC.REGION = AWC.REGION and RC.COUNTRY_NAME = AWC.COUNTRY_NAME -------AK----------------------------------

GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19
;







---------------------------------------------------------------------------------------------------------------------------------------------------------------------------


create or replace table Country_Packet_DATA_AGGREGATED_Dimension_Base_backup clone Country_Packet_DATA_AGGREGATED_Dimension_Base;



create or replace table Country_Packet_DATA_AGGREGATED_Dimension_Base as
SELECT distinct
REGION,
COUNTRY_NAME,
MTH_YR,

RFM_PERSONA,
DOMINANT_CORRIDOR,
DOMINANT_SNDCOUNTRY_NAME,
DOMINANT_RCVCOUNTRY_NAME,
DOMINANT_AGENT,
DOMINANT_AGENT_DMA,
DOMINANT_RCV_AGENT,
DOMINANT_CHANNEL,
FLAG_CONTACTABLE,
EMAIL_SMS_MARKETABLE,
RETAIL_DIGITAL_FLAG,
DOMINANT_ATTRBUTE_FUNDS_IN,
DOMINANT_ATTRBUTE_FUNDS_OUT,
R12_active_breakup,
MYWU_status_1,
DOMINANT_CORRIDOR_TYPE_1
from Country_Packet_CUST_LEVEL_DATA_AGGREGATED_R12
UNION
select distinct 
REGION,
COUNTRY_NAME,
MTH_YR,
RFM_PERSONA,
DOMINANT_CORRIDOR,
DOMINANT_SNDCOUNTRY_NAME,
DOMINANT_RCVCOUNTRY_NAME,
DOMINANT_AGENT,
DOMINANT_AGENT_DMA,
DOMINANT_RCV_AGENT,
DOMINANT_CHANNEL,
FLAG_CONTACTABLE,
EMAIL_SMS_MARKETABLE,
RETAIL_DIGITAL_FLAG,
DOMINANT_ATTRBUTE_FUNDS_IN,
DOMINANT_ATTRBUTE_FUNDS_OUT,
R12_active_breakup,
MYWU_STATUS_1,
DOMINANT_CORRIDOR_TYPE_1
from Country_Packet_CUST_LEVEL_DATA_AGGREGATED_PR12;







create or replace table Country_Packet_DATA_AGGREGATED_backup clone Country_Packet_DATA_AGGREGATED;


create or replace table Country_Packet_DATA_AGGREGATED as
select 
a.REGION,
a.COUNTRY_NAME,
a.MTH_YR,
a.RFM_PERSONA,
a.DOMINANT_CORRIDOR,
a.DOMINANT_SNDCOUNTRY_NAME,
a.DOMINANT_RCVCOUNTRY_NAME,
a.DOMINANT_AGENT,
a.DOMINANT_AGENT_DMA,
a.DOMINANT_RCV_AGENT,
a.DOMINANT_CHANNEL,
a.FLAG_CONTACTABLE,
a.EMAIL_SMS_MARKETABLE,
a.RETAIL_DIGITAL_FLAG,
a.DOMINANT_ATTRBUTE_FUNDS_IN,
a.DOMINANT_ATTRBUTE_FUNDS_OUT,
a.R12_active_breakup,
a.MYWU_status_1 as MYWU_status,

case 
    when a.RFM_PERSONA IN ('1.LOYALS','2.ENGAGED','3.PROMISING') then 'MOST ENGAGED'
    when a.RFM_PERSONA = '4.WHALES' then 'WHALES'
    when a.RFM_PERSONA = '5.SPORADICS' then 'BUILD HABIT'
    when a.RFM_PERSONA IN ('6.SLIPPING','7.LOST') then 'LOSING TOUCH'
    when a.RFM_PERSONA = '8.ONE AND DONES' then 'ONE TIMERS'
    else 'N/A' end as CONSOLIDATED_PERSONA,

case
    when a.DOMINANT_CORRIDOR_TYPE_1 = 'INTERNATIONAL' then 'IMT'
    when a.DOMINANT_CORRIDOR_TYPE_1 = 'DOMESTIC' then 'DMT' 
      else 'R12_INACTIVE'  end as DOMINANT_CORRIDOR_TYPE,

--R12 Metrices
AQUISITION,
WINBACK,
CHURNS,
R12_ACTIVE,
R1_Cust,
RETAINED_IN_TWO_MONTHS,
RETAINED_CUST,
R1_TXNS,
R12_TXNS,
R1_PRINCIPAL,
R12_PRINCIPAL,
R1_REVENUE,
R12_REVENUE,
R1_FEE,
R12_FEE ,
R1_NET_FX,
R12_NET_FX,

--PR12 Metrices
PR12_ACTIVE,
PR1_Cust,
Retained_Cust_New,

PR1_TXNS,
PR12_TXNS,
PR1_PRINCIPAL,
PR12_PRINCIPAL,
PR1_REVENUE,
PR12_REVENUE,
PR1_FEE,
PR12_FEE ,
PR1_NET_FX,
PR12_NET_FX,
PR1_AQUISITION,
PR1_WINBACK,
PR1_CHURN


from Country_Packet_DATA_AGGREGATED_Dimension_Base a

left join Country_Packet_CUST_LEVEL_DATA_AGGREGATED_R12 b
	on nvl(a.REGION ,'NA') =  nvl(b.REGION,'NA') and
	nvl(a.COUNTRY_NAME ,'NA') =  nvl(b.COUNTRY_NAME,'NA') and
	nvl(a.RFM_PERSONA ,'NA') =  nvl(b.RFM_PERSONA,'NA') and
	nvl(a.DOMINANT_CORRIDOR ,'NA') =  nvl(b.DOMINANT_CORRIDOR,'NA') and
	nvl(a.DOMINANT_AGENT ,'DIGITAL') =  nvl(b.DOMINANT_AGENT,'DIGITAL') and
	nvl(a.DOMINANT_AGENT_DMA ,'DIGITAL') =  nvl(b.DOMINANT_AGENT_DMA,'DIGITAL') and
	nvl(a.DOMINANT_RCV_AGENT ,'DIGITAL') =  nvl(b.DOMINANT_RCV_AGENT,'DIGITAL') and
	nvl(a.DOMINANT_CHANNEL ,'NA') =  nvl(b.DOMINANT_CHANNEL,'NA') and
	nvl(a.FLAG_CONTACTABLE ,'NA') =  nvl(b.FLAG_CONTACTABLE,'NA') and
	nvl(a.EMAIL_SMS_MARKETABLE ,'NA') =  nvl(b.EMAIL_SMS_MARKETABLE,'NA') and
	nvl(a.RETAIL_DIGITAL_FLAG ,'NA') =  nvl(b.RETAIL_DIGITAL_FLAG,'NA') and
	nvl(a.DOMINANT_ATTRBUTE_FUNDS_IN ,'NA') =  nvl(b.DOMINANT_ATTRBUTE_FUNDS_IN,'NA') and
	nvl(a.DOMINANT_ATTRBUTE_FUNDS_OUT ,'NA') =  nvl(b.DOMINANT_ATTRBUTE_FUNDS_OUT,'NA') and
	nvl(a.R12_active_breakup ,'NA') =  nvl(b.R12_active_breakup,'NA') and
	nvl(a.DOMINANT_SNDCOUNTRY_NAME ,'NA') =  nvl(b.DOMINANT_SNDCOUNTRY_NAME,'NA') and
	nvl(a.DOMINANT_RCVCOUNTRY_NAME ,'NA') =  nvl(b.DOMINANT_RCVCOUNTRY_NAME,'NA') and
    nvl(a.MYWU_STATUS_1,'NA') =  nvl(b.MYWU_STATUS_1,'NA') and
    nvl(a.DOMINANT_CORRIDOR_TYPE_1,'NA') =  nvl(b.DOMINANT_CORRIDOR_TYPE_1,'NA') and
	a.MTH_YR = b.MTH_YR

left join Country_Packet_CUST_LEVEL_DATA_AGGREGATED_PR12 c
	on nvl(a.REGION ,'NA') =  nvl(c.REGION,'NA') and
	nvl(a.COUNTRY_NAME ,'NA') =  nvl(c.COUNTRY_NAME,'NA') and
	nvl(a.RFM_PERSONA ,'NA') =  nvl(c.RFM_PERSONA,'NA') and
	nvl(a.DOMINANT_CORRIDOR ,'NA') =  nvl(c.DOMINANT_CORRIDOR,'NA') and
	nvl(a.DOMINANT_AGENT ,'DIGITAL') =  nvl(c.DOMINANT_AGENT,'DIGITAL') and
	nvl(a.DOMINANT_AGENT_DMA ,'DIGITAL') =  nvl(c.DOMINANT_AGENT_DMA,'DIGITAL') and
	nvl(a.DOMINANT_RCV_AGENT ,'DIGITAL') =  nvl(c.DOMINANT_RCV_AGENT,'DIGITAL') and
	nvl(a.DOMINANT_CHANNEL ,'NA') =  nvl(c.DOMINANT_CHANNEL,'NA') and
	nvl(a.FLAG_CONTACTABLE ,'NA') =  nvl(c.FLAG_CONTACTABLE,'NA') and
	nvl(a.EMAIL_SMS_MARKETABLE ,'NA') =  nvl(c.EMAIL_SMS_MARKETABLE,'NA') and
	nvl(a.RETAIL_DIGITAL_FLAG ,'NA') =  nvl(c.RETAIL_DIGITAL_FLAG,'NA') and
	nvl(a.DOMINANT_ATTRBUTE_FUNDS_IN ,'NA') =  nvl(c.DOMINANT_ATTRBUTE_FUNDS_IN,'NA') and
	nvl(a.DOMINANT_ATTRBUTE_FUNDS_OUT ,'NA') =  nvl(c.DOMINANT_ATTRBUTE_FUNDS_OUT,'NA') and
	nvl(a.R12_active_breakup ,'NA') =  nvl(c.R12_active_breakup,'NA') and
	nvl(a.DOMINANT_SNDCOUNTRY_NAME ,'NA') =  nvl(c.DOMINANT_SNDCOUNTRY_NAME,'NA') and
	nvl(a.DOMINANT_RCVCOUNTRY_NAME ,'NA') =  nvl(c.DOMINANT_RCVCOUNTRY_NAME,'NA') and
    nvl(a.MYWU_STATUS_1,'NA') =  nvl(c.MYWU_STATUS_1,'NA') and
    nvl(a.DOMINANT_CORRIDOR_TYPE_1,'NA') =  nvl(c.DOMINANT_CORRIDOR_TYPE_1,'NA') and
	a.MTH_YR = c.MTH_YR;

    

