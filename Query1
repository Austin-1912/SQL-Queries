WITH CombinedEmployeeData AS (
    SELECT
        t1.ObjectName1 AS EmployeeName,
        CASE
            WHEN t2.Int1 = 0 THEN t2.Text12
            ELSE CAST(t2.Int1 AS NVARCHAR)
        END AS EmployeeID,
        t3.Name AS PersonnelTypeName,
        DATEADD(MINUTE, -1 * t1.MessageLocaleOffset, t1.MessageUTC) AS LocaleMessageTime,
        t1.XMLGuid
    FROM
        [ACVSUJournal_00010024].[dbo].[ACVSUJournalLog] AS t1
    INNER JOIN [ACVSCore].[Access].[Personnel] AS t2
        ON t1.ObjectIdentity1 = t2.GUID
    INNER JOIN [ACVSCore].[Access].[PersonnelType] AS t3
        ON t2.PersonnelTypeID = t3.ObjectID
    WHERE
        t1.MessageType = 'CardAdmitted'
        AND t1.PartitionName2 = 'APAC.Default'
        AND DATEADD(MINUTE, -1 * t1.MessageLocaleOffset, t1.MessageUTC) >= '2025-01-01'
        AND t3.Name = 'Employee'
),
 
EmployeeOutDirections AS (
    SELECT
        c.EmployeeName,
        c.EmployeeID,
        c.LocaleMessageTime
    FROM
        CombinedEmployeeData c
    INNER JOIN [ACVSUJournal_00010024].[dbo].[ACVSUJournalLogxmlShred] AS x
        ON c.XMLGuid = x.GUID
    WHERE
        x.Value = 'OutDirection'
        AND (
            CAST(c.LocaleMessageTime AS TIME) >= '20:00:00'
            OR CAST(c.LocaleMessageTime AS TIME) < '06:00:00'
        )
)
 
SELECT
    EmployeeName,
    EmployeeID,
    MAX(LocaleMessageTime) AS LastOutTime
FROM
    EmployeeOutDirections
GROUP BY
    EmployeeName,
    EmployeeID
ORDER BY
    LastOutTime DESC;
