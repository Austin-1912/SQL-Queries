CREATE OR REPLACE TABLE AU_Corridors AS
WITH base_txn AS (
    SELECT DISTINCT
        t.SNDCUSTOMER_KEY,         -- 19-digit GID
        UPPER(t.SNDCOUNTRY_CODE) AS sndcountry_code,
        UPPER(t.RCVCOUNTRY_CODE) AS rcvcountry_code,
        t.PRICING_CHANNEL,
        CASE 
            WHEN PRICING_CHANNEL IN ('TMT', 'POS', 'AIR') THEN 'Retail'
            WHEN PRICING_CHANNEL IN ('WEB', 'APP') THEN 'Digital'
            ELSE 'OTHER'
        END AS Channel
    FROM SUMMARY_GEN.WUDNA_TXN_MASTER_ANALYTICS_VW t  
    WHERE UPPER(t.SNDCOUNTRY_CODE) = 'AU'
      AND UPPER(t.RCVCOUNTRY_CODE) IN ('PK', 'CO', 'NP')
      -- AND DATE(t.RCVPAYING_DATETIME) >= '2024-10-01' 
      -- AND DATE(t.RCVPAYING_DATETIME) <= '2025-09-30'
),

app_flag AS (
    SELECT
       DISTINCT SNDCUSTOMER_KEY
    FROM base_txn
    WHERE PRICING_CHANNEL = 'APP'
    GROUP BY SNDCUSTOMER_KEY
)

SELECT DISTINCT
    b.SNDCUSTOMER_KEY AS gid_customer_key,
    cm.customer_umn    AS umn_customer_key,
    b.sndcountry_code,
    b.rcvcountry_code,
    

    -- Marketability Flags
    CASE 
        WHEN cm.marketing_flag = 'Y' AND cm.email_address_on_file_flag = 'Y' AND cm.opt_email = 'I' THEN 'Y'
        ELSE 'N'
    END AS email_marketability_flag,

    CASE 
        WHEN cm.marketing_flag = 'Y' AND cm.mobile_number_on_file_flag = 'Y' AND cm.opt_sms = 'I' THEN 'Y'
        ELSE 'N'
    END AS sms_marketability_flag,

    CASE WHEN af.SNDCUSTOMER_KEY IS NOT NULL THEN 'Y' ELSE 'N' END AS App_Marketability_Flag,
    CASE 
        WHEN email_marketability_flag = 'Y' OR sms_marketability_flag = 'Y' OR af.SNDCUSTOMER_KEY IS NOT NULL THEN 'Y' ELSE 'N' END AS MARKETABILITY_FLAG

FROM base_txn b
JOIN SUMMARY_GEN.WUDNA_CUSTOMER_MASTER_VW cm
  ON b.SNDCUSTOMER_KEY = cm.customer_key
LEFT JOIN app_flag af
  ON b.SNDCUSTOMER_KEY = af.SNDCUSTOMER_KEY;


  
---------------------------------------------------------------------------------------------------------------------
  -- SELECT COUNT(gid_customer_key), COUNT(DISTINCT gid_customer_key) FROM AU_IN_Corridor;
  -- select COUNT(marketability_flag) from NZ_IN_CORRIDOR Group by marketability_flag having marketability_flag = 'Y';
  
  SELECT '@' || GID_CUSTOMER_KEY AS GID,
         '@' || UMN_CUSTOMER_KEY AS UMN,
         email_marketability_flag,
         sms_marketability_flag,
         App_Marketability_Flag,
         MARKETABILITY_FLAG,
         FROM AU_Corridors;
