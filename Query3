CREATE OR REPLACE TABLE LACA_RNT_CUSTOMERS1 AS
WITH params AS (
  SELECT 12 AS rnt_window_mths,
         48 AS txn_lookback_mths  -- Check 48 months back for transactions
),

-- Generate months from Jan 2024 up to the last completed month
months AS (
  SELECT DISTINCT DATE_TRUNC('MONTH', MTH_YR) AS ref_date
  FROM WUDNA.CEX_SANDBOX.VA_KPI_2020_2
  WHERE MTH_YR >= TO_DATE('2024-01-01')
    AND MTH_YR < DATE_TRUNC('MONTH', CURRENT_DATE)
),

-- Registered customers
cust_reg AS (
  SELECT
    c.customer_key,
    DATE_TRUNC('MONTH', c.first_registration_date) AS reg_month,
    first_registration_date,
    c.country_code,
    CASE
      WHEN c.email_address_on_file_flag = 'Y'
       AND c.opt_email = 'I'
       AND c.marketing_flag = 'Y'
      THEN 'Y'
      ELSE 'N'
    END AS email_marketable,
    CASE
      WHEN (c.opt_sms = 'I'
        AND c.mobile_number_on_file_flag = 'Y'
        AND c.marketing_flag = 'Y'
        AND c.country_code NOT IN ('US','CA'))
      OR (c.mobile_number_on_file_flag = 'Y'
        AND c.opt_sms = 'I'
        AND c.double_opt_sms = 'I'
        AND c.marketing_flag = 'Y'
        AND c.country_code IN ('US','CA'))
      THEN 'Y'
      ELSE 'N'
    END AS sms_marketable
  FROM SUMMARY_GEN.WUDNA_CUSTOMER_MASTER_VW c
  JOIN SUMMARY_GEN.COUNTRY_VW cnt
    ON c.country_code = cnt.country_code
  WHERE cnt.super_region = 'LACA'
    AND c.first_registration_date IS NOT NULL
),

-- All transactions from 2021 onwards
all_txns AS (
  SELECT DISTINCT
    --t.sndcustomer_key AS customer_key,
    DATE_TRUNC('MONTH', t.rcvpaying_datetime) AS txn_month,
    --t.rcvpaying_datetime AS txn_date
  FROM SUMMARY_GEN.WUDNA_TXN_MASTER_ANALYTICS_VW t
  -- JOIN SUMMARY_GEN.COUNTRY_VW snd
  --   ON t.sndcountry_code = snd.country_code
  WHERE t.SEND_SUPER_REGION = 'LACA'
    AND t.rcvpaying_datetime >= '2021-01-01' -- Get all transactions from 2021
),

-- RNT logic: 
-- 1. Registered in R12 window (from ref_date)
-- 2. NO transactions in R48 window (from ref_date)
rnt_no_txn AS (
  SELECT DISTINCT
    m.ref_date,
    r.customer_key,
    r.country_code,
    r.reg_month,
    r.email_marketable,
    r.sms_marketable
  FROM months m
  JOIN cust_reg r
    ON r.reg_month BETWEEN DATEADD(MONTH, - (SELECT rnt_window_mths FROM params) + 1, m.ref_date)
                      AND m.ref_date
  LEFT JOIN all_txns t
    ON r.customer_key = t.customer_key
    -- Check for ANY transaction in the R48 window from ref_date
    AND t.txn_date BETWEEN DATEADD(MONTH, - (SELECT txn_lookback_mths FROM params) + 1, m.ref_date)
                       AND LAST_DAY(m.ref_date)
  WHERE t.customer_key IS NULL  -- No transactions found in R48 window
)

-- Final RNT customer table
SELECT DISTINCT
  rnt.ref_date,
  rnt.customer_key,
  rnt.country_code,
  rnt.reg_month,
  'Y' AS rnt_flag,
  rnt.email_marketable,
  rnt.sms_marketable
FROM rnt_no_txn rnt;
