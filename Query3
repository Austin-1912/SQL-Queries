CREATE OR REPLACE TABLE LACA_RNT_CUSTOMERS1_TEST_AM AS
WITH 
-- Generate months from Jan 2024 up to the last completed month
months AS (
  SELECT DISTINCT DATE_TRUNC('MONTH', MTH_YR) AS ref_date
  FROM WUDNA.CEX_SANDBOX.VA_KPI_2020_2
  WHERE MTH_YR >= TO_DATE('2024-01-01')
    AND MTH_YR < DATE_TRUNC('MONTH', CURRENT_DATE)
),

-- Registered LACA customers with marketability flags
cust_reg AS (
  SELECT
    c.customer_key,
    DATE_TRUNC('MONTH', c.first_registration_date) AS reg_month,
    c.country_code,
    CASE
      WHEN c.email_address_on_file_flag = 'Y'
       AND c.opt_email = 'I'
       AND c.marketing_flag = 'Y'
      THEN 'Y'
      ELSE 'N'
    END AS email_marketable,
    CASE
      WHEN (c.opt_sms = 'I'
        AND c.mobile_number_on_file_flag = 'Y'
        AND c.marketing_flag = 'Y'
        AND c.country_code NOT IN ('US','CA'))
      OR (c.mobile_number_on_file_flag = 'Y'
        AND c.opt_sms = 'I'
        AND c.double_opt_sms = 'I'
        AND c.marketing_flag = 'Y'
        AND c.country_code IN ('US','CA'))
      THEN 'Y'
      ELSE 'N'
    END AS sms_marketable
  FROM SUMMARY_GEN.WUDNA_CUSTOMER_MASTER_VW c
  JOIN SUMMARY_GEN.COUNTRY_VW cnt
    ON c.country_code = cnt.country_code
   AND cnt.super_region = 'LACA'
  WHERE c.first_registration_date IS NOT NULL
),

-- All LACA transactions from 2021 onwards
all_txns AS (
  SELECT DISTINCT
    t.sndcustomer_key AS customer_key,
    DATE(t.rcvpaying_datetime) AS txn_date
  FROM SUMMARY_GEN.WUDNA_TXN_MASTER_ANALYTICS_VW t
  WHERE t.SEND_SUPER_REGION = 'LACA'
    AND t.rcvpaying_datetime >= '2021-01-01'
)

-- Final RNT: Registered in R12, No transactions in R48
SELECT DISTINCT
  m.ref_date,
  r.customer_key,
  r.country_code,
  r.reg_month,
  'Y' AS rnt_flag,
  r.email_marketable,
  r.sms_marketable
FROM months m
JOIN cust_reg r
  ON r.reg_month >= DATEADD(MONTH, -11, m.ref_date)  -- R12 start
 AND r.reg_month <= m.ref_date                       -- R12 end
LEFT JOIN all_txns t
  ON r.customer_key = t.customer_key
 AND t.txn_date >= DATEADD(MONTH, -47, m.ref_date)  -- R48 start
 AND t.txn_date <= DATEADD(DAY, 1, LAST_DAY(m.ref_date))            -- R48 end
WHERE t.customer_key IS NULL;  -- No transactions in R48
