-- Step 1: Create base customer table (Active R12 US customers)
CREATE OR REPLACE TABLE CAR_759_C2B_BASE_CUSTOMERS AS
SELECT 
    CUSTOMER_KEY,
    COUNTRY_CODE,
    Age AS AGE_GROUP,
    PRFRD_LANGUAGE_CODE
FROM WUDNA.SUMMARY_GEN.WUDNA_CUSTOMER_MASTER_VW
WHERE COUNTRY_CODE = 'US'
    AND CUSTOMER_KEY IS NOT NULL;

-- Step 2: Create consolidated transaction table (Prepaid, Bill Pay, MT all in one)
CREATE OR REPLACE TABLE CAR_759_C2B_ALL_TXNS AS
-- Prepaid Card transactions
SELECT
    p.CUSTOMER_KEY,
    'PREPAID' AS PRODUCT_TYPE,
    p.SETTLEMENT_DATE AS TXN_DATE,
    p.TOTAL_AMOUNT AS PRINCIPAL_USD,
    NULL AS STATE,
    NULL AS CHANNEL,
    NULL AS DIGITAL_SUBCHANNEL
FROM WUDNA.SUMMARY_GEN.WUDNA_PREPAID_TXN_VW p
INNER JOIN CAR_759_C2B_BASE_CUSTOMERS c
    ON p.CUSTOMER_KEY = c.CUSTOMER_KEY  -- Only US customers
WHERE p.CARDTRANSACTIONTYPE = 'PREPAID CARD PAYMENT'
    AND DATE(p.SETTLEMENT_DATE) >= '2024-12-01' AND DATE(p.SETTLEMENT_DATE) <= '2025-11-30'
    AND p.CUSTOMER_KEY IS NOT NULL

UNION ALL

-- Bill Pay transactions
SELECT
    t.SNDCUSTOMER_KEY AS CUSTOMER_KEY,
    'BILLPAY' AS PRODUCT_TYPE,
    DATE(t.RCVPAYING_DATETIME) AS TXN_DATE,
    t.SNDPRINCIPAL_USD AS PRINCIPAL_USD,
    STATE,
    CASE
        WHEN UPPER(t.PRICING_CHANNEL) IN ('WEB','APP') THEN 'Digital'
        WHEN UPPER(t.PRICING_CHANNEL) IN ('POS','TMT','AIR') THEN 'Retail'
        ELSE 'Other'
    END AS CHANNEL,
    CASE
        WHEN UPPER(t.PRICING_CHANNEL) = 'WEB' THEN 'Web'
        WHEN UPPER(t.PRICING_CHANNEL) = 'APP' THEN 'App'
        ELSE NULL
    END AS DIGITAL_SUBCHANNEL
FROM WUDNA.SUMMARY_GEN.WUDNA_TXN_MASTER_VW t
INNER JOIN CAR_759_C2B_BASE_CUSTOMERS c
    ON t.SNDCUSTOMER_KEY = c.CUSTOMER_KEY  -- Only US customers
WHERE t.PRODUCT_GROUP IN ('QCOL','QCSH')
    AND t.SNDCOUNTRY_CODE = 'US'
    AND DATE(t.RCVPAYING_DATETIME) >= '2024-12-01' AND DATE(t.RCVPAYING_DATETIME) <= '2025-11-30'
    AND t.SNDCUSTOMER_KEY IS NOT NULL
 
 
UNION ALL

-- Money Transfer transactions
SELECT
    t.SNDCUSTOMER_KEY AS CUSTOMER_KEY,
    'MT' AS PRODUCT_TYPE,
    DATE(t.RCVPAYING_DATETIME) AS TXN_DATE,
    t.SNDPRINCIPAL_USD AS PRINCIPAL_USD,
    t.SEND_STATE AS STATE,
    CASE
        WHEN UPPER(t.PRICING_CHANNEL) IN ('RETAIL','POS','TMT','AIR') THEN 'Retail'
        WHEN UPPER(t.PRICING_CHANNEL) IN ('DIGITAL','WEB','APP') THEN 'Digital'
        ELSE 'Other'
    END AS CHANNEL,
    CASE
        WHEN UPPER(t.PRICING_CHANNEL) = 'WEB' THEN 'Web'
        WHEN UPPER(t.PRICING_CHANNEL) = 'APP' THEN 'App'
        ELSE NULL
    END AS DIGITAL_SUBCHANNEL
FROM WUDNA.SUMMARY_GEN.WUDNA_TXN_MASTER_VW t
INNER JOIN CAR_759_C2B_BASE_CUSTOMERS c
    ON t.SNDCUSTOMER_KEY = c.CUSTOMER_KEY  -- Only US customers
WHERE t.PRODUCT_GROUP = 'MTRN'
    AND t.SNDCOUNTRY_CODE = 'US'
    AND DATE(t.RCVPAYING_DATETIME) >= '2024-12-01' AND DATE(t.RCVPAYING_DATETIME) <= '2025-11-30'
    AND t.SNDCUSTOMER_KEY IS NOT NULL;

-- Step 2.5: Calculate dominant state for each customer
CREATE OR REPLACE TABLE CAR_759_C2B_CUSTOMER_DOMINANT_STATE AS
SELECT
    CUSTOMER_KEY,
    STATE AS DOMINANT_STATE
FROM (
    SELECT
        CUSTOMER_KEY,
        STATE,
        COUNT(*) AS TXN_COUNT,
        ROW_NUMBER() OVER (PARTITION BY CUSTOMER_KEY ORDER BY COUNT(*) DESC, STATE) AS STATE_RANK
    FROM CAR_759_C2B_ALL_TXNS
    WHERE STATE IS NOT NULL
    GROUP BY CUSTOMER_KEY, STATE
)
WHERE STATE_RANK = 1;

-- Step 3: customer-level aggregation with proper dominant state join
CREATE OR REPLACE TABLE CAR_759_C2B_CUSTOMER_MASTER_ANALYSIS AS
SELECT
    c.CUSTOMER_KEY,
    c.AGE_GROUP,
    c.PRFRD_LANGUAGE_CODE,
    
    -- Product flags
    MAX(CASE WHEN t.PRODUCT_TYPE = 'PREPAID' THEN 1 ELSE 0 END) AS HAS_PREPAID,
    MAX(CASE WHEN t.PRODUCT_TYPE = 'BILLPAY' THEN 1 ELSE 0 END) AS HAS_BILLPAY,
    MAX(CASE WHEN t.PRODUCT_TYPE = 'MT' THEN 1 ELSE 0 END) AS HAS_MT,
    
    -- Transaction counts
    SUM(CASE WHEN t.PRODUCT_TYPE = 'PREPAID' THEN 1 ELSE 0 END) AS PREPAID_TXN_COUNT,
    SUM(CASE WHEN t.PRODUCT_TYPE = 'BILLPAY' THEN 1 ELSE 0 END) AS BILLPAY_TXN_COUNT,
    SUM(CASE WHEN t.PRODUCT_TYPE = 'MT' THEN 1 ELSE 0 END) AS MT_TXN_COUNT,
    
    -- Transaction volumes
    SUM(CASE WHEN t.PRODUCT_TYPE = 'PREPAID' THEN t.PRINCIPAL_USD ELSE 0 END) AS PREPAID_VOLUME,
    SUM(CASE WHEN t.PRODUCT_TYPE = 'BILLPAY' THEN t.PRINCIPAL_USD ELSE 0 END) AS BILLPAY_VOLUME,
    SUM(CASE WHEN t.PRODUCT_TYPE = 'MT' THEN t.PRINCIPAL_USD ELSE 0 END) AS MT_VOLUME,
    
    -- Customer segment
    CASE
        WHEN MAX(CASE WHEN t.PRODUCT_TYPE IN ('PREPAID','BILLPAY') THEN 1 ELSE 0 END) = 1
             AND MAX(CASE WHEN t.PRODUCT_TYPE = 'MT' THEN 1 ELSE 0 END) = 0 THEN 'C2B Only'
        WHEN MAX(CASE WHEN t.PRODUCT_TYPE IN ('PREPAID','BILLPAY') THEN 1 ELSE 0 END) = 1
             AND MAX(CASE WHEN t.PRODUCT_TYPE = 'MT' THEN 1 ELSE 0 END) = 1 THEN 'C2B + Money Transfer'
        WHEN MAX(CASE WHEN t.PRODUCT_TYPE IN ('PREPAID','BILLPAY') THEN 1 ELSE 0 END) = 0
             AND MAX(CASE WHEN t.PRODUCT_TYPE = 'MT' THEN 1 ELSE 0 END) = 1 THEN 'Money Transfer Only'
        ELSE 'Other'
    END AS CUSTOMER_SEGMENT,
    
    -- Product combination
    CASE
        WHEN MAX(CASE WHEN t.PRODUCT_TYPE = 'PREPAID' THEN 1 ELSE 0 END) = 1
             AND MAX(CASE WHEN t.PRODUCT_TYPE = 'BILLPAY' THEN 1 ELSE 0 END) = 0
             AND MAX(CASE WHEN t.PRODUCT_TYPE = 'MT' THEN 1 ELSE 0 END) = 0 THEN 'Prepaid Only'
        WHEN MAX(CASE WHEN t.PRODUCT_TYPE = 'PREPAID' THEN 1 ELSE 0 END) = 0
             AND MAX(CASE WHEN t.PRODUCT_TYPE = 'BILLPAY' THEN 1 ELSE 0 END) = 1
             AND MAX(CASE WHEN t.PRODUCT_TYPE = 'MT' THEN 1 ELSE 0 END) = 0 THEN 'Bill Pay Only'
        WHEN MAX(CASE WHEN t.PRODUCT_TYPE = 'PREPAID' THEN 1 ELSE 0 END) = 1
             AND MAX(CASE WHEN t.PRODUCT_TYPE = 'BILLPAY' THEN 1 ELSE 0 END) = 1
             AND MAX(CASE WHEN t.PRODUCT_TYPE = 'MT' THEN 1 ELSE 0 END) = 0 THEN 'Prepaid + Bill Pay'
        WHEN MAX(CASE WHEN t.PRODUCT_TYPE = 'PREPAID' THEN 1 ELSE 0 END) = 1
             AND MAX(CASE WHEN t.PRODUCT_TYPE = 'BILLPAY' THEN 1 ELSE 0 END) = 0
             AND MAX(CASE WHEN t.PRODUCT_TYPE = 'MT' THEN 1 ELSE 0 END) = 1 THEN 'Prepaid + MT'
        WHEN MAX(CASE WHEN t.PRODUCT_TYPE = 'PREPAID' THEN 1 ELSE 0 END) = 0
             AND MAX(CASE WHEN t.PRODUCT_TYPE = 'BILLPAY' THEN 1 ELSE 0 END) = 1
             AND MAX(CASE WHEN t.PRODUCT_TYPE = 'MT' THEN 1 ELSE 0 END) = 1 THEN 'Bill Pay + MT'
        WHEN MAX(CASE WHEN t.PRODUCT_TYPE = 'PREPAID' THEN 1 ELSE 0 END) = 1
             AND MAX(CASE WHEN t.PRODUCT_TYPE = 'BILLPAY' THEN 1 ELSE 0 END) = 1
             AND MAX(CASE WHEN t.PRODUCT_TYPE = 'MT' THEN 1 ELSE 0 END) = 1 THEN 'All Products'
        WHEN MAX(CASE WHEN t.PRODUCT_TYPE = 'MT' THEN 1 ELSE 0 END) = 1 THEN 'MT Only'
        ELSE 'Other'
    END AS PRODUCT_COMBINATION,
    
    -- Dominant state
    ds.DOMINANT_STATE,
    
    -- Dominant agent and channel from dominancy table
    d.DOMINANT_AGENT_STATE,
    d.DOMINANT_PRICING_CHANNEL,
    d.DOMINANT_CHANNEL
 
FROM CAR_759_C2B_BASE_CUSTOMERS c
INNER JOIN CAR_759_C2B_ALL_TXNS t
    ON c.CUSTOMER_KEY = t.CUSTOMER_KEY
LEFT JOIN CAR_759_C2B_CUSTOMER_DOMINANT_STATE ds
    ON c.CUSTOMER_KEY = ds.CUSTOMER_KEY
LEFT JOIN (
    SELECT
        SNDCUSTOMER_KEY AS CUSTOMER_KEY,
        DOMINANT_AGENT_STATE,
        DOMINANT_PRICING_CHANNEL,
        CASE
            WHEN DOMINANT_PRICING_CHANNEL IN ('APP', 'WEB') THEN 'Digital'
            WHEN DOMINANT_PRICING_CHANNEL IN ('POS', 'TMT', 'AIR') THEN 'Retail'
            ELSE 'OTHER'
        END AS DOMINANT_CHANNEL
    FROM WUDNA.CEX_SANDBOX.SK_DOMINANCY_METRICS
) d ON c.CUSTOMER_KEY = d.CUSTOMER_KEY
 
GROUP BY
    c.CUSTOMER_KEY,
    c.AGE_GROUP,
    c.PRFRD_LANGUAGE_CODE,
    ds.DOMINANT_STATE,
    d.DOMINANT_AGENT_STATE,
    d.DOMINANT_PRICING_CHANNEL,
    d.DOMINANT_CHANNEL;

-- Step 4: Create summary reports
-- Summary by segment and product combination
CREATE OR REPLACE TABLE CAR_759_C2B_SEGMENT_SUMMARY AS
SELECT 
    CUSTOMER_SEGMENT,
    PRODUCT_COMBINATION,
    COUNT(DISTINCT CUSTOMER_KEY) AS CUSTOMER_COUNT,
    
    -- Transaction metrics
    SUM(PREPAID_TXN_COUNT) AS TOTAL_PREPAID_TXNS,
    SUM(PREPAID_VOLUME) AS TOTAL_PREPAID_VOLUME,
    SUM(BILLPAY_TXN_COUNT) AS TOTAL_BILLPAY_TXNS,
    SUM(BILLPAY_VOLUME) AS TOTAL_BILLPAY_VOLUME,
    SUM(MT_TXN_COUNT) AS TOTAL_MT_TXNS,
    SUM(MT_VOLUME) AS TOTAL_MT_VOLUME,
    
    
    -- Channel split
    SUM(CASE WHEN DOMINANT_CHANNEL = 'Digital' THEN 1 ELSE 0 END) AS DIGITAL_DOMINANT_CUSTOMERS,
    SUM(CASE WHEN DOMINANT_CHANNEL = 'Retail' THEN 1 ELSE 0 END) AS RETAIL_DOMINANT_CUSTOMERS,
    

FROM CAR_759_C2B_CUSTOMER_MASTER_ANALYSIS
GROUP BY CUSTOMER_SEGMENT, PRODUCT_COMBINATION
ORDER BY CUSTOMER_COUNT DESC;

-- Demographics breakdown by segment
CREATE OR REPLACE TABLE CAR_759_C2B_SEGMENT_DEMOGRAPHICS AS
SELECT 
    CUSTOMER_SEGMENT,
    PRODUCT_COMBINATION,
    AGE_GROUP,
    PRFRD_LANGUAGE_CODE,
    DOMINANT_CHANNEL,
    COUNT(DISTINCT CUSTOMER_KEY) AS CUSTOMER_COUNT,
    SUM(PREPAID_VOLUME + BILLPAY_VOLUME + MT_VOLUME) AS TOTAL_VOLUME,
FROM CAR_759_C2B_CUSTOMER_MASTER_ANALYSIS
GROUP BY 1,2,3,4,5
ORDER BY CUSTOMER_SEGMENT, CUSTOMER_COUNT DESC;

-- Geography breakdown by segment
CREATE OR REPLACE TABLE CAR_759_C2B_SEGMENT_GEOGRAPHY AS
SELECT 
    CUSTOMER_SEGMENT,
    PRODUCT_COMBINATION,
    DOMINANT_STATE,
    DOMINANT_AGENT_STATE,
    COUNT(DISTINCT CUSTOMER_KEY) AS CUSTOMER_COUNT,
    SUM(PREPAID_VOLUME + BILLPAY_VOLUME + MT_VOLUME) AS TOTAL_VOLUME,
FROM CAR_759_C2B_CUSTOMER_MASTER_ANALYSIS
WHERE DOMINANT_STATE IS NOT NULL
GROUP BY 1,2,3,4
ORDER BY CUSTOMER_SEGMENT, CUSTOMER_COUNT DESC;
