WITH params AS (
    SELECT TO_DATE('2025-01-01') AS ref_date,
           DATEADD(MONTH, -11, TO_DATE('2025-01-01')) AS reg_start
),
months AS (
    SELECT DATE_TRUNC('MONTH', p.ref_date) AS ref_date
    FROM params p
),
cust_reg AS (
    SELECT
        c.customer_key,
        DATE_TRUNC('MONTH', c.first_registration_date) AS reg_month,
        c.first_registration_date,
        c.country_code
    FROM SUMMARY_GEN.WUDNA_CUSTOMER_MASTER_VW c
    JOIN SUMMARY_GEN.COUNTRY_VW cnt
        ON c.country_code = cnt.country_code
    JOIN params p ON 1=1
    WHERE cnt.super_region = 'LACA'
      AND c.first_registration_date IS NOT NULL
      AND DATE_TRUNC('MONTH', c.first_registration_date) >= p.reg_start
      AND DATE_TRUNC('MONTH', c.first_registration_date) <= p.ref_date
),
txns_rnt AS (
    SELECT DISTINCT
        t.sndcustomer_key AS customer_key,
        DATE_TRUNC('MONTH', t.rcvpaying_datetime) AS txn_month,
        DATE(MIN(t.rcvpaying_datetime)) AS first_txn_date
    FROM SUMMARY_GEN.WUDNA_TXN_MASTER_ANALYTICS_VW t
    JOIN SUMMARY_GEN.COUNTRY_VW snd
        ON t.sndcountry_code = snd.country_code
    JOIN params p ON 1=1
    WHERE snd.super_region = 'LACA'
      AND t.rcvpaying_datetime >= DATE '2023-01-01'
    GROUP BY t.sndcustomer_key, txn_month
),
rnt_no_txn AS (
    SELECT
        m.ref_date,
        r.customer_key
    FROM months m
    JOIN cust_reg r
        ON r.reg_month >= DATEADD(MONTH, -11, m.ref_date)
       AND r.reg_month <= m.ref_date
    LEFT JOIN txns_rnt t
        ON r.customer_key = t.customer_key
       AND t.first_txn_date BETWEEN r.reg_month AND LAST_DAY(m.ref_date)
       AND DATE(r.first_registration_date) <= DATE(t.first_txn_date)
    WHERE t.customer_key IS NULL
),
rnt_main AS (
    SELECT customer_key
    FROM LACA_RNT_CUSTOMERS
    WHERE ref_date = TO_DATE('2025-01-01')
)
SELECT
    (SELECT COUNT(DISTINCT customer_key) FROM cust_reg) AS registered_customers,
    (SELECT COUNT(DISTINCT customer_key) FROM rnt_no_txn) AS rnt_test,
    (SELECT COUNT(DISTINCT customer_key) FROM rnt_main) AS rnt_main;
