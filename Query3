CREATE OR REPLACE TABLE LACA_ENGAGEMENT_CUSTOMERS_AGG_test AS
WITH corridor_ranked AS (
  SELECT
    ref_date,
    dominant_corridor_name,
    DENSE_RANK() OVER (
      PARTITION BY ref_date
      ORDER BY COUNT(DISTINCT customer_key) DESC
    ) AS corridor_rank
  FROM LACA_ENGAGEMENT_CORRIDOR_CUSTOMERS
  GROUP BY ref_date, dominant_corridor_name
),
engaged AS (
  SELECT
     e.customer_key,
    e.ref_date,
    e.country_code,
    e.r12_txns,
    e.r6_txns,
    e.pr12_txns,
    e.ppr12_txns,
    e.pppr12_txns,
    e.dominant_sndcountry_name,
    e.dominant_rcvcountry_name,
    e.channel_dominance,
    e.email_marketable,
    e.sms_marketable,
    e.retail_digital_flag,
    e.Web_App_Flag,
    e.channel_native,
    e.rnt_flag,
    e.r12_active,
    e.active_churn_r7_r12,
    e.lapsed_r12_plus,
    CASE
      WHEN cr.corridor_rank <= 11 THEN e.dominant_corridor_name
      ELSE 'Others'
    END AS corridor_bucket
  FROM LACA_ENGAGEMENT_CORRIDOR_CUSTOMERS e
  LEFT JOIN corridor_ranked cr
    ON e.ref_date = cr.ref_date
   AND e.dominant_corridor_name = cr.dominant_corridor_name
)
SELECT
  ref_date,
  country_code,
  corridor_bucket,
  dominant_sndcountry_name,
  dominant_rcvcountry_name,
  channel_dominance,
  email_marketable,
  sms_marketable,
  retail_digital_flag,
  Web_App_Flag,
  channel_native,
  rnt_flag,
  r12_active,
  active_churn_r7_r12,
  lapsed_r12_plus,
  customer_key,  
  COALESCE(SUM(r12_txns), 0) AS total_r12_txns,
  COALESCE(SUM(r6_txns), 0) AS total_r6_txns,
  COALESCE(SUM(pr12_txns), 0) AS total_pr12_txns,
  COALESCE(SUM(ppr12_txns), 0) AS total_ppr12_txns,
  COALESCE(SUM(pppr12_txns), 0) AS total_pppr12_txns 
FROM engaged
GROUP BY
  ALL;

  SELECT
  count(customer_key) AS customer_count,
  CASE
  -- WHEN a.r12_active = 'Y' THEN
  --   CASE WHEN a.active_churn_r7_r12 = 'Y' THEN 'Churn R7-12' ELSE 'Active R1-6' END
        WHEN B.TOTAL_R12_TXNS = 0 AND B.TOTAL_PR12_TXNS > 0 AND B.TOTAL_PPR12_TXNS = 0 AND B.TOTAL_PPPR12_TXNS = 0 THEN 'R13-R24 Active'
        WHEN B.TOTAL_R12_TXNS = 0 AND B.TOTAL_PR12_TXNS = 0 AND B.TOTAL_PPR12_TXNS > 0 AND B.TOTAL_PPPR12_TXNS = 0 THEN 'R25-R36 Active'
        WHEN B.TOTAL_R12_TXNS = 0 AND B.TOTAL_PR12_TXNS = 0 AND B.TOTAL_PPR12_TXNS = 0 AND B.TOTAL_PPPR12_TXNS > 0 THEN 'R37-R48 Active'
        WHEN B.TOTAL_R12_TXNS = 0 AND B.TOTAL_PR12_TXNS > 0 AND B.TOTAL_PPR12_TXNS > 0 AND B.TOTAL_PPPR12_TXNS = 0 THEN 'R13-R36 Active'
        WHEN B.TOTAL_R12_TXNS = 0 AND B.TOTAL_PR12_TXNS = 0 AND B.TOTAL_PPR12_TXNS > 0 AND B.TOTAL_PPPR12_TXNS > 0 THEN 'R25-R48 Active'
        WHEN B.TOTAL_R12_TXNS = 0 AND B.TOTAL_PR12_TXNS > 0 AND B.TOTAL_PPR12_TXNS > 0 AND B.TOTAL_PPPR12_TXNS > 0 THEN 'R13-R48 Active'
        WHEN B.TOTAL_R12_TXNS = 0 AND B.TOTAL_PR12_TXNS > 0 AND B.TOTAL_PPR12_TXNS = 0 AND B.TOTAL_PPPR12_TXNS > 0 THEN 'R13-R24 Active and R37-R48 Active'
        else 'OTHER' end as LEVEL3_BREAKDOWN
FROM LACA_ENGAGEMENT_CUSTOMERS_AGG_test b
where ref_date = '2025-09-01'
GROUP BY all;
